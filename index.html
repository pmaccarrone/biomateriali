<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuratore Didattico Biomateriali v92 - Accademia Albertina</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: #f4f4f4; color: #333; min-height: 100vh; font-size: 14px; }

        /* HEADER */
        header { background: linear-gradient(135deg, #1a472a 0%, #2d5a3d 100%); color: white; padding: 0.6rem 1.5rem; display: flex; align-items: center; gap: 0.75rem; }
        .header-logo { flex-shrink: 0; }
        .header-logo img { width: 52px; height: 52px; border-radius: 50%; object-fit: cover; transition: transform 0.2s, box-shadow 0.2s; }
        .header-logo:hover img { transform: scale(1.08); box-shadow: 0 2px 8px rgba(45,90,61,0.25); }
        .header-info { flex: 1; }
        .header-info h1 { font-size: 1.15rem; font-weight: 600; margin-bottom: 0.15rem; }
        .header-info .credits { font-size: 0.6rem; opacity: 0.85; line-height: 1.4; }
        
        /* Pulsante Info nell'header */
        .btn-info {
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .btn-info:hover {
            background: rgba(255,255,255,0.25);
            transform: scale(1.1);
        }
        
        /* Modal Credits */
        .credits-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        .credits-modal.show { display: flex; }
        .credits-content {
            background: white;
            border-radius: 12px;
            max-width: 700px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        .credits-header {
            background: linear-gradient(135deg, #1a472a 0%, #2d5a3d 100%);
            color: white;
            padding: 1.25rem 1.5rem;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .credits-header h2 { margin: 0; font-size: 1.2rem; }
        .credits-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            font-size: 1.3rem;
            cursor: pointer;
            line-height: 1;
        }
        .credits-close:hover { background: rgba(255,255,255,0.3); }
        .credits-body { padding: 1.5rem; }
        .credits-section {
            margin-bottom: 1.5rem;
            padding-bottom: 1.25rem;
            border-bottom: 1px solid #eee;
        }
        .credits-section:last-child { border-bottom: none; margin-bottom: 0; }
        .credits-section h3 {
            color: #2d5a3d;
            font-size: 0.95rem;
            margin: 0 0 0.75rem 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .credits-section p, .credits-section li {
            font-size: 0.85rem;
            line-height: 1.6;
            color: #444;
            margin: 0.4rem 0;
        }
        .credits-section ul {
            margin: 0.5rem 0;
            padding-left: 1.25rem;
        }
        .credits-section a {
            color: #2d5a3d;
            text-decoration: none;
        }
        .credits-section a:hover { text-decoration: underline; }
        .disclaimer-box {
            background: #fff8e1;
            border-left: 4px solid #ff9800;
            padding: 1rem;
            border-radius: 0 8px 8px 0;
            margin: 0.75rem 0;
        }
        .disclaimer-box.warning {
            background: #ffebee;
            border-left-color: #f44336;
        }
        .disclaimer-box p {
            margin: 0.3rem 0;
            font-size: 0.8rem;
        }
        .ai-note {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 1rem;
            border-radius: 0 8px 8px 0;
            margin: 0.75rem 0;
        }
        .credits-version {
            text-align: center;
            color: #999;
            font-size: 0.75rem;
            padding-top: 1rem;
        }

        /* LAYOUT */
        .app-layout { display: grid; grid-template-columns: 1fr 200px; min-height: calc(100vh - 70px); }
        .main-area { display: flex; flex-direction: column; }

        /* TABS */
        .tabs-container { background: white; border-bottom: 1px solid #ddd; padding: 0 1rem; }
        .tabs { display: flex; }
        .tab { padding: 0.7rem 1.25rem; cursor: pointer; border-bottom: 3px solid transparent; font-weight: 500; color: #666; font-size: 0.85rem; }
        .tab:hover { background: #f8f8f8; }
        .tab.active { border-bottom-color: #2d5a3d; color: #1a472a; background: #f0f7f2; }
        .tab .tab-subtitle { font-size: 0.6rem; color: #888; font-weight: 400; display: block; }

        /* CONTENT */
        .content-area { flex: 1; padding: 1rem; overflow-y: auto; overflow-x: hidden; }
        .panel-container { display: none; overflow: visible; }
        .panel-container.active { display: block; }
        /* v60.4: Layout per sticky headers in Tab A e P */
        /* Quando Tab A o P sono attivi, content-area non scrolla */
        body.tab-A-active .content-area,
        body.tab-P-active .content-area {
            overflow: hidden;
        }
        
        /* Tab A: layout con header fisso */
        #panel-A.active {
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }
        
        #panel-A .output-selector {
            flex-shrink: 0;
            position: relative;
        }
        
        #panel-A .materiali-scroll-area {
            flex: 1;
            overflow-y: auto;
            padding-top: 0.5rem;
        }
        
        /* Tab P: layout con header fisso */
        #panel-P.active {
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }
        
        #panel-P > .project-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }
        
        #panel-P .project-hero {
            flex-shrink: 0;
        }
        
        #panel-P .project-scroll-area {
            flex: 1;
            overflow-y: auto;
            padding-top: 0.5rem;
        }


        /* CARRELLO SIDEBAR */
        .cart-sidebar { background: white; border-left: 1px solid #ddd; display: flex; flex-direction: column; }
        .cart-header { background: #f8f9fa; padding: 0.6rem 0.75rem; border-bottom: 1px solid #eee; font-weight: 600; font-size: 0.75rem; color: #555; display: flex; justify-content: space-between; }
        .cart-header .count { background: #2d5a3d; color: white; padding: 2px 7px; border-radius: 10px; font-size: 0.65rem; }
        .cart-body { flex: 1; padding: 0.6rem; overflow-y: auto; min-height: 100px; }
        .cart-empty { color: #999; font-size: 0.7rem; text-align: center; padding: 1rem; }
        .cart-item { display: flex; align-items: center; padding: 0.4rem; background: #f8f9fa; border-radius: 5px; margin-bottom: 0.35rem; font-size: 0.7rem; border: 1px solid transparent; }
        .cart-item-teorico { background: #fff0f0; border: 1px solid #ffcccc; }
        .cart-separator { font-size: 0.6rem; color: #c00; text-align: center; padding: 0.3rem; margin: 0.5rem 0 0.3rem; border-top: 1px dashed #ddd; }
        .cart-item:hover { border-color: #2d5a3d; background: #f0f7f2; }
        .cart-item.in-tavolo { background: #e3f2fd; border-color: #90caf9; }
        .cart-item .dot { width: 8px; height: 8px; border-radius: 50%; margin-right: 0.4rem; }
        .cart-item .name { flex: 1; }
        
        .cart-item .cart-actions {
            display: flex;
            gap: 0.25rem;
            align-items: center;
            margin-left: auto;
        }
        .cart-item .cart-btn {
            cursor: pointer;
            padding: 0;
            font-size: 0.6rem;
            font-weight: 600;
            border-radius: 3px;
            border: 1px solid;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            box-sizing: border-box;
        }
        .cart-item .btn-tavolo {
            background: #e3f2fd;
            border-color: #90caf9;
            color: #1565c0;
        }
        .cart-item .btn-tavolo:hover {
            background: #1565c0;
            color: white;
        }
        .cart-item .btn-tavolo.in-tavolo {
            background: #1565c0;
            color: white;
        }
        .cart-item .btn-info {
            background: #f0f7f2;
            border-color: #a5d6a7;
            color: #2d5a3d;
        }
        .cart-item .btn-info:hover {
            background: #2d5a3d;
            color: white;
        }
        .cart-item .btn-remove {
            background: #fff5f5;
            border-color: #ffcccc;
            color: #c00;
        }
        .cart-item .btn-remove:hover {
            background: #c00;
            color: white;
        }
        .cart-item .name { flex: 1; cursor: pointer; }
        .cart-footer { padding: 0.6rem; border-top: 1px solid #eee; }
        .btn { padding: 0.45rem 0.7rem; border: none; border-radius: 5px; font-size: 0.7rem; cursor: pointer; text-align: center; width: 100%; }
        .btn-primary { background: #2d5a3d; color: white; }
        .btn-primary:hover { background: #1a472a; }

        /*                                                                                                                                                                                  
           TAB PROGETTO: PERCORSO INVERSO
                                                                                                                                                                                          */
        
        .project-container {
            max-width: 100%;
            margin: 0;
            padding: 0;
        }
        
        .project-hero {
            text-align: center;
            padding: 2rem 1rem;
            background: linear-gradient(135deg, #f0f7f2 0%, #e8f5e9 100%);
            border-radius: 16px;
            margin-bottom: 1.5rem;
        }
        
        /* v60.3: Hero compatto */
        .project-hero.compact {
            padding: 0.75rem 1rem;
            margin-bottom: 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .project-hero h2 {
            color: #1a472a;
            font-size: 1.5rem;
            margin: 0 0 0.5rem 0;
            font-weight: 600;
        }
        
        .project-hero.compact h2 {
            font-size: 1rem;
            margin: 0 0 0.15rem 0;
        }
        
        .project-hero p {
            color: #666;
            margin: 0;
            font-size: 0.9rem;
        }
        
        .project-hero.compact p {
            font-size: 0.75rem;
            color: #888;
        }
        
        /* Filtri proprietà  */
        .filters-section {
            background: white;
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        
        .filters-section h3 {
            font-size: 0.75rem;
            color: #1a472a;
            margin: 0 0 0.6rem 0;
            padding-bottom: 0.4rem;
            border-bottom: 1px solid #e8f5e9;
        }
        
        /* v76: Filter chips con immagini Leonardo AI */
        .filters-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            justify-content: center;
        }
        
        .filter-chip {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 90px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }
        
        .filter-chip .filter-img-wrap {
            position: relative;
            width: 90px;
            height: 90px;
            border-radius: 16px;
            overflow: hidden;
            border: 3px solid #e0e0e0;
            transition: all 0.25s ease;
            background: #f8f9fa;
        }
        
        .filter-chip .filter-img-wrap img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.25s ease;
        }
        
        .filter-chip:hover .filter-img-wrap {
            border-color: #2d5a3d;
            box-shadow: 0 4px 12px rgba(45,90,61,0.2);
        }
        
        .filter-chip:hover .filter-img-wrap img {
            transform: scale(1.05);
        }
        
        .filter-chip.active .filter-img-wrap {
            border-color: #2d5a3d;
            border-width: 3px;
            box-shadow: 0 4px 16px rgba(45,90,61,0.35);
        }
        
        .filter-chip .filter-check {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 24px;
            height: 24px;
            background: #2d5a3d;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            z-index: 2;
        }
        
        .filter-chip.active .filter-check {
            display: flex;
        }
        
        .filter-chip .filter-label {
            margin-top: 0.45rem;
            font-size: 0.7rem;
            color: #666;
            text-align: center;
            font-weight: 500;
            line-height: 1.2;
            transition: all 0.2s;
        }
        
        .filter-chip.active .filter-label {
            color: #2d5a3d;
            font-weight: 700;
        }
        
        .filter-chip:hover .filter-label {
            color: #2d5a3d;
        }
        
        /* Risultati */
        .results-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }
        
        @media (max-width: 800px) {
            .results-section { grid-template-columns: 1fr; }
        }
        
        .results-panel {
            background: white;
            border-radius: 8px;
            padding: 0.75rem;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }
        
        .results-panel h3 {
            font-size: 0.8rem;
            color: #1a472a;
            margin: 0 0 1rem 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .results-panel h3 .count-badge {
            background: #e8f5e9;
            color: #2d5a3d;
            padding: 0.15rem 0.5rem;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .results-empty {
            text-align: center;
            padding: 2rem;
            color: #999;
            font-size: 0.85rem;
        }
        
        .results-empty .empty-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            opacity: 0.5;
        }
        
        /* Card materiale suggerito */
        .material-card {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 0.6rem;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        
        .material-card:hover {
            border-color: #2d5a3d;
            background: #f0f7f2;
            transform: translateX(4px);
        }
        
        .material-card .mat-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #2d5a3d, #4a8c5f);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.1rem;
            margin-right: 0.75rem;
            flex-shrink: 0;
        }
        
        .material-card .mat-info {
            flex: 1;
            min-width: 0;
        }
        
        .material-card .mat-name {
            font-weight: 600;
            font-size: 0.85rem;
            color: #333;
            margin-bottom: 0.15rem;
        }
        
        .material-card .mat-desc {
            font-size: 0.7rem;
            color: #777;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .material-card .mat-match {
            display: flex;
            gap: 0.2rem;
            margin-left: 0.5rem;
        }
        
        .material-card .match-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4caf50;
        }
        
        .material-card .match-dot.partial {
            background: #ffc107;
        }
        
        .material-card .match-dot.miss {
            background: #e0e0e0;
        }
        
        /* Ingrediente suggerito */
        .ingredient-suggestion {
            display: inline-flex;
            align-items: center;
            padding: 0.5rem 0.75rem;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 20px;
            margin: 0.25rem;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .ingredient-suggestion:hover {
            border-color: #2d5a3d;
            background: #f0f7f2;
        }
        
        .ingredient-suggestion .ing-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }
        
        .ingredient-suggestion .add-btn {
            margin-left: 0.5rem;
            width: 18px;
            height: 18px;
            background: #2d5a3d;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .ingredient-suggestion:hover .add-btn {
            background: #1a472a;
        }
        
        /* Suggerimenti per proprietà  */
        .property-suggestions {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #eee;
        }
        
        .property-suggestion {
            margin-bottom: 0.75rem;
        }
        
        .property-suggestion .prop-label {
            font-size: 0.7rem;
            color: #888;
            margin-bottom: 0.3rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        
        .property-suggestion .prop-label .prop-icon {
            font-size: 0.9rem;
        }
        
        /* Pulsanti azione */
        .project-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #eee;
        }
        
        /* v72: Percorsi consigliati */
        .path-card {
            background: #f8faf8;
            border: 1px solid #c8e6c9;
            border-radius: 10px;
            padding: 0.75rem;
            margin-bottom: 0.6rem;
            transition: border-color 0.2s;
            display: flex;
            gap: 0.5rem;
            align-items: stretch;
        }
        .path-card-content { flex: 1; min-width: 0; }
        .path-card-actions {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
            justify-content: center;
            flex-shrink: 0;
        }
        .path-action-btn {
            width: 32px; height: 32px;
            border-radius: 6px;
            border: 1px solid #c8e6c9;
            background: #fff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            transition: all 0.2s;
        }
        .path-action-btn:hover { background: #e8f5e9; }
        .path-action-btn.add-btn { background: #2d5a3d; border-color: #2d5a3d; color: white; }
        .path-action-btn.add-btn:hover { background: #1b3a28; }
        .path-card:hover { border-color: #81c784; }
        .path-card-title {
            font-size: 0.8rem;
            font-weight: 600;
            color: #2d5a3d;
            margin-bottom: 0.4rem;
        }
        .path-card-ings {
            display: flex;
            flex-wrap: wrap;
            gap: 0.3rem;
            margin-bottom: 0.4rem;
        }
        .path-ing-chip {
            font-size: 0.7rem;
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            background: #e8f5e9;
            color: #2d5a3d;
            border: 1px solid #c8e6c9;
        }
        .path-ing-chip.modifier {
            background: #fff3e0;
            color: #e65100;
            border-color: #ffcc80;
        }
        .path-rationale {
            font-size: 0.7rem;
            color: #666;
            line-height: 1.4;
            margin-bottom: 0.5rem;
        }
        .path-btn {
            background: #2d5a3d;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 0.4rem 0.8rem;
            font-size: 0.7rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        .path-btn:hover { background: #1b3a28; }
        
        /* v72: Trade-off warnings */
        .tradeoff-box {
            background: #fff8e1;
            border: 1px solid #ffe082;
            border-radius: 8px;
            padding: 0.6rem 0.75rem;
            margin-bottom: 0.5rem;
            font-size: 0.75rem;
            color: #5d4037;
            line-height: 1.4;
        }
        .tradeoff-label {
            font-weight: 600;
            color: #e65100;
            font-size: 0.7rem;
            margin-bottom: 0.3rem;
        }
        
        .btn-project {
            flex: 1;
            padding: 0.6rem 1rem;
            border: none;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-project.primary {
            background: #2d5a3d;
            color: white;
        }
        
        .btn-project.primary:hover {
            background: #1a472a;
        }
        
        .btn-project.secondary {
            background: #f0f7f2;
            color: #2d5a3d;
            border: 1px solid #2d5a3d;
        }
        
        .btn-project.secondary:hover {
            background: #e8f5e9;
        }

        /* Stato vuoto filtri */
        .filters-hint {
            text-align: center;
            padding: 1rem;
            color: #888;
            font-size: 0.8rem;
            font-style: italic;
        }

        /*                                                                                                                                                                                  
           TAB A: MATERIALI
                                                                                                                                                                                          */
        
        .output-selector {
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex; 
            gap: 0.5rem; 
            padding: 0.6rem; 
            background: white;
            border-radius: 8px; 
            margin-bottom: 0.75rem; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            flex-wrap: wrap; 
            justify-content: center; 
            align-items: stretch;
        }
        .output-btn {
            display: flex; flex-direction: column; align-items: center;
            padding: 0.4rem; border: 2px solid #e0e0e0; border-radius: 6px;
            cursor: pointer; transition: all 0.2s; width: 85px; background: #fafafa;
        }
        .output-btn:hover { border-color: #2d5a3d; background: #f0f7f2; }
        .output-btn.active { border-color: #2d5a3d; background: #2d5a3d; color: white; }
        .output-photo {
            width: 100%; height: 40px; background: #e8e8e8; border-radius: 4px;
            margin-bottom: 0.3rem; display: flex; align-items: center; justify-content: center;
            overflow: hidden;
        }
        .output-photo img { width: 100%; height: 100%; object-fit: cover; }
        .output-btn.active .output-photo { background: rgba(255,255,255,0.2); }
        .output-name { font-weight: 600; font-size: 0.7rem; text-align: center; }
        .output-count { font-size: 0.55rem; opacity: 0.7; margin-top: 0.1rem; }
        .output-count .doc { color: #1565c0; }
        .output-count .prog { color: #7b1fa2; }
        .output-btn.active .output-count span { color: rgba(255,255,255,0.8); }

        .output-info {
            background: white; border-radius: 8px; padding: 0.75rem 1rem;
            margin-bottom: 0.75rem; box-shadow: 0 1px 4px rgba(0,0,0,0.08);
            border-left: 4px solid #2d5a3d;
        }
        .output-info.hidden { display: none; }
        .output-info h3 { font-size: 0.95rem; margin-bottom: 0.2rem; color: #1a472a; }
        .output-info .desc { font-size: 0.72rem; color: #666; margin: 0; }
        .output-info-matrici { margin-top: 0.4rem; font-size: 0.68rem; }
        .output-info-matrici .label { color: #888; }
        .output-info-matrici .matrici-list { color: #2d5a3d; font-weight: 500; }
        .output-info-warning {
            margin-top: 0.4rem; padding: 0.3rem 0.5rem; background: #fff3e0;
            border-radius: 4px; font-size: 0.65rem; color: #e65100; display: none;
        }

        .materiali-section {
            background: white; border-radius: 8px; margin-bottom: 0.6rem;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08); overflow: hidden;
        }
        .section-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0.55rem 0.75rem; border-bottom: 1px solid #eee;
        }
        .section-header.doc-header {
            background: #f0f7f2; border-left: 3px solid #4a9d6d;
        }
        .section-header.prog-header {
            background: #fdf8f0; border-left: 3px solid #d4a054;
        }
        .section-title { font-weight: 700; font-size: 0.78rem; color: #333; letter-spacing: 0.02em; }
        .section-count { font-size: 0.65rem; color: #888; }
        .materiali-list {
            padding: 0.5rem; display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 0.4rem; max-height: 300px; overflow-y: auto;
        }
        .materiali-list.doc-list { max-height: 250px; }
        .materiali-list.all-view { max-height: none; }

        .materiale-card {
            display: flex; align-items: flex-start; gap: 0.4rem;
            padding: 0.5rem; border: 1px solid #e8e8e8; border-radius: 6px;
            cursor: pointer; transition: all 0.15s; background: white;
        }
        .materiale-card:hover { border-color: #2d5a3d; background: #f8fdf9; }
        .materiale-card.industriale { opacity: 0.65; background: #f5f5f5; }

        .trl-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; margin-top: 2px; }
        .trl-verde { background: #4caf50; }
        .trl-bianco { background: #bdbdbd; }
        .trl-rosa { background: #f48fb1; }
        .trl-doc { background: #42a5f5; }
        .trl-ind { background: #9e9e9e; }

        .materiale-info { flex: 1; min-width: 0; }
        .materiale-nome { font-weight: 600; font-size: 0.72rem; color: #333; margin-bottom: 0.1rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .materiale-ingredienti { font-size: 0.62rem; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .materiale-actions { display: flex; gap: 0.2rem; align-items: center; }
        .mat-btn { width: 22px; height: 22px; border: 1px solid #ddd; border-radius: 4px; background: white; cursor: pointer; font-size: 0.7rem; display: flex; align-items: center; justify-content: center; }
        .mat-btn:hover { background: #e3f2fd; border-color: #1976d2; }
        .mat-btn.usa { color: #1976d2; font-weight: bold; }

        .trl-badge { font-size: 0.55rem; padding: 2px 5px; border-radius: 3px; background: #f0f0f0; color: #666; white-space: nowrap; }

        .trl-legenda {
            display: flex; gap: 0.75rem; padding: 0.4rem 0.75rem; background: #f8f9fa;
            border-radius: 6px; margin-top: 0.5rem; justify-content: center; flex-wrap: wrap;
        }
        .trl-item { display: flex; align-items: center; gap: 0.25rem; font-size: 0.6rem; color: #666; }
        .trl-item .trl-dot { width: 8px; height: 8px; }

        /* MODAL */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal-overlay.show { display: flex; }
        .modal { background: white; border-radius: 10px; padding: 1.25rem; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem; }
        .modal-header h3 { font-size: 1rem; color: #1a472a; }
        .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #999; line-height: 1; }
        .modal-close:hover { color: #333; }
        
        /* MODAL BODY - INTERLINEA AUMENTATA */
        .modal-body { font-size: 0.8rem; line-height: 1.6; }
        .modal-body .field { margin-bottom: 0.65rem; line-height: 1.5; }
        .field-group {
            margin: 0.8rem 0;
            padding: 0.5rem;
            background: #f8f9fa;
            border-radius: 6px;
        }
        .field-group-title {
            font-size: 0.65rem;
            font-weight: 700;
            color: #2d5a3d;
            margin-bottom: 0.4rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .modal-body .field-label { font-weight: 600; color: #555; font-size: 0.7rem; display: block; margin-bottom: 0.15rem; }
        .modal-body .field-value { color: #333; line-height: 1.5; }
        
        /* INGREDIENTI - COLORE DISTINTIVO */
        .modal-body .field-ingredienti { color: #1a472a; font-weight: 500; }
        
        .modal-actions { margin-top: 1rem; display: flex; gap: 0.5rem; justify-content: flex-end; }
        .modal-actions .btn { width: auto; padding: 0.5rem 1rem; }

        /* TAB B & C placeholder */
        .placeholder-panel { padding: 2rem; text-align: center; color: #888; }
        /* Chip ingredienti nella scheda */
        .ing-chip {
            display: inline-block;
            background: #e8f4ea;
            color: #2d5a3d;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.85em;
            margin: 2px;
        }
        /* v60.1: Stili per ingredienti operativi vs teorici */
        .ing-chip.ing-operativo { 
            background: #d4edda; 
            border-color: #28a745; 
            color: #155724;
        }
        .ing-chip.ing-operativo:hover { 
            background: #c3e6cb; 
        }
        .ing-chip.ing-teorico { 
            background: #f8d7da; 
            border-color: #dc3545; 
            color: #721c24;
        }
        .ing-chip.ing-teorico:hover { 
            background: #f5c6cb; 
        }

        .ing-chip.teorico {
            background: #ffeaea;
            color: #a03030;
        }
        .ing-chip.clickable {
            cursor: pointer;
            transition: all 0.2s;
        }
        .ing-chip.clickable:hover {
            background: #c8e6c9;
            transform: scale(1.05);
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        }
        .ing-chip.clickable small {
            font-weight: bold;
            margin-left: 3px;
            color: #1a472a;
        }
        .ing-chip.teorico.clickable:hover {
            background: #ffcccc;
        }
        
        /* Box ingredienti evidenziato */
        .field-ingredienti-box {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px !important;
        }
        .field-ingredienti-box .field-label {
            font-size: 1.1em;
            color: #333;
        }
        
        /* Campi compatti su riga */
        .field-row {
            display: inline-flex;
            margin-right: 20px;
            margin-bottom: 8px !important;
        }
        .field-row .field-label {
            margin-bottom: 0;
            margin-right: 8px;
        }
        .field-row .field-value {
            display: inline;
        }
        
        /* Bottone piccolo */
        .btn-sm {
            padding: 6px 14px;
            font-size: 0.9em;
        }
        
        /* Sezione risorse/link */
        .field-risorse {
            margin-top: 16px;
            padding-top: 12px;
            border-top: 1px dashed #ddd;
        }
        .risorsa-link {
            display: inline-block;
            background: #f0f4f8;
            color: #1a5a8a;
            padding: 4px 10px;
            border-radius: 4px;
            margin: 3px 6px 3px 0;
            text-decoration: none;
            font-size: 0.85em;
            transition: background 0.2s;
        }
        .risorsa-link:hover {
            background: #d8e8f4;
            text-decoration: none;
        }
        
        /* Aziende/Designer */
        .field-companies {
            color: #555;
            font-style: italic;
        }
        
        /* Toast notifications */
        .toast-container {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .toast {
            background: #333;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            animation: toastIn 0.3s ease, toastOut 0.3s ease 2.7s;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .toast.warning {
            background: #c04000;
        }
        .toast.success {
            background: #2d7a4d;
        }
        .toast.info {
            background: #1a5a8a;
        }
        .toast-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 4px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
        }
        .toast-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        .toast-btn.confirm {
            background: #fff;
            color: #333;
        }
        
        /* Modal di conferma personalizzato */
        .confirm-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.15s ease;
        }
        
        .confirm-modal {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            max-width: 380px;
            width: 90%;
            overflow: hidden;
            animation: slideUp 0.2s ease;
        }
        
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .confirm-modal-header {
            background: linear-gradient(135deg, #1a472a 0%, #2d5a3d 100%);
            color: white;
            padding: 1rem 1.25rem;
            font-weight: 600;
            font-size: 1rem;
        }
        
        .confirm-modal-body {
            padding: 1.25rem;
            color: #333;
            font-size: 0.9rem;
            line-height: 1.5;
        }
        
        .confirm-modal-actions {
            display: flex;
            gap: 0.75rem;
            padding: 0 1.25rem 1.25rem;
            justify-content: flex-end;
        }
        
        .btn-confirm-cancel, .btn-confirm-ok {
            padding: 0.6rem 1.25rem;
            border: none;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-confirm-cancel {
            background: #f0f0f0;
            color: #666;
        }
        
        .btn-confirm-cancel:hover {
            background: #e0e0e0;
        }
        
        .btn-confirm-ok {
            background: #2d5a3d;
            color: white;
        }
        
        .btn-confirm-ok:hover {
            background: #1a472a;
        }
        
        .btn-confirm-secondary {
            background: #f0f7f2;
            color: #2d5a3d;
            border: 1px solid #2d5a3d;
            padding: 0.6rem 1.25rem;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-confirm-secondary:hover {
            background: #e0efe4;
        }
        
        /* Popup conferma inline (vicino all'elemento) */
        .confirm-popup {
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            background: #c04000;
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
            z-index: 100;
            white-space: nowrap;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 6px;
            animation: popIn 0.15s ease;
        }
        .confirm-popup::before {
            content: '';
            position: absolute;
            right: 100%;
            top: 50%;
            transform: translateY(-50%);
            border: 6px solid transparent;
            border-right-color: #c04000;
        }
        .confirm-popup button {
            background: rgba(255,255,255,0.9);
            color: #333;
            border: none;
            padding: 3px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .confirm-popup button:hover {
            background: #fff;
        }
        .confirm-popup button.cancel {
            background: rgba(255,255,255,0.3);
            color: white;
        }
        .confirm-popup button.cancel:hover {
            background: rgba(255,255,255,0.5);
        }
        @keyframes popIn {
            from { opacity: 0; transform: translateY(-50%) scale(0.8); }
            to { opacity: 1; transform: translateY(-50%) scale(1); }
        }
        
        @keyframes toastIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes toastOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
    
        /*                                                                                                                                                                                  
           TAB B - APPROFONDIMENTO INGREDIENTI
                                                                                                                                                                                          */
        .study-layout { display: grid; grid-template-columns: 300px 1fr; gap: 1rem; height: calc(100vh - 180px); }
        .ing-list-panel { background: white; border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.1); display: flex; flex-direction: column; overflow: hidden; }
        .ing-list-header { padding: 0.75rem; border-bottom: 1px solid #eee; }
        .ing-search { width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 5px; font-size: 0.8rem; }
        .ing-search:focus { outline: none; border-color: #2d5a3d; }
        .ing-filters { display: flex; flex-wrap: wrap; gap: 0.3rem; margin-top: 0.5rem; }
        .ing-filter { padding: 0.25rem 0.5rem; border: 1px solid #ddd; border-radius: 12px; font-size: 0.65rem; cursor: pointer; background: white; }
        .ing-filter:hover { border-color: #2d5a3d; }
        .ing-filter.active { background: #2d5a3d; color: white; border-color: #2d5a3d; }
        .ing-filter.cart-filter { background: #e3f2fd; border-color: #90caf9; color: #1565c0; }
        .ing-filter.cart-filter.active { background: #1565c0; color: white; }
        .ing-list { flex: 1; overflow-y: auto; padding: 0.5rem; }
        .famiglia-info-box { margin: 0 0 0.75rem 0; background: #f0f7f2; border: 1px solid #c8e6c9; border-radius: 8px; overflow: hidden; }
        .famiglia-info-header { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0.75rem; background: #2d5a3d; color: white; cursor: pointer; font-size: 0.8rem; font-weight: 600; }
        .famiglia-info-toggle { font-family: monospace; }
        .famiglia-info-content { padding: 0.75rem; font-size: 0.75rem; }
        .famiglia-info-content.collapsed { display: none; }
        .famiglia-desc { color: #555; margin-bottom: 0.5rem; font-style: italic; }
        .famiglia-confronto { margin-bottom: 0.5rem; }
        .famiglia-confronto-title { font-weight: 600; color: #2d5a3d; margin-bottom: 0.3rem; }
        .famiglia-confronto-item { display: flex; gap: 0.5rem; padding: 0.3rem 0; border-bottom: 1px dashed #ddd; }
        .famiglia-confronto-item:last-child { border-bottom: none; }
        .famiglia-confronto-nome { font-weight: 500; min-width: 80px; }
        .famiglia-confronto-desc { flex: 1; color: #666; }
        .famiglia-confronto-nota { color: #888; font-size: 0.7rem; }
        .famiglia-confronto-vegano { color: #4caf50; font-size: 0.65rem; }
        .famiglia-confronto-nonvegano { color: #ff9800; font-size: 0.65rem; }
        .famiglia-quando { margin-bottom: 0.5rem; }
        .famiglia-quando-title { font-weight: 600; color: #1565c0; margin-bottom: 0.3rem; }
        .famiglia-quando-item { padding: 0.2rem 0; }
        .famiglia-quando-item strong { color: #333; }
        .famiglia-avvisi { background: #fff3e0; border-radius: 4px; padding: 0.5rem; }
        .famiglia-avvisi-title { font-weight: 600; color: #e65100; margin-bottom: 0.3rem; }
        .famiglia-avvisi li { margin-left: 1rem; color: #bf360c; }
        .ing-list-item { display: flex; align-items: center; padding: 0.5rem; border-radius: 5px; cursor: pointer; margin-bottom: 0.3rem; }
        .ing-list-item:hover { background: #f0f7f2; }
        .ing-list-item.selected { background: #e8f5e9; border-left: 3px solid #2d5a3d; }
        .ing-list-item .dot { margin-right: 0.5rem; }
        .ing-list-item .info { flex: 1; }
        .ing-list-item .info .name { font-weight: 500; font-size: 0.8rem; }
        .ing-list-item .info .famiglia { font-size: 0.6rem; color: #888; }
        .ing-list-item .cart-status { font-size: 0.7rem; color: #2d5a3d; }
        .ing-list-count { padding: 0.5rem; font-size: 0.7rem; color: #888; border-top: 1px solid #eee; text-align: center; }
        
        .ing-detail-panel { background: white; border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.1); overflow-y: auto; }
        .ing-detail-empty { display: flex; align-items: center; justify-content: center; height: 100%; color: #999; font-size: 0.9rem; }
        .ing-detail-header { 
            padding: 1rem; 
            border-bottom: 1px solid #eee; 
            display: flex; 
            justify-content: space-between; 
            align-items: flex-start;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .ing-detail-header .header-left { flex: 1; min-width: 200px; }
        .ing-detail-header .header-right { display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center; }
        .ing-detail-header h2 { font-size: 1.2rem; color: #1a472a; margin-bottom: 0.25rem; }
        .ing-detail-header .badges { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.5rem; }
        .famiglia-badge { display: inline-block; padding: 0.25rem 0.6rem; background: #e8f5e9; color: #2d5a3d; border-radius: 12px; font-size: 0.7rem; }
        .ing-detail-body { padding: 1rem; }
        .ing-detail-section { margin-bottom: 1.25rem; }
        .ing-detail-section:last-child { margin-bottom: 0; }
        .ing-detail-section h3 { font-size: 0.75rem; color: #888; text-transform: uppercase; margin-bottom: 0.5rem; padding-bottom: 0.25rem; border-bottom: 1px solid #eee; }
        .ing-props-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; }
        .ing-prop { background: #f8f9fa; padding: 0.5rem; border-radius: 5px; }
        .ing-prop .label { font-size: 0.6rem; color: #888; }
        .ing-prop .value { font-size: 0.8rem; font-weight: 500; }
        .ing-desc { font-size: 0.85rem; line-height: 1.5; color: #555; }
        .ing-tags { display: flex; flex-wrap: wrap; gap: 0.3rem; }
        .ing-actions { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .ing-process { list-style: none; padding: 0; margin: 0; }
        .ing-process li { padding: 0.3rem 0 0.3rem 1.2rem; position: relative; font-size: 0.8rem; color: #555; }
        .ing-process li::before { content: "> "; position: absolute; left: 0; color: #2d5a3d; }
        .ing-warnings { background: #fff8e1; border-radius: 6px; padding: 0.5rem; border-left: 3px solid #ff9800; }
        .ing-warnings h3 { color: #e65100; }
        .ing-warnings-list { list-style: none; padding: 0; margin: 0; }
        .ing-warnings-list li { padding: 0.25rem 0 0.25rem 1.2rem; position: relative; font-size: 0.8rem; color: #bf360c; }
        .ing-warnings-list li::before { content: "! "; position: absolute; left: 0; }
        .ing-bool-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.4rem; }
        .ing-bool-item { display: flex; align-items: center; gap: 0.4rem; font-size: 0.8rem; padding: 0.35rem 0.5rem; background: #f8f9fa; border-radius: 5px; }
        .ing-bool-item .check { color: #2e7d32; font-weight: bold; }
        .ing-bool-item .cross { color: #c62828; }
        .ing-bool-item .label { color: #555; }
        .ing-bool-item .note { font-size: 0.7rem; color: #888; margin-left: auto; }
        .ing-detail-section.durabilita { background: #f1f8e9; border-radius: 6px; padding: 0.75rem; border-left: 3px solid #7cb342; }
        .ing-detail-section.durabilita h3 { color: #558b2f; }
        .ing-detail-section.compatibilita { background: #e8eaf6; border-radius: 6px; padding: 0.75rem; border-left: 3px solid #5c6bc0; }
        .ing-detail-section.compatibilita h3 { color: #283593; }
        .ing-incompat-list { list-style: none; padding: 0; margin: 0; }
        .ing-incompat-list li { padding: 0.25rem 0 0.25rem 1.2rem; position: relative; font-size: 0.8rem; color: #37474f; }
        .ing-incompat-list li::before { content: "- "; position: absolute; left: 0; }
        .ing-alt-text { font-size: 0.8rem; color: #555; line-height: 1.4; }
        .ing-note-box { background: #fff8e1; padding: 0.5rem 0.75rem; border-radius: 5px; font-size: 0.8rem; color: #6d4c00; margin-top: 0.5rem; }

        /*                                                                                                                                                                                  
           TAB C - LABORATORIO
                                                                                                                                                                                          */
        .lab-layout { 
            display: grid; 
            grid-template-columns: 1fr 400px; 
            gap: 1rem; 
            height: calc(100vh - 140px); /* Altezza viewport meno header/tab */
            max-height: calc(100vh - 140px);
        }
        .result-panel { 
            background: white; 
            border-radius: 8px; 
            box-shadow: 0 1px 4px rgba(0,0,0,0.1); 
            order: 1; 
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .tavolo-panel { 
            background: white; 
            border-radius: 8px; 
            box-shadow: 0 1px 4px rgba(0,0,0,0.1); 
            order: 2; 
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .tavolo-header { 
            position: sticky;
            top: 0;
            z-index: 10;
            flex-shrink: 0;
            background: #2d5a3d; color: white; padding: 0.75rem 1rem; border-radius: 8px 8px 0 0; font-weight: 600; display: flex; justify-content: space-between; align-items: center; }
        .tavolo-header .count { background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; }
        .tavolo-body { 
            padding: 1rem; 
            overflow-y: auto;
            flex: 1;
        }
        .tavolo-ingredienti { min-height: 80px; background: #fafafa; border: 2px dashed #ccc; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; }
        .tavolo-ingredienti.has-items { border-style: solid; border-color: #2d5a3d; background: #f0f7f2; }
        .tavolo-hint { color: #999; font-size: 0.8rem; text-align: center; }
        .tavolo-chips { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .tavolo-chip { display: inline-flex; align-items: center; background: white; border: 1px solid #ddd; border-radius: 20px; padding: 0.35rem 0.7rem; font-size: 0.8rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .tavolo-chip .dot { margin-right: 0.4rem; }
        .tavolo-chip .remove { margin-left: 0.5rem; color: #999; cursor: pointer; font-size: 0.9rem; }
        .tavolo-chip .remove:hover { color: #c00; }
        
        .compat-section { margin-top: 1rem; }
        .compat-title { font-size: 0.7rem; text-transform: uppercase; color: #888; margin-bottom: 0.5rem; font-weight: 600; }
        .compat-row { display: flex; align-items: flex-start; padding: 0.6rem; border-radius: 6px; margin-bottom: 0.4rem; font-size: 0.8rem; }
        .compat-row.ok { background: #e8f5e9; }
        .compat-row.synergy { background: #e3f2fd; }
        .compat-row.warning { background: #fff3e0; }
        .compat-row.error { background: #ffebee; }
        .compat-row .status { font-weight: bold; margin-right: 0.6rem; min-width: 28px; font-size: 0.9rem; }
        .compat-row.ok .status { color: #4caf50; }
        .compat-row.synergy .status { color: #2196f3; }
        .compat-row.warning .status { color: #ff9800; }
        .compat-row.error .status { color: #f44336; }
        .compat-row .content .pair { font-weight: 500; }
        .compat-row .content .note { font-size: 0.7rem; color: #666; margin-top: 0.15rem; }
        .compat-empty { color: #999; font-size: 0.8rem; text-align: center; padding: 1rem; }
        
        .result-header { 
            background: #f8f9fa; 
            padding: 0.75rem 1rem; 
            border-radius: 8px 8px 0 0; 
            font-weight: 600; 
            font-size: 0.85rem; 
            border-bottom: 1px solid #eee; 
            flex-shrink: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .section-jump {
            font-size: 0.65rem;
            font-weight: 400;
            color: #7c9a8a;
            text-decoration: none;
            cursor: pointer;
            transition: color 0.2s;
        }
        .section-jump:hover {
            color: #2d5a3d;
            text-decoration: underline;
        }
        .result-body { 
            padding: 1rem; 
            overflow-y: auto;
            flex: 1;
        }
        .result-section { margin-bottom: 1rem; }
        .result-section:last-child { margin-bottom: 0; }
        .result-label { font-size: 0.65rem; text-transform: uppercase; color: #888; margin-bottom: 0.3rem; }
        .result-type { font-size: 1.1rem; font-weight: 600; color: #2d5a3d; }
        .result-base { font-size: 0.8rem; color: #666; margin-top: 0.2rem; }
        .bar-row { display: flex; align-items: center; margin-bottom: 0.5rem; }
        .bar-label { width: 100px; font-size: 0.75rem; color: #555; }
        .bar-track { flex: 1; height: 10px; background: #e8e8e8; border-radius: 5px; overflow: hidden; }
        .bar-fill { height: 100%; border-radius: 5px; transition: width 0.3s; }
        .bar-fill.high { background: linear-gradient(90deg, #4caf50, #8bc34a); }
        .bar-fill.medium { background: linear-gradient(90deg, #ff9800, #ffc107); }
        .bar-fill.low { background: linear-gradient(90deg, #f44336, #ff7043); }
        .result-tags { display: flex; flex-wrap: wrap; gap: 0.3rem; }
        
        .limits-section { background: #fff8e1; border: 1px solid #ffe082; border-radius: 6px; padding: 0.75rem; margin-top: 1rem; }
        .limits-title { font-size: 0.75rem; font-weight: 600; color: #f57c00; margin-bottom: 0.5rem; }
        .limit-item { margin-bottom: 0.5rem; }
        .limit-item:last-child { margin-bottom: 0; }
        .limit-problem { font-size: 0.8rem; color: #e65100; }
        .limit-solution { font-size: 0.75rem; color: #666; padding-left: 1rem; margin-top: 0.2rem; }
        .solution-btn { display: inline-block; padding: 0.2rem 0.5rem; background: #fff3e0; border: 1px solid #ffe082; border-radius: 4px; font-size: 0.7rem; cursor: pointer; color: #e65100; margin-left: 0.3rem; }
        .solution-btn:hover { background: #ffe082; }
        
        .suggestions-section { background: #e3f2fd; border: 1px solid #90caf9; border-radius: 6px; padding: 0.75rem; margin-top: 1rem; }
        .suggestions-title { font-size: 0.75rem; font-weight: 600; color: #1565c0; margin-bottom: 0.5rem; }
        .suggestion-item { font-size: 0.8rem; color: #1565c0; margin-bottom: 0.3rem; }

    
        .cat-proteina { background: #e91e63; }
        .cat-polisaccaride { background: #4caf50; }
        .cat-policatione { background: #2196f3; }
        .cat-plastificante { background: #ff9800; }
        .cat-sale { background: #9c27b0; }
        .cat-lipide { background: #795548; }
        .cat-colorante { background: #f44336; }
        .cat-carica { background: #607d8b; }
        .cat-coltura { background: #00bcd4; }
        .cat-emulsionante { background: #cddc39; }
        .cat-additivo { background: #607d8b; }
        .cat-default { background: #9e9e9e; }

        /* ==========================================
           TAB D - PROBLEMI E SOLUZIONI (v90)
           ========================================== */
        /* Hide main cart sidebar when Tab D active */
        body.tab-D-active .cart-sidebar { display: none; }
        body.tab-D-active .app-layout { grid-template-columns: 1fr; }
        body.tab-D-active .content-area { overflow: hidden; }

        /* Tab D active style — warm yellow accent */
        .tab.tab-d-style.active { border-bottom-color: #b8860b; color: #6b5a00; background: #fdf8e8; }

        /* Tab D layout — 2 columns, problems + diagnostic sidebar */
        .tabD-layout { display: grid; grid-template-columns: 1fr 260px; gap: 0; height: calc(100vh - 140px); max-height: calc(100vh - 140px); }
        .tabD-main { overflow-y: auto; overflow-x: hidden; min-width: 0; padding: 1rem; }
        .tabD-sidebar { background: white; border-left: 2px solid #e8d48b; display: flex; flex-direction: column; overflow: hidden; }
        .tabD-sidebar-header { background: linear-gradient(135deg, #f9f0d0 0%, #f0e2a8 100%); padding: 0.6rem 0.75rem; border-bottom: 1px solid #e0cf80; font-weight: 600; font-size: 0.75rem; color: #6b5a00; display: flex; flex-direction: column; gap: 0.15rem; }
        .tabD-sidebar-header .td-title-row { display: flex; justify-content: space-between; align-items: center; }
        .tabD-sidebar-header .td-count { background: #b8860b; color: white; padding: 2px 7px; border-radius: 10px; font-size: 0.65rem; }
        .tabD-sidebar-header .td-subtitle { font-size: 0.55rem; font-weight: 400; color: #9a8530; }
        .tabD-sidebar-body { flex: 1; padding: 0.5rem; overflow-y: auto; }
        .tabD-sidebar-footer { padding: 0.5rem; border-top: 1px solid #e0cf80; display: flex; flex-direction: column; gap: 0.35rem; }

        /* Ingredient selector */
        .tabD-ing-selector { padding: 0.5rem; border-bottom: 1px solid #eee; }
        .tabD-ing-selector select { width: 100%; padding: 0.35rem; font-size: 0.7rem; border: 1px solid #ddd; border-radius: 4px; }

        /* Sidebar tavolo items */
        .td-section { margin-bottom: 0.5rem; }
        .td-section-title { font-size: 0.6rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: #999; padding: 0.3rem 0.2rem 0.15rem; display: flex; align-items: center; gap: 0.3rem; }
        .td-section-title .sec-count { font-weight: 400; }
        .td-section-title.correttivi { color: #e65100; }

        .td-item { display: flex; align-items: center; padding: 0.3rem 0.4rem; border-radius: 5px; margin-bottom: 0.2rem; font-size: 0.7rem; border: 1px solid #eee; gap: 0.35rem; transition: all 0.15s; background: white; }
        .td-item:hover { border-color: #d4a017; }
        .td-item .dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
        .td-item .name { flex: 1; font-weight: 500; }
        .td-item .fam { font-size: 0.5rem; color: #888; }
        .td-item .remove { background: none; border: none; color: #ccc; cursor: pointer; font-size: 0.75rem; padding: 0 2px; }
        .td-item .remove:hover { color: #c00; }

        .td-check { width: 16px; height: 16px; border: 2px solid #bbb; border-radius: 3px; flex-shrink: 0; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.6rem; color: white; transition: all 0.15s; background: white; }
        .td-check:hover { border-color: #d4a017; }

        .td-item.active { background: #fdf8e8; border-color: #e8d48b; }
        .td-item.active .td-check { background: #b8860b; border-color: #b8860b; }
        .td-item.active .name { color: #5a4800; }
        .td-item.inactive { background: #fafafa; border-color: #eee; opacity: 0.55; }
        .td-item.inactive .name { color: #888; }
        .td-item.inactive:hover { opacity: 0.8; }
        .td-item.correttivo { background: #fff8f0; border-color: #ffcc80; }
        .td-item.correttivo .td-check { background: #e65100; border-color: #e65100; }
        .td-item.correttivo .name { color: #bf360c; }
        .td-fix-badge { font-size: 0.45rem; background: #e65100; color: white; padding: 1px 4px; border-radius: 6px; font-weight: 700; letter-spacing: 0.3px; flex-shrink: 0; }

        /* Inline confirm */
        .td-item.confirming { background: #fff3e0; border-color: #ffb74d; justify-content: center; gap: 0.5rem; animation: tdConfirmPulse 0.2s; }
        .td-item.confirming .td-confirm-msg { font-size: 0.65rem; color: #6b5a00; font-weight: 500; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .td-item.confirming .td-cfm-yes, .td-item.confirming .td-cfm-no { border: none; border-radius: 4px; font-size: 0.65rem; font-weight: 600; cursor: pointer; padding: 0.15rem 0.5rem; }
        .td-item.confirming .td-cfm-yes { background: #c62828; color: white; }
        .td-item.confirming .td-cfm-yes:hover:not(.disabled) { background: #b71c1c; }
        .td-item.confirming .td-cfm-yes.disabled { background: #e0e0e0; color: #bbb; cursor: not-allowed; pointer-events: none; }
        .td-item.confirming .td-cfm-no { background: #f5f5f5; color: #333; font-weight: 700; }
        .td-item.confirming .td-cfm-no:hover { background: #e0e0e0; }
        @keyframes tdConfirmPulse { from { transform: scale(1.02); } to { transform: scale(1); } }

        .td-clear-zone { display: flex; gap: 0; }
        .td-clear-zone .td-clear-btn { flex: 1; width: 100%; padding: 0.35rem; background: none; color: #999; border: 1px solid #ddd; border-radius: 5px; font-size: 0.65rem; cursor: pointer; }
        .td-clear-zone .td-clear-btn:hover { background: #fff0f0; color: #c62828; border-color: #e57373; }
        .td-clear-zone.confirming { gap: 0.4rem; align-items: center; background: #fff3e0; border: 1px solid #ffb74d; border-radius: 5px; padding: 0.3rem 0.5rem; animation: tdConfirmPulse 0.2s; }
        .td-clear-zone.confirming .td-clear-msg { flex: 1; font-size: 0.65rem; color: #6b5a00; font-weight: 500; }
        .td-clear-zone.confirming .td-cfm-yes, .td-clear-zone.confirming .td-cfm-no { border: none; border-radius: 4px; font-size: 0.65rem; font-weight: 600; cursor: pointer; padding: 0.2rem 0.5rem; }
        .td-clear-zone.confirming .td-cfm-yes { background: #c62828; color: white; }
        .td-clear-zone.confirming .td-cfm-yes.disabled { background: #e0e0e0; color: #bbb; cursor: not-allowed; pointer-events: none; }
        .td-clear-zone.confirming .td-cfm-no { background: #f5f5f5; color: #333; font-weight: 700; }

        /* Lab button in sidebar */
        .td-goto-lab { width: 100%; padding: 0.5rem; background: linear-gradient(135deg, #1a472a, #2d5a3d); color: white; border: none; border-radius: 6px; font-size: 0.72rem; font-weight: 600; cursor: pointer; transition: all 0.15s; }
        .td-goto-lab:hover { background: linear-gradient(135deg, #2d5a3d, #3e7a52); transform: translateY(-1px); box-shadow: 0 3px 10px rgba(0,0,0,0.2); }
        .td-goto-lab .lab-count { background: rgba(255,255,255,0.2); padding: 1px 6px; border-radius: 8px; font-size: 0.6rem; margin-left: 4px; }
        .td-empty { color: #999; font-size: 0.7rem; text-align: center; padding: 1rem; line-height: 1.5; }

        /* Context zone */
        .td-context { background: #fff8e1; border: 2px solid #ffcc02; border-radius: 10px; padding: 0.75rem; margin-bottom: 1rem; }
        .td-context.empty { background: #f5f5f5; border-color: #e0e0e0; }
        .td-context h3 { font-size: 0.8rem; color: #e65100; margin: 0 0 0.5rem 0; }
        .td-context.empty h3 { color: #999; }
        .td-context-chips { display: flex; flex-wrap: wrap; gap: 0.4rem; }
        .td-context-chip { display: inline-flex; align-items: center; gap: 0.3rem; padding: 0.3rem 0.6rem; background: white; border: 1px solid #ffcc02; border-radius: 16px; font-size: 0.7rem; cursor: pointer; transition: all 0.15s; }
        .td-context-chip:hover { background: #fff3e0; border-color: #e65100; transform: translateY(-1px); }
        .td-context-chip .grav { display: inline-flex; gap: 1px; align-items: flex-end; margin-left: 2px; }
        .td-context-chip .gbar { width: 4px; height: 10px; border-radius: 1px; background: #e0e0e0; }
        .td-context-chip .gbar.g1 { background: #43a047; }
        .td-context-chip .gbar.g2 { background: #c0ca33; }
        .td-context-chip .gbar.g3 { background: #ffb300; }
        .td-context-chip .gbar.g4 { background: #f4511e; }
        .td-context-chip .gbar.g5 { background: #c62828; }
        .td-context-lab-btn { display: inline-block; margin-top: 0.4rem; padding: 0.35rem 0.7rem; background: linear-gradient(135deg, #1a472a, #2d5a3d); color: white; border: none; border-radius: 6px; font-size: 0.7rem; font-weight: 600; cursor: pointer; }
        .td-context-lab-btn:hover { background: linear-gradient(135deg, #2d5a3d, #3e7a52); }

        /* Filter showcase */
        .td-filters { display: flex; flex-wrap: wrap; gap: 0.6rem; margin-bottom: 1.2rem; justify-content: center; }
        .td-filter-btn { display: flex; flex-direction: column; align-items: center; gap: 0; padding: 0; background: white; border: 2.5px solid transparent; border-radius: 14px; font-size: 0.65rem; cursor: pointer; transition: all 0.2s; color: #555; width: 110px; text-align: center; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
        .td-filter-btn:hover { border-color: #2d5a3d; transform: translateY(-3px); box-shadow: 0 6px 20px rgba(0,0,0,0.12); }
        .td-filter-btn.active { border-color: #2d5a3d; box-shadow: 0 4px 16px rgba(45,90,61,0.25); }
        .td-filter-btn .td-filter-img { width: 100%; aspect-ratio: 1; object-fit: cover; display: block; }
        .td-filter-btn .td-filter-footer { padding: 0.4rem 0.3rem; display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .td-filter-btn .td-filter-label { flex: 1; text-align: left; font-weight: 600; }
        .td-filter-btn .td-badge { background: #e0e0e0; color: #555; padding: 1px 5px; border-radius: 8px; font-size: 0.55rem; font-weight: 700; }
        .td-filter-btn.active .td-badge { background: #2d5a3d; color: white; }
        .td-filter-btn-all { width: 64px; justify-content: center; padding: 0.5rem 0; }
        .td-filter-btn-all .td-filter-all-icon { font-size: 1.5rem; color: #ccc; }
        .td-filter-btn-all.active .td-filter-all-icon { color: #2d5a3d; }

        /* Problem cards */
        .td-group-sep { padding: 0.5rem 0 0.2rem; display: flex; align-items: center; gap: 0.5rem; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.8px; color: #888; }
        .td-group-sep .gs-icon { width: 22px; height: 22px; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.5rem; font-weight: 800; }

        .td-problem-card { background: white; border-radius: 10px; margin-bottom: 0.6rem; box-shadow: 0 1px 4px rgba(0,0,0,0.06); border-left: 4px solid #ddd; overflow: hidden; transition: all 0.2s; max-width: 100%; }
        .td-problem-card:hover { box-shadow: 0 3px 12px rgba(0,0,0,0.1); }
        .td-problem-card.highlighted { border-left-color: #e65100; background: #fffaf5; }
        .td-problem-card.hidden { display: none; }

        .td-pc-header { display: flex; align-items: center; padding: 0.6rem 0.75rem; cursor: pointer; gap: 0.6rem; }
        .td-pc-icon { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 0.55rem; font-weight: 800; color: white; background: #999; flex-shrink: 0; }
        .td-pc-icon.g-ess { background: #e65100; }
        .td-pc-icon.g-mec { background: #c62828; }
        .td-pc-icon.g-bio { background: #2e7d32; }
        .td-pc-icon.g-pro { background: #1565c0; }
        .td-pc-icon.g-sta { background: #6a1b9a; }
        .td-pc-icon.g-col { background: #00695c; }
        .td-pc-icon.g-amb { background: #f57f17; }
        .td-pc-title-area { flex: 1; }
        .td-pc-title { font-weight: 600; font-size: 0.85rem; color: #333; }
        .td-pc-subtitle { font-size: 0.65rem; color: #888; }
        .td-pc-indicators { display: flex; gap: 0.8rem; }
        .td-pc-indicator { text-align: center; }
        .td-pc-indicator label { font-size: 0.5rem; color: #aaa; text-transform: uppercase; display: block; margin-top: 1px; }
        .td-pc-dots { display: flex; gap: 2px; }
        .td-pc-dot { width: 8px; height: 8px; border-radius: 50%; background: #e0e0e0; }
        .td-pc-dot.g1 { background: #43a047; }
        .td-pc-dot.g2 { background: #c0ca33; }
        .td-pc-dot.g3 { background: #ffb300; }
        .td-pc-dot.g4 { background: #f4511e; }
        .td-pc-dot.g5 { background: #c62828; }
        .td-pc-dot.active-green { background: #43a047; }
        .td-pc-chevron { color: #ccc; font-size: 0.7rem; transition: transform 0.2s; }
        .td-problem-card.open .td-pc-chevron { transform: rotate(90deg); color: #2d5a3d; }

        .td-pc-body { display: none; padding: 0.25rem 0.75rem 0.75rem 2.5rem; overflow-x: hidden; word-break: break-word; border-left: 3px solid #ddd; margin-left: 1.75rem; }
        .td-problem-card[data-gruppo="essiccazione"] .td-pc-body { border-left-color: #e65100; }
        .td-problem-card[data-gruppo="meccanica"] .td-pc-body { border-left-color: #c62828; }
        .td-problem-card[data-gruppo="biologici"] .td-pc-body { border-left-color: #2e7d32; }
        .td-problem-card[data-gruppo="processo"] .td-pc-body { border-left-color: #1565c0; }
        .td-problem-card[data-gruppo="stabilita"] .td-pc-body { border-left-color: #6a1b9a; }
        .td-problem-card[data-gruppo="colture"] .td-pc-body { border-left-color: #00695c; }
        .td-problem-card[data-gruppo="ambiente"] .td-pc-body { border-left-color: #f57f17; }
        .td-problem-card.open .td-pc-body { display: block; }
        .td-pc-section { margin-bottom: 0.6rem; overflow: hidden; }
        .td-pc-section-title { font-size: 0.6rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: #888; margin-bottom: 0.2rem; }
        .td-pc-text { font-size: 0.75rem; color: #444; line-height: 1.5; }

        .td-tag-row { display: flex; flex-wrap: wrap; gap: 0.3rem; margin-top: 0.3rem; }
        .td-tag { display: inline-block; padding: 0.2rem 0.5rem; border-radius: 12px; font-size: 0.6rem; font-weight: 600; }
        .td-tag.risk { background: #fff3e0; color: #e65100; border: 1px solid #ffcc80; }
        .td-tag.family { font-size: 0.55rem; }

        /* Solutions grid */
        .td-solutions-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.5rem; }
        .td-sol-card { background: #f8f9fa; border: 1px solid #eee; border-radius: 8px; padding: 0.5rem 0.6rem; cursor: pointer; transition: all 0.15s; }
        .td-sol-card:hover { border-color: #2d5a3d; background: #f0f7f2; }
        .td-sol-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem; }
        .td-sol-name { font-weight: 600; font-size: 0.75rem; color: #333; }
        .td-sol-difficulty { font-size: 0.55rem; padding: 1px 5px; border-radius: 8px; background: #e8f5e9; color: #2e7d32; font-weight: 600; }
        .td-sol-difficulty.medium { background: #fff3e0; color: #e65100; }
        .td-sol-difficulty.hard { background: #fce4ec; color: #c62828; }
        .td-sol-stars { font-size: 0.65rem; color: #ffb300; letter-spacing: 1px; }
        .td-sol-desc { font-size: 0.68rem; color: #666; line-height: 1.4; }
        .td-sol-pro-con { margin-top: 0.3rem; display: flex; flex-wrap: wrap; gap: 0.25rem; }
        .td-sol-add-btn { display: inline-flex; align-items: center; gap: 0.2rem; padding: 0.2rem 0.5rem; background: #e8f5e9; border: 1px solid #a5d6a7; border-radius: 12px; font-size: 0.6rem; color: #2e7d32; cursor: pointer; transition: all 0.15s; font-weight: 600; }
        .td-sol-add-btn:hover { background: #c8e6c9; }
        .td-sol-add-btn .plus { font-weight: 800; }
        .td-sol-add-btn.added { background: #f5f5f5; color: #888; border-color: #ddd; cursor: default; }

        /* Student quotes */
        .td-student-quote { background: #f5f5f5; border-left: 3px solid #90a4ae; padding: 0.4rem 0.6rem; margin-bottom: 0.3rem; border-radius: 0 6px 6px 0; font-size: 0.7rem; font-style: italic; color: #555; }
        .td-student-quote .source { font-style: normal; font-weight: 600; color: #37474f; font-size: 0.6rem; }
        .td-sci-note { background: #e3f2fd; border-radius: 6px; padding: 0.4rem 0.6rem; font-size: 0.68rem; color: #1565c0; line-height: 1.4; }

        /* Matrix/checklist */
        .td-matrix-table { width: 100%; border-collapse: collapse; font-size: 0.7rem; margin-top: 0.3rem; table-layout: fixed; word-break: break-word; }
        .td-matrix-table th { background: #f5f5f5; padding: 0.3rem 0.4rem; text-align: left; border-bottom: 2px solid #ddd; font-weight: 600; color: #555; font-size: 0.65rem; }
        .td-matrix-table td { padding: 0.3rem 0.4rem; border-bottom: 1px solid #eee; vertical-align: top; }
        .td-matrix-table tr:hover { background: #f8f9fa; }
        .td-checklist { list-style: none; padding: 0; }
        .td-checklist li { font-size: 0.72rem; padding: 0.2rem 0 0.2rem 1.4rem; position: relative; color: #444; }
        .td-checklist li::before { content: '[ ]'; position: absolute; left: 0; color: #999; font-size: 0.65rem; font-family: monospace; }

        /* Show more */
        .td-show-more-zone { text-align: center; padding: 0.75rem; }
        .td-show-more-btn { padding: 0.5rem 1.2rem; background: white; border: 1px solid #ddd; border-radius: 20px; font-size: 0.72rem; color: #555; cursor: pointer; transition: all 0.15s; }
        .td-show-more-btn:hover { background: #f0f7f2; border-color: #2d5a3d; color: #2d5a3d; }

        /* Solution modal */
        .td-sol-modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 999; display: none; align-items: center; justify-content: center; }
        .td-sol-modal-overlay.open { display: flex; }
        .td-sol-modal-content { background: white; border-radius: 12px; max-width: 520px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .td-sol-modal-header { padding: 0.75rem 1rem; background: #f8f9fa; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 0.5rem; border-radius: 12px 12px 0 0; }
        .td-sol-modal-header h3 { flex: 1; font-size: 0.9rem; margin: 0; }
        .td-sol-modal-badge { font-size: 0.6rem; padding: 2px 8px; border-radius: 10px; background: #e8f5e9; color: #2e7d32; font-weight: 600; }
        .td-sol-modal-badge.medium { background: #fff3e0; color: #e65100; }
        .td-sol-modal-badge.hard { background: #fce4ec; color: #c62828; }
        .td-sol-modal-close { background: none; border: none; font-size: 1.2rem; color: #999; cursor: pointer; padding: 0 4px; }
        .td-sol-modal-body { padding: 1rem; }
        .td-sol-modal-section { margin-bottom: 0.75rem; }
        .td-sol-modal-label { font-size: 0.6rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: #888; margin-bottom: 0.2rem; }
        .td-sol-modal-desc { font-size: 0.78rem; color: #444; line-height: 1.5; }
        .td-sol-modal-efficacy { display: flex; gap: 3px; }
        .td-sol-modal-star { width: 16px; height: 16px; border-radius: 50%; background: #e0e0e0; }
        .td-sol-modal-star.filled { background: #ffb300; }
        .td-sol-modal-procon { display: flex; flex-direction: column; gap: 0.3rem; }
        .td-sol-modal-pro { font-size: 0.72rem; color: #2e7d32; }
        .td-sol-modal-con { font-size: 0.72rem; color: #c62828; }
        .td-sol-modal-adds { display: flex; flex-wrap: wrap; gap: 0.3rem; }
        .td-sol-modal-link { display: block; padding: 0.4rem 0.6rem; background: #fff3e0; border-radius: 6px; font-size: 0.72rem; color: #e65100; cursor: pointer; margin-top: 0.2rem; }
        .td-sol-modal-link:hover { background: #ffe0b2; }

    
        
        .cart-nav { display: flex; gap: 0.3rem; padding: 0.4rem 0.6rem; border-bottom: 1px solid #eee; background: #fafafa; }
        .btn-sm { padding: 0.3rem 0.5rem; font-size: 0.65rem; flex: 1; }

        .btn-warning { background: #ff9800; color: white; }
        .btn-warning:hover { background: #f57c00; }
        .btn-secondary { background: #f5f5f5; color: #333; border: 1px solid #ddd; }
        .btn-outline { background: transparent; color: #999; border: 1px solid #ddd; }
        .btn-outline:hover { background: #ffebee; color: #c00; border-color: #c00; }
        .btn-secondary:hover { background: #e8e8e8; }

            /* FORMULA SECTION (dentro result-panel) */
        /* v91: SELETTORE TECNICA */
        .tecnica-section { margin: 0.75rem 0; padding: 10px 14px; background: linear-gradient(135deg, #f0f4ff, #e8eef8); border-radius: 10px; border: 1px solid #c5d5ea; }
        .tecnica-title { font-size: 0.8rem; font-weight: 600; color: #37474f; margin-bottom: 8px; display: flex; align-items: center; gap: 6px; }
        .tecnica-options { display: flex; flex-wrap: wrap; gap: 6px; }
        .tecnica-btn { padding: 6px 12px; border-radius: 20px; border: 1.5px solid #b0bec5; background: white; cursor: pointer; font-size: 0.75rem; color: #546e7a; transition: all 0.2s; display: flex; align-items: center; gap: 5px; }
        .tecnica-btn:hover { border-color: #1565c0; color: #1565c0; background: #e3f2fd; }
        .tecnica-btn.active { border-color: #1565c0; background: #1565c0; color: white; font-weight: 600; box-shadow: 0 2px 6px rgba(21,101,192,0.25); }
        .tecnica-hint { font-size: 0.7rem; color: #78909c; margin-top: 6px; font-style: italic; display: none; padding: 4px 8px; background: white; border-radius: 6px; border-left: 3px solid #1565c0; }
        .tecnica-hint.visible { display: block; }
        .tecnica-btn.disabled { opacity: 0.35; cursor: not-allowed; border-color: #cfd8dc; color: #90a4ae; background: #eceff1; pointer-events: none; }
        .tecnica-btn.disabled:hover { border-color: #cfd8dc; color: #90a4ae; background: #eceff1; }
        .tecnica-btn.disabled[title] { pointer-events: auto; }
        .coating-row { display: none; align-items: center; gap: 8px; margin-top: 8px; padding: 6px 12px; background: white; border-radius: 8px; border: 1px solid #d0d8dd; transition: all 0.3s; }
        .coating-row.visible { display: flex; }
        .coating-row label { font-size: 0.78rem; color: #455a64; cursor: pointer; display: flex; align-items: center; gap: 6px; flex: 1; }
        .coating-row input[type=checkbox] { accent-color: #1565c0; width: 15px; height: 15px; cursor: pointer; }
        .coating-hint { font-size: 0.68rem; color: #78909c; font-style: italic; }
        .coating-row.active { border-color: #1565c0; background: #e8f0fe; }
        @media (max-width: 600px) { .tecnica-options { gap: 4px; } .tecnica-btn { padding: 5px 9px; font-size: 0.7rem; } }

        .formula-section { margin-top: 1rem; border-top: 2px solid #2d5a3d; padding-top: 1rem; }
        .formula-section-title { font-weight: 600; color: #2d5a3d; margin-bottom: 0.75rem; font-size: 0.95rem; }
        
        /* ANNOTAZIONI */
        .annotations-section {
            margin-top: 1rem;
            padding-top: 0.75rem;
            border-top: 1px dashed #ddd;
        }
        .annotations-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: #f57c00;
            margin-bottom: 0.4rem;
        }
        .annotations-textarea {
            width: 100%;
            min-height: 80px;
            padding: 0.5rem;
            border: 2px solid #ffb74d;
            border-radius: 4px;
            font-size: 0.75rem;
            font-family: inherit;
            resize: vertical;
            background: #fff8e1;
            color: #e65100;
        }
        .annotations-textarea::placeholder {
            color: #ffb74d;
        }
        .annotations-textarea:focus {
            outline: none;
            border-color: #f57c00;
            background: #fff3e0;
        }
        
        /* FORMULE SALVATE */
        .saved-formulas-section {
            margin-top: 1rem;
            padding-top: 0.75rem;
            border-top: 1px dashed #ddd;
        }
        .saved-formulas-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .saved-formulas-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: #666;
        }
        .saved-formulas-count {
            background: #2d5a3d;
            color: white;
            font-size: 0.65rem;
            padding: 0.15rem 0.4rem;
            border-radius: 10px;
        }
        .saved-formulas-list {
            max-height: 200px;
            overflow-y: auto;
        }
        .saved-empty {
            color: #999;
            font-size: 0.72rem;
            font-style: italic;
            text-align: center;
            padding: 0.5rem;
        }
        .saved-formula-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.4rem 0.5rem;
            margin-bottom: 0.3rem;
            background: #f5f5f5;
            border-radius: 4px;
            font-size: 0.72rem;
        }
        .saved-formula-item:hover {
            background: #e8f5e9;
        }
        .saved-formula-info {
            flex: 1;
            cursor: pointer;
        }
        .note-indicator {
            color: #f57c00;
            font-weight: bold;
            font-size: 0.9rem;
        }
        .saved-formula-name {
            font-weight: 500;
            color: #333;
        }
        .saved-formula-date {
            font-size: 0.65rem;
            color: #888;
        }
        .saved-formula-actions {
            display: flex;
            gap: 0.3rem;
        }
        .saved-formula-actions button {
            padding: 0.2rem 0.4rem;
            font-size: 0.65rem;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .btn-load {
            background: #2d5a3d;
            color: white;
        }
        .btn-load:hover {
            background: #1e3d2a;
        }
        .btn-delete {
            background: #dc3545;
            color: white;
        }
        .btn-delete:hover {
            background: #b02a37;
        }
        .formula-empty { color: #999; font-size: 0.85rem; padding: 1rem; text-align: center; background: #fafafa; border-radius: 6px; }
        .formula-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .formula-table th { text-align: left; padding: 0.5rem; background: #f5f5f5; border-bottom: 2px solid #ddd; font-weight: 600; color: #555; }
        .formula-table td { padding: 0.5rem; border-bottom: 1px solid #eee; }
        .formula-table tr:last-child td { border-bottom: none; }
        .formula-table .ing-name { display: flex; align-items: center; gap: 0.4rem; }
        .formula-table .percent { text-align: right; font-weight: 600; color: #2d5a3d; }
        .formula-table .grams { text-align: right; color: #666; }
        .formula-table tfoot td { background: #f0f7f2; font-weight: 600; border-top: 2px solid #2d5a3d; }
        .formula-notes { margin-top: 0.75rem; padding: 0.75rem; background: #fff8e1; border-radius: 6px; font-size: 0.8rem; }
        .formula-notes-title { font-weight: 600; color: #f57c00; margin-bottom: 0.3rem; }
        .formula-actions { margin-top: 0.75rem; display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .formula-actions button { padding: 0.4rem 0.8rem; border-radius: 4px; font-size: 0.8rem; cursor: pointer; border: 1px solid #ddd; background: white; }
        .formula-actions button:hover { background: #f5f5f5; }
        .formula-actions .btn-save { background: #e8f5e9; border-color: #a5d6a7; color: #2d5a3d; }
        .formula-actions .btn-download { background: #e3f2fd; border-color: #90caf9; color: #1565c0; }
        
        /* v71: Dosaggi interattivi */
        .formula-table .dose-controls { display: flex; align-items: center; justify-content: flex-end; gap: 0.15rem; }
        .formula-table .dose-btn {
            width: 22px; height: 22px; border: 1px solid #ccc; border-radius: 4px;
            background: white; cursor: pointer; font-size: 0.85rem; font-weight: 700;
            color: #555; display: flex; align-items: center; justify-content: center;
            padding: 0; line-height: 1; transition: all 0.15s; flex-shrink: 0;
        }
        .formula-table .dose-btn:hover { background: #e8f5e9; border-color: #2d5a3d; color: #2d5a3d; }
        .formula-table .dose-btn:active { transform: scale(0.9); }
        .formula-table .dose-btn.at-limit { opacity: 0.25; cursor: default; pointer-events: none; }
        .formula-table .dose-val { min-width: 28px; text-align: right; font-weight: 600; color: #2d5a3d; font-size: 0.85rem; }
        .formula-table .dose-val.modified { color: #e65100; }
        .formula-table .dose-delta { font-size: 0.6rem; color: #e65100; margin-left: 1px; }
        .formula-table .grams.modified { color: #bf6000; }
        .formula-total-msg { margin-top: 0.5rem; padding: 0.4rem 0.6rem; border-radius: 6px; font-size: 0.75rem; line-height: 1.4; }
        .formula-total-msg.ok { background: #e8f5e9; color: #2e7d32; border-left: 3px solid #2e7d32; }
        .formula-total-msg.info { background: #e3f2fd; color: #1565c0; border-left: 3px solid #1565c0; }
        .formula-total-msg.warn { background: #fff3e0; color: #e65100; border-left: 3px solid #e65100; }
        .formula-reset-link { font-size: 0.7rem; color: #999; cursor: pointer; text-decoration: underline; margin-left: 0.5rem; }
        .formula-reset-link:hover { color: #e65100; }
        @keyframes barPulse { 0% { filter: brightness(1); } 50% { filter: brightness(1.4); } 100% { filter: brightness(1); } }
        .bar-fill.pulse { animation: barPulse 0.4s ease; }
        /* Checkbox stile tavolo */
        .tavolo-chip input[type="checkbox"] { margin-right: 0.3rem; cursor: pointer; }
        .tavolo-chip.selected { background: #e8f5e9; border-color: #66bb6a; }
        .tavolo-chip.deselected { opacity: 0.5; }
        .tavolo-select-hint { font-size: 0.75rem; color: #888; margin-top: 0.5rem; text-align: center; }

    
        /* DISCLAIMER */
        .disclaimer-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #f5f5f5;
            border-top: 1px solid #e0e0e0;
            padding: 0.4rem 1rem;
            font-size: 0.7rem;
            color: #757575;
            text-align: center;
            z-index: 1000;
        }
        .disclaimer-footer strong { color: #616161; font-weight: 600; }
        .disclaimer-inline {
            background: #f5f5f5;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 0.6rem;
            margin-top: 0.75rem;
            font-size: 0.72rem;
            color: #666;
            line-height: 1.4;
        }
        .disclaimer-inline strong { color: #555; }
        body { padding-bottom: 35px; } /* spazio per footer fisso */

        /* DESCRIZIONE MATERIALE IPOTIZZATO */
        .description-section {
            background: linear-gradient(135deg, #f8f6f0 0%, #f0ece0 100%);
            border-radius: 6px;
            padding: 0.75rem;
            margin-top: 0.5rem;
            border-left: 3px solid #8b7355;
        }
        .description-title {
            font-size: 0.95rem;
            font-weight: 600;
            color: #5a4a3a;
            margin-bottom: 0.4rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .description-disclaimer {
            font-size: 0.68rem;
            color: #888;
            font-style: italic;
            margin-bottom: 0.6rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px dashed #ddd;
        }
        .description-content {
            font-size: 0.78rem;
            line-height: 1.5;
            color: #444;
        }
        .description-empty {
            font-style: italic;
            color: #999;
            font-size: 0.72rem;
        }
        .description-content p {
            margin: 0.5rem 0;
        }
        .description-content .desc-title {
            font-weight: 600;
            color: #5a4a3a;
            margin-top: 0.75rem;
            margin-bottom: 0.25rem;
            font-size: 0.73rem;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .description-content .desc-title:first-child {
            margin-top: 0;
        }
        .description-content .desc-highlight {
            background: rgba(139, 115, 85, 0.15);
            padding: 0.15rem 0.35rem;
            border-radius: 3px;
            font-weight: 500;
        }
        .description-content .desc-warning {
            color: #b86800;
            font-weight: 500;
        }
        .description-content .desc-positive {
            color: #2a7a2a;
            font-weight: 500;
        }
        .description-content ul {
            margin: 0.3rem 0;
            padding-left: 1.2rem;
        }
        .description-content li {
            margin: 0.15rem 0;
        }
        
        /* === v70: Difficulty badge === */
        .desc-difficulty {
            margin-bottom: 0.75rem;
            padding: 0.45rem 0.6rem;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 3px solid #ddd;
            font-size: 0.78rem;
            line-height: 1.4;
        }
        .desc-diff-detail {
            font-size: 0.66rem;
            color: #888;
            font-weight: 400;
        }
        
        /* === v70: Materiali simili === */
        .desc-matches {
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
            margin: 0.4rem 0;
        }
        .desc-match-card {
            padding: 0.45rem 0.6rem;
            background: #f0f7f2;
            border-radius: 6px;
            border-left: 3px solid #7c9a8a;
            font-size: 0.72rem;
        }
        .desc-match-header {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.3rem;
            margin-bottom: 0.15rem;
        }
        .desc-match-badge {
            display: inline-block;
            padding: 0.08rem 0.4rem;
            border-radius: 10px;
            color: white;
            font-size: 0.58rem;
            font-weight: 600;
        }
        .desc-match-src {
            font-size: 0.58rem;
            color: #999;
            font-style: italic;
        }
        .desc-match-detail {
            color: #555;
            margin: 0.1rem 0;
        }
        .desc-match-tests {
            color: #666;
            font-size: 0.66rem;
        }
        .desc-match-warn {
            color: #b86800;
            font-size: 0.66rem;
            margin-top: 0.1rem;
        }
        .desc-match-more {
            font-size: 0.66rem;
            color: #999;
            font-style: italic;
            margin-top: 0.2rem;
        }
        
        /* === v70: Dosaggi === */
        .desc-dosaggi {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.72rem;
            margin: 0.4rem 0;
        }
        .desc-dosaggi th {
            background: #f0ebe3;
            padding: 0.3rem 0.5rem;
            text-align: left;
            font-weight: 600;
            color: #5a4a3a;
            font-size: 0.63rem;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .desc-dosaggi td {
            padding: 0.25rem 0.5rem;
            border-bottom: 1px solid #f0ebe3;
            color: #444;
        }
        .desc-dosaggi small {
            color: #999;
        }
        .desc-dosaggi-note {
            font-size: 0.63rem;
            color: #999;
            font-style: italic;
            margin-top: 0.15rem;
        }
        
        /* === v70: Trade-offs === */
        .desc-tradeoffs {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
            margin: 0.4rem 0;
        }
        .desc-tradeoff {
            padding: 0.4rem 0.6rem;
            background: #faf6f0;
            border-radius: 5px;
            border-left: 3px solid #d4a853;
            font-size: 0.72rem;
            color: #555;
            line-height: 1.45;
        }
        .desc-tradeoff-q {
            font-weight: 600;
            color: #8b6914;
        }

        /* v80: Welcome onboarding – restyling luminoso */
        .welcome-overlay {
            position: fixed; inset: 0; z-index: 10000;
            background: rgba(255, 253, 248, 0.75);
            backdrop-filter: blur(12px) saturate(1.2);
            -webkit-backdrop-filter: blur(12px) saturate(1.2);
            display: flex; align-items: center; justify-content: center;
            opacity: 0; animation: welcomeFadeIn 0.5s ease forwards;
            padding: 1rem;
        }
        .welcome-overlay.hidden { display: none; }
        @keyframes welcomeFadeIn { to { opacity: 1; } }
        
        .welcome-modal {
            background: white;
            border-radius: 24px;
            max-width: 540px; width: 100%;
            padding: 2rem 2rem 1.6rem;
            box-shadow: 0 8px 40px rgba(45, 90, 61, 0.10), 0 1px 3px rgba(0,0,0,0.06);
            animation: welcomeSlideUp 0.45s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
            transform: translateY(20px);
            display: flex; flex-direction: column;
            max-height: calc(100vh - 2rem);
            overflow-y: auto;
        }
        @keyframes welcomeSlideUp { to { transform: translateY(0); } }
        
        .welcome-header {
            text-align: center; margin-bottom: 1.2rem;
        }
        .welcome-header-logo {
            width: 52px; height: 52px; border-radius: 50%;
            object-fit: cover; margin-bottom: 0.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .welcome-header h2 {
            font-size: 1.2rem; color: #2d5a3d; margin: 0 0 0.25rem;
            font-weight: 700; letter-spacing: -0.02em;
        }
        .welcome-header p {
            font-size: 0.72rem; color: #999; margin: 0;
            line-height: 1.4;
        }
        
        .welcome-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;
        }
        .welcome-card {
            border-radius: 16px; overflow: hidden;
            background: #fafaf7;
            border: 1.5px solid #eee;
            cursor: pointer;
            transition: all 0.25s ease;
        }
        .welcome-card:hover {
            border-color: #4a9d6d;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(74, 157, 109, 0.12);
            background: white;
        }
        .welcome-card:active {
            transform: translateY(0);
        }
        .welcome-card-img {
            width: 100%; aspect-ratio: 16/10;
            object-fit: cover; display: block;
            background: linear-gradient(135deg, #f0f7f0, #faf5ee);
        }
        .welcome-card-body {
            padding: 0.55rem 0.7rem 0.65rem;
        }
        .welcome-card-title {
            font-size: 0.8rem; font-weight: 700;
            color: #2d5a3d; margin-bottom: 0.1rem;
        }
        .welcome-card-desc {
            font-size: 0.62rem; color: #999;
            line-height: 1.35; margin: 0;
        }
        .welcome-guide-link {
            text-align: center; margin-top: 1.1rem;
            font-size: 0.78rem;
        }
        .welcome-guide-link a {
            color: #4a9d6d; cursor: pointer; text-decoration: none;
            border-bottom: 1.5px solid #a3d4b7;
            padding-bottom: 1px;
            font-weight: 600;
            transition: color 0.2s, border-color 0.2s;
        }
        .welcome-guide-link a:hover { color: #2d5a3d; border-bottom-color: #2d5a3d; }
        .welcome-guide {
            display: none; overflow-y: auto;
            max-height: calc(100vh - 10rem);
            padding: 0.2rem 0.3rem;
            font-size: 0.72rem; color: #444; line-height: 1.55;
        }
        .welcome-guide.visible { display: block; }
        .welcome-guide-back {
            font-size: 0.65rem; color: #6b9e7d; cursor: pointer;
            margin-bottom: 0.8rem; display: inline-block;
        }
        .welcome-guide-back:hover { color: #2d5a3d; }
        .welcome-guide-intro {
            font-style: italic; color: #666; margin-bottom: 0.9rem;
            font-size: 0.7rem; line-height: 1.5;
        }
        .welcome-guide h3 {
            font-size: 0.78rem; color: #2d5a3d; font-weight: 700;
            margin: 1rem 0 0.35rem; letter-spacing: 0.01em;
        }
        .welcome-guide h3:first-of-type { margin-top: 0.2rem; }
        .welcome-guide p { margin: 0 0 0.5rem; }
        .welcome-guide .guide-tab {
            margin-bottom: 0.45rem; padding-left: 0;
        }
        .welcome-guide .guide-tab strong { color: #2d5a3d; }
        .welcome-guide .guide-section {
            margin-top: 0.9rem; padding-top: 0.6rem;
            border-top: 1px solid #eee;
        }
        .welcome-guide .guide-footer {
            margin-top: 1rem; padding-top: 0.6rem;
            border-top: 1px solid #eee;
            font-size: 0.62rem; color: #aaa; text-align: center;
        }
        .welcome-guide .guide-footer a { color: #6b9e7d; }
        
        @media (max-width: 420px) {
            .welcome-modal { padding: 1.2rem 1rem 1rem; border-radius: 20px; }
            .welcome-grid { gap: 0.5rem; }
            .welcome-card-body { padding: 0.4rem 0.5rem 0.5rem; }
            .welcome-header h2 { font-size: 1.05rem; }
            .welcome-card-img { aspect-ratio: 3/2; }
        }
        @media (max-height: 650px) {
            .welcome-modal { padding: 1rem; }
            .welcome-header { margin-bottom: 0.7rem; }
            .welcome-card-img { aspect-ratio: 2/1; }
            .welcome-card-body { padding: 0.35rem 0.5rem 0.45rem; }
            .welcome-grid { gap: 0.4rem; }
        }
    
        /* v89: Nota didattica famiglie */
        .famiglia-nota-didattica {
            margin-top: 1rem;
            padding: 0.8rem;
            background: linear-gradient(135deg, #e8f5e9 0%, #f1f8e9 100%);
            border-left: 3px solid #66bb6a;
            border-radius: 0 6px 6px 0;
            font-size: 0.78rem;
        }
        .famiglia-nota-title {
            font-weight: 600;
            color: #2e7d32;
            margin-bottom: 0.4rem;
        }
        .famiglia-nota-didattica p {
            margin: 0;
            color: #33691e;
            line-height: 1.5;
        }

        /* v89: Sezione Modalità d'uso - GIALLO */
        .modalita-uso-section {
            margin-top: 1.2rem;
            padding: 1rem;
            background: linear-gradient(135deg, #fffde7 0%, #fff9c4 100%);
            border-radius: 8px;
            border-left: 4px solid #fbc02d;
        }
        .modalita-uso-title {
            font-weight: 600;
            font-size: 0.95rem;
            color: #f57f17;
            margin-bottom: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .modalita-fase {
            background: white;
            border-radius: 6px;
            padding: 0.7rem;
            margin-bottom: 0.6rem;
            border: 1px solid #fff59d;
        }
        .fase-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.4rem;
        }
        .fase-icona {
            font-size: 0.9rem;
            font-weight: 700;
            color: #f9a825;
        }
        .fase-nome {
            font-weight: 600;
            color: #e65100;
            font-size: 0.85rem;
        }
        .fase-azioni {
            margin: 0.3rem 0 0.3rem 1.8rem;
            padding: 0;
            font-size: 0.78rem;
            color: #5d4037;
        }
        .fase-azioni li {
            margin-bottom: 0.2rem;
        }
        .fase-nota {
            font-size: 0.72rem;
            color: #827717;
            font-style: italic;
            margin-top: 0.3rem;
            padding-left: 0.3rem;
        }
        .modalita-avviso {
            margin-top: 0.8rem;
            padding: 0.6rem;
            background: #fff3e0;
            border-radius: 4px;
            font-size: 0.78rem;
            color: #e65100;
            font-weight: 500;
            border-left: 3px solid #ff9800;
        }
        /* ============================================
           MOBILE RESPONSIVE — v92 mobile patch
           Solo sotto 768px, desktop invariato
           ============================================ */
        
        /* FAB button — nascosto su desktop */
        .cart-fab {
            display: none;
            position: fixed;
            bottom: 48px;
            right: 16px;
            z-index: 900;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: #1a472a;
            border: none;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.25);
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }
        .cart-fab:active { transform: scale(0.93); }
        .cart-fab svg { width: 22px; height: 22px; fill: none; stroke: white; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
        .cart-fab .fab-badge {
            position: absolute; top: -4px; right: -4px;
            background: #e65100; color: white; font-size: 0.6rem; font-weight: 700;
            min-width: 18px; height: 18px; border-radius: 9px;
            display: flex; align-items: center; justify-content: center; padding: 0 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        .cart-fab .fab-badge:empty { display: none; }
        
        /* Tab D FAB variant */
        .cart-fab.fab-tabD { background: #b8860b; }
        
        /* Chiudi sidebar mobile */
        .mobile-sidebar-close {
            display: none;
            position: absolute; top: 8px; right: 8px;
            width: 28px; height: 28px; border-radius: 50%;
            background: #f0f0f0; border: 1px solid #ddd;
            font-size: 1rem; cursor: pointer; z-index: 5;
            align-items: center; justify-content: center; color: #666;
        }
        
        @media (max-width: 768px) {
            /* Layout principale: colonna singola */
            .app-layout { grid-template-columns: 1fr !important; }
            
            /* Header compatto */
            header { padding: 0.4rem 0.8rem; gap: 0.5rem; }
            header h1 { font-size: 0.85rem; }
            
            /* Tab: scroll orizzontale se troppe */
            .tabs { overflow-x: auto; -webkit-overflow-scrolling: touch; }
            .tabs .tab { white-space: nowrap; font-size: 0.7rem; padding: 0.5rem 0.6rem; }
            
            /* Cart sidebar: nascosta, overlay quando aperta */
            .cart-sidebar {
                display: none !important;
                position: fixed; top: 0; right: 0; bottom: 0;
                width: 280px; max-width: 80vw;
                z-index: 950; box-shadow: -4px 0 16px rgba(0,0,0,0.2);
            }
            .cart-sidebar.mobile-open {
                display: flex !important;
            }
            
            /* Tab D sidebar: stessa logica */
            .tabD-layout { grid-template-columns: 1fr !important; }
            .tabD-sidebar {
                display: none !important;
                position: fixed; top: 0; right: 0; bottom: 0;
                width: 280px; max-width: 80vw;
                z-index: 950; box-shadow: -4px 0 16px rgba(0,0,0,0.2);
            }
            .tabD-sidebar.mobile-open {
                display: flex !important;
            }
            
            /* Mostra FAB */
            .cart-fab { display: flex; }
            
            /* Mostra bottone chiudi dentro sidebar */
            .mobile-sidebar-close { display: flex; }
            .cart-header, .tabD-sidebar-header { position: relative; }
            
            /* Overlay scuro dietro sidebar aperta */
            .mobile-overlay {
                display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.4); z-index: 940;
            }
            .mobile-overlay.show { display: block; }
            
            /* Lab: da 2 colonne a stack verticale */
            .lab-layout { 
                grid-template-columns: 1fr !important; 
                height: auto !important;
                max-height: none !important;
            }
            .tavolo-panel { order: 1; max-height: 40vh; }
            .result-panel { order: 2; }
            
            /* Catalogo: card più compatte */
            .catalogo-grid { grid-template-columns: 1fr !important; }
            
            /* Formula table: compatta */
            .formula-table { font-size: 0.7rem; }
            .dose-btn { width: 24px; height: 24px; }
            
            /* Results section: singola colonna */
            .results-section { grid-template-columns: 1fr !important; }
            
            /* Welcome: 2 colonne su tablet, 1 su phone */
            .welcome-grid { grid-template-columns: repeat(2, 1fr); }
            
            /* Proprietà predette: compatte */
            .mat-bar-label { font-size: 0.65rem; }
            
            /* Disclaimer footer */
            .disclaimer-footer { font-size: 0.55rem; padding: 0.4rem; }
        }
        
        @media (max-width: 480px) {
            /* Phone piccoli */
            header h1 { font-size: 0.75rem; }
            .tabs .tab { font-size: 0.65rem; padding: 0.45rem 0.5rem; }
            .welcome-grid { grid-template-columns: 1fr; }
            .cart-sidebar, .tabD-sidebar { width: 260px; }
        }
        
</style>

    <!-- Database esterno -->
    <script src="data/database_biomateriali_v10_5.js"></script>
</head>
<body class="tab-P-active">
    <!-- v77: Welcome onboarding modal -->
    <div class="welcome-overlay hidden" id="welcomeOverlay">
        <div class="welcome-modal">
            <div class="welcome-header">
                <img class="welcome-header-logo" src="data/files/logo_albertina.png" alt="Logo Albertina" 
                     onerror="this.style.display='none'">
                <h2>Configuratore Biomateriali</h2>
                <p>Accademia Albertina di Belle Arti di Torino<br>
                Scuola PAI · Tipologia dei Nuovi Materiali<br>
                <span style="font-size:0.65rem;">Prof. Paolo Maccarrone</span></p>
            </div>
            <div class="welcome-grid">
                <div class="welcome-card" onclick="welcomeGoTo('P')">
                    <img class="welcome-card-img" src="data/files/onboarding_progetto.jpg" 
                         alt="Progetto" onerror="this.style.background='linear-gradient(135deg,#e8f5e9,#fff8e1)';this.style.minHeight='80px'">
                    <div class="welcome-card-body">
                        <div class="welcome-card-title">Progetto</div>
                        <p class="welcome-card-desc">Scegli le proprietà  desiderate, il sistema suggerisce ingredienti e percorsi</p>
                    </div>
                </div>
                <div class="welcome-card" onclick="welcomeGoTo('A')">
                    <img class="welcome-card-img" src="data/files/onboarding_catalogo 2.jpg" 
                         alt="Catalogo" onerror="this.style.background='linear-gradient(135deg,#e3f2fd,#f3e5f5)';this.style.minHeight='80px'">
                    <div class="welcome-card-body">
                        <div class="welcome-card-title">Catalogo</div>
                        <p class="welcome-card-desc">Esplora biomateriali esistenti organizzati per tipo di output</p>
                    </div>
                </div>
                <div class="welcome-card" onclick="welcomeGoTo('B')">
                    <img class="welcome-card-img" src="data/files/onboarding_ingredienti.jpg" 
                         alt="Ingredienti" onerror="this.style.background='linear-gradient(135deg,#fff8e1,#fff3e0)';this.style.minHeight='80px'">
                    <div class="welcome-card-body">
                        <div class="welcome-card-title">Ingredienti</div>
                        <p class="welcome-card-desc">Scopri 63 ingredienti con proprietà , compatibilità  e fonti</p>
                    </div>
                </div>
                <div class="welcome-card" onclick="welcomeGoTo('C')">
                    <img class="welcome-card-img" src="data/files/onboarding_laboratorio.jpg" 
                         alt="Laboratorio" onerror="this.style.background='linear-gradient(135deg,#e8eaf6,#e0f7fa)';this.style.minHeight='80px'">
                    <div class="welcome-card-body">
                        <div class="welcome-card-title">Laboratorio</div>
                        <p class="welcome-card-desc">Componi ricette, verifica compatibilità , esporta schede tecniche</p>
                    </div>
                </div>
                <div class="welcome-card" onclick="welcomeGoTo('D')">
                    <img class="welcome-card-img" src="data/files/Processo.jpg" 
                         alt="Problemi" onerror="this.style.background='linear-gradient(135deg,#fff3e0,#fff8e1)';this.style.minHeight='80px'">
                    <div class="welcome-card-body">
                        <div class="welcome-card-title">Problemi</div>
                        <p class="welcome-card-desc">Diagnostica problemi, trova soluzioni, aggiungi correttivi alla ricetta</p>
                    </div>
                </div>
            </div>
            <div class="welcome-guide-link" id="welcomeGuideLink">
                <a onclick="toggleWelcomeGuide(true)">Leggi come funziona →</a>
            </div>
            <div class="welcome-guide" id="welcomeGuide">
                <span class="welcome-guide-back" onclick="toggleWelcomeGuide(false)">← Torna</span>
                <div class="welcome-guide-intro">
                    Gli strumenti degli uomini non derivano soltanto dalle necessità  ma anche dalla curiosità . Si verifica sempre più pressante la necessità  di sostituire quanti più materiali sintetici possibile dall'uso quotidiano e i nuovi biomateriali sono una delle prospettive più promettenti.<br><br>
                    Questo Configuratore Didattico Sperimentale nasce dal desiderio di comprendere il mondo dei materiali biologici così complesso, articolato e variegato. Nessuna intenzione di sostituire competenze biochimiche e studi specifici: si tratta di un cacciavite didattico che potrebbe aiutare a comprendere la differenza tra una carica e una matrice, tra un plastificante e una proteina. Consente, nel laboratorio virtuale, di effettuare esperimenti ripetibili semplici e – perché no – originali.
                </div>
                <h3>L'idea in breve</h3>
                <p>Non si parte dalla ricetta ma da quello che serve: un film flessibile? Un coating impermeabile? Il sistema suggerisce ingredienti e percorsi possibili. Si può verificare, adattare, sperimentare in teoria ed eventualmente anche in pratica, come per le ricette della cucina.</p>
                <p>C'è un carrello della spesa che mantiene gli ingredienti scelti e permette di trasferirli e attivarli sul tavolo del Laboratorio. Si possono salvare le ricette, esportarle, così come esportare schede ingredienti singolarmente o in gruppi funzionali.</p>

                <h3>Le quattro aree</h3>
                <p class="guide-tab"><strong>Catalogo</strong> – Materiali che esistono già : documentati dalla letteratura o testati nel lab Albertina. Clicca per vedere ingredienti, proprietà , limiti. Usa il bottone + per caricare gli ingredienti nel carrello.</p>
                <p class="guide-tab"><strong>Ingredienti</strong> – La dispensa. 63 ingredienti organizzati per famiglia chimica. Ogni scheda dice cosa fa, come si usa, con cosa è compatibile. Filtra per famiglia per orientarti.</p>
                <p class="guide-tab">⚗️ <strong>Laboratorio</strong> – Il banco di lavoro. Metti gli ingredienti sul tavolo, regola i dosaggi, verifica la compatibilità . Il sistema avvisa se qualcosa non funziona insieme e dice perché.</p>
                <p class="guide-tab"><strong>Progetto</strong> – Il percorso inverso. Scegli le proprietà  che vuoi ottenere e il sistema propone 2-3 strade possibili con ingredienti e motivazioni. È il punto di partenza consigliato.</p>

                <div class="guide-section">
                    <h3>Di cosa fidarsi, di cosa no</h3>
                    <p>I dati sugli ingredienti singoli (temperature, pH, compatibilità ) provengono da letteratura scientifica e sono affidabili. Le previsioni sul materiale risultante (cosa succede mescolando X con Y) sono stime ragionate, non certezze – i biomateriali sono imprevedibili e la sperimentazione resta indispensabile.</p>
                    <p>I materiali "in progress" sono test reali fatti in laboratorio: i risultati sono quelli osservati, non calcolati.</p>
                </div>

                <div class="guide-section">
                    <h3>Note pratiche</h3>
                    <p>Il sistema ragiona per famiglie chimiche: le proteine si comportano in un modo, i polisaccaridi in un altro. Non serve sapere la chimica, ma capire che "gelatina e caseina fanno parte della stessa famiglia ma si comportano diversamente" aiuta a fare scelte migliori.</p>
                    <p>Quando il sistema segnala un'incompatibilità , è bene leggere il perché. Spesso non è un divieto ma un avviso: "funziona, ma devi fare attenzione a"¦"</p>
                </div>

                <div class="guide-footer">
                    Lo strumento è in crescita. Ogni miglioramento e arricchimento di dati è gradito.<br>
                    <a href="/cdn-cgi/l/email-protection#0575646a696a2b686466666477776a6b60456469676077716c6b642b6466646160687c"><span class="__cf_email__" data-cfemail="1565747a797a3b787476767467677a7b70557479777067617c7b743b7476747170786c">[email&#160;protected]</span></a>
                </div>
            </div>
        </div>
    </div>
    <header>
        <div class="header-logo" onclick="showWelcome(true)" style="cursor:pointer;" title="Informazioni e navigazione"><img src="data/files/logo_albertina.png" alt="Logo" onerror="this.style.display='none'"></div>
        <div class="header-info">
            <h1>Configuratore Didattico Biomateriali</h1>
            <div class="credits">Accademia Albertina di Belle Arti · Tipologia dei Nuovi Materiali · Prof. Paolo Maccarrone</div>
        </div>
        <button class="btn-info" onclick="openCreditsModal()" title="Info, Credits e Fonti">i</button>
    </header>

    <div class="app-layout">
        <div class="main-area">
            <div class="tabs-container">
                <div class="tabs">
                    <div class="tab active" onclick="switchTab('P')">
                        Progetto
                        <span class="tab-subtitle">Da esigenze a ingredienti</span>
                    </div>
                    <div class="tab" onclick="switchTab('A')">
                        Catalogo
                        <span class="tab-subtitle">Materiali esistenti</span>
                    </div>
                    <div class="tab" onclick="switchTab('B')">
                        Ingredienti
                        <span class="tab-subtitle">Database completo</span>
                    </div>
                    <div class="tab" onclick="switchTab('C')">
                        Laboratorio
                        <span class="tab-subtitle">Test combinazioni</span>
                    </div>
                    <div class="tab tab-d-style" onclick="switchTab('D')">
                        Problemi
                        <span class="tab-subtitle">Troubleshooting</span>
                    </div>
                </div>
            </div>

            <div class="content-area">
                <!-- TAB A: MATERIALI -->
                <div id="panel-A" class="panel-container">
                    <div class="output-selector" id="outputSelector">
                        <div class="output-btn" data-output="film" onclick="toggleOutput('film')">
                            <div class="output-photo"><img src="data/files/film.jpg" onerror="this.parentElement.innerHTML='Film'"></div>
                            <div class="output-name">Film</div>
                            <div class="output-count"><span class="doc">-</span>+<span class="prog">-</span></div>
                        </div>
                        <div class="output-btn" data-output="gel" onclick="toggleOutput('gel')">
                            <div class="output-photo"><img src="data/files/gel.jpg" onerror="this.parentElement.innerHTML='Gel'"></div>
                            <div class="output-name">Gel</div>
                            <div class="output-count"><span class="doc">-</span>+<span class="prog">-</span></div>
                        </div>
                        <div class="output-btn" data-output="rigido" onclick="toggleOutput('rigido')">
                            <div class="output-photo"><img src="data/files/massa.jpg" onerror="this.parentElement.innerHTML='Massa'"></div>
                            <div class="output-name">Massa</div>
                            <div class="output-count"><span class="doc">-</span>+<span class="prog">-</span></div>
                        </div>
                        <div class="output-btn" data-output="coating" onclick="toggleOutput('coating')">
                            <div class="output-photo"><img src="data/files/coating.jpg" onerror="this.parentElement.innerHTML='Coating'"></div>
                            <div class="output-name">Coating</div>
                            <div class="output-count"><span class="doc">-</span>+<span class="prog">-</span></div>
                        </div>
                        <div class="output-btn" data-output="schiuma" onclick="toggleOutput('schiuma')">
                            <div class="output-photo"><img src="data/files/schiuma 2.jpg" onerror="this.parentElement.innerHTML='Schiuma'"></div>
                            <div class="output-name">Schiuma</div>
                            <div class="output-count"><span class="doc">-</span>+<span class="prog">-</span></div>
                        </div>
                        <div class="output-btn" data-output="pelle" onclick="toggleOutput('pelle')">
                            <div class="output-photo"><img src="data/files/pelle.jpg" onerror="this.parentElement.innerHTML='Pelle'"></div>
                            <div class="output-name">Pelle</div>
                            <div class="output-count"><span class="doc">-</span>+<span class="prog">-</span></div>
                        </div>
                        <div class="output-btn" data-output="composito" onclick="toggleOutput('composito')">
                            <div class="output-photo"><img src="data/files/composito.jpg" onerror="this.parentElement.innerHTML='Composito'"></div>
                            <div class="output-name">Composito</div>
                            <div class="output-count"><span class="doc">-</span>+<span class="prog">-</span></div>
                        </div>
                    </div>

                    <div class="materiali-scroll-area">
                    <div class="output-info hidden" id="outputInfo">
                        <h3 id="outputTitle">-</h3>
                        <p class="desc" id="outputDesc">-</p>
                        <div class="output-info-matrici">
                            <span class="label">Matrici tipiche: </span>
                            <span class="matrici-list" id="outputMatrici">-</span>
                        </div>
                        <div class="output-info-warning" id="outputWarning"></div>
                    </div>

                    <div class="materiali-section">
                        <div class="section-header doc-header">
                            <span class="section-title">Documentati</span>
                            <span class="section-count" id="docCount">-</span>
                        </div>
                        <div class="materiali-list doc-list" id="materialiDocumentati">
                            <div style="padding:1rem;color:#888;font-size:0.75rem;">Caricamento...</div>
                        </div>
                    </div>

                    <div class="materiali-section">
                        <div class="section-header prog-header">
                            <span class="section-title">In Progress (Lab Albertina)</span>
                            <span class="section-count" id="progCount">-</span>
                        </div>
                        <div class="materiali-list" id="materialiInProgress">
                            <div style="padding:1rem;color:#888;font-size:0.75rem;">Caricamento...</div>
                        </div>
                    </div>

                    <div class="trl-legenda">
                        <span class="trl-item"><span class="trl-dot trl-verde"></span> Validato</span>
                        <span class="trl-item"><span class="trl-dot trl-bianco"></span> Funziona</span>
                        <span class="trl-item"><span class="trl-dot trl-rosa"></span> Problemi</span>
                        <span class="trl-item"><span class="trl-dot trl-doc"></span> Replicabile</span>
                        <span class="trl-item"><span class="trl-dot trl-ind"></span> Industriale</span>
                    </div>
                    </div>
                </div>

                <!-- TAB P: PROGETTO - PERCORSO INVERSO -->
                <div id="panel-P" class="panel-container active">
                    <div class="project-container">
                        <div class="project-hero compact">
                            <h2>Esigenze / Requisiti</h2>
                            <p>da proprietà  a ingredienti</p>
                        </div>
                        
                        <div class="project-scroll-area">
                        <div class="filters-section">
                            <h3>Proprieta desiderate</h3>
                            <div class="filters-grid" id="projectFilters">
                                <div class="filter-chip" data-filter="trasparente" onclick="toggleProjectFilter(this)">
                                    <div class="filter-img-wrap">
                                        <img src="data/files/TRASPARENTE.jpg" alt="Trasparente">
                                        <span class="filter-check">&#10003;</span>
                                    </div>
                                    <span class="filter-label">Trasparente</span>
                                </div>
                                <div class="filter-chip" data-filter="flessibile" onclick="toggleProjectFilter(this)">
                                    <div class="filter-img-wrap">
                                        <img src="data/files/FLESSIBILE.jpg" alt="Flessibile">
                                        <span class="filter-check">&#10003;</span>
                                    </div>
                                    <span class="filter-label">Flessibile</span>
                                </div>
                                <div class="filter-chip" data-filter="rigido" onclick="toggleProjectFilter(this)">
                                    <div class="filter-img-wrap">
                                        <img src="data/files/RIGIDO.jpg" alt="Rigido">
                                        <span class="filter-check">&#10003;</span>
                                    </div>
                                    <span class="filter-label">Rigido</span>
                                </div>
                                <div class="filter-chip" data-filter="resistente_acqua" onclick="toggleProjectFilter(this)">
                                    <div class="filter-img-wrap">
                                        <img src="data/files/RESISTENTE_ACQUA.jpg" alt="Resistente acqua">
                                        <span class="filter-check">&#10003;</span>
                                    </div>
                                    <span class="filter-label">Resistente<br>all'acqua</span>
                                </div>
                                <div class="filter-chip" data-filter="vegano" onclick="toggleProjectFilter(this)">
                                    <div class="filter-img-wrap">
                                        <img src="data/files/VEGANO.jpg" alt="Vegano">
                                        <span class="filter-check">&#10003;</span>
                                    </div>
                                    <span class="filter-label">Vegano</span>
                                </div>
                                <div class="filter-chip" data-filter="food_safe" onclick="toggleProjectFilter(this)">
                                    <div class="filter-img-wrap">
                                        <img src="data/files/FOODSAFE.jpg" alt="Food-safe">
                                        <span class="filter-check">&#10003;</span>
                                    </div>
                                    <span class="filter-label">Food-safe</span>
                                </div>
                                <div class="filter-chip" data-filter="antibatterico" onclick="toggleProjectFilter(this)">
                                    <div class="filter-img-wrap">
                                        <img src="data/files/ANTIBATTERICO.jpg" alt="Antibatterico">
                                        <span class="filter-check">&#10003;</span>
                                    </div>
                                    <span class="filter-label">Antibatterico</span>
                                </div>
                                <div class="filter-chip" data-filter="termostabile" onclick="toggleProjectFilter(this)">
                                    <div class="filter-img-wrap">
                                        <img src="data/files/TERMOSTABILE.jpg" alt="Termostabile">
                                        <span class="filter-check">&#10003;</span>
                                    </div>
                                    <span class="filter-label">Termostabile</span>
                                </div>

                            </div>
                            <p class="filters-hint" id="filtersHint">Seleziona almeno una proprieta per vedere i suggerimenti</p>
                        </div>
                        
                        <!-- v73: Trade-offs (prima di tutto) -->
                        <div id="projectTradeoffs" style="display: none;"></div>
                        
                        <!-- v73: Percorsi consigliati (sopra i dettagli) -->
                        <div id="projectPaths" style="display: none;">
                            <h3 style="font-size:0.85rem; color:#555; margin: 1rem 0 0.5rem;">Percorsi consigliati</h3>
                            <p style="font-size:0.75rem; color:#999; margin-bottom:0.5rem;">Combinazioni calcolate in base alle tue esigenze</p>
                            <div id="pathsContent"></div>
                        </div>
                        
                        <div class="results-section" id="projectResults" style="display: none;">
                            <div class="results-panel">
                                <h3>
                                    <span>Materiali esistenti</span>
                                    <span class="count-badge" id="materialsCount">0</span>
                                </h3>
                                <div id="matchingMaterials">
                                    <div class="results-empty">
                                        <div class="empty-icon">Nessun risultato</div>
                                        <div>Nessun materiale corrisponde ai filtri</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="results-panel">
                                <h3>
                                    <span>Ingredienti suggeriti</span>
                                    <span class="count-badge" id="ingredientsCount">0</span>
                                </h3>
                                <div id="matchingIngredients">
                                    <div class="results-empty">
                                        <div class="empty-icon">Nessun risultato</div>
                                        <div>Nessun ingrediente corrisponde ai filtri</div>
                                    </div>
                                </div>
                                <div class="property-suggestions" id="propertySuggestions" style="display: none;">
                                </div>
                                <div class="project-actions" id="projectActions" style="display: none;">
                                    <button class="btn-project secondary" onclick="clearProjectFilters()">Resetta filtri</button>
                                </div>
                            </div>
                        </div>
                        
                        </div>
                    </div>
                </div>

                <!-- TAB B: INGREDIENTI (Database completo) -->
                <div id="panel-B" class="panel-container">
                    <div class="study-layout">
                        <div class="ing-list-panel">
                            <div class="ing-list-header">
                                <input type="text" class="ing-search" id="ingSearch" placeholder="Cerca ingrediente..." oninput="filterIngredients()">
                                <div class="ing-filters">
                                    <span class="ing-filter active" data-famiglia="ALL" onclick="toggleIngFilter(null)">Tutti</span>
                                    <span class="ing-filter cart-filter" onclick="toggleIngFilter('cart')">Carrello</span>
                                    <span class="ing-filter" data-famiglia="PROTEINA" onclick="toggleIngFilter('PROTEINA')">Proteine</span>
                                    <span class="ing-filter" data-famiglia="POLISACCARIDE" onclick="toggleIngFilter('POLISACCARIDE')">Polisaccaridi</span>
                                    <span class="ing-filter" data-famiglia="POLICATIONE" onclick="toggleIngFilter('POLICATIONE')">Policatione</span>
                                    <span class="ing-filter" data-famiglia="PLASTIFICANTE" onclick="toggleIngFilter('PLASTIFICANTE')">Plastificanti</span>
                                    <span class="ing-filter" data-famiglia="LIPIDE" onclick="toggleIngFilter('LIPIDE')">Lipidi</span>
                                    <span class="ing-filter" data-famiglia="SALE_RETICOLANTE" onclick="toggleIngFilter('SALE_RETICOLANTE')">Sali</span>
                                    <span class="ing-filter" data-famiglia="CARICA" onclick="toggleIngFilter('CARICA')">Cariche</span>
                                    <span class="ing-filter" data-famiglia="COLORANTE" onclick="toggleIngFilter('COLORANTE')">Coloranti</span>
                                    <span class="ing-filter" data-famiglia="ADDITIVO" onclick="toggleIngFilter('ADDITIVO')">Additivi</span>
                                    <span class="ing-filter" data-famiglia="COLTURA" onclick="toggleIngFilter('COLTURA')">Colture</span>
                                </div>
                            </div>
                            <div class="ing-list" id="ingredientList"></div>
                            <div class="ing-list-count" id="ingListCount">0 ingredienti</div>
                            <div style="text-align:center;margin-top:0.4rem;padding-top:0.4rem;border-top:1px solid #e0e0e0;">
                                <a href="#" onclick="downloadGuidaMultifase(); return false;" 
                                   style="font-size:0.7rem;color:#f57f17;text-decoration:none;">
                                    Guida ingredienti multifase (PDF)
                                </a>
                            </div>
                        </div>
                        <div class="ing-detail-panel" id="ingDetailPanel">
                            <div class="famiglia-info-box" id="famigliaInfoBox" style="display:none;">
                                <div class="famiglia-info-header" onclick="toggleFamigliaBox()">
                                    <span class="famiglia-info-title" id="famigliaInfoTitle">Gruppo Funzionale</span>
                                    <span class="famiglia-info-toggle">[-]</span>
                                </div>
                                <div class="famiglia-info-content" id="famigliaInfoContent">
                                    <div class="famiglia-desc" id="famigliaDesc"></div>
                                    <div class="famiglia-confronto" id="famigliaConfronto"></div>
                                    <div class="famiglia-quando" id="famigliaQuando"></div>
                                    <div class="famiglia-avvisi" id="famigliaAvvisi"></div>
                                </div>
                            </div>
                            <div id="ingDetailContent">
                                <div class="ing-detail-empty">Seleziona un ingrediente</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB C: LABORATORIO (placeholder) -->
                <div id="panel-C" class="panel-container">
                    <div class="lab-layout">
                        <div class="tavolo-panel">
                            <div class="tavolo-header">
                                Tavolo di Lavoro
                                <span class="count" id="tavoloCount">0</span>
                            </div>
                            <div class="tavolo-body">
                                <div class="tavolo-ingredienti" id="tavoloArea">
                                    <div class="tavolo-hint">Clicca sugli ingredienti nel carrello per aggiungerli al tavolo</div>
                                </div>
                                
                                <div class="compat-section">
                                    <div class="compat-title">Verifica Compatibilita  </div>
                                    <div id="compatResults">
                                        <div class="compat-empty">Aggiungi almeno 2 ingredienti</div>
                                    </div>
                                </div>

                            </div>
                        </div>
                        
                        <div class="result-panel">
                            <div class="result-header" id="resultHeader">Materiale Risultante <a href="#descriptionSection" class="section-jump" onclick="event.preventDefault(); document.getElementById('descriptionSection').scrollIntoView({behavior:'smooth', block:'start'});">Descrizione ↓</a></div>
                            <div class="result-body">
                                <div class="result-section">
                                    <div class="result-label">Tipo previsto</div>
                                    <div class="result-type" id="resultType">-</div>
                                    <div class="result-base" id="resultBase">Aggiungi ingredienti al tavolo</div>
                                </div>
                                
                                <div class="result-section">
                                    <div class="result-label">Propriet   stimate</div>
                                    <div class="bar-row"><span class="bar-label">Trasparenza</span><div class="bar-track"><div class="bar-fill" id="barTrasp" style="width:0%"></div></div></div>
                                    <div class="bar-row"><span class="bar-label">Flessibilit  </span><div class="bar-track"><div class="bar-fill" id="barFlex" style="width:0%"></div></div></div>
                                    <div class="bar-row"><span class="bar-label">Resist. H   O</span><div class="bar-track"><div class="bar-fill" id="barH2O" style="width:0%"></div></div></div>
                                    <div class="bar-row"><span class="bar-label">Resist. mecc.</span><div class="bar-track"><div class="bar-fill" id="barMecc" style="width:0%"></div></div></div>
                                </div>
                                
                                <div class="result-section">
                                    <div class="result-label">Requisiti</div>
                                    <div class="result-tags" id="resultTags">-</div>
                                </div>
                                
                                <div class="limits-section" id="limitsSection" style="display:none;">
                                    <div class="limits-title">    Limiti e soluzioni</div>
                                    <div id="limitsContent"></div>
                                </div>
                                
                                <div class="suggestions-section" id="suggestionsSection" style="display:none;">
                                    <div class="suggestions-title">     Suggerimenti</div>
                                    <div id="suggestionsContent"></div>
                                </div>
                                
                                <!-- v91: SELETTORE TECNICA -->
                                <div class="tecnica-section" id="tecnicaSection">
                                    <div class="tecnica-title">Tecnica di lavorazione</div>
                                    <div class="tecnica-options">
                                        <button class="tecnica-btn active" data-tecnica="colata" onclick="setTecnica('colata')">Colata</button>
                                        <button class="tecnica-btn" data-tecnica="reticolazione" onclick="setTecnica('reticolazione')">Reticolazione ionica</button>
                                        <button class="tecnica-btn" data-tecnica="compressione" onclick="setTecnica('compressione')">Compressione a caldo</button>
                                        <button class="tecnica-btn" data-tecnica="aerazione" onclick="setTecnica('aerazione')">Aerazione / Schiuma</button>
                                        <button class="tecnica-btn" data-tecnica="fermentazione" onclick="setTecnica('fermentazione')">Fermentazione</button>
                                        <button class="tecnica-btn" data-tecnica="stratificazione" onclick="setTecnica('stratificazione')">Stratificazione</button>
                                    </div>
                                    <div class="tecnica-hint" id="tecnicaHint"></div>
                                    <!-- v92: Coating come post-processo -->
                                    <div class="coating-row" id="coatingRow">
                                        <label><input type="checkbox" id="coatingCheck" onchange="toggleCoating()"> Lipide come coating superficiale</label>
                                        <span class="coating-hint" id="coatingHint"></span>
                                    </div>
                                </div>

                                <div class="formula-section" id="formulaSection">
                                    <div class="formula-section-title">Ipotesi di Formula<br><small style="font-weight:normal;color:#888;font-size:0.7rem;">formulazioni variabili da verificare</small></div>
                                    <div id="formulaContent">
                                        <div class="formula-empty">Usa le     sul tavolo per selezionare</div>
                                    </div>
                                </div>
                                
                                <!-- ANNOTAZIONI -->
                                <div class="annotations-section" id="annotationsSection">
                                    <div class="annotations-title">Annotazioni personali</div>
                                    <textarea id="formulaAnnotations" class="annotations-textarea" placeholder="Scrivi qui le tue note sulla formula: osservazioni, varianti da provare, risultati dei test..."></textarea>
                                </div>
                                
                                <!-- FORMULE SALVATE -->
                                <div class="saved-formulas-section" id="savedFormulasSection">
                                    <div class="saved-formulas-header">
                                        <span class="saved-formulas-title">Formule Salvate</span>
                                        <span class="saved-formulas-count" id="savedCount">0</span>
                                    </div>
                                    <div class="saved-formulas-list" id="savedFormulasList">
                                        <div class="saved-empty">Nessuna formula salvata</div>
                                    </div>
                                </div>
                                
                                <!-- DESCRIZIONE MATERIALE IPOTIZZATO (in fondo per non bloccare la formula) -->
                                <div class="result-section description-section" id="descriptionSection">
                                    <div class="description-title">Descrizione Materiale Ipotizzato <a href="#resultHeader" class="section-jump" onclick="event.preventDefault(); this.closest('.result-body').scrollTo({top:0, behavior:'smooth'});">Formulazione ↑</a></div>
                                    <div class="description-disclaimer">Previsione basata sulle famiglie chimiche, non sulle interazioni specifiche tra ingredienti. Il risultato reale dipende da proporzioni, temperatura e tecnica.</div>
                                    <div class="description-content" id="descriptionContent">
                                        <div class="description-empty">Aggiungi ingredienti al tavolo per vedere una descrizione del possibile materiale</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB D: PROBLEMI E SOLUZIONI -->
                <div id="panel-D" class="panel-container">
                    <div class="tabD-layout">
                        <!-- MAIN CONTENT -->
                        <div class="tabD-main" id="tdMainArea">
                            <!-- FILTERS — VISUAL SHOWCASE -->
                            <div class="td-filters" id="tdFilterBar">
                                <button class="td-filter-btn td-filter-btn-all active" data-filter="all" onclick="tabD_toggleFilter('all')">
                                    <div class="td-filter-all-icon">✦</div>
                                    <span class="td-filter-label">Tutti</span> <span class="td-badge">20</span>
                                </button>
                                <button class="td-filter-btn" data-filter="essiccazione" onclick="tabD_toggleFilter('essiccazione')">
                                    <img class="td-filter-img" src="data/files/Essiccazione.jpg" alt="Essiccazione">
                                    <div class="td-filter-footer"><span class="td-filter-label">Essiccazione</span> <span class="td-badge">3</span></div>
                                </button>
                                <button class="td-filter-btn" data-filter="meccanica" onclick="tabD_toggleFilter('meccanica')">
                                    <img class="td-filter-img" src="data/files/Meccanica.jpg" alt="Meccanica">
                                    <div class="td-filter-footer"><span class="td-filter-label">Meccanica</span> <span class="td-badge">3</span></div>
                                </button>
                                <button class="td-filter-btn" data-filter="biologici" onclick="tabD_toggleFilter('biologici')">
                                    <img class="td-filter-img" src="data/files/Biologici.jpg" alt="Biologici">
                                    <div class="td-filter-footer"><span class="td-filter-label">Biologici</span> <span class="td-badge">2</span></div>
                                </button>
                                <button class="td-filter-btn" data-filter="processo" onclick="tabD_toggleFilter('processo')">
                                    <img class="td-filter-img" src="data/files/Processo.jpg" alt="Processo">
                                    <div class="td-filter-footer"><span class="td-filter-label">Processo</span> <span class="td-badge">4</span></div>
                                </button>
                                <button class="td-filter-btn" data-filter="stabilita" onclick="tabD_toggleFilter('stabilita')">
                                    <img class="td-filter-img" src="data/files/Stabilit_nel_tempo.jpg" alt="Stabilità">
                                    <div class="td-filter-footer"><span class="td-filter-label">Stabilità</span> <span class="td-badge">3</span></div>
                                </button>
                                <button class="td-filter-btn" data-filter="colture" onclick="tabD_toggleFilter('colture')">
                                    <img class="td-filter-img" src="data/files/Colture.jpg" alt="Colture">
                                    <div class="td-filter-footer"><span class="td-filter-label">Colture</span> <span class="td-badge">3</span></div>
                                </button>
                                <button class="td-filter-btn" data-filter="ambiente" onclick="tabD_toggleFilter('ambiente')">
                                    <img class="td-filter-img" src="data/files/Ambiente.jpg" alt="Ambiente">
                                    <div class="td-filter-footer"><span class="td-filter-label">Ambiente</span> <span class="td-badge">2</span></div>
                                </button>
                            </div>

                            <!-- CONTEXTUAL ZONE -->
                            <div class="td-context empty" id="tdContextZone">
                                <h3 id="tdContextTitle">Aggiungi ingredienti al tavolo per evidenziare i problemi della tua ricetta</h3>
                                <div class="td-context-chips" id="tdContextChips"></div>
                            </div>

                            <!-- PROBLEMS LIST -->
                            <div id="tdProblemsList"></div>

                            <!-- SHOW MORE -->
                            <div class="td-show-more-zone" id="tdShowMoreZone" style="display:none">
                                <button class="td-show-more-btn" id="tdShowMoreBtn" onclick="tabD_showAllProblems()"></button>
                            </div>
                        </div>

                        <!-- DIAGNOSTIC SIDEBAR -->
                        <div class="tabD-sidebar">
                            <div class="tabD-sidebar-header">
                                <div class="td-title-row">La tua ricetta <span class="td-count" id="tdCartCount">0</span><button class="mobile-sidebar-close" onclick="mobileCloseSidebar()" title="Chiudi">&times;</button></div>
                                <div class="td-subtitle">Ingredienti dal Laboratorio</div>
                            </div>
                            <div class="tabD-ing-selector">
                                <select id="tdIngSelect" onchange="tabD_addToTavolo(this.value, 'base')">
                                    <option value="">+ Aggiungi ingrediente...</option>
                                </select>
                            </div>
                            <div class="tabD-sidebar-body" id="tdCartBody">
                                <div class="td-empty">Nessun ingrediente.<br><br>Aggiungi la ricetta che stai preparando per diagnosticare problemi e trovare soluzioni.<br><br>Attiva/disattiva ciascuno per isolare quale ingrediente causa cosa.</div>
                            </div>
                            <div class="tabD-sidebar-footer">
                                <button class="td-goto-lab" id="tdGotoLab" onclick="tabD_gotoLab()" style="display:none">
                                    &larr; Vai in Laboratorio <span class="lab-count" id="tdLabCount"></span>
                                </button>
                                <div class="td-clear-zone" id="tdClearZone">
                                    <button class="td-clear-btn" onclick="tabD_askClear()">Svuota ricetta</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- CARRELLO -->
        <div class="cart-sidebar">
            <div class="cart-header">
                Carrello
                <span class="count" id="cartCount">0</span>
                <button class="mobile-sidebar-close" onclick="mobileCloseSidebar()" title="Chiudi">&times;</button>
            </div>
            <div class="cart-nav" id="cartFooter">
                <button class="btn btn-secondary btn-sm" onclick="switchTab('B')" id="btnToB">Ingredienti</button>
                <button class="btn btn-primary btn-sm" onclick="switchTab('C')" id="btnToC">Laboratorio</button>
                <button class="btn btn-success btn-sm" onclick="addAllToTavolo()" id="btnAllToTavolo" style="display:none;">Tutti sul tavolo</button>
                <button class="btn btn-warning btn-sm" onclick="clearTavolo()" id="btnClear" style="display:none;">Svuota tavolo</button>
                <button class="btn btn-outline btn-sm" onclick="clearCart()" id="btnClearCart" title="Svuota carrello">Svuota</button>
            </div>
            <div class="cart-body" id="cartBody">
                <div class="cart-empty">Carrello vuoto.<br>Aggiungi ingredienti da un materiale.</div>
            </div>
            
        </div>
    </div>

    <!-- MODAL -->
    <div class="modal-overlay" id="modalOverlay" onclick="closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 id="modalTitle">Dettaglio</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-actions" id="modalActions"></div>
        </div>
    </div>
    
    <!-- TAB D: SOLUTION DETAIL MODAL -->
    <div class="td-sol-modal-overlay" id="tdSolModal" onclick="if(event.target===this)tabD_closeSolModal()">
        <div class="td-sol-modal-content">
            <div class="td-sol-modal-header">
                <h3 id="tdSolModalTitle"></h3>
                <span id="tdSolModalBadge" class="td-sol-modal-badge"></span>
                <button class="td-sol-modal-close" onclick="tabD_closeSolModal()">✕</button>
            </div>
            <div class="td-sol-modal-body" id="tdSolModalBody"></div>
        </div>
    </div>

    <!-- MODAL CREDITS/FONTI/DISCLAIMER -->
    <div class="credits-modal" id="creditsModal" onclick="closeCreditsModal(event)">
        <div class="credits-content" onclick="event.stopPropagation()">
            <div class="credits-header">
                <h2>i Informazioni e Credits</h2>
                <button class="credits-close" onclick="closeCreditsModal()">&times;</button>
            </div>
            <div class="credits-body">
                
                <!-- DISCLAIMER -->
                <div class="credits-section">
                    <h3>Disclaimer</h3>
                    <div class="disclaimer-box warning">
                        <p><strong>Strumento DIDATTICO</strong> – Questo configuratore è pensato per studenti di design e maker. NON è un manuale professionale né una fonte primaria per applicazioni industriali o alimentari.</p>
                        <p>Le informazioni sono <strong>indicative</strong> e devono essere <strong>verificate</strong> prima dell'uso pratico.</p>
                    </div>
                    <div class="disclaimer-box">
                        <p><strong>Sicurezza</strong> – Alcuni materiali e processi comportano rischi (calore, sostanze irritanti, reazioni chimiche). Lavorare sempre con protezioni adeguate (guanti, occhiali, ventilazione) e sotto supervisione se inesperti.</p>
                    </div>
                    <div class="disclaimer-box">
                        <p><strong>Food contact</strong> – Le indicazioni "food-safe" sono riferite agli ingredienti puri. Il materiale finale può NON essere idoneo al contatto alimentare – verificare con test specifici e normative vigenti.</p>
                    </div>
                </div>
                
                <!-- NOTA AI -->
                <div class="credits-section">
                    <h3>Nota sui contenuti AI</h3>
                    <div class="ai-note">
                        <p>I testi descrittivi degli ingredienti sono stati generati con assistenza di <strong>intelligenza artificiale</strong> (Claude, Anthropic) sulla base di conoscenze consolidate di chimica e scienza dei materiali.</p>
                        <p>Questo significa che: (1) i concetti chimici di base sono affidabili; (2) i dosaggi e tempi sono indicativi, da tarare sperimentalmente; (3) alcune informazioni pratiche derivano da "saggezza collettiva" non sempre documentata scientificamente.</p>
                        <p><strong>Per applicazioni critiche, verificare sempre su letteratura peer-reviewed o schede tecniche dei fornitori.</strong></p>
                    </div>
                </div>
                
                <!-- FONTI SCIENTIFICHE -->
                <div class="credits-section">
                    <h3>Letteratura scientifica</h3>
                    <ul>
                        <li><strong>Stevens, E.S.</strong> – <em>Green Plastics: An Introduction to the New Science of Biodegradable Plastics</em>, Princeton University Press, 2002</li>
                        <li><strong>Rhim, Park, Ha</strong> – <em>Bio-nanocomposites for food packaging applications</em>, Progress in Polymer Science, 2013</li>
                        <li><strong>Cazón, Velazquez et al.</strong> – <em>Polysaccharide-based films and coatings for food packaging: A review</em>, Food Hydrocolloids, 2017</li>
                        <li><strong>Benyus, Janine M.</strong> – <em>Biomimicry: Innovation Inspired by Nature</em>, Harper Perennial, 1997</li>
                        <li><strong>McDonough & Braungart</strong> – <em>Cradle to Cradle: Remaking the Way We Make Things</em>, North Point Press, 2002</li>
                    </ul>
                    
                    <h4 style="margin-top: 1rem; font-size: 0.85rem; color: #555;">Riviste e risorse accessibili</h4>
                    <ul>
                        <li><a href="https://zygotequarterly.com" target="_blank"><strong>Zygote Quarterly</strong></a> – Rivista gratuita su biomimicry e design bio-ispirato (PDF scaricabili)</li>
                        <li><a href="https://www.sciencedirect.com/journal/carbohydrate-polymers" target="_blank">Carbohydrate Polymers</a> – Rivista peer-reviewed su polisaccaridi (alcuni articoli open access)</li>
                        <li><a href="https://www.sciencedirect.com/journal/food-hydrocolloids" target="_blank">Food Hydrocolloids</a> – Ricerca su idrocolloidi alimentari</li>
                        <li><a href="https://www.dezeen.com/tag/bioplastic/" target="_blank">Dezeen - Bioplastics</a> – Articoli divulgativi su progetti e ricerche</li>
                        <li><a href="https://materialdistrict.com" target="_blank">Material District</a> – Database materiali innovativi con schede accessibili</li>
                    </ul>
                    
                    <h4 style="margin-top: 1rem; font-size: 0.85rem; color: #555;">Database e biblioteche materiali</h4>
                    <ul>
                        <li><a href="https://matrec.com" target="_blank"><strong>MATREC</strong></a> – Database italiano di materiali eco-sostenibili e riciclati</li>
                        <li><a href="https://www.materialconnexion.com" target="_blank"><strong>Material Connexion</strong></a> – Biblioteca globale di materiali innovativi (ora Sandow)</li>
                        <li><a href="https://www.oxman.com" target="_blank"><strong>Neri Oxman / Mediated Matter</strong></a> – Ricerca MIT su design computazionale e biomateriali (Silk Pavilion, Aguahoja)</li>
                    </ul>
                    
                    <h4 style="margin-top: 1rem; font-size: 0.85rem; color: #555;">Database e biblioteche materiali</h4>
                    <ul>
                        <li><a href="https://matrec.com" target="_blank"><strong>MATREC</strong></a> – Database italiano materiali eco-sostenibili, schede tecniche dettagliate</li>
                        <li><a href="https://www.materialconnexion.com" target="_blank"><strong>Material Connexion</strong></a> – Biblioteca globale materiali innovativi (ora Sandow Design Group)</li>
                        <li><a href="https://www.oxman.com" target="_blank"><strong>Neri Oxman / Mediated Matter</strong></a> – Ricerca MIT su design computazionale e biomateriali (Silk Pavilion, Aguahoja)</li>
                    </ul>
                </div>
                
                <!-- RISORSE PRATICHE -->
                <div class="credits-section">
                    <h3>Risorse pratiche e community</h3>
                    <ul>
                        <li><a href="https://materiom.org" target="_blank">Materiom.org</a> – Database open-source di ricette per materiali sostenibili</li>
                        <li><a href="https://textile-academy.org" target="_blank">Fabricademy</a> – Programma educativo su tessuti e materiali bio-based</li>
                        <li><a href="https://www.ecovative.com" target="_blank">Ecovative Design</a> – Leader nei materiali a base di micelio</li>
                        <li><a href="https://www.futurematerialsbank.com" target="_blank">Future Materials Bank</a> – Archivio materiali sostenibili con schede dettagliate</li>
                        <li><strong>Margaret Dunne</strong> – <em>Bioplastic Cook Book</em>, 2018</li>
                        <li>Instructables, Reddit r/Bioplastics, Precious Plastic community</li>
                    </ul>
                    
                    <h4 style="margin-top: 1rem; font-size: 0.85rem; color: #555;">Progetti e case studies – Alghe e biomateriali</h4>
                    <ul>
                        <li><a href="https://www.corpuscoli.com/projects/de-algarum-natura/" target="_blank"><strong>Officina Corpuscoli – De Algarum Natura</strong></a> – Ricerca artistica sui materiali da alghe (Amsterdam)</li>
                        <li><a href="https://living.corriere.it/design/atelier-luma-biomateriali-del-futuro-alghe-sale/" target="_blank"><strong>Atelier Luma</strong></a> – Biomateriali da alghe e sale della Camargue (Arles)</li>
                        <li><a href="https://www.designboom.com/architecture/algae-building-material-eco-village-concept-china-10-02-2020/" target="_blank">Designboom</a> – Materiali edilizi da alghe, eco-village concept (Cina)</li>
                        <li><a href="https://www.futurematerialsbank.com/material/algae-4/" target="_blank">Future Materials Bank – Algae materials</a> – Schede tecniche materiali da alghe</li>
                        <li><a href="https://www.floornature.it/design-trends/nuovo-articolo-it-17477/" target="_blank">Floornature</a> – Trend design biomateriali</li>
                    </ul>
                </div>
                
                <!-- SCHEDE TECNICHE -->
                <div class="credits-section">
                    <h3>Schede tecniche ingredienti</h3>
                    <p style="font-size: 0.8rem; color: #555; margin-bottom: 0.75rem; font-style: italic;">Nota: molte schede ingredienti nel configuratore contengono link diretti a risorse esterne (Materiom, Wikipedia, fornitori) per approfondimenti specifici.</p>
                    <ul>
                        <li><a href="https://www.sigmaaldrich.com" target="_blank">Sigma-Aldrich / Merck</a> – Schede reagenti chimici</li>
                        <li><a href="https://msk-ingredients.com" target="_blank">MSK Ingredients</a> – Ingredienti cucina molecolare</li>
                        <li><a href="https://sosa.cat" target="_blank">Sosa Ingredients</a> – Texturizzanti alimentari</li>
                    </ul>
                </div>
                
                <!-- CREDITS -->
                <div class="credits-section">
                    <h3>Credits progetto</h3>
                    <p><strong>Ideazione e sviluppo:</strong> Prof. Paolo Maccarrone</p>
                    <p><strong>Corso:</strong> Tipologia dei Nuovi Materiali – Accademia Albertina di Belle Arti, Torino</p>
                    <p><strong>Sviluppo database:</strong> Con assistenza AI (Claude, Anthropic)</p>
                    <p><strong>Anno:</strong> 2025-2026</p>
                </div>
                
                <!-- RINGRAZIAMENTI -->
                <div class="credits-section">
                    <h3>Ringraziamenti</h3>
                    <p>Comunità  Fabricademy e Fab Lab Network, Materiom.org per le risorse open-source, Accademia Albertina di Torino, e tutti i maker e ricercatori che condividono conoscenza.</p>
                </div>
                
                <div class="credits-version">
                    Configuratore Biomateriali v92 – Database v10.1
                </div>
            </div>
        </div>
    </div>

    <!-- CARICAMENTO DATI VIA SCRIPT (funziona da file://) -->
    
    
    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
// DEBUG v92 - Se vedi questo alert, il file è aggiornato!

    //                                                                                                                                                                                  
    // DATI EMBEDDED (tutto inline, nessun file esterno)
    //                                                                                                                                                                                  
    // ============================================
// DATI CARICATI DA FILE ESTERNO
// ============================================
// I dati sono in: data/database_biomateriali_v10_5.js
// Contiene: CATALOGO_DATA, MATERIALI_DATA, INGREDIENTI_DATA, 
//           OUTPUT_INFO, IN_PROGRESS_MAPPING
// ============================================


    
    
    
    console.log("Dati inline caricati:", {
        outputs: Object.keys(CATALOGO_DATA.outputs || {}),
        documentati: MATERIALI_DATA.materiali_documentati?.length || 0,
        inProgress: MATERIALI_DATA.materiali_in_progress?.length || 0,
        ingredienti: INGREDIENTI_DATA.ingredienti?.length || 0
    });

    //                                                                                                                                                                                  
    // STATO
    //                                                                                                                                                                                  
    let catalogo = null;
    let materialiDB = null;
    let ingredientiDB = null;
    let cart = [];
    let tavolo = [];
    let formulaSelection = new Set(); // ingredienti selezionati per formula
    let customDosages = {}; // v71: dosaggi personalizzati { ingredientId: percent }
    let descUpdateTimer = null; // v71: debounce per aggiornamento descrizione
    
    // v71: Contributo proprietà  per 1% di dosaggio, per famiglia
    // v89: Coefficienti CALIBRATI su 34 materiali reali (feb 2026)
    const FAMILY_PROP_RATES = {
        PROTEINA:               { trasp: 0.743, flex: 0.443, h2o: 0.272, mecc: 0.529 },
        POLISACCARIDE_NEUTRO:   { trasp: 0.871, flex: 0.243, h2o: 0.372, mecc: 0.600 },
        POLISACCARIDE_ANIONICO: { trasp: 1.100, flex: 0.428, h2o: 0.385, mecc: 0.685 },
        POLICATIONE:            { trasp: 0.715, flex: 0.357, h2o: 0.458, mecc: 0.886 },
        COLTURA:                { trasp: 0.429, flex: 0.714, h2o: 0.357, mecc: 0.786 },
        PLASTIFICANTE:          { trasp:-0.050, flex: 2.100, h2o: 0.400, mecc:-0.300 },
        LIPIDE:                 { trasp: 1.000, flex: 1.300, h2o: 2.300, mecc: 3.000 },
        CARICA:                 { trasp:-1.867, flex:-0.334, h2o: 0.200, mecc: 1.933 },
        SALE_RETICOLANTE:       { trasp:-3.000, flex:-5.000, h2o: 7.333, mecc: 5.334 },
        COLORANTE:              { trasp:-17.00, flex: 0.500, h2o: 5.000, mecc: 3.500 },
        ACIDO:                  { trasp: 0.000, flex: 0.000, h2o: 0.000, mecc: 2.500 },
        ADDITIVO:               { trasp:-0.200, flex: 0.200, h2o: 3.800, mecc: 1.400 },
        EMULSIONANTE:           { trasp: 1.000, flex: 2.000, h2o: 0.000, mecc: 0.000 }
    };
    
    // v89: INTERAZIONI TRA FAMIGLIE - bonus/malus per combinazioni chimiche significative
    const FAMILY_INTERACTIONS = {
        // Reticolazione ionica: alginato/pectina + calcio = gel forte idrorepellente
        'POLISACCARIDE_ANIONICO+SALE_RETICOLANTE': { trasp: -5, flex: -10, h2o: +25, mecc: +20, note: 'Gel ionico: resistenza H₂O e meccanica aumentate' },
        // Reticolazione proteica: proteina + borace/tannini = materiale più rigido e idrorepellente  
        'PROTEINA+SALE_RETICOLANTE': { trasp: -5, flex: -5, h2o: +20, mecc: +15, note: 'Reticolazione proteica: migliora resistenze' },
        // Ibrido matrice: proteina + polisaccaride = sinergia strutturale
        'PROTEINA+POLISACCARIDE_NEUTRO': { trasp: 0, flex: +5, h2o: +5, mecc: +10, note: 'Ibrido proteina-polisaccaride: struttura rinforzata' },
        'PROTEINA+POLISACCARIDE_ANIONICO': { trasp: 0, flex: +5, h2o: +5, mecc: +10, note: 'Ibrido proteina-polisaccaride: struttura rinforzata' },
        // Carica eccessiva penalizza flessibilità
        'CARICA+CARICA': { trasp: -10, flex: -15, h2o: 0, mecc: +5, note: 'Troppe cariche: materiale friabile' },
        // Plastificante + matrice rigida = equilibrio
        'POLISACCARIDE_NEUTRO+PLASTIFICANTE': { trasp: 0, flex: +10, h2o: 0, mecc: 0, note: 'Plastificante bilancia rigidità polisaccaride' },
        // Coloranti naturali spesso hanno effetti secondari
        'COLORANTE+PROTEINA': { trasp: 0, flex: 0, h2o: +5, mecc: +5, note: 'Coloranti naturali interagiscono con proteine' },
        // Policatione + anionico = complesso polielettrolitico
        'POLICATIONE+POLISACCARIDE_ANIONICO': { trasp: -10, flex: -5, h2o: +15, mecc: +15, note: 'Complesso polielettrolitico: molto resistente' }
    };
    
    // v89: REGOLE COMPOSIZIONE TAVOLO - limiti per famiglia (warning, non blocchi)
    const TAVOLO_LIMITS = {
        MATRICI: { max: 2, warn: 'Max 2 matrici consigliate per miscele stabili' },
        PLASTIFICANTE: { max: 1, warn: 'Un solo plastificante è sufficiente' },
        SALE_RETICOLANTE: { max: 1, warn: 'Un solo reticolante per volta (meccanismi diversi)' },
        CARICA: { max: 2, warn: 'Max 2 cariche per evitare miscele friabili' },
        COLORANTE: { max: 1, warn: 'Un solo colorante per risultati prevedibili' },
        LIPIDE: { max: 1, warn: 'Un solo lipide per coating uniforme' }
    };
    
    // v71: Limiti dosaggio per famiglia (% su peso secco totale)
    const FAMILY_DOSE_RULES = {
        PROTEINA:               { min: 5,  max: 80, step: 1 },
        POLISACCARIDE_NEUTRO:   { min: 5,  max: 80, step: 1 },
        POLISACCARIDE_ANIONICO: { min: 5,  max: 80, step: 1 },
        POLICATIONE:            { min: 5,  max: 80, step: 1 },
        COLTURA:                { min: 5,  max: 80, step: 1 },
        PLASTIFICANTE:          { min: 1,  max: 50, step: 1 },
        LIPIDE:                 { min: 1,  max: 30, step: 1 },
        CARICA:                 { min: 1,  max: 40, step: 1 },
        SALE_RETICOLANTE:       { min: 1,  max: 10, step: 1 },
        COLORANTE:              { min: 1,  max: 10, step: 1 },
        ACIDO:                  { min: 1,  max: 10, step: 1 },
        ADDITIVO:               { min: 1,  max: 15, step: 1 },
        EMULSIONANTE:           { min: 1,  max: 15, step: 1 }
    };
    let currentOutput = null;
    
    // v91: TECNICA DI LAVORAZIONE — v92: +stratificazione, coating, filtro contestuale
    let currentTecnica = 'colata';
    let coatingAttivo = false; // v92: lipide applicato come coating superficiale
    const TECNICA_MODIFIERS = {
        colata:        { trasp: 0,   flex: 0,   h2o: 0,   mecc: 0,   label: 'Colata e asciugatura', descTipo: '',
            hint: 'Tecnica base: versa la miscela in uno stampo e lascia asciugare.',
            descNota: 'Colata in stampo piano, asciugatura 24-72h a temperatura ambiente. Spessore: 2-5mm film, 5-15mm lastre.' },
        reticolazione: { trasp: -5,  flex: -10, h2o: 25,  mecc: 15,  label: 'Reticolazione ionica', descTipo: ' reticolato',
            hint: 'Bagno in soluzione salina (CaCl2, borace). Piu resistente ad acqua e meccanicamente, meno flessibile.',
            descNota: 'Immersione in bagno CaCl2 2-5% o borace 4%. Tempo: 1-5min gusci, 15-30min gel solidi. Risciacquare dopo.' },
        compressione:  { trasp: -5,  flex: -15, h2o: 10,  mecc: 30,  label: 'Compressione a caldo', descTipo: ' pressato',
            hint: 'Pressatura con calore (50-120C). Ideale per caseina, amidi. Materiali densi e rigidi.',
            descNota: 'Compressione in pressa o morsa a 50-120C per 15-60 min. Espelle acqua, compatta struttura. Densita elevata, superficie liscia.' },
        aerazione:     { trasp: -40, flex: 15,  h2o: -10, mecc: -25, label: 'Aerazione / Schiuma', descTipo: ' aerato',
            hint: 'Montatura a frusta o sifone. Poroso, leggero, opaco. Fragile ma flessibile e isolante.',
            descNota: 'Montatura meccanica (frusta, planetaria) o chimica (sifone, bicarbonato). Stabilizzare rapidamente prima del collasso.' },
        fermentazione: { trasp: -20, flex: 20,  h2o: 15,  mecc: 10,  label: 'Fermentazione / Coltura', descTipo: ' fermentato',
            hint: 'Crescita biologica (SCOBY, micelio). Tempi lunghi, proprieta emergenti.',
            descNota: 'Coltura biologica 20-30C. SCOBY: 1-3 settimane su te zuccherato. Micelio: 1-4 settimane su substrato lignocellulosico.' },
        stratificazione: { trasp: -5, flex: -5, h2o: 10, mecc: 5, label: 'Stratificazione / Laminazione', descTipo: ' stratificato',
            hint: 'Strati sovrapposti di materiali diversi. Ogni strato contribuisce proprieta specifiche.',
            descNota: 'Sovrapporre strati alternati (es. film matrice + coating cera + film chitosano). Asciugare ogni strato prima del successivo. Il risultato combina le proprieta dei singoli strati.' }
    };
    
    // v92: Regole contestuali — quali tecniche sono disponibili in base agli ingredienti
    const TECNICA_REQUIRES = {
        colata: { always: true },
        reticolazione: {
            famiglie: ['SALE_RETICOLANTE', 'POLISACCARIDE_ANIONICO', 'PROTEINA'],
            reason: 'Serve matrice reticolabile (proteina, polisaccaride anionico) o sale reticolante'
        },
        compressione: {
            famiglie: ['PROTEINA', 'POLISACCARIDE_NEUTRO', 'CARICA'],
            reason: 'Ideale per caseina, amidi o compositi con cariche (matrici comprimibili)'
        },
        aerazione: {
            ingredienti: ['albumina', 'aquafaba', 'gelatina'],
            famiglie: ['EMULSIONANTE'],
            reason: 'Serve agente schiumogeno (albumina, aquafaba, gelatina, emulsionante)'
        },
        fermentazione: {
            famiglie: ['COLTURA'],
            reason: 'Serve una coltura biologica (SCOBY, micelio)'
        },
        stratificazione: {
            minIngredienti: 2,
            reason: 'Servono almeno 2 ingredienti per creare strati distinti'
        }
    };

    function setTecnica(tecnica) {
        // v92: blocca click su bottoni disabilitati
        var btn = document.querySelector('.tecnica-btn[data-tecnica="' + tecnica + '"]');
        if (btn && btn.classList.contains('disabled')) return;
        currentTecnica = tecnica;
        document.querySelectorAll('.tecnica-btn').forEach(function(b) {
            b.classList.toggle('active', b.dataset.tecnica === tecnica);
        });
        var hintEl = document.getElementById('tecnicaHint');
        if (hintEl) {
            var mod = TECNICA_MODIFIERS[tecnica];
            if (mod && tecnica !== 'colata') {
                hintEl.textContent = mod.hint;
                hintEl.classList.add('visible');
            } else {
                hintEl.classList.remove('visible');
            }
        }
        calculateFormula();
        calculateMaterial();
    }
    
    // v92: Toggle coating — lipide come rivestimento superficiale
    function toggleCoating() {
        var cb = document.getElementById('coatingCheck');
        coatingAttivo = cb ? cb.checked : false;
        var row = document.getElementById('coatingRow');
        if (row) row.classList.toggle('active', coatingAttivo);
        calculateFormula();
        calculateMaterial();
    }
    
    // v92: Aggiorna disponibilita bottoni tecnica + coating in base agli ingredienti
    function updateTecnicaAvailability() {
        var ings = INGREDIENTI_DATA ? INGREDIENTI_DATA.ingredienti || {} : {};
        var famiglieAttive = new Set();
        var idsAttivi = [];
        formulaSelection.forEach(function(id) {
            var ing = ings[id];
            if (ing) { famiglieAttive.add(ing.famiglia); idsAttivi.push(id); }
        });
        
        var hasLipide = famiglieAttive.has('LIPIDE');
        
        // Aggiorna bottoni tecnica
        document.querySelectorAll('.tecnica-btn').forEach(function(btn) {
            var tecnica = btn.dataset.tecnica;
            var req = TECNICA_REQUIRES[tecnica];
            if (!req || req.always) { btn.classList.remove('disabled'); btn.title = ''; return; }
            
            var enabled = false;
            if (req.famiglie) {
                req.famiglie.forEach(function(f) { if (famiglieAttive.has(f)) enabled = true; });
            }
            if (req.ingredienti) {
                req.ingredienti.forEach(function(ingId) { if (idsAttivi.indexOf(ingId) >= 0) enabled = true; });
            }
            if (req.minIngredienti) {
                if (idsAttivi.length >= req.minIngredienti) enabled = true;
            }
            
            btn.classList.toggle('disabled', !enabled);
            btn.title = enabled ? '' : req.reason;
            
            // Se tecnica attiva viene disabilitata, torna a colata
            if (!enabled && currentTecnica === tecnica) {
                currentTecnica = 'colata';
                document.querySelectorAll('.tecnica-btn').forEach(function(b) {
                    b.classList.toggle('active', b.dataset.tecnica === 'colata');
                });
                var hintEl = document.getElementById('tecnicaHint');
                if (hintEl) hintEl.classList.remove('visible');
            }
        });
        
        // v92: Coating visibile solo se LIPIDE presente
        var coatingRow = document.getElementById('coatingRow');
        if (coatingRow) {
            coatingRow.classList.toggle('visible', hasLipide);
            var cb = document.getElementById('coatingCheck');
            if (!hasLipide && coatingAttivo) {
                coatingAttivo = false;
                if (cb) cb.checked = false;
                coatingRow.classList.remove('active');
            }
            var hint = document.getElementById('coatingHint');
            if (hint) hint.textContent = coatingAttivo ? 'Spalmato/applicato sulla superficie, non miscelato' : 'Spunta se il lipide va applicato sopra, non nel mix';
        }
    }
    
    // v91: Cap proporzionali + modificatori tecnica (post-calcolo)
    // v92: + coating ricalcola contributo lipide
    function applyPostCalcModifiers(trasp, flex, h2o, mecc, formula) {
        if (formula && formula.length > 0) {
            var total = 0;
            formula.forEach(function(f) { total += (f.percent || 0); });
            if (total > 0) {
                var plastPct = 0, caricaPct = 0, reticPct = 0, lipidePct = 0;
                formula.forEach(function(f) {
                    var fam = f.ing ? f.ing.famiglia : '';
                    if (fam === 'PLASTIFICANTE') plastPct += f.percent;
                    else if (fam === 'CARICA') caricaPct += f.percent;
                    else if (fam === 'SALE_RETICOLANTE') reticPct += f.percent;
                    else if (fam === 'LIPIDE') lipidePct += f.percent;
                });
                var plastEff = plastPct / total * 100;
                var caricaEff = caricaPct / total * 100;
                var reticEff = reticPct / total * 100;
                if (plastEff > 40) mecc = Math.min(mecc, 15);
                else if (plastEff > 35) mecc = Math.min(mecc, 25);
                if (caricaEff > 30) flex = Math.min(flex, 20);
                else if (caricaEff > 25) flex = Math.min(flex, 35);
                if (reticEff > 7) { trasp = Math.min(trasp, 25); flex = Math.min(flex, 20); }
                
                // v92: Coating — lipide sulla superficie, non nel mix
                if (coatingAttivo && lipidePct > 0) {
                    var lipRates = FAMILY_PROP_RATES['LIPIDE'];
                    if (lipRates) {
                        // Annulla effetto mix del lipide (gia calcolato con rates)
                        trasp -= lipidePct * lipRates.trasp;
                        flex  -= lipidePct * lipRates.flex;
                        h2o  -= lipidePct * lipRates.h2o;
                        mecc -= lipidePct * lipRates.mecc;
                        // Ricalcola come coating: quasi zero su trasp/flex/mecc, forte su H2O
                        trasp += lipidePct * (-0.2);
                        // flex: nessun contributo (coating non cambia flessibilita substrato)
                        h2o  += lipidePct * 4.0;
                        // mecc: nessun contributo
                    }
                }
            }
        }
        var mod = TECNICA_MODIFIERS[currentTecnica];
        if (mod) { trasp += mod.trasp; flex += mod.flex; h2o += mod.h2o; mecc += mod.mecc; }
        return {
            trasparenza: Math.max(0, Math.min(100, Math.round(trasp))),
            flessibilita: Math.max(0, Math.min(100, Math.round(flex))),
            resistenzaH2O: Math.max(0, Math.min(100, Math.round(h2o))),
            resistenzaMecc: Math.max(0, Math.min(100, Math.round(mecc)))
        };
    }

    // INFO OUTPUT - chiave 'rigido' ma display 'Massa'
    


    //                                                                                                                                                                                  
    // TAB B - INGREDIENTI
    //                                                                                                                                                                                  
    let ingFilter = null;
    let selectedIngredient = null;
    const compatDB = INGREDIENTI_DATA.regole_compatibilita_famiglie || {};
    
    function renderIngredientList() {
        const list = document.getElementById('ingredientList');
        if (!list) return;
        const search = (document.getElementById('ingSearch')?.value || '').toLowerCase();
        list.innerHTML = '';
        
        let count = 0;
        const ings = INGREDIENTI_DATA?.ingredienti || {};
        const sortedIds = Object.keys(ings).sort((a, b) => 
            ings[a].nome.localeCompare(ings[b].nome)
        );
        
        for (const id of sortedIds) {
            const ing = ings[id];
            if (search && !ing.nome.toLowerCase().includes(search)) continue;
            if (ingFilter === 'cart' && !cart.find(c => c.id === id)) continue;
            if (ingFilter && ingFilter !== 'cart' && !ing.famiglia.includes(ingFilter)) continue;
            
            count++;
            const inCart = cart.find(c => c.id === id);
            const dotClass = getCategoryClass(ing.famiglia);
            
            const item = document.createElement('div');
            item.className = 'ing-list-item' + (selectedIngredient === id ? ' selected' : '');
            item.innerHTML = `
                <span class="dot ${dotClass}"></span>
                <div class="info">
                    <div class="name">${ing.nome}</div>
                    <div class="famiglia">${formatFamiglia(ing.famiglia)}</div>
                </div>
                ${inCart ? '<span class="cart-status">    </span>' : ''}
            `;
            item.onclick = () => showIngredientDetail(id);
            list.appendChild(item);
        }
        
        var exportLabel = '';
        if (ingFilter && ingFilter !== 'cart') {
            // v81: Usa nome_display plurale da FAMIGLIA_INFO
            var famDisplayName = formatFamiglia(ingFilter);
            if (typeof FAMIGLIA_INFO !== 'undefined') {
                var famMap = {'POLISACCARIDE':'POLISACCARIDE_NEUTRO'};
                var famKey = famMap[ingFilter] || ingFilter;
                var famInfo = FAMIGLIA_INFO[famKey];
                if (famInfo && famInfo.nome_display) {
                    // Prende solo la prima parte prima di eventuale parentesi
                    famDisplayName = famInfo.nome_display.split('(')[0].trim();
                }
            }
            exportLabel = 'esporta ' + famDisplayName.toLowerCase() + ' ↓';
        } else if (cart.length > 0) {
            exportLabel = 'esporta carrello ↓';
        }
        var exportSpan = exportLabel ? ' <span style="float:right;font-size:0.62rem;color:#888;cursor:pointer;text-decoration:underline;" onclick="exportFilteredIngredientsTXT()" title="Esporta in TXT">' + exportLabel + '</span>' : '';
        document.getElementById('ingListCount').innerHTML = count + ' ingredienti' + exportSpan;
    }
    
    function toggleIngFilter(filter) {
        const btns = document.querySelectorAll('.ing-filter');
        
        ingFilter = filter;
        btns.forEach(b => {
            const f = b.dataset.famiglia;
            const isCart = b.classList.contains('cart-filter');
            if (filter === null) {
                b.classList.toggle('active', f === 'ALL');
            } else if (filter === 'cart') {
                b.classList.toggle('active', isCart);
            } else {
                b.classList.toggle('active', f === filter);
            }
        });
        
        // Mostra box FAMIGLIA_INFO se selezionata una famiglia specifica
        showFamigliaInfo(filter);
        
        // Reset selezione ingrediente quando cambia filtro
        selectedIngredient = null;
        document.getElementById('ingDetailContent').innerHTML = '<div class="ing-detail-empty">Seleziona un ingrediente</div>';
        
        renderIngredientList();
        if (filter === 'cart' && cart.length > 0) {
            showIngredientDetail(cart[0].id);
        }
    }
    
    
    // v89: FAMIGLIA_INFO esteso per POLICATIONE (fallback se non nel DB)
    const POLICATIONE_INFO_FALLBACK = {
        nome_display: "Policationi (Chitosano)",
        descrizione: "Polimeri con CARICA POSITIVA – rari in natura. Il chitosano è l'unico policatione naturale accessibile per uso didattico. Deriva dalla chitina (esoscheletri di crostacei) tramite deacetilazione, che espone gruppi amminici (-NH₃⁺) carichi positivamente.",
        sottocategorie: {
            "chitosano": "Unico policatione naturale accessibile – da crostacei o funghi"
        },
        confronto_rapido: {
            "chitosano": "Antibatterico naturale, film resistenti, richiede pH acido (aceto) per sciogliersi. Da crostacei o fonte fungina (vegano)."
        },
        quando_usare: {
            "packaging_attivo": "Chitosano – proprietà antimicrobiche naturali",
            "film_antibatterico": "Chitosano + plastificante (glicerina 15-20%)",
            "coating_protettivo": "Chitosano in soluzione acida, applicare a pennello",
            "vegano": "Esistono fonti di chitosano FUNGINO (da Aspergillus niger)"
        },
        note_processo: "Il chitosano NON si scioglie in acqua pura – richiede ambiente acido (aceto 1-2% o acido citrico). Una volta disciolto, il film si forma per evaporazione e neutralizzazione.",
        avvisi: [
            "Chitosano da crostacei NON è vegano – cercare fonte fungina se necessario",
            "Richiede SEMPRE acido per sciogliersi (aceto, acido citrico)",
            "La carica positiva lo rende incompatibile con polianioni in miscela diretta (forma coacervati)"
        ],
        nota_didattica: "I policationi sono molecole con carica elettrica positiva. Sono rarissimi in natura perché la maggior parte dei biopolimeri è neutra o carica negativamente. Il chitosano è l'eccezione: deriva dalla deacetilazione della chitina che espone gruppi -NH₂ che in ambiente acido diventano -NH₃⁺. Questa carica positiva è responsabile delle proprietà antibatteriche (le membrane batteriche sono cariche negativamente) e della capacità di formare complessi con polimeri anionici (alginato, pectina). Altri policationi esistono (polilisina, protamina) ma sono sintetici, farmaceutici o molto costosi – non accessibili per laboratori didattici."
    };
    
function showFamigliaInfo(famiglia) {
        const box = document.getElementById('famigliaInfoBox');
        if (!box) return;
        
        // Nascondi se "Tutti", "Carrello" o nessuna selezione
        if (!famiglia || famiglia === 'cart') {
            box.style.display = 'none';
            return;
        }
        
        // Mappa filtri UI a chiavi FAMIGLIA_INFO
        const mappaFamiglie = {
            'PROTEINA': 'PROTEINA',
            'POLISACCARIDE': 'POLISACCARIDE_NEUTRO',
            'POLICATIONE': 'POLICATIONE',
            'PLASTIFICANTE': 'PLASTIFICANTE',
            'LIPIDE': 'LIPIDE',
            'SALE_RETICOLANTE': 'SALE_RETICOLANTE',
            'CARICA': 'CARICA',
            'COLORANTE': 'COLORANTE',
            'ADDITIVO': 'ADDITIVO',
            'COLTURA': 'COLTURA'
        };
        
        const famigliaKey = mappaFamiglie[famiglia] || famiglia;
        const info = (typeof FAMIGLIA_INFO !== 'undefined' && FAMIGLIA_INFO[famigliaKey]) 
            ? FAMIGLIA_INFO[famigliaKey] 
            : (famigliaKey === 'POLICATIONE' ? POLICATIONE_INFO_FALLBACK : null);
        
        if (!info) {
            box.style.display = 'none';
            return;
        }
        
        box.style.display = 'block';
        document.getElementById('famigliaInfoTitle').textContent = info.nome_display || famiglia;
        document.getElementById('famigliaDesc').textContent = info.descrizione || '';
        
        // Confronto rapido (i dati sono stringhe)
        let confrontoHtml = '<div class="famiglia-confronto-title">Confronto rapido</div>';
        if (info.confronto_rapido) {
            for (const [nome, descrizione] of Object.entries(info.confronto_rapido)) {
                // descrizione e' una stringa diretta
                const desc = typeof descrizione === 'string' ? descrizione : (descrizione.desc || '');
                confrontoHtml += '<div class="famiglia-confronto-item">' +
                    '<span class="famiglia-confronto-nome">' + nome + '</span>' +
                    '<span class="famiglia-confronto-desc">' + desc + '</span>' +
                    '</div>';
            }
        }
        document.getElementById('famigliaConfronto').innerHTML = confrontoHtml;
        
        // Quando usare
        let quandoHtml = '<div class="famiglia-quando-title">Quando usare</div>';
        if (info.quando_usare) {
            for (const [uso, ricetta] of Object.entries(info.quando_usare)) {
                quandoHtml += '<div class="famiglia-quando-item"><strong>' + uso.replace(/_/g, ' ') + ':</strong> ' + ricetta + '</div>';
            }
        }
        document.getElementById('famigliaQuando').innerHTML = quandoHtml;
        
        // Avvisi
        let avvisiHtml = '';
        if (info.avvisi && info.avvisi.length > 0) {
            avvisiHtml = '<div class="famiglia-avvisi-title">Attenzione</div><ul>';
            info.avvisi.forEach(a => { avvisiHtml += '<li>' + a + '</li>'; });
            avvisiHtml += '</ul>';
        }
        document.getElementById('famigliaAvvisi').innerHTML = avvisiHtml;
        
        // v89: Mostra nota didattica se presente (es: POLICATIONE)
        let notaDidatticaHtml = '';
        if (info.nota_didattica) {
            notaDidatticaHtml = '<div class="famiglia-nota-didattica"><div class="famiglia-nota-title">Perché una famiglia separata?</div><p>' + info.nota_didattica + '</p></div>';
        }
        const notaBox = document.getElementById('famigliaNotaDidattica');
        if (notaBox) notaBox.innerHTML = notaDidatticaHtml;
        else if (notaDidatticaHtml) {
            // Crea il box se non esiste
            const container = document.getElementById('famigliaInfoContent');
            if (container) {
                let existingNota = container.querySelector('.famiglia-nota-didattica');
                if (!existingNota) {
                    container.insertAdjacentHTML('beforeend', '<div id="famigliaNotaDidattica">' + notaDidatticaHtml + '</div>');
                } else {
                    existingNota.outerHTML = '<div id="famigliaNotaDidattica">' + notaDidatticaHtml + '</div>';
                }
            }
        }
    }
    
    function toggleFamigliaBox() {
        const content = document.getElementById('famigliaInfoContent');
        const toggle = document.querySelector('.famiglia-info-toggle');
        if (content.classList.contains('collapsed')) {
            content.classList.remove('collapsed');
            toggle.textContent = '[-]';
        } else {
            content.classList.add('collapsed');
            toggle.textContent = '[+]';
        }
    }
    
    function filterIngredients() { renderIngredientList(); }
    
    
// v89: Dati modalità d'uso per ingredienti articolati
const MODALITA_USO = {
    'scoby': {
        titolo: "Tre vite in un ingrediente",
        fasi: [
            { fase: "Durante la crescita", icona: "1.", azioni: ["Coloranti nel substrato - film cresce già colorato", "Forma del contenitore - stampa la forma crescendola", "pH e temperatura - modificano texture finale"], nota: "2-4 settimane di crescita, ambiente acido naturale" },
            { fase: "Come rinforzo (frullato)", icona: "2.", azioni: ["SCOBY di scarto frullato - carica fibrosa", "Aggiunto a Guar/Xantana - materiale simil-cuoio", "Nanofibre si intrecciano con catene polisaccaridiche"], nota: "Seconda vita per SCOBY vecchi o ritagli" },
            { fase: "Come supporto (post-crescita)", icona: "3.", azioni: ["Immersione in olio/cera - impermeabilizzazione", "Concia con tannini - più resistente e stabile", "Colorazione a pennello - decorazione superficiale", "Pressatura a caldo - compatta e liscia"], nota: "L'aceto è amico dello SCOBY (pH naturale)" }
        ],
        avviso: "Le fasi NON sono intercambiabili - ogni timing apre possibilità diverse"
    },
    'micelio': {
        titolo: "Cresce digerendo, poi si tratta",
        fasi: [
            { fase: "Durante la crescita", icona: "1.", azioni: ["Il substrato (segatura, caffè, paglia) DIVENTA il materiale", "Il micelio DIGERISCE la lignina con enzimi specifici", "Forma e densità dipendono da contenitore e compressione"], nota: "1-3 settimane, il fungo è VIVO e sensibile" },
            { fase: "Cottura (morte del fungo)", icona: "2.", azioni: ["60-80°C per uccidere il micelio", "La struttura ifale resta ma non cresce più", "Da questo momento è un materiale inerte"], nota: "Passaggio obbligatorio prima di qualsiasi trattamento" },
            { fase: "Post-cottura (trattamenti)", icona: "3.", azioni: ["Cere e oli - impermeabilizzazione", "Tannini - aumento resistenza", "Pressatura a caldo - compattazione", "Rivestimento con SCOBY - finitura liscia"], nota: "Solo DOPO la cottura puoi usare acidi e trattamenti aggressivi" }
        ],
        avviso: "MAI aceto/limone durante la crescita - uccidono il fungo!"
    },
    'albumina': {
        titolo: "Tre stati, tre materiali diversi",
        fasi: [
            { fase: "Liquida (cruda)", icona: "1.", azioni: ["Emulsionante - stabilizza miscele acqua-olio", "Adesivo - legante per pigmenti (tempera)", "Coating - film sottile protettivo"], nota: "Sotto i 60°C resta liquida e reversibile" },
            { fase: "Montata (schiuma)", icona: "2.", azioni: ["Incorpora aria - schiuma stabile", "Denaturazione parziale delle proteine", "Essiccabile mantenendo struttura porosa"], nota: "Base per materiali leggeri e isolanti" },
            { fase: "Cotta (termoindurente)", icona: "3.", azioni: ["Sopra 60-70°C - denaturazione IRREVERSIBILE", "Diventa solida, opaca, stabile", "Non tornerà mai più liquida"], nota: "Pianifica la forma finale PRIMA di scaldare!" }
        ],
        avviso: "La cottura è irreversibile - una volta cotta non si torna indietro"
    },
    'caseina': {
        titolo: "Dal latte alla plastica in tre fasi",
        fasi: [
            { fase: "Precipitazione", icona: "1.", azioni: ["Latte caldo + acido (aceto/limone)", "pH scende sotto 5 - caseina precipita", "Si formano grumi bianchi (cagliata)"], nota: "Stessa chimica del formaggio" },
            { fase: "Modellazione", icona: "2.", azioni: ["Cagliata scolata ancora morbida", "Con calore (50-60°C) diventa modellabile", "Aggiungere coloranti, cariche, plastificanti"], nota: "Finestra temporale limitata - lavorare rapidamente" },
            { fase: "Indurimento (reticolazione)", icona: "3.", azioni: ["Immersione in allume (5-10%) per 24-48h", "Oppure tannini per effetto simile", "Risultato: Galalite - plastica dura, lucidabile"], nota: "Storicamente usata per bottoni, pettini, gioielli" }
        ],
        avviso: "Le tre fasi sono sequenziali e non reversibili"
    },
    'alginato': {
        titolo: "Il timing è tutto",
        fasi: [
            { fase: "Soluzione (senza calcio)", icona: "1.", azioni: ["Alginato in acqua - liquido viscoso", "Può essere colorato, addensato, miscelato", "Stabile indefinitamente se senza Ca"], nota: "Preparare sempre SEPARATAMENTE dal calcio" },
            { fase: "Gelificazione (contatto con calcio)", icona: "2.", azioni: ["Bagno di CaCl2 - gelifica dalla superficie", "Gocce - sfere (sferificazione)", "Film - gel con bordi gelificati prima"], nota: "Reazione ISTANTANEA e IRREVERSIBILE" },
            { fase: "Rilascio controllato (alternativa)", icona: "3.", azioni: ["Lattato di calcio invece di CaCl2", "Rilascia ioni più lentamente", "Permette miscelazione prima della gelificazione"], nota: "Per film uniformi senza bordi prematuramente gelificati" }
        ],
        avviso: "MAI mescolare alginato + CaCl2 direttamente - grumi istantanei!"
    },
    'olio_lino': {
        titolo: "Non asciuga, polimerizza",
        fasi: [
            { fase: "Applicazione", icona: "1.", azioni: ["Stendere a pennello o immersione", "Penetra nel materiale (legno, fibre)", "Strati sottili multipli meglio di strato unico spesso"], nota: "Diventa parte della struttura, non un coating superficiale" },
            { fase: "Polimerizzazione", icona: "2.", azioni: ["Reagisce con ossigeno dell'aria", "GIORNI-SETTIMANE per indurire", "Non accelerabile significativamente"], nota: "È una reazione chimica, non evaporazione" }
        ],
        avviso: "PERICOLO: stracci imbevuti possono AUTO-INCENDIARSI! Stendere all'aperto o immergere in acqua."
    },
    'olio_tung': {
        titolo: "Siccativo veloce e resistente",
        fasi: [
            { fase: "Applicazione", icona: "1.", azioni: ["Stendere con guanti (irritante fresco)", "Penetra meno dell'olio di lino", "Più resistente all'acqua"], nota: "Più costoso ma più veloce e resistente" },
            { fase: "Polimerizzazione", icona: "2.", azioni: ["ORE-GIORNI (molto più veloce del lino)", "Forma film più duro", "Migliore resistenza all'umidità"], nota: "Ideale quando serve velocità" }
        ],
        avviso: "Usare guanti - irritante per la pelle quando fresco"
    },
    'tannini': {
        titolo: "L'effetto dipende dalla matrice",
        fasi: [
            { fase: "Su PROTEINE", icona: "A.", azioni: ["Forma legami stabili - CONCIA", "Gelatina diventa simil-cuoio", "Più resistente all'acqua e al calore"], nota: "Effetto collaterale: scurisce (marrone)" },
            { fase: "Su POLISACCARIDI neutri", icona: "B.", azioni: ["Poca affinità chimica", "Effetto minimo o nullo", "Non aspettarti reticolazione"], nota: "Amido e agar non rispondono ai tannini" },
            { fase: "Su POLIANIONI", icona: "C.", azioni: ["Può formare precipitati", "Con alginato: possibili problemi", "Testare sempre prima su piccola scala"], nota: "Reazione non sempre utile" }
        ],
        avviso: "Funziona davvero solo su proteine - non è un reticolante universale"
    },
    'gelatina': {
        titolo: "Termoreversibile con eccezioni",
        fasi: [
            { fase: "Soluzione calda", icona: "1.", azioni: ["Sciogliere in acqua 50-60°C", "Aggiungere plastificanti, coloranti", "Versare in stampo sopra 35°C"], nota: "Non superare 60°C (degrada le proteine)" },
            { fase: "Gelificazione", icona: "2.", azioni: ["Sotto 15-20°C - gel elastico", "Processo reversibile (rifonde a 30-35°C)", "Film flessibile dopo essiccazione"], nota: "Termoreversibile = puoi rifondere e ricolare" },
            { fase: "Reticolazione (opzionale)", icona: "3.", azioni: ["Tannini - simil-cuoio, più stabile", "Dopo reticolazione NON è più termoreversibile"], nota: "La reticolazione cambia tutto - non si torna indietro" }
        ],
        avviso: "Senza reticolazione fonde a 30-35°C - attenzione in estate!"
    }
};

function renderModalitaUso(ingredientId) {
    const mod = MODALITA_USO[ingredientId];
    if (!mod) return '';
    
    let html = '<div class="modalita-uso-section">';
    html += '<div class="modalita-uso-title">MODALITA DI USO: ' + mod.titolo + '</div>';
    
    mod.fasi.forEach(function(fase) {
        html += '<div class="modalita-fase">';
        html += '<div class="fase-header">';
        html += '<span class="fase-icona">' + fase.icona + '</span>';
        html += '<span class="fase-nome">' + fase.fase + '</span>';
        html += '</div>';
        html += '<ul class="fase-azioni">';
        fase.azioni.forEach(function(a) {
            html += '<li>' + a + '</li>';
        });
        html += '</ul>';
        if (fase.nota) {
            html += '<div class="fase-nota">Nota: ' + fase.nota + '</div>';
        }
        html += '</div>';
    });
    
    if (mod.avviso) {
        html += '<div class="modalita-avviso">! ' + mod.avviso + '</div>';
    }
    
    html += '</div>';
    return html;
}

function showIngredientDetail(id) {
        selectedIngredient = id;
        var ings = INGREDIENTI_DATA?.ingredienti || {};
        var ing = ings[id];
        if (!ing) return;
        
        renderIngredientList();
        
        var panel = document.getElementById('ingDetailContent');
        var inCart = cart.find(function(c) { return c.id === id; });
        var dotClass = getCategoryClass(ing.famiglia);
        var props = ing.proprieta || {};
        var params = ing.parametri || {};
        var lav = ing.lavorabilita || {};
        var dur = ing.durabilita || {};
        var dos = ing.dosaggio_tipico || {};
        
        // === Helpers ===
        function pv(label, value, suffix) {
            if (value === undefined || value === null || value === '') return '';
            return '<div class="ing-prop"><div class="label">' + label + '</div><div class="value">' + value + (suffix || '') + '</div></div>';
        }
        function boolRow(label, val, note) {
            if (val === undefined || val === null) return '';
            var icon = val ? '<span class="check">Si</span>' : '<span class="cross">No</span>';
            return '<div class="ing-bool-item">' + icon + '<span class="label">' + label + '</span>' + (note ? '<span class="note">' + note + '</span>' : '') + '</div>';
        }
        function makeTags(arr) {
            if (!arr || !arr.length) return '';
            return '<div class="ing-tags">' + arr.map(function(x) { return '<span class="tag info">' + x + '</span>'; }).join('') + '</div>';
        }
        function makeList(arr, cls) {
            if (!arr || !arr.length) return '';
            return '<ul class="' + (cls || 'ing-process') + '">' + arr.map(function(x) { return '<li>' + x + '</li>'; }).join('') + '</ul>';
        }
        function makeSection(title, content, extraClass) {
            if (!content) return '';
            return '<div class="ing-detail-section' + (extraClass ? ' ' + extraClass : '') + '"><h3>' + title + '</h3>' + content + '</div>';
        }
        function gridFromPairs(pairs) {
            var cells = '';
            pairs.forEach(function(p) { cells += pv(p[0], p[1], p[2]); });
            return cells ? '<div class="ing-props-grid">' + cells + '</div>' : '';
        }
        function boolGrid(items) {
            var cells = '';
            items.forEach(function(i) { cells += boolRow(i[0], i[1], i[2]); });
            return cells ? '<div class="ing-bool-grid">' + cells + '</div>' : '';
        }
        function arrOrStr(v) {
            return Array.isArray(v) ? v.join(', ') : (v || '');
        }
        
        // === BUILD HTML ===
        var h = '';
        
        // --- HEADER ---
        h += '<div class="ing-detail-header">';
        h += '<div class="header-left">';
        h += '<h2>' + ing.nome;
        if (ing.nome_scientifico) h += ' <small style="font-weight:normal;color:#888;font-size:0.7em">(' + ing.nome_scientifico + ')</small>';
        h += '</h2>';
        h += '<div class="badges">';
        h += '<span class="famiglia-badge"><span class="dot ' + dotClass + '" style="display:inline-block;margin-right:5px;"></span>' + formatFamiglia(ing.famiglia) + '</span>';
        if (ing.sottofamiglia) h += '<span class="tag info" style="font-size:0.65rem;">' + ing.sottofamiglia + '</span>';
        if (ing.categoria) h += '<span class="tag info">' + ing.categoria + '</span>';
        if (ing.vegano) h += '<span class="tag ok">Vegano</span>';
        if (ing.food_safe) h += '<span class="tag ok">Food-safe</span>';
        if (ing.biodegradabile || dur.biodegradabile) h += '<span class="tag ok">Biodegradabile</span>';
        if (dur.compostabile) h += '<span class="tag ok">Compostabile</span>';
        h += '</div></div>';
        h += '<div class="header-right ing-actions">';
        h += '<button class="btn ' + (inCart ? 'btn-secondary' : 'btn-primary') + '" onclick="' + (inCart ? "removeFromCartById('" + id + "')" : "addToCartById('" + id + "')") + '">' + (inCart ? 'Nel carrello' : '+ Aggiungi') + '</button>';
        if (inCart) h += ' <button class="btn btn-primary" onclick="addToTavolo(\'' + id + '\'); showPanel(\'C\');">Metti sul tavolo</button>';
        h += ' <button class="btn btn-secondary" onclick="exportIngredientTXT(\'' + id + '\')" title="Esporta scheda TXT" style="font-size:0.7rem;padding:0.3rem 0.6rem;">TXT</button>';
        h += '</div></div>';
        
        h += '<div class="ing-detail-body">';
        
        // --- DESCRIZIONE ---
        var desc = ing.descrizione || ing.funzione || ing.funzione_primaria || '-';
        var descExtra = '';
        if (ing.funzione_primaria && ing.descrizione) descExtra += '<br><strong>Funzione primaria:</strong> ' + ing.funzione_primaria;
        if (ing.funzione && ing.descrizione && ing.funzione !== ing.descrizione) descExtra += '<br><strong>Funzione:</strong> ' + ing.funzione;
        if (ing.ruolo) descExtra += '<br><strong>Ruolo:</strong> ' + ing.ruolo;
        if (ing.note_uso) descExtra += '<div class="ing-note-box">' + ing.note_uso + '</div>';
        h += makeSection('Descrizione', '<p class="ing-desc">' + desc + descExtra + '</p>');
        
        // --- PROPRIETA FISICHE ---
        h += makeSection('Proprieta', gridFromPairs([
            ['Trasparenza', props.trasparenza],
            ['Flessibilita', props.flessibilita],
            ['Barriera H2O', props.barriera_H2O],
            ['Barriera O2', props.barriera_O2],
            ['Struttura', props.struttura],
            ['Colore', props.colore],
            ['Solubilita', props.solubilita],
            ['Conducibilita', props.conducibilita],
            ['Densita', props.densita],
            ['Modulo elastico', props.modulo_elastico],
            ['Resistenza tensile', props.resistenza_tensile],
            ['Viscosita', props.viscosita],
            ['pH', props.ph || props.pH],
            ['pH soluzione', props.pH_soluzione],
            ['Punto ebollizione', props.punto_ebollizione],
            ['Punto fumo', props.punto_fumo],
            ['T ottimale', props.temperatura_ottimale],
            ['Tempo indurimento', props.tempo_indurimento],
            ['Gelatinizzazione', props.gelatinizzazione],
            ['Contenuto pectina', props.contenuto_pectina],
            ['Composizione', props.composizione],
            ['Profumo', props.profumo],
            ['Antibatterico', props.antibatterico === true ? 'Si' : (props.antibatterico === false ? 'No' : props.antibatterico)],
            ['Fonte', ing.fonte],
            ['Reperibilita', ing.reperibilita],
            ['Costo indicativo', ing.costo_indicativo]
        ]));
        
        // --- PARAMETRI TECNICI ---
        var pp = [];
        if (params.range_percent_min != null) pp.push(['Concentrazione', params.range_percent_min + '-' + params.range_percent_max + '%']);
        if (params.temp_dissoluzione) pp.push(['T dissoluzione', params.temp_dissoluzione + '\u00b0C']);
        else if (params.temp_dissoluzione_min) pp.push(['T dissoluzione', params.temp_dissoluzione_min + '-' + params.temp_dissoluzione_max + '\u00b0C']);
        if (params.temp_gelatinizzazione) pp.push(['T gelatinizzazione', params.temp_gelatinizzazione + '\u00b0C']);
        else if (params.temp_gelatinizzazione_min) pp.push(['T gelatinizzazione', params.temp_gelatinizzazione_min + '-' + params.temp_gelatinizzazione_max + '\u00b0C']);
        if (params.temp_fusione_gel != null) pp.push(['T fusione gel', params.temp_fusione_gel + '\u00b0C']);
        if (params.temp_gelificazione != null) pp.push(['T gelificazione', params.temp_gelificazione + '\u00b0C']);
        if (params.pH_min != null) pp.push(['Range pH', params.pH_min + ' - ' + params.pH_max]);
        if (params.temp_Tg) pp.push(['Tg (transizione vetrosa)', params.temp_Tg + '\u00b0C']);
        if (params.temp_degradazione) pp.push(['T degradazione', params.temp_degradazione + '\u00b0C']);
        if (params.concentrazione_tipica) pp.push(['Concentrazione tipica', params.concentrazione_tipica]);
        if (params.velocita_gel) pp.push(['Velocita gel', params.velocita_gel]);
        if (params.strati) pp.push(['Strati consigliati', params.strati]);
        if (params.applicazione) pp.push(['Applicazione', params.applicazione]);
        if (params.plastificanti) pp.push(['Plastificanti', arrOrStr(params.plastificanti)]);
        if (params.tipi) {
            if (params.tipi.HM) pp.push(['Tipo HM', params.tipi.HM]);
            if (params.tipi.LM) pp.push(['Tipo LM', params.tipi.LM]);
        }
        if (dos.min != null) pp.push(['Dosaggio tipico', dos.min + ' - ' + dos.max + (dos.unita ? ' ' + dos.unita : '')]);
        h += makeSection('Parametri tecnici', gridFromPairs(pp));
        
        // --- LAVORABILITA ---
        var lavHtml = '';
        var forme = lav.forma_tipica || ing.forma_output;
        if (forme && forme.length) {
            lavHtml += '<p class="ing-desc" style="margin-bottom:0.3rem;"><strong>Forme ottenibili:</strong></p>' + makeTags(forme);
        }
        if (lav.note_forma) lavHtml += '<p class="ing-desc" style="margin-top:0.4rem;font-style:italic;">' + lav.note_forma + '</p>';
        if (lav.effetto_su_matrice) lavHtml += '<p class="ing-desc" style="margin-top:0.4rem;"><strong>Effetto sulla matrice:</strong> ' + lav.effetto_su_matrice + '</p>';
        var bools = boolGrid([
            ['Termosaldabile', lav.termosaldabile, (lav.temp_saldatura_min ? lav.temp_saldatura_min + '-' + lav.temp_saldatura_max + '\u00b0C' : null)],
            ['Cucibile', lav.cucibile, null],
            ['Colorabile', lav.colorabile, null],
            ['Reversibile', lav.reversibile, null],
            ['Stampabile 3D', lav.stampabile_3D, null]
        ]);
        if (bools) lavHtml += '<div style="margin-top:0.5rem;">' + bools + '</div>';
        if (lav.incollabile_con) lavHtml += '<p class="ing-desc" style="margin-top:0.4rem;"><strong>Incollabile con:</strong> ' + arrOrStr(lav.incollabile_con) + '</p>';
        if (lav.metodo_colorazione) lavHtml += '<p class="ing-desc" style="margin-top:0.3rem;"><strong>Metodo colorazione:</strong> ' + lav.metodo_colorazione + '</p>';
        if (lav.note_cucibilita) lavHtml += '<p class="ing-desc" style="margin-top:0.3rem;"><strong>Note cucibilita:</strong> ' + lav.note_cucibilita + '</p>';
        if (lav.note_stampabilita) lavHtml += '<p class="ing-desc" style="margin-top:0.3rem;"><strong>Note stampa 3D:</strong> ' + lav.note_stampabilita + '</p>';
        if (lav.note_colore) lavHtml += '<p class="ing-desc" style="margin-top:0.3rem;"><strong>Note colore:</strong> ' + lav.note_colore + '</p>';
        if (lav.note_reversibilita) lavHtml += '<p class="ing-desc" style="margin-top:0.3rem;"><strong>Note reversibilita:</strong> ' + lav.note_reversibilita + '</p>';
        h += makeSection('Lavorabilita', lavHtml);
        
        // --- DURABILITA ---
        var durHtml = '';
        if (dur.durata_stimata) durHtml += '<p class="ing-desc"><strong>Durata stimata:</strong> ' + dur.durata_stimata + '</p>';
        var durBools = boolGrid([
            ['Biodegradabile', dur.biodegradabile],
            ['Compostabile', dur.compostabile]
        ]);
        if (durBools) durHtml += durBools;
        if (dur.fattori_degradazione) durHtml += '<p class="ing-desc" style="margin-top:0.4rem;"><strong>Fattori degradazione:</strong> ' + arrOrStr(dur.fattori_degradazione) + '</p>';
        if (dur.condizioni_conservazione) durHtml += '<p class="ing-desc" style="margin-top:0.3rem;"><strong>Conservazione:</strong> ' + dur.condizioni_conservazione + '</p>';
        if (dur.effetto_su_durabilita) durHtml += '<p class="ing-desc" style="margin-top:0.3rem;"><strong>Effetto:</strong> ' + dur.effetto_su_durabilita + '</p>';
        if (dur.nota) durHtml += '<div class="ing-note-box">' + dur.nota + '</div>';
        h += makeSection('Durabilita', durHtml, 'durabilita');
        
        // --- PROCESSO ---
        h += makeSection('Processo', makeList(ing.processo));
        if (ing.fase_utilizzo) {
            var faseHtml = '';
            if (ing.fase_utilizzo.durante_crescita) faseHtml += '<p class="ing-desc"><strong>Durante crescita:</strong> ' + ing.fase_utilizzo.durante_crescita + '</p>';
            if (ing.fase_utilizzo.post_processing) faseHtml += '<p class="ing-desc"><strong>Post-processing:</strong> ' + ing.fase_utilizzo.post_processing + '</p>';
            h += makeSection('Fasi di utilizzo', faseHtml);
        }
        
        // --- COMPATIBILITA ---
        var compHtml = '';
        if (ing.incompatibilita) compHtml += '<p class="ing-desc" style="margin-bottom:0.3rem;"><strong>Incompatibilita:</strong></p>' + makeList(Array.isArray(ing.incompatibilita) ? ing.incompatibilita : [ing.incompatibilita], 'ing-incompat-list');
        if (ing.sinergie) compHtml += '<p class="ing-desc" style="margin-top:0.4rem;"><strong>Sinergie:</strong></p>' + makeTags(Array.isArray(ing.sinergie) ? ing.sinergie : [ing.sinergie]);
        if (ing.alternative) compHtml += '<p class="ing-desc" style="margin-top:0.4rem;"><strong>Alternative:</strong> ' + ing.alternative + '</p>';
        if (ing.interazioni_specifiche) {
            compHtml += '<p class="ing-desc" style="margin-top:0.5rem;"><strong>Interazioni specifiche:</strong></p>';
            Object.keys(ing.interazioni_specifiche).forEach(function(key) {
                var inter = ing.interazioni_specifiche[key];
                var label = key.replace(/^con_/, '').replace(/_/g, ' ');
                label = label.charAt(0).toUpperCase() + label.slice(1);
                if (typeof inter === 'object' && (inter.compatibilita || inter.meccanismo)) {
                    compHtml += '<div style="margin:0.3rem 0 0.3rem 0.5rem;font-size:0.8rem;">';
                    compHtml += '<strong>' + label + '</strong>';
                    if (inter.compatibilita) compHtml += ' &mdash; <em>' + inter.compatibilita + '</em>';
                    if (inter.meccanismo) compHtml += '<br><span style="color:#555;">' + inter.meccanismo + '</span>';
                    if (inter.risultato) compHtml += '<br><span style="color:#555;">' + inter.risultato + '</span>';
                    if (inter.uso) compHtml += '<br><span style="color:#555;">Uso: ' + inter.uso + '</span>';
                    if (inter.regola) compHtml += '<br><span style="color:#c62828;">' + inter.regola + '</span>';
                    if (inter.limite) compHtml += '<br><span style="color:#c62828;">' + inter.limite + '</span>';
                    if (inter.uso_corretto) compHtml += '<br><span style="color:#2e7d32;">' + inter.uso_corretto + '</span>';
                    compHtml += '</div>';
                } else if (typeof inter === 'object') {
                    compHtml += '<div style="margin:0.3rem 0 0.3rem 0.5rem;font-size:0.8rem;"><strong>' + label + ':</strong></div>';
                    Object.keys(inter).forEach(function(subkey) {
                        var sub = inter[subkey];
                        var subLabel = subkey.replace(/_/g, ' ');
                        subLabel = subLabel.charAt(0).toUpperCase() + subLabel.slice(1);
                        compHtml += '<div style="margin:0.2rem 0 0.2rem 1rem;font-size:0.78rem;">';
                        compHtml += '<strong>' + subLabel + ':</strong> ' + (typeof sub === 'string' ? sub : JSON.stringify(sub));
                        compHtml += '</div>';
                    });
                }
            });
        }
        h += makeSection('Compatibilita e interazioni', compHtml, 'compatibilita');
        
        // v89: Sezione Modalità d'uso per ingredienti articolati (PRIMA di Dove acquistare)
        h += renderModalitaUso(id);
        
        // --- DOVE ACQUISTARE ---
        var acqHtml = '';
        if (ing.acquisto) acqHtml += '<p class="ing-desc">' + ing.acquisto + '</p>';
        if (ing.fonti_comuni) acqHtml += '<p class="ing-desc" style="margin-top:0.3rem;"><strong>Fonti comuni:</strong> ' + arrOrStr(ing.fonti_comuni) + '</p>';
        h += makeSection('Dove acquistare', acqHtml);
        
        // --- AVVERTENZE ---
        var warnItems = [];
        if (ing.warnings && ing.warnings.length) warnItems = warnItems.concat(ing.warnings);
        if (ing.avvertenze) warnItems = warnItems.concat(Array.isArray(ing.avvertenze) ? ing.avvertenze : [ing.avvertenze]);
        h += makeSection('Attenzione', makeList(warnItems, 'ing-warnings-list'), 'ing-warnings');
        
        // --- NOTE E RIFERIMENTI ---
        var noteHtml = '';
        if (ing.note) noteHtml += '<p class="ing-desc">' + ing.note + '</p>';
        if (ing.trasparenza && !props.trasparenza) noteHtml += '<p class="ing-desc"><strong>Trasparenza:</strong> ' + ing.trasparenza + '</p>';
        if (ing.vantaggi_vs_CaCl2) noteHtml += '<p class="ing-desc" style="margin-top:0.3rem;"><strong>Vantaggi vs CaCl2:</strong> ' + arrOrStr(ing.vantaggi_vs_CaCl2) + '</p>';
        if (ing.fonti) noteHtml += '<p class="ing-desc" style="margin-top:0.3rem;"><strong>Fonti scientifiche:</strong> ' + arrOrStr(ing.fonti) + '</p>';
        if (ing.applicazioni) noteHtml += '<p class="ing-desc" style="margin-top:0.3rem;"><strong>Applicazioni:</strong> ' + arrOrStr(ing.applicazioni) + '</p>';
        if (ing.applicazioni_avanzate) {
            Object.keys(ing.applicazioni_avanzate).forEach(function(key) {
                var label = key.charAt(0).toUpperCase() + key.slice(1).replace(/_/g, ' ');
                noteHtml += '<p class="ing-desc" style="margin-top:0.3rem;"><strong>' + label + ':</strong> ' + ing.applicazioni_avanzate[key] + '</p>';
            });
        }
        h += makeSection('Note e riferimenti', noteHtml);
        
        // v89: renderModalitaUso già chiamata sopra (prima di "Dove acquistare")
        
        h += '</div>'; // close ing-detail-body
        panel.innerHTML = sanitizeNull(h);
    }
    
    // v80: Export TXT scheda ingrediente
    function buildIngredientTXT(id) {
        var ings = (INGREDIENTI_DATA && INGREDIENTI_DATA.ingredienti) ? INGREDIENTI_DATA.ingredienti : {};
        var ing = ings[id];
        if (!ing) return null;
        
        var nl = '\r\n';
        var line = '▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪';
        var subline = '████████████████████████████████████████████████████████████';
        var t = '';
        
        function safe(v) { return (v !== undefined && v !== null && v !== '') ? String(v) : ''; }
        function arrStr(v) { return Array.isArray(v) ? v.join(', ') : safe(v); }
        function boolStr(v) { return v === true ? 'Sì' : (v === false ? 'No' : safe(v)); }
        function field(label, value) {
            var v = safe(value);
            if (!v) return '';
            return '  ' + label + ': ' + v + nl;
        }
        function section(title) {
            return nl + subline + nl + title.toUpperCase() + nl + subline + nl;
        }
        
        var props = ing.proprieta || {};
        var params = ing.parametri || {};
        var lav = ing.lavorabilita || {};
        var dur = ing.durabilita || {};
        var dos = ing.dosaggio_tipico || {};
        
        // HEADER
        t += line + nl;
        t += ing.nome;
        if (ing.nome_scientifico) t += ' (' + ing.nome_scientifico + ')';
        t += nl;
        t += line + nl;
        t += field('Famiglia', formatFamiglia(ing.famiglia));
        if (ing.sottofamiglia) t += field('Sottofamiglia', ing.sottofamiglia);
        if (ing.categoria) t += field('Categoria', ing.categoria);
        var tags = [];
        if (ing.vegano) tags.push('Vegano');
        if (ing.food_safe) tags.push('Food-safe');
        if (ing.biodegradabile || (dur && dur.biodegradabile)) tags.push('Biodegradabile');
        if (dur && dur.compostabile) tags.push('Compostabile');
        if (tags.length) t += field('Certificazioni', tags.join(', '));
        if (ing.fonte) t += field('Fonte', ing.fonte);
        if (ing.reperibilita) t += field('Reperibilità ', ing.reperibilita);
        if (ing.costo_indicativo) t += field('Costo indicativo', ing.costo_indicativo);
        
        // DESCRIZIONE
        t += section('Descrizione');
        if (ing.descrizione) t += '  ' + ing.descrizione + nl;
        if (ing.funzione_primaria && ing.funzione_primaria !== ing.descrizione) t += field('Funzione primaria', ing.funzione_primaria);
        if (ing.funzione && ing.funzione !== ing.descrizione) t += field('Funzione', ing.funzione);
        if (ing.ruolo) t += field('Ruolo', ing.ruolo);
        if (ing.note_uso) t += field('Note uso', ing.note_uso);
        
        // PROPRIETÀ
        var propFields = [
            ['Trasparenza', props.trasparenza], ['Flessibilità ', props.flessibilita],
            ['Barriera H2O', props.barriera_H2O], ['Barriera O2', props.barriera_O2],
            ['Struttura', props.struttura], ['Colore', props.colore],
            ['Solubilità ', props.solubilita], ['Conducibilità ', props.conducibilita],
            ['Densità ', props.densita], ['Modulo elastico', props.modulo_elastico],
            ['Resistenza tensile', props.resistenza_tensile], ['Viscosità ', props.viscosita],
            ['pH', props.ph || props.pH], ['pH soluzione', props.pH_soluzione],
            ['Punto ebollizione', props.punto_ebollizione], ['Punto fumo', props.punto_fumo],
            ['T ottimale', props.temperatura_ottimale], ['Tempo indurimento', props.tempo_indurimento],
            ['Gelatinizzazione', props.gelatinizzazione], ['Contenuto pectina', props.contenuto_pectina],
            ['Composizione', props.composizione], ['Profumo', props.profumo],
            ['Antibatterico', typeof props.antibatterico === 'boolean' ? boolStr(props.antibatterico) : props.antibatterico]
        ];
        var propText = '';
        propFields.forEach(function(pf) { propText += field(pf[0], pf[1]); });
        if (propText) t += section('Proprietà ') + propText;
        
        // PARAMETRI TECNICI
        var paramText = '';
        if (params.range_percent_min != null) paramText += field('Concentrazione', params.range_percent_min + '-' + params.range_percent_max + '%');
        if (params.temp_dissoluzione) paramText += field('T dissoluzione', params.temp_dissoluzione + '°C');
        else if (params.temp_dissoluzione_min) paramText += field('T dissoluzione', params.temp_dissoluzione_min + '-' + params.temp_dissoluzione_max + '°C');
        if (params.temp_gelatinizzazione) paramText += field('T gelatinizzazione', params.temp_gelatinizzazione + '°C');
        else if (params.temp_gelatinizzazione_min) paramText += field('T gelatinizzazione', params.temp_gelatinizzazione_min + '-' + params.temp_gelatinizzazione_max + '°C');
        if (params.temp_fusione_gel != null) paramText += field('T fusione gel', params.temp_fusione_gel + '°C');
        if (params.temp_gelificazione != null) paramText += field('T gelificazione', params.temp_gelificazione + '°C');
        if (params.pH_min != null) paramText += field('Range pH', params.pH_min + ' - ' + params.pH_max);
        if (params.temp_Tg) paramText += field('Tg (transizione vetrosa)', params.temp_Tg + '°C');
        if (params.temp_degradazione) paramText += field('T degradazione', params.temp_degradazione + '°C');
        if (params.concentrazione_tipica) paramText += field('Concentrazione tipica', params.concentrazione_tipica);
        if (params.velocita_gel) paramText += field('Velocità  gel', params.velocita_gel);
        if (params.strati) paramText += field('Strati consigliati', params.strati);
        if (params.applicazione) paramText += field('Applicazione', params.applicazione);
        if (params.plastificanti) paramText += field('Plastificanti', arrStr(params.plastificanti));
        if (params.tipi) {
            if (params.tipi.HM) paramText += field('Tipo HM', params.tipi.HM);
            if (params.tipi.LM) paramText += field('Tipo LM', params.tipi.LM);
        }
        if (dos.min != null) paramText += field('Dosaggio tipico', dos.min + ' - ' + dos.max + (dos.unita ? ' ' + dos.unita : ''));
        if (paramText) t += section('Parametri tecnici') + paramText;
        
        // LAVORABILITÀ
        var lavText = '';
        var forme = lav.forma_tipica || ing.forma_output;
        if (forme && forme.length) lavText += field('Forme ottenibili', arrStr(forme));
        if (lav.note_forma) lavText += field('Note forma', lav.note_forma);
        if (lav.effetto_su_matrice) lavText += field('Effetto su matrice', lav.effetto_su_matrice);
        if (lav.termosaldabile != null) {
            var ts = boolStr(lav.termosaldabile);
            if (lav.temp_saldatura_min) ts += ' (' + lav.temp_saldatura_min + '-' + lav.temp_saldatura_max + '°C)';
            lavText += field('Termosaldabile', ts);
        }
        if (lav.cucibile != null) lavText += field('Cucibile', boolStr(lav.cucibile));
        if (lav.colorabile != null) lavText += field('Colorabile', boolStr(lav.colorabile));
        if (lav.reversibile != null) lavText += field('Reversibile', boolStr(lav.reversibile));
        if (lav.stampabile_3D != null) lavText += field('Stampabile 3D', boolStr(lav.stampabile_3D));
        if (lav.incollabile_con) lavText += field('Incollabile con', arrStr(lav.incollabile_con));
        if (lav.metodo_colorazione) lavText += field('Metodo colorazione', lav.metodo_colorazione);
        if (lav.note_cucibilita) lavText += field('Note cucibilità ', lav.note_cucibilita);
        if (lav.note_stampabilita) lavText += field('Note stampa 3D', lav.note_stampabilita);
        if (lav.note_colore) lavText += field('Note colore', lav.note_colore);
        if (lav.note_reversibilita) lavText += field('Note reversibilità ', lav.note_reversibilita);
        if (lavText) t += section('Lavorabilità ') + lavText;
        
        // DURABILITÀ
        var durText = '';
        if (dur.durata_stimata) durText += field('Durata stimata', dur.durata_stimata);
        if (dur.biodegradabile != null) durText += field('Biodegradabile', boolStr(dur.biodegradabile));
        if (dur.compostabile != null) durText += field('Compostabile', boolStr(dur.compostabile));
        if (dur.fattori_degradazione) durText += field('Fattori degradazione', arrStr(dur.fattori_degradazione));
        if (dur.condizioni_conservazione) durText += field('Conservazione', dur.condizioni_conservazione);
        if (dur.effetto_su_durabilita) durText += field('Effetto', dur.effetto_su_durabilita);
        if (dur.nota) durText += field('Nota', dur.nota);
        if (durText) t += section('Durabilità ') + durText;
        
        // PROCESSO
        if (ing.processo && ing.processo.length) {
            t += section('Processo');
            ing.processo.forEach(function(step, i) { t += '  ' + (i + 1) + '. ' + step + nl; });
        }
        if (ing.fase_utilizzo) {
            if (ing.fase_utilizzo.durante_crescita) t += field('Durante crescita', ing.fase_utilizzo.durante_crescita);
            if (ing.fase_utilizzo.post_processing) t += field('Post-processing', ing.fase_utilizzo.post_processing);
        }
        
        // COMPATIBILITÀ
        var compText = '';
        if (ing.incompatibilita) compText += field('Incompatibilità ', arrStr(ing.incompatibilita));
        if (ing.sinergie) compText += field('Sinergie', arrStr(ing.sinergie));
        if (ing.alternative) compText += field('Alternative', ing.alternative);
        if (ing.interazioni_specifiche) {
            compText += '  Interazioni specifiche:' + nl;
            Object.keys(ing.interazioni_specifiche).forEach(function(key) {
                var inter = ing.interazioni_specifiche[key];
                var label = key.replace(/^con_/, '').replace(/_/g, ' ');
                label = label.charAt(0).toUpperCase() + label.slice(1);
                compText += '    ' + label;
                if (typeof inter === 'object') {
                    if (inter.compatibilita) compText += ' – ' + inter.compatibilita;
                    compText += nl;
                    if (inter.meccanismo) compText += '      Meccanismo: ' + inter.meccanismo + nl;
                    if (inter.risultato) compText += '      Risultato: ' + inter.risultato + nl;
                    if (inter.uso) compText += '      Uso: ' + inter.uso + nl;
                    if (inter.regola) compText += '      Regola: ' + inter.regola + nl;
                    if (inter.limite) compText += '      Limite: ' + inter.limite + nl;
                    if (inter.uso_corretto) compText += '      Uso corretto: ' + inter.uso_corretto + nl;
                } else {
                    compText += ': ' + safe(inter) + nl;
                }
            });
        }
        if (compText) t += section('Compatibilità  e interazioni') + compText;
        
        // ACQUISTO
        var acqText = '';
        if (ing.acquisto) acqText += field('Dove', ing.acquisto);
        if (ing.fonti_comuni) acqText += field('Fonti comuni', arrStr(ing.fonti_comuni));
        if (acqText) t += section('Dove acquistare') + acqText;
        
        // AVVERTENZE
        var warnItems = [];
        if (ing.warnings && ing.warnings.length) warnItems = warnItems.concat(ing.warnings);
        if (ing.avvertenze) warnItems = warnItems.concat(Array.isArray(ing.avvertenze) ? ing.avvertenze : [ing.avvertenze]);
        if (warnItems.length) {
            t += section('Attenzione');
            warnItems.forEach(function(w) { t += '  ☐ ' + w + nl; });
        }
        
        // NOTE E RIFERIMENTI
        var noteText = '';
        if (ing.note) noteText += '  ' + ing.note + nl;
        if (ing.fonti) noteText += field('Fonti scientifiche', arrStr(ing.fonti));
        if (ing.applicazioni) noteText += field('Applicazioni', arrStr(ing.applicazioni));
        if (ing.applicazioni_avanzate) {
            Object.keys(ing.applicazioni_avanzate).forEach(function(key) {
                var label = key.charAt(0).toUpperCase() + key.slice(1).replace(/_/g, ' ');
                noteText += field(label, ing.applicazioni_avanzate[key]);
            });
        }
        if (ing.vantaggi_vs_CaCl2) noteText += field('Vantaggi vs CaCl₂', arrStr(ing.vantaggi_vs_CaCl2));
        if (noteText) t += section('Note e riferimenti') + noteText;
        
        // FOOTER
        t += nl + line + nl;
        t += 'Configuratore Biomateriali v92 – Accademia Albertina' + nl;
        t += 'Scheda generata il ' + new Date().toLocaleDateString('it-IT') + nl;
        t += line + nl;
        
        return { text: t, nome: ing.nome };
    }
    
    function exportIngredientTXT(id) {
        var result = buildIngredientTXT(id);
        if (!result) { showToast('Ingrediente non trovato', 'error'); return; }
        
        var blob = new Blob([result.text], { type: 'text/plain;charset=utf-8' });
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        a.download = 'scheda_' + result.nome.replace(/[^a-zA-Z0-9à èéìòùç]/gi, '_').toLowerCase() + '.txt';
        a.click();
        URL.revokeObjectURL(url);
        showToast('Scheda ' + result.nome + ' esportata', 'success');
    }
    
    // v81: Export contestuale – famiglia filtrata (con info gruppo) o carrello
    function exportFilteredIngredientsTXT() {
        var ings = (INGREDIENTI_DATA && INGREDIENTI_DATA.ingredienti) ? INGREDIENTI_DATA.ingredienti : {};
        var nl = '\r\n';
        var bigLine = '▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪';
        var subLine = '████████████████████████████████████████████████████████████';
        
        // Determina cosa esportare in base al filtro attivo
        var ids = [];
        var exportTitle = '';
        var famigliaKey = null;
        
        if (ingFilter && ingFilter !== 'cart') {
            // EXPORT FAMIGLIA FILTRATA
            famigliaKey = ingFilter;
            // v81: nome plurale da FAMIGLIA_INFO
            exportTitle = formatFamiglia(famigliaKey).toUpperCase();
            if (typeof FAMIGLIA_INFO !== 'undefined') {
                var famMap = {'POLISACCARIDE':'POLISACCARIDE_NEUTRO'};
                var fKey = famMap[famigliaKey] || famigliaKey;
                if (FAMIGLIA_INFO[fKey] && FAMIGLIA_INFO[fKey].nome_display) {
                    exportTitle = FAMIGLIA_INFO[fKey].nome_display.toUpperCase();
                }
            }
            var sortedIds = Object.keys(ings).sort(function(a, b) {
                return (ings[a].nome || '').localeCompare(ings[b].nome || '');
            });
            for (var i = 0; i < sortedIds.length; i++) {
                if (ings[sortedIds[i]].famiglia && ings[sortedIds[i]].famiglia.includes(famigliaKey)) {
                    ids.push(sortedIds[i]);
                }
            }
        } else {
            // EXPORT CARRELLO
            exportTitle = 'CARRELLO';
            for (var ci = 0; ci < cart.length; ci++) {
                if (ings[cart[ci].id]) ids.push(cart[ci].id);
            }
            ids.sort(function(a, b) {
                return (ings[a].nome || '').localeCompare(ings[b].nome || '');
            });
        }
        
        if (!ids.length) {
            showToast(famigliaKey ? 'Nessun ingrediente in questa famiglia' : 'Carrello vuoto', 'info');
            return;
        }
        
        // --- HEADER ---
        var allText = bigLine + nl;
        allText += (famigliaKey ? 'FAMIGLIA: ' : '') + exportTitle + nl;
        allText += 'Configuratore Biomateriali v92 – Accademia Albertina' + nl;
        allText += 'Generato il ' + new Date().toLocaleDateString('it-IT') + ' – ' + ids.length + ' ingredienti' + nl;
        allText += bigLine + nl;
        
        // --- INFO FAMIGLIA (se disponibile) ---
        if (famigliaKey && typeof FAMIGLIA_INFO !== 'undefined') {
            var mappaFam = {
                'PROTEINA': 'PROTEINA', 'POLISACCARIDE': 'POLISACCARIDE_NEUTRO',
                'POLICATIONE': 'POLICATIONE', 'PLASTIFICANTE': 'PLASTIFICANTE',
                'LIPIDE': 'LIPIDE', 'SALE_RETICOLANTE': 'SALE_RETICOLANTE',
                'CARICA': 'CARICA', 'COLORANTE': 'COLORANTE',
                'ADDITIVO': 'ADDITIVO', 'COLTURA': 'COLTURA',
                'POLISACCARIDE_ANIONICO': 'POLISACCARIDE_ANIONICO',
                'EMULSIONANTE': 'EMULSIONANTE'
            };
            var infoKey = mappaFam[famigliaKey] || famigliaKey;
            var info = FAMIGLIA_INFO[infoKey];
            if (info) {
                allText += nl + '  ' + (info.nome_display || exportTitle) + nl;
                allText += subLine + nl;
                if (info.descrizione) {
                    allText += nl + '  ' + info.descrizione + nl;
                }
                if (info.confronto_rapido) {
                    allText += nl + '  CONFRONTO RAPIDO' + nl;
                    for (var nome in info.confronto_rapido) {
                        var desc = info.confronto_rapido[nome];
                        if (typeof desc === 'object') desc = desc.desc || '';
                        allText += '    ' + nome.charAt(0).toUpperCase() + nome.slice(1) + ': ' + desc + nl;
                    }
                }
                if (info.quando_usare) {
                    allText += nl + '  QUANDO USARE' + nl;
                    for (var uso in info.quando_usare) {
                        allText += '    ' + uso.replace(/_/g, ' ') + ': ' + info.quando_usare[uso] + nl;
                    }
                }
                if (info.avvisi && info.avvisi.length) {
                    allText += nl + '  ATTENZIONE' + nl;
                    for (var ai = 0; ai < info.avvisi.length; ai++) {
                        allText += '    ! ' + info.avvisi[ai] + nl;
                    }
                }
                if (info.note_processo) {
                    allText += nl + '  NOTE DI PROCESSO' + nl;
                    allText += '    ' + info.note_processo + nl;
                }
                allText += nl + subLine + nl;
            }
        }
        
        // --- SCHEDE INGREDIENTI ---
        allText += nl;
        ids.forEach(function(id) {
            var result = buildIngredientTXT(id);
            if (result) {
                allText += result.text + nl;
            }
        });
        
        // --- DOWNLOAD ---
        var blob = new Blob([allText], { type: 'text/plain;charset=utf-8' });
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        var filename = famigliaKey 
            ? 'famiglia_' + famigliaKey.toLowerCase() + '_' + new Date().toISOString().slice(0, 10) + '.txt'
            : 'carrello_ingredienti_' + new Date().toISOString().slice(0, 10) + '.txt';
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
        showToast('Esportati ' + ids.length + ' ingredienti', 'success');
    }
    
    // v81: Sanitizza null/undefined da HTML renderizzato
    function sanitizeNull(html) {
        if (!html) return '';
        // Replace "null" or "undefined" when they appear as sole content or field value
        return html
            .replace(/>null</g, '>-<')
            .replace(/>undefined</g, '>-<')
            .replace(/>null,/g, '>-,')
            .replace(/,\s*null</g, ', -<')
            .replace(/>null\s/g, '>- ')
            .replace(/\snull</g, ' -<')
            .replace(/>null\./g, '>-.')
            .replace(/>undefined\./g, '>-.');
    }
    function formatFamiglia(f) { return (f || '').replace(/_/g, ' ').toLowerCase().replace(/^\w/, c => c.toUpperCase()); }
    
    function goToIngredientDetail(id) {
        // Va a Tab B e mostra la scheda dell'ingrediente
        switchTab('B');
        setTimeout(() => {
            showIngredientDetail(id);
            // Scroll all'ingrediente nella lista se esiste
            const item = document.querySelector('.ing-item[data-id="' + id + '"]');
            if (item) {
                item.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }, 100);
    }
    
    function addToCartById(id) {
        const ings = INGREDIENTI_DATA?.ingredienti || {};
        const ing = ings[id];
        if (ing && !cart.find(c => c.id === id)) {
            cart.push({...ing, id: id, informativo: false});
            updateCart();
            renderIngredientList();
            showIngredientDetail(id);
            showToast(ing.nome + ' aggiunto', 'success');
            saveCartToStorage();
        }
    }
    
    function removeFromCartById(id) {
        cart = cart.filter(c => c.id !== id);
        tavolo = tavolo.filter(t => t !== id);
        updateCart();
        renderIngredientList();
        if (selectedIngredient === id) showIngredientDetail(id);
        updateTavolo();
        saveCartToStorage();
    }
    
    //                                                                                                                                                                                  
    // TAB C - LABORATORIO
    //                                                                                                                                                                                  
    function updateTavolo() {
        const area = document.getElementById('tavoloArea');
        const countEl = document.getElementById('tavoloCount');
        if (!area || !countEl) return;
        
        countEl.textContent = tavolo.length;
        const ings = INGREDIENTI_DATA?.ingredienti || {};
        
        // Sincronizza formulaSelection: rimuovi ingredienti non pi   sul tavolo
        formulaSelection = new Set([...formulaSelection].filter(id => tavolo.includes(id)));
        
        if (tavolo.length === 0) {
            area.className = 'tavolo-ingredienti';
            area.innerHTML = '<div class="tavolo-hint">Clicca sugli ingredienti nel carrello per aggiungerli al tavolo</div>';
            formulaSelection.clear(); customDosages = {};
        } else {
            area.className = 'tavolo-ingredienti has-items';
            area.innerHTML = '<div class="tavolo-chips">' + tavolo.map(id => {
                const ing = ings[id];
                // v60.2: Mostra anche ingredienti non nel DB come teorici
                const nome = ing ? ing.nome : id.replace(/_/g, ' ');
                const famiglia = ing ? ing.famiglia : 'teorico';
                const dotClass = getCategoryClass(famiglia);
                const isSelected = formulaSelection.has(id);
                const chipClass = isSelected ? 'tavolo-chip selected' : 'tavolo-chip' + (formulaSelection.size > 0 ? ' deselected' : '');
                const teorico = ing ? '' : ' teorico';
                return '<div class="' + chipClass + teorico + '">' +
                    '<input type="checkbox" ' + (isSelected ? 'checked' : '') + ' onchange="toggleFormulaIngredient(\'' + id + '\', this.checked)">' +
                    '<span class="dot ' + dotClass + '"></span>' + nome + 
                    '<span class="remove" onclick="removeFromTavolo(\'' + id + '\')">&times;</span></div>';
            }).join('') + '</div>' +
            '<div class="tavolo-select-hint">    Seleziona ingredienti per la formula</div>';
        }
        
        // v89: Box riferimento ricetta caricata
        var refBox = document.getElementById('recipeRefBox');
        if (!refBox) {
            refBox = document.createElement('div');
            refBox.id = 'recipeRefBox';
            area.parentNode.insertBefore(refBox, area.nextSibling);
        }
        if (window._loadedRecipeRef && tavolo.length > 0) {
            var ref = window._loadedRecipeRef;
            var refHtml = '<div style="margin:0.5rem 0;padding:0.6rem;background:#e3f2fd;border-radius:6px;border-left:3px solid #1976d2;font-size:0.72rem;">';
            refHtml += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.3rem;">';
            refHtml += '<strong style="color:#1565c0;">Ricetta di riferimento: ' + ref.nome + '</strong>';
            refHtml += '<span onclick="window._loadedRecipeRef=null;updateTavolo();" style="cursor:pointer;color:#999;font-size:0.8rem;" title="Chiudi">&times;</span>';
            refHtml += '</div>';
            if (ref.dosaggi) {
                refHtml += '<div style="color:#37474f;line-height:1.5;margin-bottom:0.3rem;">' + ref.dosaggi + '</div>';
            }
            var dettagli = [];
            if (ref.colore) dettagli.push('Colore: ' + ref.colore);
            if (ref.consistenza) dettagli.push(ref.consistenza);
            if (ref.trasparenza) dettagli.push('Trasp: ' + ref.trasparenza);
            if (dettagli.length > 0) {
                refHtml += '<div style="color:#78909c;font-size:0.67rem;">' + dettagli.join(' · ') + '</div>';
            }
            if (ref.problemi && ref.problemi !== 'Nessuna.' && ref.problemi !== '') {
                refHtml += '<div style="color:#c62828;font-size:0.67rem;margin-top:0.2rem;">⚠ ' + ref.problemi + '</div>';
            }
            refHtml += '</div>';
            refBox.innerHTML = refHtml;
        } else {
            refBox.innerHTML = '';
        }
        
        checkCompatibility();
        calculateMaterial();
        calculateFormula();
    }
    
    function addAllToTavolo() {
        // Aggiungi tutti gli ingredienti operativi del carrello al tavolo
        const operativi = cart.filter(i => !i.informativo);
        operativi.forEach(ing => {
            if (!tavolo.includes(ing.id)) {
                tavolo.push(ing.id);
            }
        });
        updateTavolo();
        updateCart();
        switchTab('C');
        saveCartToStorage();
    }
    
    function addToTavolo(id) {
        if (!tavolo.includes(id)) {
            tavolo.push(id);
            updateTavolo();
            updateCart();
            saveCartToStorage();
        }
    }
    
    function removeFromTavolo(id) {
        tavolo = tavolo.filter(i => i !== id);
        updateTavolo();
        updateCart();
        saveCartToStorage();
    }
    

    function clearTavolo() {
        if (tavolo.length === 0) return;
        showConfirmModal(
            'Svuota tavolo',
            'Svuotare il tavolo di lavoro?<br><br>Gli ingredienti resteranno nel carrello.',
            function() {
                tavolo = [];
                formulaSelection.clear(); customDosages = {};
                window._editingFormulaId = null; window._editingFormulaName = null; // v75
                window._loadedRecipeRef = null; // v89
                updateTavolo();
                updateCart();
                saveCartToStorage();
            }
        );
    }
    
    function clearCart() {
        if (cart.length === 0) {
            showToast('Il carrello è già  vuoto', 'info');
            return;
        }
        showConfirmModal(
            'Svuota carrello',
            'Svuotare completamente il carrello?<br><br>Verranno rimossi <strong>' + cart.length + ' ingredienti</strong> e il tavolo verrà  svuotato.',
            function() {
                cart = [];
                tavolo = [];
                formulaSelection.clear(); customDosages = {};
                window._editingFormulaId = null; window._editingFormulaName = null; // v75
                window._loadedRecipeRef = null; // v89
                updateCart();
                updateTavolo();
                saveCartToStorage();
                showToast('Carrello svuotato', 'info');
            }
        );
    }
    
    //                                                                                                                                                                                  
    // FORMULA - Generazione e gestione
    //                                                                                                                                                                                  
    function toggleFormulaIngredient(id, checked) {
        if (checked) {
            formulaSelection.add(id);
        } else {
            formulaSelection.delete(id);
            delete customDosages[id]; // v71
        }
        updateTavolo();
        saveCartToStorage();
    }
    
    function calculateFormula() {
        const contentEl = document.getElementById('formulaContent');
        if (!contentEl) return;
        
        const selected = [...formulaSelection];
        
        if (selected.length === 0) {
            contentEl.innerHTML = '<div class="formula-empty">Seleziona ingredienti con le le checkbox sul tavolo</div>';
            return;
        }
        
        const ings = INGREDIENTI_DATA?.ingredienti || {};
        const compatDB = INGREDIENTI_DATA.regole_compatibilita_famiglie || {};
        
        // Categorizza ingredienti per ruolo
        let matrici = [], plastificanti = [], cariche = [], reticolanti = [], lipidi = [], coloranti = [], acidi = [], altri = [];
        
        selected.forEach(id => {
            const ing = ings[id];
            if (!ing) return;
            const fam = ing.famiglia;
            
            if (['PROTEINA', 'POLISACCARIDE_NEUTRO', 'POLISACCARIDE_ANIONICO', 'POLICATIONE', 'COLTURA'].includes(fam)) {
                matrici.push({ id, ing, role: 'Matrice' });
            } else if (fam === 'PLASTIFICANTE') {
                plastificanti.push({ id, ing, role: 'Plastificante' });
            } else if (fam === 'CARICA') {
                cariche.push({ id, ing, role: 'Carica/Fibra' });
            } else if (fam === 'SALE_RETICOLANTE') {
                reticolanti.push({ id, ing, role: 'Reticolante' });
            } else if (fam === 'LIPIDE') {
                lipidi.push({ id, ing, role: 'Lipide/Coating' });
            } else if (fam === 'COLORANTE') {
                coloranti.push({ id, ing, role: 'Colorante' });
            } else if (fam === 'ACIDO') {
                acidi.push({ id, ing, role: 'Regolatore pH' });
            } else {
                altri.push({ id, ing, role: 'Altro' });
            }
        });
        
        // Calcola percentuali BASE
        let formula = [];
        let totalPercent = 0;
        
        if (matrici.length > 0) {
            const perMatrice = Math.round(70 / matrici.length);
            matrici.forEach(m => { formula.push({ ...m, percent: perMatrice }); totalPercent += perMatrice; });
        }
        plastificanti.forEach(p => {
            const pct = Math.round(((p.ing.range_percent_min || 10) + (p.ing.range_percent_max || 30)) / 2);
            formula.push({ ...p, percent: pct }); totalPercent += pct;
        });
        if (cariche.length > 0) {
            const perCarica = Math.round(15 / cariche.length);
            cariche.forEach(c => { formula.push({ ...c, percent: perCarica }); totalPercent += perCarica; });
        }
        reticolanti.forEach(r => {
            const pct = Math.round(((r.ing.range_percent_min || 1) + (r.ing.range_percent_max || 5)) / 2);
            formula.push({ ...r, percent: pct }); totalPercent += pct;
        });
        if (lipidi.length > 0) {
            const perLipide = Math.round(10 / lipidi.length);
            lipidi.forEach(l => { formula.push({ ...l, percent: perLipide }); totalPercent += perLipide; });
        }
        coloranti.forEach(c => { formula.push({ ...c, percent: 2 }); totalPercent += 2; });
        acidi.forEach(a => { formula.push({ ...a, percent: 2 }); totalPercent += 2; });
        altri.forEach(o => { formula.push({ ...o, percent: 5 }); totalPercent += 5; });
        
        // Normalizza a 100% per i valori BASE
        if (totalPercent !== 100 && formula.length > 0) {
            const factor = 100 / totalPercent;
            let sum = 0;
            formula.forEach((f, i) => {
                if (i < formula.length - 1) { f.percent = Math.round(f.percent * factor); sum += f.percent; }
                else { f.percent = 100 - sum; }
            });
        }
        
        // v71: Salva base e applica customDosages
        let hasCustom = false;
        formula.forEach(f => {
            f.basePercent = f.percent;
            if (customDosages[f.id] !== undefined) {
                f.percent = customDosages[f.id];
                f.modified = true;
                hasCustom = true;
            }
        });
        
        // Calcola totale effettivo
        let total = formula.reduce((s, f) => s + f.percent, 0);
        
        // Raccogli note di compatibilità 
        let notes = [];
        for (let i = 0; i < selected.length; i++) {
            for (let j = i + 1; j < selected.length; j++) {
                const ing1 = ings[selected[i]], ing2 = ings[selected[j]];
                if (!ing1 || !ing2) continue;
                const fam1 = ing1.famiglia, fam2 = ing2.famiglia;
                let compat = null;
                if (compatDB[fam1] && compatDB[fam1][fam2]) compat = compatDB[fam1][fam2];
                else if (compatDB[fam2] && compatDB[fam2][fam1]) compat = compatDB[fam2][fam1];
                if (compat && compat.note && compat.note !== 'Compatibili' && compat.note !== 'Non interagiscono') {
                    notes.push(compat.note);
                }
            }
        }
        
        // Genera nome formula
        let formulaName = 'Formula';
        if (matrici.length > 0) formulaName = matrici[0].ing.nome;
        if (plastificanti.length > 0) formulaName += ' + ' + plastificanti[0].ing.nome;
        else if (cariche.length > 0) formulaName += ' + ' + cariche[0].ing.nome;
        
        // === v71: RENDER HTML CON +/- ===
        let html = '<table class="formula-table">';
        html += '<thead><tr><th>Ingrediente</th><th>Ruolo</th><th style="text-align:right">Grammi</th><th style="text-align:right">%</th></tr></thead>';
        html += '<tbody>';
        formula.forEach(f => {
            const dotClass = getCategoryClass(f.ing.famiglia);
            const rules = FAMILY_DOSE_RULES[f.ing.famiglia] || { min: 1, max: 50, step: 1 };
            const atMin = f.percent <= rules.min;
            const atMax = f.percent >= rules.max;
            const delta = f.modified ? f.percent - f.basePercent : 0;
            const deltaStr = delta > 0 ? '+' + delta : '' + delta;
            const effectivePct = total > 0 ? Math.round(f.percent / total * 100) : 0;
            
            html += '<tr>';
            html += '<td><div class="ing-name"><span class="dot ' + dotClass + '"></span>' + f.ing.nome + '</div></td>';
            html += '<td>' + f.role + '</td>';
            html += '<td><div class="dose-controls">';
            html += '<button class="dose-btn' + (atMin ? ' at-limit' : '') + '" onclick="adjustDosage(\'' + f.id + '\',-1)" title="\u22121g">\u2212</button>';
            html += '<span class="dose-val' + (f.modified ? ' modified' : '') + '">' + f.percent + 'g</span>';
            if (f.modified) html += '<span class="dose-delta">(' + deltaStr + ')</span>';
            html += '<button class="dose-btn' + (atMax ? ' at-limit' : '') + '" onclick="adjustDosage(\'' + f.id + '\',1)" title="+1g">+</button>';
            html += '</div></td>';
            html += '<td class="grams' + (f.modified && effectivePct !== f.basePercent ? ' modified' : '') + '" style="text-align:right">' + effectivePct + '%</td>';
            html += '</tr>';
        });
        html += '</tbody>';
        
        // Riga totale
        html += '<tfoot><tr><td colspan="2"><strong>' + formulaName + '</strong>';
        if (hasCustom) html += ' <span class="formula-reset-link" onclick="resetDosages()">reset</span>';
        html += '</td><td style="text-align:right;font-weight:600' + (total !== 100 ? ';color:#e65100' : '') + '">' + total + 'g</td>';
        html += '<td style="text-align:right;font-weight:600">100%</td></tr></tfoot>';
        html += '</table>';

        
        // v71: Smart messages
        const smartMsgs = getSmartMessages(formula, total);
        smartMsgs.forEach(msg => {
            html += '<div class="formula-total-msg ' + msg.type + '">' + msg.text + '</div>';
        });
        
        if (notes.length > 0) {
            // Filtra note generiche/inutili — mostra solo quelle operative
            const skipNotes = ['Standard', 'Rinforzo', 'Rinforzo meccanico', 'Rinforzo strutturale',
                'Coating', 'Coating possibile', 'Blend comuni', 'Combinabili', 'Post-processing',
                'Miscele colori', 'Mix cariche possibile', 'Variabile', 'Possono combinarsi',
                'Antiossidante', 'Variabile per reticolante', 'Coating per waterproofing',
                'Solo chitosano nel database', 'Alginato+carragenina possibile',
                'Non interazione diretta significativa', 'Non interazione significativa',
                'Gelatina+agar classico', 'Chitosano come coating', 'Chitosano come coating antimicrobico',
                'Olio riduce shrinkage', 'Gusci+alginato classico', 'Tinture durante o dopo crescita'];
            const filteredNotes = [...new Set(notes)].filter(n => 
                !skipNotes.includes(n) && n.length > 22
            );
            if (filteredNotes.length > 0) {
                html += '<div class="formula-notes"><div class="formula-notes-title">Note di processo</div>';
                html += filteredNotes.map(n => '→ ' + n).join('<br>');
                html += '</div>';
            }
        }
        
        html += '<div class="formula-actions">';
        html += '<button class="btn-save" onclick="saveFormula()">Salva</button>';
        html += '<button class="btn-download" onclick="downloadFormula()">Scarica</button>';
        html += '</div>';
        
        contentEl.innerHTML = html;
        
        // v71: Calcola proprietà  proporzionali ai dosaggi
        const props = recalcPropsFromFormula(formula);
        
        // Salva formula corrente per export
        window.currentFormula = { name: formulaName, items: formula, notes, total, properties: props };
        
        // v71: Aggiorna barre con animazione se dosaggio custom
        updateBar('barTrasp', props.trasparenza);
        updateBar('barFlex', props.flessibilita);
        updateBar('barH2O', props.resistenzaH2O);
        updateBar('barMecc', props.resistenzaMecc);
        if (hasCustom) {
            ['barTrasp', 'barFlex', 'barH2O', 'barMecc'].forEach(id => {
                const el = document.getElementById(id);
                if (el) { el.classList.remove('pulse'); void el.offsetWidth; el.classList.add('pulse'); }
            });
        }
        
        // v71: Debounce aggiornamento descrizione se dosaggi custom
        if (hasCustom) {
            clearTimeout(descUpdateTimer);
            descUpdateTimer = setTimeout(() => {
                calculateMaterial();
            }, 600);
        }
    }
    
    // v71: Regola dosaggio di un ingrediente
    function adjustDosage(ingId, delta) {
        const ings = INGREDIENTI_DATA?.ingredienti || {};
        const ing = ings[ingId];
        if (!ing) return;
        
        const rules = FAMILY_DOSE_RULES[ing.famiglia] || { min: 1, max: 50, step: 5 };
        
        // Trova valore attuale
        const current = customDosages[ingId] !== undefined ? customDosages[ingId] : getBasePercent(ingId);
        const newVal = Math.max(rules.min, Math.min(rules.max, current + delta));
        
        if (newVal === current) return;
        
        // Se torna al base, rimuovi custom
        const base = getBasePercent(ingId);
        if (newVal === base) {
            delete customDosages[ingId];
        } else {
            customDosages[ingId] = newVal;
        }
        
        calculateFormula();
    }
    
    // v71: Ottieni percentuale base (calcolata dal sistema) per un ingrediente
    function getBasePercent(ingId) {
        if (window.currentFormula && window.currentFormula.items) {
            const item = window.currentFormula.items.find(f => f.id === ingId);
            if (item) return item.basePercent;
        }
        return 0;
    }
    
    // v71: Reset tutti i dosaggi personalizzati
    function resetDosages() {
        customDosages = {};
        calculateFormula();
        showToast('Dosaggi ripristinati', 'info');
    }
    
    // v71: Calcola proprietà  proporzionali dalle percentuali effettive
    function recalcPropsFromFormula(formula) {
        let trasp = 0, flex = 0, h2o = 0, mecc = 0;
        let hasMatrice = false;
        let famigliePresenti = new Set();
        let famiglieConte = {};
        
        formula.forEach(f => {
            const fam = f.ing.famiglia;
            const rates = FAMILY_PROP_RATES[fam];
            if (!rates) return;
            
            famigliePresenti.add(fam);
            famiglieConte[fam] = (famiglieConte[fam] || 0) + 1;
            
            const pct = f.percent;
            trasp += pct * rates.trasp;
            flex += pct * rates.flex;
            h2o += pct * rates.h2o;
            mecc += pct * rates.mecc;
            
            if (['PROTEINA', 'POLISACCARIDE_NEUTRO', 'POLISACCARIDE_ANIONICO', 'POLICATIONE', 'COLTURA'].includes(fam)) {
                hasMatrice = true;
            }
        });
        
        // v89: Applica INTERAZIONI tra famiglie
        const famArray = [...famigliePresenti];
        for (let i = 0; i < famArray.length; i++) {
            for (let j = i; j < famArray.length; j++) {
                const key1 = famArray[i] + '+' + famArray[j];
                const key2 = famArray[j] + '+' + famArray[i];
                const interaction = FAMILY_INTERACTIONS[key1] || FAMILY_INTERACTIONS[key2];
                if (interaction) {
                    trasp += interaction.trasp || 0;
                    flex += interaction.flex || 0;
                    h2o += interaction.h2o || 0;
                    mecc += interaction.mecc || 0;
                }
            }
        }
        if ((famiglieConte['CARICA'] || 0) >= 2) {
            const dc = FAMILY_INTERACTIONS['CARICA+CARICA'];
            if (dc) { trasp += dc.trasp||0; flex += dc.flex||0; h2o += dc.h2o||0; mecc += dc.mecc||0; }
        }
        
        // v89: CAP OPACIZZANTI
        if (famigliePresenti.has('CARICA')) trasp = Math.min(trasp, 40);
        if (famigliePresenti.has('COLORANTE')) trasp = Math.min(trasp, 35);
        const opacizzanti = ['fondi_caffe', 'bucce_agrumi', 'segatura', 'paglia', 'cellulosa_carta'];
        if (formula.some(f => opacizzanti.includes(f.id))) trasp = Math.min(trasp, 25);
        
        if (!hasMatrice && formula.length > 0) {
            trasp = Math.max(trasp, 20);
            flex = Math.max(flex, 20);
            h2o = Math.max(h2o, 10);
            mecc = Math.max(mecc, 15);
        }
        
        // v91: Cap proporzionali + tecnica
        return applyPostCalcModifiers(trasp, flex, h2o, mecc, formula);
    }
    
    // v71: Messaggi smart basati su composizione e totale
    function getSmartMessages(formula, total) {
        let msgs = [];
        
        // Analisi composizione
        let plastPct = 0, matricePct = 0, reticPct = 0, lipidePct = 0, caricaPct = 0;
        formula.forEach(f => {
            const fam = f.ing.famiglia;
            if (fam === 'PLASTIFICANTE') plastPct += f.percent;
            else if (['PROTEINA','POLISACCARIDE_NEUTRO','POLISACCARIDE_ANIONICO','POLICATIONE','COLTURA'].includes(fam)) matricePct += f.percent;
            else if (fam === 'SALE_RETICOLANTE') reticPct += f.percent;
            else if (fam === 'LIPIDE') lipidePct += f.percent;
            else if (fam === 'CARICA') caricaPct += f.percent;
        });
        
        // Messaggi su totale – spiega in termini di grammi da pesare
        if (total !== 100 && total >= 95 && total <= 105) {
            // Piccola variazione, niente di grave
        } else if (total > 130) {
            msgs.push({ type: 'warn', text: 'Stai usando ' + total + 'g di ingredienti secchi su una base pensata per 100g. Le proporzioni sono cambiate molto. In laboratorio: parti da piccole quantita (10-20g totali) mantenendo i rapporti della colonna %.' });
        } else if (total > 105) {
            msgs.push({ type: 'info', text: 'Totale ' + total + 'g invece di 100g. La colonna % mostra le proporzioni reali. Ricorda di scalare anche l\'acqua (circa 1:3-4 sul peso secco totale).' });
        } else if (total < 70) {
            msgs.push({ type: 'warn', text: 'Solo ' + total + 'g di ingredienti secchi. La matrice potrebbe non bastare a dare struttura. Considera di aumentare l\'ingrediente base.' });
        } else if (total < 95) {
            msgs.push({ type: 'info', text: 'Totale ' + total + 'g. La miscela risultera piu diluita. La colonna % mostra le proporzioni effettive.' });
        }
        
        // Messaggi su composizione – usa % effettiva sul totale
        const plastEff = total > 0 ? Math.round(plastPct / total * 100) : 0;
        const matEff = total > 0 ? Math.round(matricePct / total * 100) : 0;
        const reticEff = total > 0 ? Math.round(reticPct / total * 100) : 0;
        const caricaEff = total > 0 ? Math.round(caricaPct / total * 100) : 0;
        const lipideEff = total > 0 ? Math.round(lipidePct / total * 100) : 0;
        
        if (plastEff > 45) {
            msgs.push({ type: 'warn', text: 'Plastificante al ' + plastEff + '% del totale. Troppo: il materiale potrebbe non asciugare, restare appiccicoso o non mantenere la forma.' });
        } else if (plastEff > 35) {
            msgs.push({ type: 'info', text: 'Plastificante al ' + plastEff + '% del totale. Il materiale sara molto morbido, quasi gommoso. Ottimo per film flessibili, rischioso per oggetti rigidi.' });
        }
        
        if (matEff > 0 && matEff < 30 && formula.length > 1) {
            msgs.push({ type: 'warn', text: 'La matrice e solo il ' + matEff + '% del totale. Rischia di non formarsi una struttura solida – meglio almeno il 40-50%.' });
        }
        
        if (reticEff > 7) {
            msgs.push({ type: 'warn', text: 'Reticolante al ' + reticEff + '% del totale. L\'eccesso puo rendere il materiale fragile, opaco e difficile da lavorare.' });
        }
        
        if (caricaEff > 35) {
            msgs.push({ type: 'info', text: 'Cariche al ' + caricaEff + '% del totale. Il materiale sara opaco e rigido. Oltre il 40% rischia di sgretolarsi.' });
        }
        
        if (lipideEff > 25) {
            msgs.push({ type: 'info', text: 'Lipidi al ' + lipideEff + '% del totale. Buona barriera all\'acqua, ma la superficie potrebbe risultare unta o cerosa.' });
        }
        
        // Rapporto plastificante/matrice
        if (plastPct > 0 && matricePct > 0 && plastPct / matricePct > 0.6) {
            msgs.push({ type: 'info', text: 'Il plastificante e il ' + Math.round(plastPct/matricePct*100) + '% rispetto alla matrice. Di solito non supera il 30-50%. Troppo rende il materiale debole.' });
        }
        
        return msgs;
    }
    
    function saveFormula() {
        if (!window.currentFormula) return;
        
        // v60.7: Genera nome automatico dagli ingredienti
        const ings = INGREDIENTI_DATA?.ingredienti || {};
        let autoName = '';
        if (tavolo.length > 0) {
            const nomi = tavolo.slice(0, 3).map(id => {
                const ing = ings[id];
                return ing ? ing.nome.split(' ')[0] : id;
            });
            autoName = nomi.join('+');
            if (tavolo.length > 3) autoName += '+...';
        } else {
            autoName = 'Formula ' + new Date().toLocaleDateString('it-IT');
        }
        
        // Mostra modal per confermare/modificare nome
        showSaveNameModal(autoName);
    }
    
    function showSaveNameModal(suggestedName) {
        document.querySelectorAll('.confirm-modal-overlay').forEach(function(m) { m.remove(); });
        
        const isEditing = !!window._editingFormulaId;
        const editName = window._editingFormulaName || '';
        
        var overlay = document.createElement('div');
        overlay.className = 'confirm-modal-overlay';
        overlay.innerHTML = '<div class="confirm-modal">' +
            '<div class="confirm-modal-header">' + (isEditing ? 'Aggiorna Formula' : 'Salva Formula') + '</div>' +
            '<div class="confirm-modal-body">' +
                (isEditing ? '<div style="font-size:0.75rem;color:#888;margin-bottom:0.5rem;">Caricata da: "' + editName + '"</div>' : '') +
                '<label style="display:block;margin-bottom:0.5rem;font-size:0.8rem;color:#555;">Nome della formula:</label>' +
                '<input type="text" id="formulaNameInput" value="' + (isEditing ? editName : suggestedName) + '" ' +
                       'style="width:100%;padding:0.5rem;border:1px solid #ddd;border-radius:4px;font-size:0.85rem;" ' +
                       'onkeydown="if(event.key===\'Enter\'){doSaveFormula(true);event.preventDefault();}">' +
            '</div>' +
            '<div class="confirm-modal-actions" style="flex-wrap:wrap;gap:0.4rem;">' +
                '<button class="btn-confirm-cancel" onclick="this.closest(\'.confirm-modal-overlay\').remove()">Annulla</button>' +
                (isEditing ? '<button class="btn-confirm-ok" style="background:#4caf50;" onclick="doSaveFormula(true)">Aggiorna</button>' +
                             '<button class="btn-confirm-ok" style="background:#2196f3;" onclick="doSaveFormula(false)">Salva come nuova</button>'
                           : '<button class="btn-confirm-ok" onclick="doSaveFormula(false)">Salva</button>') +
            '</div>' +
        '</div>';
        document.body.appendChild(overlay);
        
        setTimeout(function() {
            var input = document.getElementById('formulaNameInput');
            if (input) { input.focus(); input.select(); }
        }, 100);
    }
    
    function doSaveFormula(overwrite) {
        var nameInput = document.getElementById('formulaNameInput');
        var name = nameInput ? nameInput.value.trim() : 'Formula';
        
        document.querySelectorAll('.confirm-modal-overlay').forEach(function(m) { m.remove(); });
        
        var saved = JSON.parse(localStorage.getItem('savedFormulas') || '[]');
        var annotations = document.getElementById('formulaAnnotations')?.value || '';
        
        // v75: Salva anche i dosaggi custom
        var dosaggiDaSalvare = {};
        if (Object.keys(customDosages).length > 0) {
            dosaggiDaSalvare = JSON.parse(JSON.stringify(customDosages));
        }
        
        var formula = {
            ...window.currentFormula,
            name: name,
            annotations: annotations,
            ingredientIds: [...formulaSelection],
            customDosages: dosaggiDaSalvare,
            tecnica: currentTecnica, // v91
            coating: coatingAttivo, // v92
            date: new Date().toISOString()
        };
        
        if (overwrite && window._editingFormulaId) {
            // v75: Sovrascrive la ricetta esistente mantenendo l'ID originale
            var idx = saved.findIndex(f => String(f.id) === String(window._editingFormulaId));
            if (idx >= 0) {
                formula.id = saved[idx].id; // mantieni ID originale
                saved[idx] = formula;
                localStorage.setItem('savedFormulas', JSON.stringify(saved));
                // Aggiorna tracking
                window._editingFormulaName = name;
                loadSavedFormulas();
                showToast('Formula "' + name + '" aggiornata!', 'success');
                return;
            }
        }
        
        // Salva come nuova
        formula.id = Date.now();
        saved.push(formula);
        localStorage.setItem('savedFormulas', JSON.stringify(saved));
        // v75: Ora stiamo editando questa nuova formula
        window._editingFormulaId = formula.id;
        window._editingFormulaName = name;
        loadSavedFormulas();
        showToast('Formula "' + name + '" salvata!', 'success');
    }
    
    function loadSavedFormulas() {
        const saved = JSON.parse(localStorage.getItem('savedFormulas') || '[]');
        const listEl = document.getElementById('savedFormulasList');
        const countEl = document.getElementById('savedCount');
        
        if (!listEl) return;
        
        countEl.textContent = saved.length;
        
        if (saved.length === 0) {
            listEl.innerHTML = '<div class="saved-empty">Nessuna formula salvata</div>';
            return;
        }
        
        let html = '';
        saved.slice().reverse().forEach(f => {
            const date = new Date(f.date).toLocaleDateString('it-IT', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' });
            const numIng = f.ingredientIds?.length || f.items?.length || 0;
            html += '<div class="saved-formula-item">';
            html += '<div class="saved-formula-info" onclick="loadFormula(' + f.id + ')">';
            const hasNotes = f.annotations && f.annotations.trim().length > 0;
            html += '<div class="saved-formula-name">' + (f.name || 'Formula') + ' <small>(' + numIng + ' ing.)</small>' + (hasNotes ? ' <span class="note-indicator" title="Ha annotazioni">*</span>' : '') + '</div>';
            html += '<div class="saved-formula-date">' + date + '</div>';
            html += '</div>';
            html += '<div class="saved-formula-actions">';
            html += '<button class="btn-load" onclick="loadFormula(' + f.id + ')" title="Carica">Carica</button>';
            html += '<button class="btn-delete" onclick="deleteFormula(' + f.id + ')" title="Elimina">X</button>';
            html += '</div>';
            html += '</div>';
        });
        
        listEl.innerHTML = html;
    }
    
    function loadFormula(id) {
        const saved = JSON.parse(localStorage.getItem('savedFormulas') || '[]');
        // v60.5: Confronto robusto - gestisce sia stringhe che numeri
        const formula = saved.find(f => String(f.id) === String(id));
        if (!formula) return;
        
        // Controlla se c'è lavoro in corso sul tavolo
        if (tavolo.length > 0) {
            showLoadConfirmModal(formula, id);
            return;
        }
        
        // Nessun lavoro in corso, carica direttamente
        doLoadFormula(formula);
    }
    
    function showLoadConfirmModal(formula, id) {
        // Crea modal overlay se non esiste
        let overlay = document.getElementById('loadConfirmOverlay');
        if (!overlay) {
            overlay = document.createElement('div');
            overlay.id = 'loadConfirmOverlay';
            overlay.className = 'modal-overlay';
            overlay.innerHTML = `
                <div class="modal" style="max-width: 400px;">
                    <div class="modal-header">
                        <h3>Lavoro in corso</h3>
                    </div>
                    <div class="modal-body" id="loadConfirmBody"></div>
                    <div class="modal-actions" style="flex-wrap: wrap; gap: 0.5rem;">
                        <button class="btn btn-secondary" id="loadConfirmNo" style="flex: 1; min-width: 80px;">No</button>
                        <button class="btn btn-primary" id="loadConfirmSave" style="flex: 1; min-width: 120px; background: #f57c00;">Salva e carica</button>
                        <button class="btn btn-primary" id="loadConfirmYes" style="flex: 1; min-width: 80px;">Si</button>
                    </div>
                </div>
            `;
            document.body.appendChild(overlay);
        }
        
        // Aggiorna contenuto
        document.getElementById('loadConfirmBody').innerHTML = 
            '<p>Hai <strong>' + tavolo.length + ' ingredienti</strong> sul tavolo.</p>' +
            '<p>Caricare "<strong>' + (formula.name || 'Formula') + '</strong>" sovrascrivera il lavoro attuale.</p>';
        
        // Event handlers
        document.getElementById('loadConfirmNo').onclick = () => {
            overlay.classList.remove('show');
        };
        
        document.getElementById('loadConfirmSave').onclick = () => {
            overlay.classList.remove('show');
            // Salva con nome progressivo
            const progressName = getNextInProgressName();
            saveCurrentAsInProgress(progressName);
            showToast('Salvato come "' + progressName + '"', 'success');
            doLoadFormula(formula);
        };
        
        document.getElementById('loadConfirmYes').onclick = () => {
            overlay.classList.remove('show');
            doLoadFormula(formula);
        };
        
        overlay.classList.add('show');
    }
    
    function getNextInProgressName() {
        const saved = JSON.parse(localStorage.getItem('savedFormulas') || '[]');
        let n = 1;
        while (saved.some(f => f.name === 'in_progress_' + n)) {
            n++;
        }
        return 'in_progress_' + n;
    }
    
    function saveCurrentAsInProgress(name) {
        const selected = [...formulaSelection];
        if (selected.length === 0 && tavolo.length === 0) return;
        
        const annotationsEl = document.getElementById('formulaAnnotations');
        const newFormula = {
            id: Date.now().toString(),
            name: name,
            ingredientIds: tavolo.length > 0 ? [...tavolo] : selected,
            annotations: annotationsEl ? annotationsEl.value : '',
            date: new Date().toISOString()
        };
        
        let saved = JSON.parse(localStorage.getItem('savedFormulas') || '[]');
        saved.push(newFormula);
        localStorage.setItem('savedFormulas', JSON.stringify(saved));
        loadSavedFormulas();
    }
    
    function doLoadFormula(formula) {
        tavolo = [];
        formulaSelection.clear(); customDosages = {};
        
        // v75: Traccia ID e nome della ricetta caricata per sovrascrittura
        window._editingFormulaId = formula.id || null;
        window._editingFormulaName = formula.name || null;
        
        const ings = INGREDIENTI_DATA?.ingredienti || {};
        const ids = formula.ingredientIds || formula.items?.map(i => i.id || i) || [];
        
        // v75: Ripristina dosaggi custom se salvati
        if (formula.customDosages) {
            try { customDosages = JSON.parse(JSON.stringify(formula.customDosages)); } catch(e) {}
        }
        // v91: Ripristina tecnica
        if (formula.tecnica && TECNICA_MODIFIERS[formula.tecnica]) {
            setTecnica(formula.tecnica);
        } else {
            setTecnica('colata');
        }
        // v92: Ripristina coating
        coatingAttivo = !!formula.coating;
        var coatingCb = document.getElementById('coatingCheck');
        if (coatingCb) coatingCb.checked = coatingAttivo;
        var coatingRow = document.getElementById('coatingRow');
        if (coatingRow) coatingRow.classList.toggle('active', coatingAttivo);
        
        ids.forEach(ingId => {
            const alreadyInCart = cart.find(c => c.id === ingId);
            if (!alreadyInCart) {
                const ing = ings[ingId];
                if (ing) {
                    cart.push({...ing, id: ingId, informativo: false});
                } else {
                    cart.push({
                        id: ingId,
                        nome: ingId.replace(/_/g, ' '),
                        famiglia: 'teorico',
                        informativo: true
                    });
                }
            }
            if (!tavolo.includes(ingId)) tavolo.push(ingId);
            formulaSelection.add(ingId);
        });
        
        const annotationsEl = document.getElementById('formulaAnnotations');
        if (annotationsEl) annotationsEl.value = formula.annotations || '';
        
        updateCart();
        updateTavolo(); // v75: già  chiama checkCompatibility + calculateMaterial + calculateFormula
        saveCartToStorage();
        switchTab('C');
        
        showToast('Formula "' + (formula.name || 'Formula') + '" caricata!', 'success');
    }
    
    function deleteFormula(id) {
        showConfirmModal(
            'Elimina formula',
            'Eliminare questa formula salvata?',
            function() {
                let saved = JSON.parse(localStorage.getItem('savedFormulas') || '[]');
                // v60.2: Confronto robusto - gestisce sia stringhe che numeri
                saved = saved.filter(f => String(f.id) !== String(id));
                localStorage.setItem('savedFormulas', JSON.stringify(saved));
                loadSavedFormulas();
                showToast('Formula eliminata', 'info');
            }
        );
    }
    
    function saveCartToStorage() {
        localStorage.setItem('biomaterialiCart', JSON.stringify(cart));
        localStorage.setItem('biomaterialiTavolo', JSON.stringify(tavolo));
        localStorage.setItem('biomaterialiSelection', JSON.stringify([...formulaSelection]));
    }
    
    function loadCartFromStorage() {
        try {
            const savedCart = JSON.parse(localStorage.getItem('biomaterialiCart') || '[]');
            const savedTavolo = JSON.parse(localStorage.getItem('biomaterialiTavolo') || '[]');
            const savedSelection = JSON.parse(localStorage.getItem('biomaterialiSelection') || '[]');
            
            if (savedCart.length > 0) {
                cart = savedCart;
                tavolo = savedTavolo;
                formulaSelection = new Set(savedSelection);
                updateCart();
                updateTavolo(); // v75: già  chiama checkCompatibility + calculateMaterial + calculateFormula
                console.log('Carrello ripristinato:', cart.length, 'ingredienti');
            }
        } catch(e) {
            console.log('Nessun carrello salvato');
        }
    }
    
    function clearAllStorage() {
        showConfirmModal(
            'Svuota tutto',
            'Svuotare carrello e tavolo?<br><br>Questa azione non puo essere annullata.',
            function() {
                cart = [];
                tavolo = [];
                formulaSelection.clear(); customDosages = {};
                window._editingFormulaId = null; window._editingFormulaName = null; // v75
                localStorage.removeItem('biomaterialiCart');
                localStorage.removeItem('biomaterialiTavolo');
                localStorage.removeItem('biomaterialiSelection');
                const ann = document.getElementById('formulaAnnotations');
                if (ann) ann.value = '';
                updateCart();
                updateTavolo(); // v75: già  chiama checkCompatibility + calculateMaterial + calculateFormula
                showToast('Tutto svuotato', 'info');
            }
        );
    }
    
    function downloadFormula() {
        if (!window.currentFormula) return;
        var f = window.currentFormula;
        var ings = INGREDIENTI_DATA?.ingredienti || {};
        
        // Calcola proprieta
        var allVegano = true, allFoodSafe = true;
        f.items.forEach(function(item) {
            if (!item.ing.vegano) allVegano = false;
            if (!item.ing.food_safe) allFoodSafe = false;
        });
        
        var props = f.properties || { trasparenza: 50, flessibilita: 50, resistenzaH2O: 50, resistenzaMecc: 50 };
        
        // Funzione per barra ASCII
        function makeBar(val) {
            var full = Math.round(val / 10);
            var empty = 10 - full;
            return '[' + '='.repeat(full) + '-'.repeat(empty) + '] ' + val + '%';
        }
        
        // Funzione pad
        function pad(str, len) {
            str = String(str);
            while (str.length < len) str += ' ';
            return str;
        }
        
        var line = '================================================================';
        var line2 = '----------------------------------------------------------------';
        var nl = '\n';
        
        var text = line + nl;
        text += '                      SCHEDA FORMULA' + nl;
        text += line + nl + nl;
        text += '     ' + f.name + nl;
        text += nl;
        text += 'Accademia Albertina di Belle Arti' + nl;
        text += 'Tipologia dei Nuovi Materiali' + nl;
        text += nl;
        text += 'Data: ' + new Date().toLocaleDateString('it-IT') + nl;
        text += nl;
        
        // Badges
        var badges = '';
        if (allFoodSafe) badges += '[Food-safe]  ';
        if (allVegano) badges += '[Vegano]  ';
        else badges += '[Non Vegano]  ';
        text += badges + nl;
        text += nl;
        
        // Formula
        text += line2 + nl;
        var actualTotal = f.total || 100;
        text += 'FORMULA (' + actualTotal + 'g totali secchi)' + nl;
        text += line2 + nl;
        text += pad('Ingrediente', 25) + pad('Ruolo', 16) + pad('Grammi', 8) + '%' + nl;
        text += line2 + nl;
        f.items.forEach(function(item) {
            var ruolo = item.role || item.ing.famiglia || '-';
            var effPct = actualTotal > 0 ? Math.round(item.percent / actualTotal * 100) : 0;
            var modMark = item.modified ? '*' : ' ';
            text += pad(item.ing.nome, 25) + pad(ruolo, 16) + pad(item.percent + 'g' + modMark, 8) + effPct + '%' + nl;
        });
        text += line2 + nl;
        text += pad('TOTALE', 41) + pad(actualTotal + 'g', 8) + '100%' + nl;
        text += nl;
        text += '+ Acqua: rapporto 1:3-4 sul peso secco (' + Math.round(actualTotal*3) + '-' + Math.round(actualTotal*4) + 'ml)' + nl;
        if (actualTotal !== 100) {
            text += nl + '* = dosaggio modificato rispetto alla formula base.' + nl;
            text += '  In laboratorio: parti da piccole quantita e mantieni i rapporti %.' + nl;
        }
        text += nl;
        
        // Note
        if (f.notes && f.notes.length > 0) {
            text += line2 + nl;
            text += 'NOTE DI PROCESSO' + nl;
            text += line2 + nl;
            f.notes.forEach(function(n) { text += '- ' + n + nl; });
            text += nl;
        }
        
        // Compatibilita
        if (f.compatList && f.compatList.length > 0) {
            text += line2 + nl;
            text += 'COMPATIBILITA' + nl;
            text += line2 + nl;
            f.compatList.forEach(function(c) {
                text += c.icon + ' ' + c.pair + ' - ' + c.note + nl;
            });
            text += nl;
        }
        
        // Proprieta
        text += line2 + nl;
        text += 'PROPRIETA STIMATE' + nl;
        text += line2 + nl;
        text += pad('Trasparenza:', 17) + makeBar(props.trasparenza) + nl;
        text += pad('Flessibilita:', 17) + makeBar(props.flessibilita) + nl;
        text += pad('Resist. H2O:', 17) + makeBar(props.resistenzaH2O) + nl;
        text += pad('Resist. mecc.:', 17) + makeBar(props.resistenzaMecc) + nl;
        text += nl;
        
        // v72: Tipo materiale risultante
        var resultType = document.getElementById('resultType');
        var resultBase = document.getElementById('resultBase');
        if (resultType && resultType.textContent && resultType.textContent !== '-') {
            text += pad('Tipo:', 17) + resultType.textContent + nl;
            if (resultBase && resultBase.textContent) {
                text += pad('', 17) + resultBase.textContent + nl;
            }
            text += nl;
        }
        
        // v72: Tags vegano/foodsafe
        var resultTags = document.getElementById('resultTags');
        if (resultTags && resultTags.textContent && resultTags.textContent !== '-') {
            text += resultTags.textContent.trim() + nl;
            text += nl;
        }
        
        // v72: Descrizione completa dal Tab C
        var descEl = document.getElementById('descriptionContent');
        if (descEl && descEl.innerText && descEl.innerText.trim().length > 20) {
            text += line + nl;
            text += '              DESCRIZIONE DEL MATERIALE' + nl;
            text += line + nl + nl;
            
            // Estrai testo pulito da ogni sezione
            var sections = descEl.querySelectorAll('.desc-title');
            sections.forEach(function(titleEl) {
                var sectionTitle = titleEl.textContent.trim().toUpperCase();
                text += line2 + nl;
                text += sectionTitle + nl;
                text += line2 + nl;
                
                // Raccogli contenuto fino al prossimo titolo
                var sibling = titleEl.nextElementSibling;
                while (sibling && !sibling.classList.contains('desc-title')) {
                    var sText = sibling.innerText || sibling.textContent || '';
                    sText = sText.trim();
                    if (sText.length > 0) {
                        text += sText + nl;
                    }
                    sibling = sibling.nextElementSibling;
                }
                text += nl;
            });
            
            // Se non ci sono sezioni strutturate, fallback a innerText grezzo
            if (sections.length === 0) {
                var rawDesc = descEl.innerText.trim();
                rawDesc = rawDesc.replace(/\n{3,}/g, '\n\n');
                text += rawDesc + nl + nl;
            }
        }
        
        // v72: Smart messages (se dosaggi modificati)
        if (f.total && f.total !== 100) {
            var smartMsgs = getSmartMessages(f.items, f.total);
            if (smartMsgs.length > 0) {
                text += line2 + nl;
                text += 'NOTE SUI DOSAGGI MODIFICATI' + nl;
                text += line2 + nl;
                smartMsgs.forEach(function(msg) {
                    var prefix = msg.type === 'warn' ? '[!] ' : '[i] ';
                    text += prefix + msg.text + nl;
                });
                text += nl;
            }
        }
        
        // v72: Limiti e compatibilita dal pannello
        var limitsEl = document.getElementById('limitsContent');
        if (limitsEl && limitsEl.innerText && limitsEl.innerText.trim().length > 5) {
            text += line2 + nl;
            text += 'COMPATIBILITA TRA INGREDIENTI' + nl;
            text += line2 + nl;
            text += limitsEl.innerText.trim() + nl;
            text += nl;
        }
        
        // Lista spesa
        text += line2 + nl;
        text += 'LISTA DELLA SPESA' + nl;
        text += line2 + nl;
        text += pad('Ingrediente', 25) + pad('Qty', 10) + 'Dove trovarlo' + nl;
        text += line2 + nl;
        f.items.forEach(function(item) {
            var dove = item.ing.reperibilita || 'Vedi scheda';
            text += pad(item.ing.nome, 25) + pad(item.percent + 'g', 10) + dove + nl;
        });
        if (f.suggested && f.suggested.length > 0) {
            f.suggested.forEach(function(s) {
                text += pad(s.nome + ' [SUGG.]', 25) + pad('~10g', 10) + (s.reperibilita || 'Vedi scheda') + nl;
            });
        }
        text += nl;
        
        // Annotazioni personali
        var annotations = document.getElementById('formulaAnnotations')?.value || '';
        if (annotations.trim()) {
            text += line2 + nl;
            text += 'ANNOTAZIONI PERSONALI' + nl;
            text += line2 + nl;
            text += annotations + nl;
            text += nl;
        }
        
        // Footer
        text += line + nl;
        text += 'Configuratore Biomateriali v92 - Accademia Albertina' + nl;
        text += 'Formula sperimentale - verificare sempre in laboratorio' + nl;
        text += line + nl;
        
        var blob = new Blob([text], { type: 'text/plain' });
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        a.download = 'scheda_' + f.name.replace(/[^a-z0-9]/gi, '_').toLowerCase() + '.txt';
        a.click();
        URL.revokeObjectURL(url);
    }

    function checkCompatibility() {
        const container = document.getElementById('compatResults');
        if (!container) return;
        const ings = INGREDIENTI_DATA?.ingredienti || {};
        
        if (tavolo.length < 2) {
            container.innerHTML = '<div class="compat-empty">Aggiungi almeno 2 ingredienti</div>';
            return;
        }
        
        let html = '';
        for (let i = 0; i < tavolo.length; i++) {
            for (let j = i + 1; j < tavolo.length; j++) {
                const id1 = tavolo[i], id2 = tavolo[j];
                const ing1 = ings[id1], ing2 = ings[id2];
                if (!ing1 || !ing2) continue;
                
                const fam1 = ing1.famiglia, fam2 = ing2.famiglia;
                let compat = null;
                
                if (compatDB[fam1] && compatDB[fam1][fam2]) compat = compatDB[fam1][fam2];
                else if (compatDB[fam2] && compatDB[fam2][fam1]) compat = compatDB[fam2][fam1];
                
                let rowClass = 'ok', statusIcon = 'OK', note = 'Compatibili';
                
                if (compat && compat.liv) {
                    if (compat.liv === 'eccellente') { rowClass = 'synergy'; statusIcon = '++'; }
                    else if (compat.liv === 'buona') { rowClass = 'ok'; statusIcon = 'OK'; }
                    else if (compat.liv === 'neutra') { rowClass = 'ok'; statusIcon = '~'; note = 'Neutri'; }
                    else if (compat.liv === 'attenzione') { rowClass = 'warning'; statusIcon = '   '; }
                    else if (compat.liv === 'limitata' || compat.liv === 'incompatibile') { rowClass = 'error'; statusIcon = '  -'; }
                    if (compat.note) note = compat.note;
                }
                
                html += '<div class="compat-row ' + rowClass + '">' +
                    '<span class="status">' + statusIcon + '</span>' +
                    '<div class="content"><div class="pair">' + ing1.nome + ' + ' + ing2.nome + '</div>' +
                    '<div class="note">' + note + '</div></div></div>';
            }
        }
        
        container.innerHTML = html || '<div class="compat-empty">Nessuna incompatibilit   rilevata</div>';
    }
    
    function calculateMaterial() {
        const typeEl = document.getElementById('resultType');
        const baseEl = document.getElementById('resultBase');
        const tagsEl = document.getElementById('resultTags');
        if (!typeEl || !baseEl || !tagsEl) return;
        
        // v92: Aggiorna disponibilita tecniche e coating
        updateTecnicaAvailability();
        
        const ings = INGREDIENTI_DATA?.ingredienti || {};
        const selected = [...formulaSelection]; // USA SELEZIONE, non tavolo
        
        if (selected.length === 0) {
            typeEl.textContent = '-';
            baseEl.textContent = 'Seleziona ingredienti con    ';
            tagsEl.innerHTML = '-';
            updateBar('barTrasp', 0); updateBar('barFlex', 0); updateBar('barH2O', 0); updateBar('barMecc', 0);
            document.getElementById('limitsSection').style.display = 'none';
            document.getElementById('suggestionsSection').style.display = 'none';
            // Reset descrizione
            const descEl = document.getElementById('descriptionContent');
            if (descEl) descEl.innerHTML = '<div class="description-empty">Aggiungi ingredienti al tavolo per vedere una descrizione del possibile materiale</div>';
            return;
        }
        
        let matrice = null, plastificante = null, lipide = null;
        let allVegano = true, allFoodSafe = true;
        
        selected.forEach(id => {
            const ing = ings[id];
            if (!ing) return;
            if (['PROTEINA', 'POLISACCARIDE_NEUTRO', 'POLISACCARIDE_ANIONICO', 'POLICATIONE', 'COLTURA'].includes(ing.famiglia)) {
                if (!matrice) matrice = ing;
            }
            if (ing.famiglia === 'PLASTIFICANTE') plastificante = ing;
            if (ing.famiglia === 'LIPIDE') lipide = ing;
            if (!ing.vegano) allVegano = false;
            if (!ing.food_safe) allFoodSafe = false;
        });
        
        let tipo = 'Miscela';
        if (matrice) {
            const forme = matrice.lavorabilita?.forma_tipica || ['materiale'];
            tipo = forme[0].charAt(0).toUpperCase() + forme[0].slice(1);
        }
        if (plastificante) tipo += ' flessibile';
        if (lipide) tipo += coatingAttivo ? ' con coating' : ' impermeabilizzato';
        // v91: Suffisso tecnica
        var tecSuffix = TECNICA_MODIFIERS[currentTecnica];
        if (tecSuffix && tecSuffix.descTipo) tipo += tecSuffix.descTipo;
        
        typeEl.textContent = tipo;
        baseEl.textContent = matrice ? 'Base: ' + matrice.nome : selected.length + ' ingredienti';
        
        // v89: Calcolo proprietà con valori CALIBRATI + interazioni + cap opacizzanti
        let trasparenza = 0, flessibilita = 0, resistH2O = 0, resistMecc = 0;
        let hasMatrice = false;
        let famiglieConte = {}; // Per contare quante di ogni famiglia
        let famigliePresenti = new Set(); // Per interazioni
        
        selected.forEach(id => {
            const ing = ings[id];
            if (!ing) return;
            const fam = ing.famiglia;
            famiglieConte[fam] = (famiglieConte[fam] || 0) + 1;
            famigliePresenti.add(fam);
            
            // v89: Valori fissi CALIBRATI su 34 materiali reali
            if (fam === 'PROTEINA') {
                trasparenza += 52; flessibilita += 31; resistH2O += 19; resistMecc += 37;
                hasMatrice = true;
            } else if (fam === 'POLISACCARIDE_NEUTRO') {
                trasparenza += 61; flessibilita += 17; resistH2O += 26; resistMecc += 42;
                hasMatrice = true;
            } else if (fam === 'POLISACCARIDE_ANIONICO') {
                trasparenza += 77; flessibilita += 30; resistH2O += 27; resistMecc += 48;
                hasMatrice = true;
            } else if (fam === 'POLICATIONE') {
                trasparenza += 50; flessibilita += 25; resistH2O += 32; resistMecc += 62;
                hasMatrice = true;
            } else if (fam === 'COLTURA') {
                trasparenza += 30; flessibilita += 50; resistH2O += 25; resistMecc += 55;
                hasMatrice = true;
            }
            // Modificatori calibrati
            else if (fam === 'PLASTIFICANTE') {
                flessibilita += 42; resistMecc -= 6; trasparenza -= 1; resistH2O += 8;
            } else if (fam === 'LIPIDE') {
                resistH2O += 23; trasparenza += 10; flessibilita += 13; resistMecc += 30;
            } else if (fam === 'CARICA') {
                resistMecc += 29; trasparenza -= 28; flessibilita -= 5; resistH2O += 3;
            } else if (fam === 'SALE_RETICOLANTE') {
                resistMecc += 16; resistH2O += 22; flessibilita -= 15; trasparenza -= 9;
            } else if (fam === 'COLORANTE') {
                trasparenza -= 34; flessibilita += 1; resistH2O += 10; resistMecc += 7;
            } else if (fam === 'ACIDO') {
                resistMecc += 5;
            } else if (fam === 'ADDITIVO') {
                resistH2O += 19; resistMecc += 7; trasparenza -= 1; flessibilita += 1;
            } else if (fam === 'EMULSIONANTE') {
                flessibilita += 10; trasparenza += 5;
            }
        });
        
        // v89: Applica INTERAZIONI tra famiglie
        const famArray = [...famigliePresenti];
        for (let i = 0; i < famArray.length; i++) {
            for (let j = i; j < famArray.length; j++) {
                const key1 = famArray[i] + '+' + famArray[j];
                const key2 = famArray[j] + '+' + famArray[i];
                const interaction = FAMILY_INTERACTIONS[key1] || FAMILY_INTERACTIONS[key2];
                if (interaction) {
                    trasparenza += interaction.trasp || 0;
                    flessibilita += interaction.flex || 0;
                    resistH2O += interaction.h2o || 0;
                    resistMecc += interaction.mecc || 0;
                }
            }
        }
        // Interazione speciale: doppia carica
        if ((famiglieConte['CARICA'] || 0) >= 2) {
            const doubleCarica = FAMILY_INTERACTIONS['CARICA+CARICA'];
            if (doubleCarica) {
                trasparenza += doubleCarica.trasp || 0;
                flessibilita += doubleCarica.flex || 0;
                resistH2O += doubleCarica.h2o || 0;
                resistMecc += doubleCarica.mecc || 0;
            }
        }
        
        // v89: CAP OPACIZZANTI - trasparenza limitata se presenti cariche/coloranti/scarti
        if (famigliePresenti.has('CARICA')) trasparenza = Math.min(trasparenza, 40);
        if (famigliePresenti.has('COLORANTE')) trasparenza = Math.min(trasparenza, 35);
        // Controllo ingredienti specifici opacizzanti (bucce, fondi, scarti)
        const opacizzanti = ['fondi_caffe', 'bucce_agrumi', 'segatura', 'paglia', 'cellulosa_carta'];
        if (selected.some(id => opacizzanti.includes(id))) trasparenza = Math.min(trasparenza, 25);
        
        // Se non c'è matrice, valori bassi
        if (!hasMatrice && selected.length > 0) {
            trasparenza = Math.max(trasparenza, 20);
            flessibilita = Math.max(flessibilita, 20);
            resistH2O = Math.max(resistH2O, 10);
            resistMecc = Math.max(resistMecc, 15);
        }
        
        // v91: Modificatori tecnica (path valori fissi)
        var tecMod = TECNICA_MODIFIERS[currentTecnica];
        if (tecMod) { trasparenza += tecMod.trasp; flessibilita += tecMod.flex; resistH2O += tecMod.h2o; resistMecc += tecMod.mecc; }
        
        // v92: Coating — swap lipide da mix a superficie (path valori fissi)
        if (coatingAttivo && famigliePresenti.has('LIPIDE')) {
            // Annulla contributo lipide nel mix: trasp+10, flex+13, h2o+23, mecc+30
            trasparenza -= 10; flessibilita -= 13; resistH2O -= 23; resistMecc -= 30;
            // Ricalcola come coating: solo forte barriera H2O, minimo impatto resto
            trasparenza -= 2; resistH2O += 45;
        }
        
        // Clamp 0-100
        trasparenza = Math.max(0, Math.min(100, trasparenza));
        flessibilita = Math.max(0, Math.min(100, flessibilita));
        resistH2O = Math.max(0, Math.min(100, resistH2O));
        resistMecc = Math.max(0, Math.min(100, resistMecc));
        
        // v71: Se dosaggi personalizzati, usa calcolo proporzionale (già include tecnica+cap via applyPostCalcModifiers)
        if (Object.keys(customDosages).length > 0 && window.currentFormula && window.currentFormula.properties) {
            const cp = window.currentFormula.properties;
            trasparenza = cp.trasparenza;
            flessibilita = cp.flessibilita;
            resistH2O = cp.resistenzaH2O;
            resistMecc = cp.resistenzaMecc;
        }
        
        updateBar('barTrasp', trasparenza); updateBar('barFlex', flessibilita);
        updateBar('barH2O', resistH2O); updateBar('barMecc', resistMecc);
        
        tagsEl.innerHTML = '<span class="tag ' + (allFoodSafe ? 'ok' : 'no') + '">' + (allFoodSafe ? '   ' : '  -') + ' Food-safe</span>' +
            '<span class="tag ' + (allVegano ? 'ok' : 'no') + '">' + (allVegano ? '   ' : '  -') + ' Vegano</span>';
        
        // Limiti
        const limitsSection = document.getElementById('limitsSection');
        const limitsContent = document.getElementById('limitsContent');
        let limits = [];
        if (resistH2O < 30 && !lipide) limits.push({problem: 'Resistenza acqua scarsa', solution: 'Aggiungi lipide', type: 'warn'});
        if (flessibilita < 40 && !plastificante && matrice) limits.push({problem: 'Materiale fragile', solution: 'Aggiungi plastificante', type: 'warn'});
        
        // v89: WARNING COMPOSIZIONE TAVOLO (elastici ma informativi)
        const matriciFams = ['PROTEINA', 'POLISACCARIDE_NEUTRO', 'POLISACCARIDE_ANIONICO', 'POLICATIONE', 'COLTURA'];
        let nMatrici = 0;
        matriciFams.forEach(function(f) { nMatrici += famiglieConte[f] || 0; });
        
        if (nMatrici > 2) {
            limits.push({problem: nMatrici + ' matrici sul tavolo', solution: 'Max 2 consigliate per stabilita', type: 'alert'});
        }
        if ((famiglieConte['PLASTIFICANTE'] || 0) > 1) {
            limits.push({problem: 'Piu plastificanti', solution: 'Uno e sufficiente', type: 'info'});
        }
        if ((famiglieConte['SALE_RETICOLANTE'] || 0) > 1) {
            limits.push({problem: 'Piu reticolanti', solution: 'Meccanismi diversi possono confliggere', type: 'alert'});
        }
        if ((famiglieConte['CARICA'] || 0) > 2) {
            limits.push({problem: famiglieConte['CARICA'] + ' cariche', solution: 'Max 2 per evitare friabilita', type: 'warn'});
        }
        if ((famiglieConte['COLORANTE'] || 0) > 1) {
            limits.push({problem: 'Piu coloranti', solution: 'Risultato cromatico imprevedibile', type: 'info'});
        }
        if ((famiglieConte['LIPIDE'] || 0) > 1) {
            limits.push({problem: 'Piu lipidi', solution: 'Coating disomogeneo possibile', type: 'info'});
        }
        if ((famiglieConte['SALE_RETICOLANTE'] || 0) > 0) {
            var hasAnionico = famigliePresenti.has('POLISACCARIDE_ANIONICO');
            var hasProteina = famigliePresenti.has('PROTEINA');
            if (!hasAnionico && !hasProteina) {
                limits.push({problem: 'Reticolante senza matrice', solution: 'Serve proteina o polisaccaride anionico', type: 'warn'});
            }
        }
        
        if (limits.length > 0) {
            limitsSection.style.display = 'block';
            limitsContent.innerHTML = limits.map(function(l) {
                var icon = l.type === 'alert' ? '<span style="color:#d32f2f">&#9679;</span>' : (l.type === 'warn' ? '<span style="color:#f57c00">&#9679;</span>' : '<span style="color:#1976d2">&#9679;</span>');
                return '<div class="limit-item"><div class="limit-problem">' + icon + ' ' + l.problem + '</div><div class="limit-solution">&#8594; ' + l.solution + '</div></div>';
            }).join('');

        } else {
            limitsSection.style.display = 'none';
        }
        
        // Suggerimenti
        const suggestionsSection = document.getElementById('suggestionsSection');
        const suggestionsContent = document.getElementById('suggestionsContent');
        let suggestions = [];
        if (!matrice && selected.length > 0) suggestions.push('Manca una matrice come base');
        
        if (suggestions.length > 0) {
            suggestionsSection.style.display = 'block';
            suggestionsContent.innerHTML = suggestions.map(s => '<div class="suggestion-item">     ' + s + '</div>').join('');
        } else {
            suggestionsSection.style.display = 'none';
        }
        
        // NUOVA: Genera descrizione testuale del materiale ipotizzato
        generateMaterialDescription(selected, matrice, plastificante, lipide, trasparenza, flessibilita, resistH2O, resistMecc, allVegano, allFoodSafe, limits);
    }
    
    function updateBar(id, value) {
        const bar = document.getElementById(id);
        if (!bar) return;
        const v = Math.min(100, Math.max(0, value));
        bar.style.width = v + '%';
        bar.className = 'bar-fill ' + (v > 60 ? 'high' : v > 30 ? 'medium' : 'low');
    }
    
    // ===============================================
    // v89: SCORE DI ATTENDIBILITA PREVISIONE
    // ===============================================
    function calculateReliabilityScore(selectedIds, limits) {
        const ings = INGREDIENTI_DATA?.ingredienti || {};
        const materialiDB = typeof MATERIALI_DATA !== 'undefined' ? MATERIALI_DATA : null;
        
        let score = 50; // Base: previsione teorica
        let reasons = [];
        let bestMatch = null;
        let bestJaccard = 0;
        
        // 1. MATCH CON MATERIALI TESTATI (Jaccard)
        if (materialiDB) {
            const userNoAcqua = selectedIds.filter(function(id) { return id !== 'acqua'; });
            
            // Scan in_progress (dati reali di laboratorio)
            (materialiDB.materiali_in_progress || []).forEach(function(mat) {
                const matIngs = (mat.ingredienti_correlati || []).filter(function(id) { return id !== 'acqua'; });
                if (matIngs.length === 0) return;
                const overlap = userNoAcqua.filter(function(id) { return matIngs.includes(id); });
                const unionSize = new Set([...userNoAcqua, ...matIngs]).size;
                const jaccard = unionSize > 0 ? overlap.length / unionSize : 0;
                if (jaccard > bestJaccard) {
                    bestJaccard = jaccard;
                    bestMatch = { nome: mat.nome, jaccard: jaccard, tipo: 'lab', id: mat.id };
                }
            });
            
            // Scan documentati
            (materialiDB.materiali_documentati || []).forEach(function(mat) {
                const matIngs = (mat.ingredienti_correlati || mat.ingredienti || []).filter(function(id) { return id !== 'acqua'; });
                if (matIngs.length === 0) return;
                const overlap = userNoAcqua.filter(function(id) { return matIngs.includes(id); });
                const unionSize = new Set([...userNoAcqua, ...matIngs]).size;
                const jaccard = unionSize > 0 ? overlap.length / unionSize : 0;
                if (jaccard > bestJaccard) {
                    bestJaccard = jaccard;
                    bestMatch = { nome: mat.nome || mat.subtitle, jaccard: jaccard, tipo: 'doc' };
                }
            });
        }
        
        // Bonus per match con materiali testati
        if (bestJaccard >= 0.95) {
            score = 95;
            reasons.push('ricetta identica a materiale testato');
        } else if (bestJaccard >= 0.8) {
            score = 75 + Math.round(bestJaccard * 20);
            reasons.push('ricetta molto simile a "' + bestMatch.nome + '"');
        } else if (bestJaccard >= 0.5) {
            score = 55 + Math.round(bestJaccard * 25);
            reasons.push('ricetta affine a materiali noti');
        } else if (bestJaccard >= 0.3) {
            score = 45 + Math.round(bestJaccard * 15);
            reasons.push('alcuni ingredienti in comune con materiali testati');
        } else {
            reasons.push('combinazione nuova, non ancora testata');
        }
        
        // 2. PENALITA PER WARNING COMPOSIZIONE
        var nAlert = 0, nWarn = 0, nInfo = 0;
        (limits || []).forEach(function(l) {
            if (l.type === 'alert') nAlert++;
            else if (l.type === 'warn') nWarn++;
            else if (l.type === 'info') nInfo++;
        });
        
        if (nAlert >= 2) {
            score -= 25;
            reasons.push('composizione molto anomala');
        } else if (nAlert >= 1) {
            score -= 15;
            reasons.push('composizione anomala');
        }
        if (nWarn >= 2) {
            score -= 10;
        } else if (nWarn >= 1) {
            score -= 5;
        }
        
        // 3. BONUS PER RICETTE SENSATE
        var hasMatrice = false;
        var hasMod = false;
        selectedIds.forEach(function(id) {
            var ing = ings[id];
            if (!ing) return;
            var fam = ing.famiglia;
            if (['PROTEINA','POLISACCARIDE_NEUTRO','POLISACCARIDE_ANIONICO','POLICATIONE','COLTURA'].includes(fam)) hasMatrice = true;
            if (['PLASTIFICANTE','LIPIDE','SALE_RETICOLANTE','CARICA','COLORANTE'].includes(fam)) hasMod = true;
        });
        
        if (hasMatrice && selectedIds.length >= 2 && selectedIds.length <= 5) {
            score += 5; // Ricetta di complessita ragionevole
        }
        if (!hasMatrice && selectedIds.length > 0) {
            score -= 15;
            reasons.push('manca matrice strutturante');
        }
        
        // Clamp 5-100
        score = Math.max(5, Math.min(100, score));
        
        // Determina livello e icona (HTML entities, no emoji)
        var level, icon, color, label;
        if (score >= 90) {
            level = 'verified'; icon = '&#9745;'; color = '#2e7d32'; label = 'Previsione verificata';
        } else if (score >= 70) {
            level = 'high'; icon = '&#9679;'; color = '#4caf50'; label = 'Previsione attendibile';
        } else if (score >= 50) {
            level = 'medium'; icon = '&#9681;'; color = '#ff9800'; label = 'Previsione teorica';
        } else if (score >= 30) {
            level = 'low'; icon = '&#9680;'; color = '#f57c00'; label = 'Previsione incerta';
        } else {
            level = 'verylow'; icon = '&#9888;'; color = '#d32f2f'; label = 'Previsione inaffidabile';
        }
        
        return {
            score: score,
            level: level,
            icon: icon,
            color: color,
            label: label,
            reasons: reasons,
            bestMatch: bestMatch,
            bestJaccard: bestJaccard
        };
    }
    
    // ===============================================
    // GENERAZIONE DESCRIZIONE MATERIALE IPOTIZZATO
    // ===============================================
    function generateMaterialDescription(selectedIds, matrice, plastificante, lipide, trasp, flex, resistH2O, resistMecc, vegano, foodSafe, limits) {
        const descEl = document.getElementById('descriptionContent');
        if (!descEl) return;
        
        if (selectedIds.length === 0) {
            descEl.innerHTML = '<div class="description-empty">Aggiungi ingredienti al tavolo per vedere una descrizione del possibile materiale</div>';
            return;
        }
        
        const ings = INGREDIENTI_DATA?.ingredienti || {};
        let html = '';

        
        // v89: SCORE DI ATTENDIBILITA
        var reliability = calculateReliabilityScore(selectedIds, limits || []);
        html += '<div class="desc-reliability" style="background:linear-gradient(135deg, ' + reliability.color + '22, ' + reliability.color + '11); border-left:4px solid ' + reliability.color + '; padding:12px 15px; margin-bottom:15px; border-radius:0 8px 8px 0;">';
        html += '<div style="display:flex; align-items:center; gap:10px; margin-bottom:6px;">';
        html += '<span style="font-size:1.5em; color:' + reliability.color + '">' + reliability.icon + '</span>';
        html += '<span style="font-weight:600; color:' + reliability.color + '; font-size:1.1em;">' + reliability.label + '</span>';
        html += '<span style="background:' + reliability.color + '; color:white; padding:2px 8px; border-radius:12px; font-size:0.85em; font-weight:600;">' + reliability.score + '%</span>';
        html += '</div>';
        if (reliability.reasons.length > 0) {
            html += '<div style="font-size:0.85em; color:#555;">' + reliability.reasons.slice(0,2).join(' - ') + '</div>';
        }
        if (reliability.bestMatch && reliability.bestJaccard >= 0.5) {
            var linkId = reliability.bestMatch.id || '';
            html += '<div style="font-size:0.8em; color:#777; margin-top:4px;">Riferimento: <strong>' + reliability.bestMatch.nome + '</strong> (' + Math.round(reliability.bestJaccard * 100) + '% affinita)';
            if (linkId) html += ' <a href="#" onclick="showMaterialDetail(\'' + linkId + '\'); return false;" style="color:' + reliability.color + '">vedi scheda</a>';
            html += '</div>';
        }
        html += '</div>';        
        // Raccogli info dettagliate su tutti gli ingredienti
        let hasCarica = false, hasColorante = false, hasReticolante = false, hasAcido = false, hasEmulsionante = false;
        let hasFibra = false, hasAmido = false, hasGelatina = false, hasAgar = false, hasAlginato = false;
        let hasCaseina = false, hasChitosano = false, hasPectina = false, hasGlicerina = false;
        let hasCera = false, hasGommalacca = false, hasTannini = false, hasCarbone = false;
        let matriceNome = matrice ? matrice.nome : null;
        let matriceFamiglia = matrice ? matrice.famiglia : null;
        let plastificanteNome = plastificante ? plastificante.nome : null;
        let lipideNome = lipide ? lipide.nome : null;
        let numIngredienti = selectedIds.length;
        let caricaNome = null, coloranteNome = null;
        
        selectedIds.forEach(id => {
            const ing = ings[id];
            if (!ing) return;
            const nome = (ing.nome || '').toLowerCase();
            const fam = ing.famiglia;
            
            if (fam === 'CARICA') { hasCarica = true; caricaNome = ing.nome; }
            if (fam === 'COLORANTE') { hasColorante = true; coloranteNome = ing.nome; }
            if (fam === 'SALE_RETICOLANTE') hasReticolante = true;
            if (fam === 'ACIDO') hasAcido = true;
            if (fam === 'EMULSIONANTE') hasEmulsionante = true;
            
            // Ingredienti specifici - controlli precisi con termini IT/EN
            // FIBRE: esclude "olio di lino", "alginato", "caolino"
            const isOlioLino = nome.includes('olio') && nome.includes('lino');
            const isAlginato = nome.includes('alginato') || nome.includes('alginate');
            const isCaolino = nome.includes('caolino') || nome.includes('kaolin');
            const isFibraTerms = nome.includes('fibr') || nome.includes('fiber') || nome.includes('fibre') ||
                nome.includes('juta') || nome.includes('jute') || 
                nome.includes('canapa') || nome.includes('hemp') ||
                nome.includes('flax') || nome.includes('sisal') || nome.includes('kenaf') ||
                (nome.includes('lino') && !isOlioLino && !isAlginato && !isCaolino) ||
                (nome.includes('cellulosa') && !nome.includes('batterica')) ||
                (nome.includes('cellulose') && !nome.includes('bacterial'));
            if (isFibraTerms) hasFibra = true;
            if (nome.includes('amido')) hasAmido = true;
            if (nome.includes('gelatina')) hasGelatina = true;
            if (nome.includes('agar')) hasAgar = true;
            if (nome.includes('alginato')) hasAlginato = true;
            if (nome.includes('caseina')) hasCaseina = true;
            if (nome.includes('chitosano')) hasChitosano = true;
            if (nome.includes('pectina')) hasPectina = true;
            if (nome.includes('glicerina') || nome.includes('sorbitolo')) hasGlicerina = true;
            if (nome.includes('cera') || nome.includes('carnauba') || nome.includes('candelilla')) hasCera = true;
            if (nome.includes('gommalacca')) hasGommalacca = true;
            if (nome.includes('tannin')) hasTannini = true;
            if (nome.includes('carbone')) hasCarbone = true;
        });
        
        // Rileva ingredienti che riducono SEMPRE la trasparenza (anche se non classificati come CARICA)
        let hasOpacizzante = false;
        let opacizzanteNome = null;
        selectedIds.forEach(id => {
            const ing = ings[id];
            if (!ing) return;
            const nome = (ing.nome || '').toLowerCase();
            // Bucce, scarti, polveri, fondi, fibre = sempre opachi (IT/EN)
            if (nome.includes('bucc') || nome.includes('peel') || nome.includes('scorz') || 
                nome.includes('agrumi') || nome.includes('citrus') ||
                nome.includes('aranci') || nome.includes('orange') || 
                nome.includes('limon') || nome.includes('lemon') || nome.includes('pomelo') ||
                nome.includes('scart') || nome.includes('waste') || 
                nome.includes('fondi') || nome.includes('ground') || nome.includes('coffee') || nome.includes('caffe') ||
                nome.includes('polpa') || nome.includes('pulp') || 
                nome.includes('pula') || nome.includes('husk') || nome.includes('crusca') || nome.includes('bran') ||
                nome.includes('gusci') || nome.includes('shell') || 
                nome.includes('noccioli') || nome.includes('pit') || nome.includes('seed') ||
                nome.includes('legno') || nome.includes('wood') || 
                nome.includes('segatura') || nome.includes('sawdust') || 
                nome.includes('sughero') || nome.includes('cork') ||
                nome.includes('vinaccia') || nome.includes('grape') || nome.includes('marc') ||
                nome.includes('lolla') || nome.includes('bagassa') || nome.includes('bagasse')) {
                hasOpacizzante = true;
                opacizzanteNome = ing.nome;
            }
        });
        
        // Calcola trasparenza reale considerando opacizzanti
        let traspReale = trasp;
        if (hasOpacizzante) traspReale = Math.min(traspReale, 25); // Max 25% con scarti/bucce
        if (hasCarica) traspReale = Math.min(traspReale, 30);
        if (hasFibra) traspReale = Math.min(traspReale, 35);
        if (hasColorante || hasCarbone) traspReale = Math.min(traspReale, 40);
        
        // === LIVELLO DI DIFFICOLTÀ ===
        let diffLevel = 1;
        let diffReasons = [];
        const hasCarragenina = selectedIds.some(id => (ings[id]?.nome || '').toLowerCase().includes('carragenina'));
        const needsBoiling = hasAgar || hasCarragenina || hasAmido;
        
        if (selectedIds.length > 4) { diffLevel++; diffReasons.push('formula complessa (' + selectedIds.length + ' ingredienti)'); }
        if (selectedIds.length > 6) { diffLevel++; }
        if (needsBoiling) { diffLevel++; diffReasons.push('richiede ebollizione controllata'); }
        if (hasReticolante && hasAlginato) { diffLevel++; diffReasons.push('gelificazione ionica (timing critico)'); }
        if (matriceFamiglia === 'COLTURA') { diffLevel += 2; diffReasons.push('coltura biologica (giorni/settimane)'); }
        if (hasEmulsionante) { diffLevel++; diffReasons.push('emulsione (tecnica di miscelazione)'); }
        if (hasCaseina) { diffReasons.push('acidificazione e pressatura'); }
        if (hasChitosano) { diffReasons.push('dissoluzione in acido'); }
        if (hasAgar && hasGelatina) { diffReasons.push('temperature incompatibili da gestire'); }
        diffLevel = Math.min(diffLevel, 5);
        
        const diffLabels = ['', 'Base', 'Facile', 'Intermedio', 'Avanzato', 'Esperto'];
        const diffColors = ['', '#4caf50', '#8bc34a', '#ff9800', '#f44336', '#9c27b0'];
        let dots = '';
        for (let d = 1; d <= 5; d++) {
            dots += '<span style="color:' + (d <= diffLevel ? diffColors[diffLevel] : '#ddd') + '; font-size:1.1em;">●</span>';
        }
        html += '<div class="desc-difficulty">' + dots + ' <span style="color:' + diffColors[diffLevel] + '; font-weight:600;">' + diffLabels[diffLevel] + '</span>';
        if (diffReasons.length > 0) {
            html += ' <span class="desc-diff-detail">– ' + diffReasons.slice(0, 3).join(', ') + '</span>';
        }
        html += '</div>';
        
        // === FORMA E CONSISTENZA ===
        html += '<div class="desc-title">Forma e consistenza</div>';
        if (!matrice) {
            html += '<p>Senza una <span class="desc-warning">matrice strutturante</span> (proteina, polisaccaride), gli ingredienti non formeranno un materiale solido autonomo. Otterrai probabilmente una miscela liquida, pastosa o una polvere che non si aggrega.</p>';
            if (hasCarica && !hasFibra) html += '<p>Le cariche minerali da sole non creano struttura: servono a rinforzare una matrice esistente.</p>';
        } else {
            let forma = '';
            
            // PROTEINE
            if (matriceFamiglia === 'PROTEINA') {
                if (hasGelatina) {
                    forma = 'La gelatina forma un <span class="desc-highlight">gel termoreversibile</span>: si scioglie a caldo (~40C) e solidifica raffreddando. Il risultato e un film elastico e trasparente.';
                    if (plastificante) {
                        if (hasGlicerina) forma += ' Con glicerina otterrai un film molto morbido, quasi gommoso, che rimane flessibile anche dopo settimane.';
                        else forma += ' Il plastificante aumentera la flessibilita del film finale.';
                    }
                    if (hasTannini) forma += ' I tannini reagiranno con la gelatina creando un effetto "concia" simile al cuoio: piu rigido, piu resistente all\'acqua, colore brunito.';
                    if (hasReticolante) forma += ' Il reticolante rendera il gel meno solubile e piu stabile.';
                } else if (hasCaseina) {
                    forma = 'La caseina forma <span class="desc-highlight">plastiche rigide</span> quando acidificata e pressata. Storicamente usata per bottoni, pettini, gioielli. Richiede stagionatura di giorni/settimane per indurire completamente.';
                    if (plastificante) forma += ' Il plastificante ridurra la fragilita ma anche la durezza finale.';
                    if (hasCarica) forma += ' Le cariche minerali aumenteranno rigidita e resistenza al graffio.';
                } else {
                    forma = 'Questo materiale sara probabilmente un <span class="desc-highlight">film o gel proteico</span>, con una struttura a rete formata dalle catene proteiche.';
                    if (plastificante) forma += ' Il plastificante rendera il film piu morbido e pieghevole.';
                }
            }
            // POLISACCARIDI NEUTRI
            else if (matriceFamiglia === 'POLISACCARIDE_NEUTRO') {
                if (hasAgar) {
                    forma = 'L\'agar forma <span class="desc-highlight">gel rigidi e fragili</span> con elevata trasparenza. Gelifica a ~35C ma fonde solo a ~85C (isteresi termica). Ottimo per stampi e forme precise.';
                    if (plastificante) forma += ' Il plastificante e ESSENZIALE per evitare crepe durante l\'essiccazione - senza glicerina l\'agar si frattura facilmente.';
                    if (hasFibra) forma += ' Le fibre daranno rinforzo strutturale creando un composito piu resistente agli urti.';
                } else if (hasAmido) {
                    forma = 'L\'amido gelatinizzato forma <span class="desc-highlight">film opachi e rigidi</span>. La consistenza dipende molto dalla fonte: mais da film piu rigidi, tapioca piu flessibili e trasparenti.';
                    if (plastificante) forma += ' Senza plastificante sufficiente (almeno 20-30% sul peso dell\'amido) il film sara fragile e si crepa.';
                    if (hasCarica) forma += ' Le cariche possono creare compositi interessanti tipo "carta minerale".';
                } else {
                    forma = 'La base polisaccaridica neutra formera un <span class="desc-highlight">materiale rigido</span> una volta essiccato, con buona trasparenza ma tendenza alla fragilita.';
                    if (plastificante) forma += ' Il plastificante e fondamentale per evitare crepe.';
                }
            }
            // POLISACCARIDI ANIONICI
            else if (matriceFamiglia === 'POLISACCARIDE_ANIONICO') {
                if (hasAlginato) {
                    forma = 'L\'alginato forma <span class="desc-highlight">gel ionici istantanei</span> a contatto con ioni calcio. Puoi creare sfere, fili, membrane con gelificazione controllata. Ideale per forme 3D complesse.';
                    if (hasReticolante) forma += ' Con CaCl2 avrai la classica "sferificazione": il gel si forma dalla superficie verso l\'interno.';
                    else forma += ' <span class="desc-warning">Senza sale di calcio</span> l\'alginato resta liquido viscoso - serve un reticolante!';
                } else if (hasPectina) {
                    forma = 'La pectina forma <span class="desc-highlight">gel acido-zuccherini</span>. Per gelificare correttamente serve pH basso (acido) e/o zuccheri. Il risultato e un gel morbido ed elastico.';
                    if (hasAcido) forma += ' L\'acido favorira la gelificazione abbassando il pH.';
                    if (plastificante) forma += ' I plastificanti aumentano flessibilita e riducono fragilita.';
                } else {
                    forma = 'I polisaccaridi anionici formano <span class="desc-highlight">gel ionici</span> reagendo con cationi bivalenti (Ca++, Mg++).';
                    if (hasReticolante) forma += ' Il sale reticolante creera una struttura stabile a "scatola di uova".';
                }
            }
            // POLICATIONI
            else if (matriceFamiglia === 'POLICATIONE') {
                if (hasChitosano) {
                    forma = 'Il chitosano forma <span class="desc-highlight">film antimicrobici</span> con proprieta uniche: la carica positiva lo rende naturalmente antibatterico e capace di legarsi a superfici cariche negativamente.';
                    forma += ' Richiede dissoluzione in acido diluito (aceto, acido citrico) prima dell\'uso.';
                    if (plastificante) forma += ' Il plastificante migliora notevolmente la flessibilita del film finale.';
                } else {
                    forma = 'I policationi producono <span class="desc-highlight">film con proprieta antimicrobiche</span> grazie alla carica positiva superficiale.';
                }
            }
            // COLTURE
            else if (matriceFamiglia === 'COLTURA') {
                forma = 'Le colture microbiche producono <span class="desc-highlight">materiali "cresciuti" biologicamente</span>. ';
                forma += 'SCOBY: pellicola di cellulosa batterica, simile a pelle/cuoio, richiede 1-3 settimane di coltura. ';
                forma += 'Micelio: struttura spugnosa o compatta a seconda del substrato e compressione.';
                forma += ' Questi materiali hanno texture organiche uniche impossibili da replicare sinteticamente.';
            }
            
            html += '<p>' + forma + '</p>';
            
            // Combinazioni specifiche
            if (matrice && hasFibra) {
                html += '<p><span class="desc-highlight">Composito fibrorinforzato</span>: le fibre aumenteranno drasticamente la resistenza a trazione e agli strappi, ma potrebbero ridurre trasparenza e uniformita.</p>';
            }
            if (matrice && hasCarica && !hasFibra) {
                html += '<p>Le <span class="desc-highlight">cariche minerali</span> (' + (caricaNome || 'minerali') + ') aumenteranno rigidita e resistenza al graffio, ma renderanno il materiale piu fragile e opaco.</p>';
            }
        }
        
        // === MATERIALI SIMILI TESTATI ===
        if (materialiDB) {
            let simili = [];
            // Scan in_progress
            (materialiDB.materiali_in_progress || []).forEach(mat => {
                const matIngs = mat.ingredienti_correlati || [];
                const userNoAcqua = selectedIds.filter(id => id !== 'acqua');
                const matNoAcqua = matIngs.filter(id => id !== 'acqua');
                const overlap = userNoAcqua.filter(id => matNoAcqua.includes(id));
                const unionSize = new Set([...userNoAcqua, ...matNoAcqua]).size;
                if (overlap.length >= 2 || (overlap.length >= 1 && matNoAcqua.length <= 2 && userNoAcqua.length <= 3)) {
                    simili.push({
                        nome: mat.nome,
                        tipo: 'lab',
                        overlap: overlap.length,
                        jaccard: unionSize > 0 ? overlap.length / unionSize : 0,
                        consistenza: mat.consistenza || '',
                        colore: mat.colore || '',
                        trasparenza: mat.trasparenza || '',
                        test_acqua: mat.test_acqua || '',
                        test_calore: mat.test_calore || '',
                        test_flessione: mat.test_flessione || '',
                        cucibile: mat.cucibile || '',
                        incollabile: mat.incollabile || '',
                        problemi: mat.problemi_realizzazione || '',
                        id: mat.id
                    });
                }
            });
            // Scan documentati
            (materialiDB.materiali_documentati || []).forEach(mat => {
                const matIngs = mat.ingredienti_correlati || mat.ingredienti || [];
                const userNoAcqua = selectedIds.filter(id => id !== 'acqua');
                const matNoAcqua = matIngs.filter(id => id !== 'acqua');
                const overlap = userNoAcqua.filter(id => matNoAcqua.includes(id));
                const unionSize = new Set([...userNoAcqua, ...matNoAcqua]).size;
                if (overlap.length >= 2) {
                    simili.push({
                        nome: mat.nome || mat.subtitle || mat.name || '',
                        tipo: 'doc',
                        overlap: overlap.length,
                        jaccard: unionSize > 0 ? overlap.length / unionSize : 0,
                        trl: mat.trl || 0,
                        replicabile: mat.replicabile_lab || mat.replicabile || false
                    });
                }
            });
            
            simili.sort((a, b) => b.jaccard - a.jaccard);
            
            if (simili.length > 0) {
                html += '<div class="desc-title">Materiali simili testati</div>';
                html += '<div class="desc-matches">';
                simili.slice(0, 4).forEach(m => {
                    const pct = Math.round(m.jaccard * 100);
                    const col = pct > 70 ? '#4caf50' : pct > 40 ? '#ff9800' : '#999';
                    html += '<div class="desc-match-card">';
                    html += '<div class="desc-match-header">';
                    html += '<strong>' + m.nome + '</strong> ';
                    html += '<span class="desc-match-badge" style="background:' + col + '">' + pct + '% affinita</span>';
                    if (m.tipo === 'lab') html += ' <span class="desc-match-src">Lab Albertina</span>';
                    else html += ' <span class="desc-match-src">Documentato' + (m.trl ? ' · TRL ' + m.trl : '') + '</span>';
                    html += '</div>';
                    if (m.tipo === 'lab') {
                        let det = [];
                        if (m.consistenza) det.push(m.consistenza);
                        if (m.colore) det.push(m.colore.toLowerCase());
                        if (m.trasparenza) det.push(m.trasparenza.toLowerCase());
                        if (det.length > 0) html += '<div class="desc-match-detail">' + det.join(' · ') + '</div>';
                        let tests = [];
                        if (m.test_flessione) tests.push('Flessione: ' + m.test_flessione.toLowerCase());
                        if (m.test_acqua) tests.push('Acqua: ' + m.test_acqua.toLowerCase());
                        if (m.test_calore) tests.push('Calore: ' + m.test_calore.toLowerCase());
                        if (tests.length > 0) html += '<div class="desc-match-tests">' + tests.join(' · ') + '</div>';
                        if (m.problemi) html += '<div class="desc-match-warn">[!] ' + m.problemi + '</div>';
                    }
                    html += '</div>';
                });
                html += '</div>';
                if (simili.length > 4) {
                    html += '<p class="desc-match-more">...e altri ' + (simili.length - 4) + ' materiali con ingredienti in comune</p>';
                }
            } else {
                // v72: Opzione 2 - match parziali con overlap=1
                let parziali = [];
                const userNoAcqua = selectedIds.filter(id => id !== 'acqua');
                (materialiDB.materiali_in_progress || []).forEach(mat => {
                    const matIngs = (mat.ingredienti_correlati || []).filter(id => id !== 'acqua');
                    const shared = userNoAcqua.filter(id => matIngs.includes(id));
                    if (shared.length >= 1) {
                        parziali.push({ nome: mat.nome, shared: shared, tipo: 'lab' });
                    }
                });
                (materialiDB.materiali_documentati || []).forEach(mat => {
                    const matIngs = (mat.ingredienti_correlati || mat.ingredienti || []).filter(id => id !== 'acqua');
                    const shared = userNoAcqua.filter(id => matIngs.includes(id));
                    if (shared.length >= 1) {
                        parziali.push({ nome: mat.nome || mat.subtitle || '', shared: shared, tipo: 'doc' });
                    }
                });
                if (parziali.length > 0) {
                    html += '<div class="desc-title">Materiali simili testati</div>';
                    html += '<p style="color:#666;font-size:0.85rem;margin-bottom:0.5rem;">Nessun materiale nel database condivide 2+ ingredienti con la tua ricetta. <strong>Stai esplorando territorio nuovo!</strong></p>';
                    html += '<p style="color:#888;font-size:0.8rem;margin-bottom:0.5rem;">Materiali con 1 ingrediente in comune:</p>';
                    html += '<div class="desc-matches">';
                    parziali.sort((a, b) => b.shared.length - a.shared.length);
                    parziali.slice(0, 5).forEach(p => {
                        const ingNames = p.shared.map(id => {
                            const ing = ings[id];
                            return ing ? ing.nome : id;
                        }).join(', ');
                        html += '<div class="desc-match-card" style="opacity:0.8">';
                        html += '<div class="desc-match-header"><strong>' + p.nome + '</strong>';
                        html += ' <span class="desc-match-src">' + (p.tipo === 'lab' ? 'Lab Albertina' : 'Documentato') + '</span></div>';
                        html += '<div class="desc-match-detail">In comune: ' + ingNames + '</div>';
                        html += '</div>';
                    });
                    html += '</div>';
                }
            }
        }
        
        // === ASPETTO VISIVO ===
        html += '<div class="desc-title">Aspetto visivo</div>';
        let aspetto = '';
        
        // Usa traspReale che considera opacizzanti, cariche, fibre, coloranti
        if (traspReale > 70) {
            aspetto = 'Il materiale sara <span class="desc-positive">molto trasparente</span>, quasi cristallino se lavorato con cura (senza bolle, essiccazione lenta).';
            if (hasAgar || hasGelatina) aspetto += ' Agar e gelatina puri possono raggiungere trasparenze simili al vetro.';
        } else if (traspReale > 40) {
            aspetto = 'Otterrai una <span class="desc-highlight">trasparenza parziale</span>: vedrai attraverso il materiale ma con un aspetto opalescente o "nebbiato".';
            if (hasAmido) aspetto += ' L\'amido tende naturalmente all\'opacita biancastra.';
            if (hasPectina && !hasOpacizzante) aspetto += ' La pectina pura puo essere traslucida, ma con estratti vegetali sara piu opaca.';
        } else {
            aspetto = 'Il materiale sara <span class="desc-warning">opaco</span>';
            if (hasOpacizzante) aspetto += ', per la presenza di ' + (opacizzanteNome || 'materiale vegetale') + ' che contiene particelle e pigmenti naturali';
            else if (hasCarica) aspetto += ', principalmente per le cariche minerali che diffondono la luce';
            else if (hasColorante) aspetto += ' per i coloranti aggiunti';
            else if (hasFibra) aspetto += ' a causa delle fibre di rinforzo';
            else if (hasCarbone) aspetto += ', con il carbone che dara un nero intenso';
            else if (hasAmido) aspetto += ', l\'amido produce naturalmente film opachi biancastri';
            else if (lipide) aspetto += ' per la presenza di resine e oli che riducono la trasparenza';
            else aspetto += ' per le caratteristiche intrinseche degli ingredienti';
            aspetto += '.';
        }
        if (hasColorante) {
            aspetto += ' ' + (coloranteNome || 'Il colorante') + ' dara tonalita naturali. ';
            aspetto += 'Nota: i coloranti naturali possono sbiadire con luce e tempo, e il colore puo variare con il pH del materiale.';
        }
        if (hasCarbone) {
            aspetto += ' Il carbone attivo conferira un <span class="desc-highlight">nero profondo</span> e proprieta assorbenti/deodoranti.';
        }
        if (lipide && hasCera) {
            aspetto += ' La cera dara una <span class="desc-highlight">finitura satinata</span> e un leggero effetto perlescente.';
        }
        html += '<p>' + aspetto + '</p>';
        
        // === SENSAZIONE AL TATTO ===
        html += '<div class="desc-title">Al tatto</div>';
        let tatto = '';
        if (flex > 70) {
            tatto = 'Sara <span class="desc-positive">morbido e flessibile</span>, piacevole da manipolare. Si pieghera facilmente senza rompersi.';
            if (hasGelatina && hasGlicerina) tatto += ' La combinazione gelatina+glicerina da un tatto simile alla gomma morbida o alla pelle sottile.';
        } else if (flex > 40) {
            tatto = 'Avra una <span class="desc-highlight">flessibilita moderata</span>: si piegera ma con resistenza, simile a un cartoncino spesso.';
            tatto += ' Piegature ripetute nello stesso punto potrebbero causare rottura.';
        } else {
            tatto = 'Il materiale sara <span class="desc-warning">rigido</span>: non si piega, si spezza. Simile a plastica dura o ceramica sottile.';
            if (!plastificante && matrice) tatto += ' Considera di aggiungere un plastificante se serve flessibilita.';
        }
        if (lipide) {
            if (hasCera) tatto += ' La cera dara una superficie <span class="desc-highlight">liscia e leggermente scivolosa</span>, idrorepellente al tatto.';
            else if (hasGommalacca) tatto += ' La gommalacca creera una superficie <span class="desc-highlight">lucida e dura</span>, simile a una vernice naturale.';
            else tatto += ' Il lipide dara una superficie leggermente cerosa o oleosa.';
        }
        if (hasFibra) {
            tatto += ' Le fibre potrebbero essere percepibili in superficie, dando una <span class="desc-highlight">texture tessile</span>.';
        }
        if (hasCarica) {
            tatto += ' Le cariche minerali possono dare una sensazione leggermente <span class="desc-highlight">granulosa o "terrosa"</span>.';
        }
        html += '<p>' + tatto + '</p>';
        
        // === COMPORTAMENTO CON ACQUA ===
        html += '<div class="desc-title">Comportamento con acqua</div>';
        let acqua = '';
        if (resistH2O > 60) {
            acqua = '<span class="desc-positive">Buona resistenza all\'umidita</span>: il materiale sopportera esposizioni prolungate senza deformarsi rapidamente.';
            if (lipide) {
                if (hasCera) acqua += ' La cera crea una vera barriera idrofoba - l\'acqua scorrera via.';
                else if (hasGommalacca) acqua += ' La gommalacca sigilla la superficie impedendo l\'assorbimento.';
                else acqua += ' Il coating lipidico protegge dalla penetrazione dell\'acqua.';
            }
            if (hasChitosano) acqua += ' Il chitosano e naturalmente piu idrofobico di altri biopolimeri.';
        } else if (resistH2O > 30) {
            acqua = '<span class="desc-highlight">Resistenza moderata</span>: il materiale sopportera schizzi o brevi esposizioni, ma si ammorbidira con contatto prolungato.';
            acqua += ' Evitare immersione diretta.';
        } else {
            acqua = '<span class="desc-warning">Molto sensibile all\'umidita</span>: ';
            if (hasGelatina) acqua += 'la gelatina si scioglie completamente in acqua tiepida. ';
            else if (hasAgar) acqua += 'l\'agar assorbe acqua e si gonfia, perdendo forma. ';
            else if (hasAmido) acqua += 'l\'amido diventa appiccicoso e si deforma. ';
            else acqua += 'il materiale si ammorbidira e deformera rapidamente. ';
            acqua += 'Questo puo essere un <span class="desc-positive">vantaggio</span> per materiali pensati per dissolversi/compostarsi velocemente.';
        }
        html += '<p>' + acqua + '</p>';
        
        // === v91: TECNICA DI LAVORAZIONE ===
        if (currentTecnica && currentTecnica !== 'colata') {
            var tecInfo = TECNICA_MODIFIERS[currentTecnica];
            if (tecInfo) {
                html += '<div class="desc-title">Tecnica: ' + tecInfo.label + '</div>';
                html += '<p style="background:#e8eef8;padding:10px 14px;border-radius:8px;border-left:3px solid #1565c0;font-size:0.9em;">' + tecInfo.descNota + '</p>';
                var effetti = [];
                if (tecInfo.h2o > 0) effetti.push('<span class="desc-positive">+resistenza H2O</span>');
                if (tecInfo.h2o < 0) effetti.push('<span class="desc-negative">-resistenza H2O</span>');
                if (tecInfo.mecc > 0) effetti.push('<span class="desc-positive">+resistenza meccanica</span>');
                if (tecInfo.mecc < 0) effetti.push('<span class="desc-negative">-resistenza meccanica</span>');
                if (tecInfo.flex > 0) effetti.push('<span class="desc-positive">+flessibilita</span>');
                if (tecInfo.flex < 0) effetti.push('<span class="desc-negative">-flessibilita</span>');
                if (tecInfo.trasp < 0) effetti.push('<span class="desc-negative">-trasparenza</span>');
                if (effetti.length > 0) html += '<p style="font-size:0.85em;color:#546e7a;">Effetti sulla previsione: ' + effetti.join(', ') + '</p>';
            }
        }
        
        // v92: COATING DESCRIPTION
        if (coatingAttivo) {
            html += '<div class="desc-title">Coating superficiale</div>';
            var lipideNomi = [];
            selectedIds.forEach(function(id) { var ing = ings[id]; if (ing && ing.famiglia === 'LIPIDE') lipideNomi.push(ing.nome); });
            html += '<p style="background:#fff3e0;padding:10px 14px;border-radius:8px;border-left:3px solid #e65100;font-size:0.9em;">';
            html += 'Il lipide (' + (lipideNomi.length > 0 ? lipideNomi.join(', ') : 'lipide') + ') viene applicato come <b>rivestimento superficiale</b>, non mescolato nella formula. ';
            html += 'Questo massimizza la <span class="desc-positive">barriera all\'acqua</span> senza alterare trasparenza, flessibilita o meccanica del materiale base.</p>';
            html += '<p style="font-size:0.85em;color:#546e7a;">Effetti: <span class="desc-positive">+++ resistenza H2O (superficie)</span>, trasparenza e meccanica invariate rispetto al substrato.</p>';
        }
        
        // === LAVORAZIONE ===
        html += '<div class="desc-title">Note di lavorazione</div>';
        let lavorazione = '<ul>';
        if (hasGelatina) {
            lavorazione += '<li><b>Gelatina</b>: sciogliere in acqua fredda (blooming 5-10 min), poi scaldare a 50-60C. Non bollire mai.</li>';
        }
        if (hasAgar) {
            lavorazione += '<li><b>Agar</b>: DEVE bollire (90-100C) per sciogliersi. Gelifica raffreddando sotto i 35C.</li>';
        }
        if (hasAlginato) {
            lavorazione += '<li><b>Alginato</b>: sciogliere in acqua con frullatore (forma grumi). Immergere in bagno di CaCl2 per gelificare.</li>';
        }
        if (hasCaseina) {
            lavorazione += '<li><b>Caseina</b>: acidificare il latte (aceto/limone), filtrare i coaguli, impastare. Stagionare giorni/settimane.</li>';
        }
        if (hasChitosano) {
            lavorazione += '<li><b>Chitosano</b>: sciogliere in soluzione acida (1-2% acido acetico). Neutralizzare per far precipitare il film.</li>';
        }
        if (hasPectina) {
            lavorazione += '<li><b>Pectina</b>: serve pH acido e/o zuccheri per gelificare correttamente.</li>';
        }
        if (hasAmido) {
            lavorazione += '<li><b>Amido</b>: scaldare gradualmente mescolando per evitare grumi. Gelatinizza a 60-80C.</li>';
        }
        if (hasCera) {
            lavorazione += '<li><b>Cera</b>: fondere a bagnomaria (60-80C). Applicare a caldo su superficie asciutta.</li>';
        }
        if (hasGommalacca) {
            lavorazione += '<li><b>Gommalacca</b>: sciogliere in alcol etilico. Applicare a strati sottili, lasciando asciugare tra uno e l\'altro.</li>';
        }
        if (hasFibra) {
            lavorazione += '<li><b>Fibre</b>: immergere nella matrice liquida calda, disporre a strati o casualmente, pressare durante l\'asciugatura.</li>';
        }
        // v91: Nota finale adattata alla tecnica
        if (currentTecnica === 'aerazione') {
            lavorazione += '<li><b>Stabilizzazione schiuma</b>: fissare rapidamente (gelificazione, essiccazione rapida o reticolazione) prima del collasso. Asciugatura delicata.</li>';
        } else if (currentTecnica === 'fermentazione') {
            lavorazione += '<li><b>Incubazione</b>: mantenere 20-30C, ambiente pulito. Durata: 1-4 settimane. Pronto quando raggiunge spessore desiderato.</li>';
        } else if (currentTecnica === 'compressione') {
            lavorazione += '<li><b>Pressatura</b>: pre-asciugare, poi comprimere a 50-120C con pressa o morsa per 15-60 minuti.</li>';
        } else if (currentTecnica === 'reticolazione') {
            lavorazione += '<li><b>Bagno reticolante</b>: preparare CaCl2 2-5% o borace 4%. Immergere 1-30 min. Risciacquare con acqua distillata.</li>';
        } else if (currentTecnica === 'stratificazione') {
            lavorazione += '<li><b>Stratificazione</b>: preparare ogni strato separatamente. Asciugare completamente ogni strato prima di applicare il successivo. Spessore strato singolo: 1-3mm.</li>';
        } else {
            lavorazione += '<li><b>Essiccazione</b>: lenta e uniforme (24-72h) per evitare crepe e deformazioni.</li>';
        }
        // v92: Nota coating se attivo
        if (coatingAttivo) {
            lavorazione += '<li><b>Coating finale</b>: applicare il lipide a pennello o immersione sulla superficie <em>asciutta</em> del materiale. Strati sottili multipli sono piu efficaci di un singolo strato spesso. La barriera all\'acqua dipende dalla copertura uniforme.</li>';
        }
        lavorazione += '</ul>';
        html += lavorazione;
        
        // === DOSAGGI CONSIGLIATI ===
        let dosaggi = [];
        selectedIds.forEach(id => {
            const ing = ings[id];
            if (!ing || id === 'acqua') return;
            const params = ing.parametri || {};
            let d = { nome: ing.nome, range: null, tipico: null, temp: null };
            if (params.range_percent_min != null && params.range_percent_max != null) {
                d.range = params.range_percent_min + '–œ' + params.range_percent_max + '%';
                if (params.range_tipico_min && params.range_tipico_max) {
                    d.tipico = params.range_tipico_min + '–œ' + params.range_tipico_max + '%';
                }
            }
            if (params.temp_dissoluzione_min || params.temp_dissoluzione) {
                const tMin = params.temp_dissoluzione_min || params.temp_dissoluzione;
                const tMax = params.temp_dissoluzione_max;
                d.temp = tMin + (tMax ? '–œ' + tMax : '') + '°C';
            }
            if (d.range || d.temp) dosaggi.push(d);
        });
        
        if (dosaggi.length > 0) {
            html += '<div class="desc-title">Dosaggi consigliati</div>';
            html += '<table class="desc-dosaggi"><thead><tr><th>Ingrediente</th><th>Dosaggio</th><th>T dissoluzione</th></tr></thead><tbody>';
            dosaggi.forEach(d => {
                html += '<tr>';
                html += '<td><strong>' + d.nome + '</strong></td>';
                html += '<td>' + (d.tipico ? d.tipico + ' <small>(range ' + d.range + ')</small>' : (d.range || '–')) + '</td>';
                html += '<td>' + (d.temp || '–') + '</td>';
                html += '</tr>';
            });
            html += '</tbody></table>';
            html += '<p class="desc-dosaggi-note">Percentuali sul peso totale della miscela (esclusa acqua solvente). Variare gradualmente.</p>';
        }
        
        // === POSSIBILI UTILIZZI ===
        html += '<div class="desc-title">Possibili utilizzi</div>';
        let usi = '<ul>';
        if (trasp > 50 && flex > 40 && matrice) {
            usi += '<li>Packaging trasparente per piccoli oggetti, gioielli, campioni</li>';
            if (foodSafe) usi += '<li>Involucri alimentari temporanei (per cibi secchi)</li>';
        }
        if (trasp > 50 && flex > 60) {
            usi += '<li>Finestre per packaging, buste con vista sul contenuto</li>';
        }
        if (resistMecc > 50 && flex < 50) {
            usi += '<li>Contenitori rigidi, vassoi, scatole strutturali</li>';
            usi += '<li>Supporti per esposizione, basi per oggetti</li>';
        }
        if (flex > 60) {
            usi += '<li>Pellicole avvolgenti, fogli di copertura</li>';
            usi += '<li>Etichette flessibili, nastri decorativi</li>';
        }
        if (flex > 40 && flex < 70 && resistMecc > 40) {
            usi += '<li>Copertine, rilegature, cartellette</li>';
        }
        if (hasCarica || hasFibra) {
            usi += '<li>Pannelli decorativi con texture naturale</li>';
            usi += '<li>Elementi di design con aspetto "materico"</li>';
        }
        if (matriceFamiglia === 'COLTURA') {
            usi += '<li>Accessori simil-pelle (portafogli, cinturini, cover)</li>';
            usi += '<li>Packaging premium con estetica organica unica</li>';
        }
        if (hasTannini && hasGelatina) {
            usi += '<li>Materiale simil-cuoio per rilegature, accessori</li>';
        }
        if (resistH2O < 30) {
            usi += '<li>Packaging solubile/compostabile per dosi singole</li>';
            usi += '<li>Materiale effimero per installazioni temporanee</li>';
        }
        if (resistH2O > 50 && foodSafe) {
            usi += '<li>Contenitori per alimenti con media shelf-life</li>';
        }
        if (hasCarbone) {
            usi += '<li>Filtri assorbenti, deodoranti naturali</li>';
        }
        if (hasChitosano) {
            usi += '<li>Packaging antimicrobico per prodotti freschi</li>';
            usi += '<li>Medicazioni e cerotti biodegradabili</li>';
        }
        usi += '</ul>';
        html += usi;
        
        // === DURABILITA ===
        html += '<div class="desc-title">Durabilita e conservazione</div>';
        let durata = '';
        if (resistH2O > 50 && resistMecc > 40) {
            durata = 'In condizioni ideali (ambiente secco, al riparo dalla luce), il materiale puo durare <span class="desc-positive">mesi o anche anni</span>.';
        } else if (resistH2O > 30) {
            durata = 'Durata stimata <span class="desc-highlight">settimane o mesi</span> in ambiente controllato.';
        } else {
            durata = 'Durata stimata <span class="desc-highlight">giorni o settimane</span>. Degradazione accelerata in ambiente umido.';
        }
        html += '<p>' + durata + '</p>';
        
        html += '<p><b>Conservare al riparo da:</b></p><ul>';
        if (resistH2O < 50) html += '<li>Umidita (causa principale di degradazione)</li>';
        if (matriceFamiglia === 'PROTEINA') html += '<li>Calore sopra 35C (la gelatina fonde, le proteine si degradano)</li>';
        html += '<li>Luce diretta prolungata (ingiallimento, fragilizzazione)</li>';
        if (!hasAcido && matriceFamiglia === 'PROTEINA') html += '<li>Muffe (le proteine sono nutrienti per funghi)</li>';
        if (hasColorante) html += '<li>UV (sbiadimento dei coloranti naturali)</li>';
        html += '</ul>';
        
        // === E SE VOLESSI... ===
        let tradeoffs = [];
        
        if (traspReale < 50 && (hasCarica || hasOpacizzante || hasFibra || hasColorante)) {
            const causa = hasOpacizzante ? (opacizzanteNome || 'gli scarti vegetali') : hasCarica ? (caricaNome || 'le cariche') : hasFibra ? 'le fibre' : (coloranteNome || 'il colorante');
            tradeoffs.push({q: 'Piu trasparente', a: 'Riduci o elimina ' + causa + '. Le matrici pure (agar, gelatina) danno la massima trasparenza.'});
        }
        if (resistH2O < 40 && !lipide && matrice) {
            tradeoffs.push({q: 'Piu resistente all\'acqua', a: 'Aggiungi un lipide come coating: cera d\'api (piu semplice), gommalacca (piu resistente), o cera di carnauba (la piu dura).'});
        }
        if (flex < 40 && !plastificante && matrice) {
            tradeoffs.push({q: 'Piu flessibile', a: 'Aggiungi glicerina (10-30% sul peso della matrice). Piu ne metti, piu sara morbido – ma anche piu appiccicoso e sensibile all\'umidita.'});
        }
        if (flex > 60 && matrice && !hasCarica && !hasFibra) {
            tradeoffs.push({q: 'Piu rigido', a: 'Aggiungi una carica (fondi di caffe, gusci d\'uovo macinati) o fibre (lino, cotone). Se c\'e plastificante, riducilo.'});
        }
        if (!vegano) {
            let nonVeg = [];
            selectedIds.forEach(id => { const ing = ings[id]; if (ing && !ing.vegano) nonVeg.push(ing.nome); });
            let alt = hasGelatina ? 'agar (gel rigido) o carragenina (gel elastico) – texture diversa ma funzione simile' : 
                      hasCaseina ? 'amido con carica minerale per rigidita simile' :
                      'ingredienti di origine vegetale equivalenti';
            tradeoffs.push({q: 'Versione vegana', a: 'Sostituisci ' + nonVeg.join(', ') + ' con ' + alt + '.'});
        }
        if (!hasChitosano && matrice && matriceFamiglia !== 'POLICATIONE') {
            tradeoffs.push({q: 'Proprieta antimicrobiche', a: 'Aggiungi chitosano (anche in piccola %). La carica positiva del chitosano e antibatterica naturale.'});
        }
        if (!foodSafe && matrice) {
            let nonFood = [];
            selectedIds.forEach(id => { const ing = ings[id]; if (ing && !ing.food_safe) nonFood.push(ing.nome); });
            if (nonFood.length > 0) tradeoffs.push({q: 'Compatibile con alimenti', a: 'Rimuovi o sostituisci: ' + nonFood.join(', ') + '. Verifica sempre con la normativa locale.'});
        }
        if (resistH2O < 30 && matrice && !hasReticolante) {
            tradeoffs.push({q: 'Maggiore durata', a: 'Un coating lipidico protegge dalla superficie. Un reticolante (tannini per proteine, CaCl\u2082 per alginato) stabilizza la struttura interna.'});
        }
        // v89: Consiglio antimuffe con suggerimenti ingredienti specifici
        if (matrice && resistH2O < 50) {
            var sugAntiMuffa = [];
            var hasTipAceto = selectedIds.includes('aceto');
            var hasTipOliEss = selectedIds.includes('oli_essenziali');
            var hasTipAllume = selectedIds.includes('allume');
            var hasTipTannini = selectedIds.includes('tannini');
            var hasTipAcidoCit = selectedIds.includes('acido_citrico');
            var hasTipTeNero = selectedIds.includes('te_nero');
            var hasTipCurcuma = selectedIds.includes('curcuma');
            
            if (!hasTipAceto) sugAntiMuffa.push('<strong>aceto</strong> (abbassa il pH — le muffe odiano l\'acidita)');
            if (!hasTipAcidoCit) sugAntiMuffa.push('<strong>acido citrico</strong> (stesso principio, piu neutro nell\'odore)');
            if (!hasTipOliEss) sugAntiMuffa.push('<strong>oli essenziali</strong> (tea tree, chiodi di garofano, timo — antimicotici naturali, poche gocce bastano)');
            if (!hasChitosano) sugAntiMuffa.push('<strong>chitosano</strong> (antimicrobico naturale, protegge a lungo)');
            if (!hasTipCurcuma) sugAntiMuffa.push('<strong>curcuma</strong> (antimicrobica naturale, colora di giallo)');
            if (!hasTipTannini) sugAntiMuffa.push('<strong>tannini</strong> (conservante naturale, stabilizza le proteine)');
            if (!hasTipAllume) sugAntiMuffa.push('<strong>allume</strong> (antisettico tradizionale, usato nella concia)');
            if (!hasTipTeNero) sugAntiMuffa.push('<strong>te nero</strong> (contiene tannini naturali, dona colore ambrato)');
            
            if (sugAntiMuffa.length > 0) {
                var txt = 'Problema comune nei biomateriali. ';
                if (matriceFamiglia === 'PROTEINA') txt += 'Le proteine sono particolarmente vulnerabili. ';
                txt += 'Puoi aggiungere alla ricetta: ' + sugAntiMuffa.slice(0, 4).join('; ') + '. ';
                txt += 'In piu: essicca bene (sotto il 15% di umidita) e conserva con silica gel.';
                tradeoffs.push({q: 'Prevenire le muffe', a: txt});
            }
        }
        
        if (tradeoffs.length > 0) {
            html += '<div class="desc-title">E se volessi...</div>';
            html += '<div class="desc-tradeoffs">';
            tradeoffs.forEach(t => {
                html += '<div class="desc-tradeoff"><span class="desc-tradeoff-q">◆ ' + t.q + '?</span> ' + t.a + '</div>';
            });
            html += '</div>';
        }
        
        // === AVVERTENZE ===
        let avvertenze = [];
        if (!matrice) {
            avvertenze.push('CRITICO: Manca una matrice strutturante. Aggiungi una proteina (gelatina, caseina) o un polisaccaride (agar, amido, alginato) per ottenere un materiale solido.');
        }
        if (!plastificante && matrice && flex < 40) {
            avvertenze.push('Il materiale sara molto fragile. Considera di aggiungere un plastificante (glicerina, sorbitolo) per evitare crepe.');
        }
        if (hasEmulsionante && !lipide) {
            avvertenze.push('Hai un emulsionante ma nessun lipide da emulsionare - potrebbe essere inutile in questa formula.');
        }
        if (hasAlginato && !hasReticolante) {
            avvertenze.push('L\'alginato richiede un sale di calcio (CaCl2, lattato di calcio) per gelificare. Senza reticolante restera liquido.');
        }
        if (hasAgar && hasGelatina) {
            avvertenze.push('Agar e gelatina insieme: l\'agar deve BOLLIRE mentre la gelatina NON deve bollire. Sciogli prima l\'agar, lascia raffreddare a 60C, poi aggiungi la gelatina.');
        }
        if (numIngredienti > 6) {
            avvertenze.push('Formula complessa con molti ingredienti. Consiglio: testa prima le combinazioni base (matrice + plastificante), poi aggiungi gli altri gradualmente.');
        }
        if (hasReticolante && !hasAlginato && matriceFamiglia && !matriceFamiglia.includes('ANIONICO')) {
            avvertenze.push('Il sale reticolante funziona principalmente con alginati e pectine. Con altre matrici l\'effetto sara limitato.');
        }
        
        if (avvertenze.length > 0) {
            html += '<div class="desc-title">Punti di attenzione</div>';
            html += '<ul>';
            avvertenze.forEach(a => html += '<li class="desc-warning">' + a + '</li>');
            html += '</ul>';
        }
        
        descEl.innerHTML = html;
    }
    
    
    //                                                                                                                                                                                  
    // CARICAMENTO DATI (da data.js caricato via script)
    //                                                                                                                                                                                  
    function loadData() {
        // I dati vengono da data.js (caricato via <script src>)
        if (typeof CATALOGO_DATA !== 'undefined' && 
            typeof MATERIALI_DATA !== 'undefined' && 
            typeof INGREDIENTI_DATA !== 'undefined') {
            
            catalogo = CATALOGO_DATA;
            materialiDB = MATERIALI_DATA;
            ingredientiDB = INGREDIENTI_DATA;
            
            console.log('Dati caricati da data.js');
            updateOutputCounts();
            showAllMateriali();
            renderIngredientList();
            updateCartButton();
            
            // Carica dati salvati da localStorage
            loadCartFromStorage();
            loadSavedFormulas();
            mobileUpdateFab();
            
            // v78: Mostra welcome modal al primo caricamento
            setTimeout(showWelcome, 300);
        } else {
            console.error('data.js non caricato. Verificare che il file esista in data/database_biomateriali_v10_5.js');
            document.getElementById('materialiDocumentati').innerHTML = 
                '<div style="padding:1rem;color:#c00;font-size:0.75rem;">Errore: data.js non trovato.<br>Verificare che esista data/database_biomateriali_v10_5.js</div>';
        }
    }

    // v77: Helper – mappa categoria_menu in_progress → output type
    function getInProgressOutput(m) {
        const cm = (m.categoria_menu || '').toUpperCase();
        if (cm.includes('FILM')) return 'film';
        if (cm.includes('GEL')) return 'gel';
        if (cm.includes('RIGIDI') || cm.includes('PLASTICI') || cm.includes('OPACHI')) return 'rigido';
        if (cm.includes('COMPOSITI') || cm.includes('SCARTI') || cm.includes('RINFORZ')) return 'composito';
        if (cm.includes('BIOLOGICI') || cm.includes('CRESCIUTI')) return 'pelle';
        if (cm.includes('IBRIDI')) return 'composito';
        return '';
    }

    // v77: Conta materiali usando CATALOGO_DATA per documentati + mapping per in_progress
    function updateOutputCounts() {
        if (!materialiDB) return;
        const catOutputs = catalogo?.outputs || {};
        
        document.querySelectorAll('.output-btn').forEach(btn => {
            const outputType = btn.dataset.output;
            const catData = catOutputs[outputType];
            const docCount = catData?.n_documentati || 0;
            const progCount = (materialiDB.materiali_in_progress || []).filter(m => 
                getInProgressOutput(m) === outputType
            ).length;
            
            btn.querySelector('.output-count .doc').textContent = docCount;
            btn.querySelector('.output-count .prog').textContent = progCount;
        });
    }

    //                                                                                                                                                                                  
    // SELEZIONE OUTPUT
    //                                                                                                                                                                                  
    function toggleOutput(output) {
        const btn = document.querySelector(`.output-btn[data-output="${output}"]`);
        const wasActive = btn.classList.contains('active');
        
        // Deseleziona tutti
        document.querySelectorAll('.output-btn').forEach(b => b.classList.remove('active'));
        
        if (wasActive) {
            // Se era gi   attivo, deseleziona e mostra tutti
            currentOutput = null;
            document.getElementById('outputInfo').classList.add('hidden');
            showAllMateriali();
        } else {
            // Seleziona questo output
            btn.classList.add('active');
            currentOutput = output;
            showOutputInfo(output);
            populateMateriali(output);
        }
    }

    function showOutputInfo(output) {
        const info = OUTPUT_INFO[output];
        const outputData = catalogo?.outputs?.[output];
        if (!info) return;
        
        document.getElementById('outputInfo').classList.remove('hidden');
        document.getElementById('outputTitle').textContent = info.display;
        document.getElementById('outputDesc').textContent = info.desc;
        
        // Matrici dal catalogo - gestisco sia stringhe che oggetti
        const matrici = outputData?.matrici || [];
        const matriciText = matrici.map(m => {
            if (typeof m === 'string') return m;
            if (m.famiglia) return m.famiglia;
            return String(m);
        }).join(', ');
        document.getElementById('outputMatrici').textContent = matriciText || '-';
        
        // Warnings - gestisco sia stringhe che oggetti
        // Warnings rimossi - non pertinenti per materiali
        const warningEl = document.getElementById('outputWarning');
        if (warningEl) warningEl.style.display = 'none';
    }

    // v79: Helper – risolve array di ID ingredienti a nomi leggibili
    function resolveIngNames(idsArray) {
        if (!idsArray || !idsArray.length) return '-';
        var ings = (INGREDIENTI_DATA && INGREDIENTI_DATA.ingredienti) ? INGREDIENTI_DATA.ingredienti : {};
        var names = [];
        for (var i = 0; i < idsArray.length; i++) {
            var ing = ings[idsArray[i]];
            names.push(ing ? ing.nome : idsArray[i]);
        }
        return names.join(', ');
    }

    function showAllMateriali() {
        // Mostra tutti i documentati replicabili
        const docContainer = document.getElementById('materialiDocumentati');
        const replicabili = materialiDB.materiali_documentati.filter(m => m.replicabile_lab);
        
        let docHtml = '';
        replicabili.forEach(mat => {
            const ingredienti = resolveIngNames(mat.ingredienti_correlati);
            // Usa TRL per colore: 8-9 verde, 6-7 bianco, <6 rosa
            const trlClass = mat.trl >= 8 ? 'trl-verde' : (mat.trl >= 6 ? 'trl-bianco' : 'trl-rosa');
            docHtml += createMaterialeCard(mat.name, ingredienti, trlClass, true, 'doc', null, mat.trl);
        });
        docContainer.innerHTML = docHtml || '<div style="padding:0.75rem;color:#888;font-size:0.72rem;">Nessun materiale</div>';
        document.getElementById('docCount').textContent = replicabili.length + ' replicabili';
        
        // Mostra tutti in progress
        const progContainer = document.getElementById('materialiInProgress');
        let progHtml = '';
        materialiDB.materiali_in_progress.forEach(m => {
            const trlClass = m.trl === 3 ? 'trl-verde' : (m.trl === 2 ? 'trl-bianco' : 'trl-rosa');
            const nome = m.ricetta_origine + ': ' + (m.nome || '').substring(0, 25);
            const desc = m.ingredienti_descrizione || m.consistenza || '-';
            progHtml += createMaterialeCard(m.ricetta_origine, desc, trlClass, false, 'prog', nome, m.trl);
        });
        progContainer.innerHTML = progHtml || '<div style="padding:0.75rem;color:#888;font-size:0.72rem;">Nessun test</div>';
        document.getElementById('progCount').textContent = materialiDB.materiali_in_progress.length;
    }

    // v77: Usa CATALOGO_DATA per lista materiali, cross-ref con MATERIALI_DATA per dettagli
    function populateMateriali(outputType) {
        // DOCUMENTATI - da CATALOGO_DATA
        const docContainer = document.getElementById('materialiDocumentati');
        const outputData = catalogo?.outputs?.[outputType];
        const catDocs = outputData?.documentati || [];
        
        // v80: Filtra materie prime industriali (replicabile=false + nessun ingrediente)
        const catDocsFiltered = catDocs.filter(catMat => {
            if (catMat.replicabile === false && (!catMat.ingredienti || catMat.ingredienti.length === 0)) return false;
            return true;
        });
        
        let docHtml = '';
        let docReplicabili = 0;
        
        catDocsFiltered.forEach(catMat => {
            const fullMat = (materialiDB.materiali_documentati || []).find(m => 
                m.name === catMat.nome || m.name === catMat.name
            );
            
            const isReplicabile = fullMat ? fullMat.replicabile_lab : (catMat.replicabile !== false);
            const trl = fullMat?.trl || catMat.trl || 0;
            const nome = fullMat?.name || catMat.nome || catMat.name;
            const ingredienti = fullMat ? resolveIngNames(fullMat.ingredienti_correlati) : resolveIngNames(catMat.ingredienti);
            
            if (isReplicabile) docReplicabili++;
            const trlClass = !isReplicabile ? 'trl-ind' : (trl >= 8 ? 'trl-verde' : (trl >= 6 ? 'trl-bianco' : 'trl-rosa'));
            docHtml += createMaterialeCard(nome, ingredienti, trlClass, isReplicabile, 'doc', null, trl);
        });
        
        docContainer.innerHTML = docHtml || '<div style="padding:0.75rem;color:#888;font-size:0.72rem;">Nessun materiale per questo output</div>';
        document.getElementById('docCount').textContent = docReplicabili + ' replicabili / ' + catDocsFiltered.length + ' totali';
        
        // IN PROGRESS - filtra per categoria_menu
        const progContainer = document.getElementById('materialiInProgress');
        const menuKeywords = {
            'film': ['FILM'],
            'gel': ['GEL'],
            'rigido': ['RIGIDI', 'OPACHI'],
            'coating': ['COATING'],
            'schiuma': ['FOAM', 'SCHIUMA'],
            'pelle': ['CRESCIUTI'],
            'composito': ['COMPOSITI', 'SCARTI']
        };
        const kws = menuKeywords[outputType] || [];
        const progFiltered = kws.length > 0 ? 
            (materialiDB.materiali_in_progress || []).filter(m => {
                const menu = (m.categoria_menu || '').toUpperCase();
                return kws.some(k => menu.includes(k));
            }) : [];
        
        let progHtml = '';
        progFiltered.forEach(m => {
            const trlClass = m.trl === 3 ? 'trl-verde' : (m.trl === 2 ? 'trl-bianco' : 'trl-rosa');
            const nome = m.ricetta_origine + ': ' + (m.nome || '').substring(0, 25);
            const desc = m.ingredienti_descrizione || m.consistenza || '-';
            progHtml += createMaterialeCard(m.ricetta_origine, desc, trlClass, false, 'prog', nome, m.trl);
        });
        
        progContainer.innerHTML = progHtml || '<div style="padding:0.75rem;color:#888;font-size:0.72rem;">Nessun test per questo output</div>';
        document.getElementById('progCount').textContent = progFiltered.length;
    }

    function createMaterialeCard(id, ingredienti, trlClass, canUse, tipo, displayName, trl) {
        const nome = displayName || id;
        // v79: Badge differenziato doc vs prog
        var trlBadge = '';
        if (tipo === 'prog') {
            trlBadge = trl ? '<span class="trl-badge">' + (trl === 3 ? 'OK' : (trl === 2 ? '?' : '!')) + '</span>' : '';
        } else if (trl) {
            // Documented: mostra numero TRL piccolo
            trlBadge = '<span class="trl-badge" style="font-size:0.55rem;min-width:auto;padding:1px 4px;background:' + 
                (trl >= 8 ? '#e8f5e9;color:#2e7d32' : (trl >= 6 ? '#e3f2fd;color:#1565c0' : '#fff3e0;color:#e65100')) + 
                ';">TRL ' + trl + '</span>';
        }
        const useBtn = canUse ? '<button class="mat-btn usa" onclick="event.stopPropagation(); usaMateriale(\'' + id.replace(/'/g, "\\'") + '\', \'' + tipo + '\')" title="Usa ingredienti">+</button>' : '';
        
        return '<div class="materiale-card ' + (trlClass === 'trl-ind' ? 'industriale' : '') + '" onclick="showDetail(\'' + id.replace(/'/g, "\\'") + '\', \'' + tipo + '\')">' +
            '<span class="trl-dot ' + trlClass + '"></span>' +
            '<div class="materiale-info">' +
                '<div class="materiale-nome">' + nome + '</div>' +
                '<div class="materiale-ingredienti">' + ingredienti + '</div>' +
            '</div>' +
            '<div class="materiale-actions">' + trlBadge + useBtn + '</div>' +
        '</div>';
    }

    // v77: Usa categoria_menu per filtrare in_progress
    function filterInProgressByOutput(outputType) {
        if (!materialiDB?.materiali_in_progress) return [];
        const keywords = {
            'film': ['FILM'], 'gel': ['GEL'], 'rigido': ['RIGIDI', 'OPACHI'],
            'coating': ['COATING'], 'schiuma': ['FOAM', 'SCHIUMA'],
            'pelle': ['CRESCIUTI'], 'composito': ['COMPOSITI', 'SCARTI']
        };
        const kws = keywords[outputType] || [];
        if (kws.length === 0) return [];
        return materialiDB.materiali_in_progress.filter(m => {
            const menu = (m.categoria_menu || '').toUpperCase();
            return kws.some(k => menu.includes(k));
        });
    }

    //                                                                                                                                                                                  
    // AZIONI MATERIALI
    //                                                                                                                                                                                  
    
    // Mapping ingredienti per materiali in_progress (da descrizione testuale a ID)
    // NOTA: le chiavi devono corrispondere a ricetta_origine (es: "R36", non "r36")
    
    
    // v89: Carica ricetta in_progress sul tavolo laboratorio
    window._loadedRecipeRef = null;
    
    function loadRecipeToLab(ricettaOrigine) {
        var mat = (materialiDB.materiali_in_progress || []).find(function(m) { 
            return m.ricetta_origine === ricettaOrigine || m.id === ricettaOrigine; 
        });
        if (!mat) { showToast('Ricetta non trovata', 'error'); return; }
        
        var correlati = mat.ingredienti_correlati || [];
        if (correlati.length === 0) {
            showToast('Nessun ingrediente mappato per questa ricetta', 'warning');
            return;
        }
        
        function doLoad() {
            // Svuota tutto
            cart = []; tavolo = [];
            formulaSelection.clear(); customDosages = {};
            window._editingFormulaId = null; window._editingFormulaName = null;
            
            // Carica ingredienti nel carrello e sul tavolo
            var ings = INGREDIENTI_DATA?.ingredienti || {};
            var aggiunti = 0;
            correlati.forEach(function(ingId) {
                var ing = ings[ingId];
                if (ing) {
                    cart.push(Object.assign({}, ing, {id: ingId, informativo: false}));
                    tavolo.push(ingId);
                    formulaSelection.add(ingId);
                    aggiunti++;
                }
            });
            
            // Salva riferimento ricetta
            window._loadedRecipeRef = {
                nome: mat.nome,
                codice: mat.ricetta_origine || mat.id,
                dosaggi: mat.ingredienti_descrizione || '',
                colore: mat.colore || '',
                consistenza: mat.consistenza || '',
                trasparenza: mat.trasparenza || '',
                problemi: mat.problemi_realizzazione || ''
            };
            
            updateCart();
            updateTavolo();
            saveCartToStorage();
            closeModal();
            switchTab('C');
            
            showToast(aggiunti + ' ingredienti caricati sul tavolo da ' + mat.nome, 'success', 3000);
        }
        
        // Se tavolo/carrello non vuoti, chiedi conferma
        if (cart.length > 0 || tavolo.length > 0) {
            showConfirmModal(
                'Carica ricetta sul tavolo',
                'Il tavolo contiene <strong>' + tavolo.length + ' ingredienti</strong> e il carrello <strong>' + cart.length + '</strong>.<br><br>' +
                'Caricare <strong>' + mat.nome + '</strong> svuoterà tutto.<br>' +
                '<span style="font-size:0.72rem;color:#888;">Suggerimento: salva prima la formula corrente se vuoi conservarla.</span>',
                doLoad,
                'Svuota e carica'
            );
        } else {
            doLoad();
        }
    }
    
    function usaMateriale(id, tipo) {
        console.log('=== usaMateriale ===');
        console.log('ID:', id, 'Tipo:', tipo);
        
        let ingredientiIds = [];
        let ingredientiTeoricos = [];
        
        if (tipo === 'doc') {
            const mat = materialiDB.materiali_documentati.find(m => m.name === id);
            console.log('Materiale doc trovato:', mat ? mat.name : 'NON TROVATO');
            if (mat) {
                ingredientiIds = mat.ingredienti_correlati || [];
                ingredientiTeoricos = mat.ingredienti_teorici || [];
            } else {
                // v79: Fallback CATALOGO – cerca ingredienti da CATALOGO_DATA
                console.log('Fallback CATALOGO per', id);
                if (typeof CATALOGO_DATA !== 'undefined' && CATALOGO_DATA && CATALOGO_DATA.outputs) {
                    var outKeys = Object.keys(CATALOGO_DATA.outputs);
                    for (var oi = 0; oi < outKeys.length; oi++) {
                        var docs = CATALOGO_DATA.outputs[outKeys[oi]].documentati || [];
                        for (var di = 0; di < docs.length; di++) {
                            if (docs[di].nome === id && docs[di].ingredienti && docs[di].ingredienti.length > 0) {
                                ingredientiIds = docs[di].ingredienti;
                                console.log('Trovati ingredienti CATALOGO:', ingredientiIds);
                                break;
                            }
                        }
                        if (ingredientiIds.length > 0) break;
                    }
                }
            }
        } else if (tipo === 'prog') {
            // v60.1: Legge ingredienti_correlati direttamente dal database
            const mat = materialiDB.materiali_in_progress.find(m => m.ricetta_origine === id || m.id === id);
            if (mat) {
                ingredientiIds = mat.ingredienti_correlati || [];
                console.log('ingredienti_correlati da DB:', ingredientiIds);
            } else {
                // Fallback a mapping statico (deprecato)
                ingredientiIds = IN_PROGRESS_MAPPING?.[id] || [];
                console.log('Fallback mapping per', id, ':', ingredientiIds);
            }
        }
        
        let aggiunti = 0;
        
        // Aggiungi ingredienti che sono nel nostro DB (operativi)
        ingredientiIds.forEach(ingId => {
            const ing = ingredientiDB.ingredienti[ingId];
            console.log('Cerco:', ingId, '-> Trovato:', ing ? ing.nome : 'NO');
            if (ing && !cart.find(c => c.id === ingId)) {
                cart.push({...ing, id: ingId, informativo: false});
                aggiunti++;
            }
        });
        
        // Aggiungi ingredienti teorici (informativi, in rosso)
        ingredientiTeoricos.forEach(nome => {
            const fakeId = 'teorico_' + nome.replace(/[^a-z0-9]/gi, '_').toLowerCase();
            if (!cart.find(c => c.id === fakeId)) {
                cart.push({
                    id: fakeId,
                    nome: nome,
                    informativo: true,
                    famiglia: 'teorico'
                });
                aggiunti++;
            }
        });
        
        if (aggiunti > 0) {
            updateCart();
            document.getElementById('cartCount').style.transform = 'scale(1.3)';
            setTimeout(() => { document.getElementById('cartCount').style.transform = 'scale(1)'; }, 200);
            showToast(aggiunti + ' ingrediente/i aggiunto/i al carrello', 'success', 2000);
        } else {
            showToast('Nessun ingrediente da aggiungere per questo materiale.', 'warning');
        }
    }

    function showDetail(id, tipo) {
        let content = '';
        console.log('[showDetail] id="' + id + '" tipo=' + tipo);
        
        if (tipo === 'doc') {
            // v79: DOPPIA RICERCA UPFRONT – catalogo + materiali
            var catMat = null;
            var catOutputType = currentOutput || null;
            
            // A) Cerca in CATALOGO_DATA (fonte primaria per Tab A)
            if (typeof CATALOGO_DATA !== 'undefined' && CATALOGO_DATA && CATALOGO_DATA.outputs) {
                // Prima prova output corrente
                if (catOutputType && CATALOGO_DATA.outputs[catOutputType]) {
                    var docs = CATALOGO_DATA.outputs[catOutputType].documentati || [];
                    for (var ci = 0; ci < docs.length; ci++) {
                        if (docs[ci].nome === id) { catMat = docs[ci]; break; }
                    }
                }
                // Se non trovato, cerca in tutti gli output
                if (!catMat) {
                    var outKeys = Object.keys(CATALOGO_DATA.outputs);
                    for (var oi = 0; oi < outKeys.length; oi++) {
                        var odocs = CATALOGO_DATA.outputs[outKeys[oi]].documentati || [];
                        for (var di = 0; di < odocs.length; di++) {
                            if (odocs[di].nome === id) {
                                catMat = odocs[di];
                                catOutputType = outKeys[oi];
                                break;
                            }
                        }
                        if (catMat) break;
                    }
                }
            }
            
            // B) Cerca in MATERIALI_DATA (dati arricchiti se disponibili)
            var mat = null;
            if (materialiDB && materialiDB.materiali_documentati) {
                for (var mi = 0; mi < materialiDB.materiali_documentati.length; mi++) {
                    if (materialiDB.materiali_documentati[mi].name === id) {
                        mat = materialiDB.materiali_documentati[mi];
                        break;
                    }
                }
            }
            
            console.log('[showDetail] catMat=' + (catMat ? catMat.nome : 'null') + ' mat=' + (mat ? mat.name : 'null') + ' output=' + catOutputType);
            
            // ========================================
            // C) RENDERING: materiale con scheda COMPLETA (MATERIALI_DATA)
            // ========================================
            if (mat) {
                document.getElementById('modalTitle').textContent = mat.name;
                
                // Ingredienti: mostra ENTRAMBI correlati e teorici - CLICCABILI
                let ingredientiHtml = '';
                const correlati = mat.ingredienti_correlati || [];
                const teorici = mat.ingredienti_teorici || [];
                
                if (correlati.length > 0) {
                    ingredientiHtml += '<div style="margin-bottom:6px;"><span style="color:#2d5a3d;font-weight:500;">Operativi:</span> ' + 
                        correlati.map(i => '<span class="ing-chip clickable" onclick="addSingleIngredient(\'' + i + '\'); event.stopPropagation();" title="Clicca per aggiungere">' + i + ' <small>+</small></span>').join(' ') + '</div>';
                }
                if (teorici.length > 0) {
                    ingredientiHtml += '<div><span style="color:#a03030;font-weight:500;">Teorici:</span> ' + 
                        teorici.map(i => '<span class="ing-chip teorico clickable" onclick="addSingleIngredient(\'' + i + '\'); event.stopPropagation();" title="Clicca per aggiungere">' + i + ' <small>+</small></span>').join(' ') + '</div>';
                }
                if (!ingredientiHtml) ingredientiHtml = '<span style="color:#999;">Nessun ingrediente disponibile</span>';
                
                // Bottone per aggiungere TUTTI
                let btnHtml = '';
                if (mat.replicabile_lab || (teorici.length > 0)) {
                    const btnText = mat.replicabile_lab ? '+ Aggiungi TUTTI al carrello' : '+ Aggiungi teorici';
                    btnHtml = '<button class="btn btn-primary btn-sm" style="margin-top:12px;" onclick="usaMateriale(\'' + mat.name.replace(/'/g, "\\'") + '\', \'doc\'); closeModal();">' + btnText + '</button>';
                }
                
                // v60.6: STRUTTURA ARRICCHITA per materiali documentati
                const ings = INGREDIENTI_DATA?.ingredienti || {};
                const catOutput = mat.categoria || mat.category || '';
                
                // Cerca info da CATALOGO_DATA per questo output
                let outputInfo = null;
                let outputWarnings = [];
                if (catOutput && CATALOGO_DATA?.outputs?.[catOutput]) {
                    outputInfo = CATALOGO_DATA.outputs[catOutput];
                    outputWarnings = outputInfo.warnings || [];
                }
                
                // Header con tipo output
                content = '<div class="field field-ingredienti-box"><span class="field-label">Ingredienti <small style="font-weight:normal;color:#888;">(clicca per aggiungere singoli)</small></span><div class="field-value">' + ingredientiHtml + btnHtml + '</div></div>';
                
                // Descrizione e TRL
                content += '<div class="field"><span class="field-label">Descrizione</span><div class="field-value">' + (mat.description || mat.subtitle || '-') + '</div></div>';
                
                const trlText = mat.trl >= 8 ? '<span style="color:#2a5;">TRL ' + mat.trl + ' - Industriale</span>' : 
                               (mat.trl >= 6 ? '<span style="color:#1565c0;">TRL ' + mat.trl + ' - Prototipo</span>' : 
                               '<span style="color:#f57c00;">TRL ' + mat.trl + ' - Sperimentale</span>');
                content += '<div class="field field-row"><span class="field-label">Maturità </span><div class="field-value">' + trlText + '</div></div>';
                content += '<div class="field field-row"><span class="field-label">Output</span><div class="field-value" style="text-transform:capitalize;">' + (catOutput || '-') + '</div></div>';
                content += '<div class="field field-row"><span class="field-label">Replicabile</span><div class="field-value">' + (mat.replicabile_lab ? '<span style="color:#2a5;">Sì, in laboratorio</span>' : '<span style="color:#c00;">No, solo industriale</span>') + '</div></div>';
                
                // Info ingredienti se presenti
                if (correlati.length > 0) {
                    let ingInfo = '<div class="field-group"><div class="field-group-title">PROPRIETA INGREDIENTI</div>';
                    let allVegano = true, allFoodSafe = true;
                    correlati.forEach(ingId => {
                        const ing = ings[ingId];
                        if (ing) {
                            if (!ing.vegano) allVegano = false;
                            if (!ing.food_safe) allFoodSafe = false;
                        }
                    });
                    ingInfo += '<div class="field field-row"><span class="field-label">Vegano</span><div class="field-value">' + (allVegano ? '<span style="color:#2a5;">Sì</span>' : '<span style="color:#888;">No</span>') + '</div></div>';
                    ingInfo += '<div class="field field-row"><span class="field-label">Food-safe</span><div class="field-value">' + (allFoodSafe ? '<span style="color:#2a5;">Sì</span>' : '<span style="color:#888;">Verificare</span>') + '</div></div>';
                    ingInfo += '</div>';
                    content += ingInfo;
                }
                
                // Note processo da CATALOGO
                if (outputInfo && outputInfo.note_processo) {
                    content += '<div class="field-group"><div class="field-group-title">NOTE DI PROCESSO</div>';
                    content += '<div class="field"><div class="field-value" style="font-size:0.75rem;color:#555;">' + outputInfo.note_processo + '</div></div>';
                    content += '</div>';
                }
                
                // Warnings da CATALOGO
                if (outputWarnings.length > 0) {
                    content += '<div class="field-group" style="background:#fff8e1;"><div class="field-group-title" style="color:#f57c00;">ATTENZIONE</div>';
                    outputWarnings.forEach(w => {
                        content += '<div class="field field-row"><span class="field-label" style="color:#e65100;">' + w.problema + '</span><div class="field-value" style="color:#555;">' + w.effetto + '</div></div>';
                    });
                    content += '</div>';
                }
                
                // Aziende/Designer
                if (mat.companies) {
                    content += '<div class="field"><span class="field-label">Aziende / Designer</span><div class="field-value field-companies">' + mat.companies + '</div></div>';
                }
                
                if (mat.nota_non_replicabile) {
                    content += '<div class="field"><span class="field-label">Nota</span><div class="field-value" style="color:#c00;">' + mat.nota_non_replicabile + '</div></div>';
                }
                
                // Risorse esterne (se presenti)
                if (mat.link_risorse && mat.link_risorse.length > 0) {
                    let linksHtml = mat.link_risorse.map(r => {
                        const icon = r.tipo === 'paper' ? '[P]' : (r.tipo === 'ricetta' ? '[R]' : (r.tipo === 'tutorial' ? '[T]' : (r.tipo === 'materiale' ? '[M]' : '[L]')));
                        return '<a href="' + r.url + '" target="_blank" class="risorsa-link">' + icon + ' ' + r.titolo + '</a>';
                    }).join('');
                    content += '<div class="field field-risorse"><span class="field-label">Approfondimenti</span><div class="field-value">' + linksHtml + '</div></div>';
                }
            } else if (catMat) {
                // ========================================
                // D) RENDERING: materiale solo da CATALOGO (senza scheda MATERIALI)
                // ========================================
                document.getElementById('modalTitle').textContent = catMat.nome;
                
                // Subtitle/Descrizione
                if (catMat.subtitle) {
                    content += '<div class="field"><span class="field-label">Descrizione</span><div class="field-value">' + catMat.subtitle + '</div></div>';
                }
                
                // TRL
                var catTrl = catMat.trl || 0;
                var catTrlText = catTrl >= 8 ? '<span style="color:#2a5;">TRL ' + catTrl + ' – Industriale</span>' : 
                               (catTrl >= 6 ? '<span style="color:#1565c0;">TRL ' + catTrl + ' – Prototipo</span>' : 
                               (catTrl >= 3 ? '<span style="color:#f57c00;">TRL ' + catTrl + ' – Sperimentale</span>' :
                               '<span style="color:#999;">TRL non specificato</span>'));
                content += '<div class="field field-row"><span class="field-label">Maturita</span><div class="field-value">' + catTrlText + '</div></div>';
                content += '<div class="field field-row"><span class="field-label">Output</span><div class="field-value" style="text-transform:capitalize;">' + (catOutputType || '-') + '</div></div>';
                content += '<div class="field field-row"><span class="field-label">Replicabile</span><div class="field-value">' + (catMat.replicabile !== false ? '<span style="color:#2a5;">Si, in laboratorio</span>' : '<span style="color:#c00;">No, solo industriale</span>') + '</div></div>';
                
                // Ingredienti (se presenti in CATALOGO)
                var catIngs = catMat.ingredienti || [];
                if (catIngs.length > 0) {
                    var catIngHtml = '';
                    for (var ii = 0; ii < catIngs.length; ii++) {
                        var ingId = catIngs[ii];
                        var ingObj = (INGREDIENTI_DATA && INGREDIENTI_DATA.ingredienti) ? INGREDIENTI_DATA.ingredienti[ingId] : null;
                        var ingNome = ingObj ? ingObj.nome : ingId;
                        catIngHtml += '<span class="ing-chip clickable" onclick="addSingleIngredient(\'' + ingId + '\'); event.stopPropagation();" title="Clicca per aggiungere">' + ingNome + ' <small>+</small></span> ';
                    }
                    content += '<div class="field field-ingredienti-box"><span class="field-label">Ingredienti suggeriti <small style="font-weight:normal;color:#888;">(clicca per aggiungere)</small></span><div class="field-value">' + catIngHtml + '</div></div>';
                    
                    // Bottone aggiungi tutti se replicabile
                    if (catMat.replicabile !== false) {
                        var btnOnclick = '';
                        for (var bi = 0; bi < catIngs.length; bi++) {
                            btnOnclick += "addSingleIngredient('" + catIngs[bi] + "'); ";
                        }
                        btnOnclick += 'closeModal();';
                        content += '<div style="text-align:center;margin:10px 0;"><button class="btn btn-primary btn-sm" onclick="' + btnOnclick + '">+ Aggiungi tutti al carrello</button></div>';
                    }
                } else {
                    content += '<div class="field"><span class="field-label">Ingredienti</span><div class="field-value" style="color:#999;">Non disponibili – materiale industriale</div></div>';
                }
                
                // Note di processo da CATALOGO
                var catOutInfo = (CATALOGO_DATA && CATALOGO_DATA.outputs && CATALOGO_DATA.outputs[catOutputType]) ? CATALOGO_DATA.outputs[catOutputType] : null;
                if (catOutInfo && catOutInfo.note_processo) {
                    content += '<div class="field-group"><div class="field-group-title">NOTE DI PROCESSO</div><div class="field"><div class="field-value" style="font-size:0.75rem;color:#555;">' + catOutInfo.note_processo + '</div></div></div>';
                }
                var catWarnings = catOutInfo ? (catOutInfo.warnings || []) : [];
                if (catWarnings.length > 0) {
                    content += '<div class="field-group" style="background:#fff8e1;"><div class="field-group-title" style="color:#f57c00;">ATTENZIONE</div>';
                    for (var wi = 0; wi < catWarnings.length; wi++) {
                        content += '<div class="field field-row"><span class="field-label" style="color:#e65100;">' + catWarnings[wi].problema + '</span><div class="field-value" style="color:#555;">' + catWarnings[wi].effetto + '</div></div>';
                    }
                    content += '</div>';
                }
                
                content += '<div class="field" style="margin-top:12px;"><div class="field-value" style="font-size:0.7rem;color:#bbb;font-style:italic;">Scheda sintetica da catalogo. Dati dettagliati non ancora disponibili.</div></div>';
            } else {
                // ========================================
                // E) NON TROVATO in nessun database
                // ========================================
                document.getElementById('modalTitle').textContent = id;
                content = '<div style="padding:1rem;color:#888;">Materiale "' + id + '" non trovato nel database.</div>';
                console.warn('[showDetail] Materiale non trovato: "' + id + '"');
            }
        } else {
            // MATERIALE IN PROGRESS
            const mat = materialiDB.materiali_in_progress.find(m => m.ricetta_origine === id);
            if (mat) {
                document.getElementById('modalTitle').textContent = mat.ricetta_origine + ': ' + mat.nome;
                
                // v60.1: Usa ingredienti_correlati (array ID) se presente, altrimenti fallback a descrizione
                let ingredientiHtml = '';
                const correlati = mat.ingredienti_correlati || [];
                
                if (correlati.length > 0) {
                    // USA ARRAY DI ID - ogni chip aggiunge per ID
                    ingredientiHtml = '<div>' + 
                        correlati.map(ingId => {
                            const ing = ingredientiDB?.ingredienti?.[ingId];
                            const nome = ing?.nome || ingId;
                            return '<span class="ing-chip ing-operativo clickable" onclick="addSingleIngredient(\'' + ingId + '\'); event.stopPropagation();" title="Clicca per aggiungere">' + nome + ' <small>+</small></span>';
                        }).join(' ') + '</div>';
                } else {
                    // FALLBACK: parsing testo libero (vecchio metodo)
                    const ingList = mat.ingredienti_descrizione || '-';
                    const ingArray = ingList.split(/[,+]/).map(i => i.trim()).filter(i => i && i !== '-');
                    if (ingArray.length > 0) {
                        ingredientiHtml = '<div>' + 
                            ingArray.map(i => '<span class="ing-chip ing-teorico clickable" onclick="addSingleIngredientByName(\'' + i.replace(/'/g, "\\'").replace(/\([^)]*\)/g, '').trim() + '\'); event.stopPropagation();" title="Clicca per aggiungere (parsing testo)">' + i + ' <small>+</small></span>').join(' ') + '</div>';
                    } else {
                        ingredientiHtml = '<span style="color:#999;">Nessun ingrediente specificato</span>';
                    }
                }
                
                // Bottone per aggiungere TUTTI
                const btnHtml = '<div style="display:flex;gap:0.5rem;margin-top:12px;flex-wrap:wrap;">' +
                    '<button class="btn btn-primary btn-sm" style="flex:1;" onclick="usaMateriale(\'' + mat.ricetta_origine + '\', \'prog\'); closeModal();">+ Aggiungi al carrello</button>' +
                    '<button class="btn btn-sm" style="flex:1;background:#1565c0;color:white;border:none;border-radius:6px;padding:0.4rem 0.8rem;font-size:0.72rem;cursor:pointer;" onclick="loadRecipeToLab(\'' + mat.ricetta_origine + '\')">Carica sul tavolo</button>' +
                '</div>';
                
                // Mini descrizione
                const miniDesc = [
                    mat.colore ? 'Colore: ' + mat.colore : '',
                    mat.consistenza ? 'Consistenza: ' + mat.consistenza : '',
                    mat.trasparenza ? 'Trasparenza: ' + mat.trasparenza : ''
                ].filter(x => x).join(' | ');
                
                const trlText = mat.trl === 3 ? '<span style="color:#2a5;">OK Validato</span>' : (mat.trl === 2 ? 'Funziona' : '<span style="color:#c00;">! Problemi</span>');
                
                // v60.6: STRUTTURA ARRICCHITA CON TUTTI I TEST
                content = '<div class="field field-ingredienti-box"><span class="field-label">Ingredienti <small style="font-weight:normal;color:#888;">(clicca per aggiungere singoli)</small></span><div class="field-value">' + ingredientiHtml + btnHtml + '</div></div>';
                
                // v89: Dosaggi testati
                if (mat.ingredienti_descrizione) {
                    content += '<div style="margin:0.5rem 0;padding:0.6rem;background:#fff8e1;border-radius:6px;border-left:3px solid #ffc107;">' +
                        '<div style="font-size:0.7rem;font-weight:600;color:#f57f17;margin-bottom:0.3rem;">DOSAGGI TESTATI:</div>' +
                        '<div style="font-size:0.75rem;color:#5d4037;line-height:1.5;">' + mat.ingredienti_descrizione + '</div>' +
                    '</div>';
                }
                
                // Aspetto
                content += '<div class="field-group"><div class="field-group-title">ASPETTO</div>';
                content += '<div class="field field-row"><span class="field-label">Colore</span><div class="field-value">' + (mat.colore || '-') + '</div></div>';
                content += '<div class="field field-row"><span class="field-label">Trasparenza</span><div class="field-value">' + (mat.trasparenza || '-') + '</div></div>';
                content += '<div class="field field-row"><span class="field-label">Consistenza</span><div class="field-value">' + (mat.consistenza || '-') + '</div></div>';
                content += '<div class="field field-row"><span class="field-label">Spessore</span><div class="field-value">' + (mat.spessore || '-') + '</div></div>';
                content += '</div>';
                
                // Test meccanici
                content += '<div class="field-group"><div class="field-group-title">TEST MECCANICI</div>';
                content += '<div class="field field-row"><span class="field-label">Flessione</span><div class="field-value">' + (mat.test_flessione || '-') + '</div></div>';
                if (mat.test_flessione_ritorno) content += '<div class="field field-row"><span class="field-label">Ritorno</span><div class="field-value">' + mat.test_flessione_ritorno + '</div></div>';
                if (mat.test_trazione) content += '<div class="field field-row"><span class="field-label">Trazione</span><div class="field-value">' + mat.test_trazione + '</div></div>';
                content += '</div>';
                
                // Test resistenza
                content += '<div class="field-group"><div class="field-group-title">RESISTENZA</div>';
                content += '<div class="field field-row"><span class="field-label">Acqua</span><div class="field-value">' + (mat.test_acqua || '-') + '</div></div>';
                if (mat.test_calore) content += '<div class="field field-row"><span class="field-label">Calore</span><div class="field-value">' + mat.test_calore + '</div></div>';
                content += '<div class="field field-row"><span class="field-label">Aging 7gg</span><div class="field-value">' + (mat.aging_7giorni || '-') + '</div></div>';
                content += '</div>';
                
                // Lavorabilità 
                content += '<div class="field-group"><div class="field-group-title">LAVORABILITA</div>';
                if (mat.forabile) content += '<div class="field field-row"><span class="field-label">Forabile</span><div class="field-value">' + mat.forabile + '</div></div>';
                if (mat.cucibile) content += '<div class="field field-row"><span class="field-label">Cucibile</span><div class="field-value">' + mat.cucibile + '</div></div>';
                if (mat.incollabile) content += '<div class="field field-row"><span class="field-label">Incollabile</span><div class="field-value">' + mat.incollabile + '</div></div>';
                content += '</div>';
                
                // Validazione e problemi
                content += '<div class="field field-row"><span class="field-label">Validazione</span><div class="field-value">' + trlText + '</div></div>';
                
                if (mat.problemi_realizzazione && mat.problemi_realizzazione !== 'Nessuna.' && mat.problemi_realizzazione !== '') {
                    content += '<div class="field"><span class="field-label" style="color:#c00;">Problemi</span><div class="field-value" style="color:#c00;">' + mat.problemi_realizzazione + '</div></div>';
                }
            }
        }
        
        document.getElementById('modalBody').innerHTML = sanitizeNull(content);
        document.getElementById('modalActions').innerHTML = ''; // Bottone gia inline
        document.getElementById('modalOverlay').classList.add('show');
    }
    
    // Aggiunge singolo ingrediente per ID
    // Aggiunge singolo ingrediente per ID
    function addSingleIngredient(ingId) {
        if (cart.find(c => c.id === ingId)) {
            showToast(ingId + ' gia nel carrello', 'info');
            return;
        }
        const ings = INGREDIENTI_DATA?.ingredienti || {};
        const ing = ings[ingId];
        if (ing) {
            // Copia tutto l'oggetto ingrediente come fa usaMateriale
            cart.push({...ing, id: ingId, informativo: false});
            updateCart();
            showToast(ing.nome + ' aggiunto!', 'success');
        } else {
            // Fallback: ingrediente non trovato nel DB
            cart.push({ id: ingId, nome: ingId, informativo: true, famiglia: 'sconosciuto' });
            updateCart();
            showToast(ingId + ' aggiunto (non in DB)', 'warning');
        }
    }
    
    // Aggiunge singolo ingrediente cercandolo per nome
    function addSingleIngredientByName(name) {
        const ings = INGREDIENTI_DATA?.ingredienti || {};
        // Pulisci il nome da quantità  e unità 
        let cleanName = name.replace(/\([^)]*\)/g, '').trim(); // Rimuovi (20g), (100ml) etc
        cleanName = cleanName.replace(/\d+\s*(g|ml|L|kg|mg)\b/gi, '').trim(); // Rimuovi 20g, 100ml etc
        cleanName = cleanName.replace(/\s+/g, ' ').trim(); // Normalizza spazi
        
        // Cerca per nome esatto o parziale
        let foundId = null;
        let foundIng = null;
        
        // Prima cerca match esatto
        for (const [id, ing] of Object.entries(ings)) {
            if (ing.nome && ing.nome.toLowerCase() === cleanName.toLowerCase()) {
                foundId = id;
                foundIng = ing;
                break;
            }
        }
        // Se non trovato, cerca se il nome pulito è contenuto nel nome ingrediente
        if (!foundId) {
            for (const [id, ing] of Object.entries(ings)) {
                if (ing.nome && ing.nome.toLowerCase().includes(cleanName.toLowerCase())) {
                    foundId = id;
                    foundIng = ing;
                    break;
                }
            }
        }
        // Se ancora non trovato, cerca se il nome ingrediente è contenuto nel nome pulito
        if (!foundId) {
            for (const [id, ing] of Object.entries(ings)) {
                if (ing.nome && cleanName.toLowerCase().includes(ing.nome.toLowerCase())) {
                    foundId = id;
                    foundIng = ing;
                    break;
                }
            }
        }
        
        if (foundId && foundIng) {
            if (cart.find(c => c.id === foundId)) {
                showToast(foundIng.nome + ' gia nel carrello', 'info');
                return;
            }
            cart.push({...foundIng, id: foundId, informativo: false});
            updateCart();
            showToast(foundIng.nome + ' aggiunto!', 'success');
        } else {
            // Ingrediente non trovato - aggiungi come teorico
            const fakeId = 'teorico_' + name.replace(/[^a-z0-9]/gi, '_').toLowerCase();
            if (cart.find(c => c.id === fakeId)) {
                showToast(name + ' gia nel carrello', 'info');
                return;
            }
            cart.push({ id: fakeId, nome: name, informativo: true, famiglia: 'teorico' });
            updateCart();
            showToast(name + ' aggiunto (teorico)', 'warning');
        }
    }

    function closeModal(e) {
        if (!e || e.target.id === 'modalOverlay') {
            document.getElementById('modalOverlay').classList.remove('show');
        }
    }
    
    // Modal Credits
    function openCreditsModal() {
        document.getElementById('creditsModal').classList.add('show');
        document.body.style.overflow = 'hidden'; // Blocca scroll pagina
    }
    
    function closeCreditsModal(e) {
        if (!e || e.target.id === 'creditsModal') {
            document.getElementById('creditsModal').classList.remove('show');
            document.body.style.overflow = ''; // Ripristina scroll
        }
    }

    //                                                                                                                                                                                  
    // CARRELLO
    //                                                                                                                                                                                  
    function updateCart() {
        const body = document.getElementById('cartBody');
        const count = document.getElementById('cartCount');
        
        // Pulisci elementi malformati (null, undefined, stringhe pure)
        cart = cart.filter(i => i && typeof i === 'object' && i.id);
        
        count.textContent = cart.length;
        mobileUpdateFab();
        
        const btnAllToTavolo = document.getElementById('btnAllToTavolo');
        
        if (cart.length === 0) {
            body.innerHTML = '<div class="cart-empty">Carrello vuoto.<br>Aggiungi ingredienti da un materiale.</div>';
            if (btnAllToTavolo) btnAllToTavolo.style.display = 'none';
            return;
        }
        
        // Mostra pulsante se ci sono ingredienti operativi
        const hasOperativi = cart.some(i => i && !i.informativo);
        if (btnAllToTavolo) btnAllToTavolo.style.display = hasOperativi ? 'block' : 'none';
        
        // Separa operativi e informativi
        const operativi = cart.filter(i => i && !i.informativo);
        const informativi = cart.filter(i => i && i.informativo);
        
        let html = '';
        
        // Prima gli operativi
        operativi.forEach(ing => {
            if (!ing || !ing.id) return; // Skip elementi malformati
            const inTavolo = tavolo.includes(ing.id);
            const clickAction = inTavolo ? "removeFromTavolo('" + ing.id + "')" : "addToTavolo('" + ing.id + "')";
            html += '<div class="cart-item' + (inTavolo ? ' in-tavolo' : '') + '" data-id="' + ing.id + '">' +
                '<span class="dot" style="background:' + getCategoryColor(ing.famiglia) + '"></span>' +
                '<span class="name" onclick="' + clickAction + '" title="Click: ' + (inTavolo ? 'rimuovi dal' : 'aggiungi al') + ' tavolo">' + ing.nome + '</span>' + 
                '<span class="cart-actions">' +
                    '<span class="cart-btn btn-info" onclick="event.stopPropagation(); goToIngredientDetail(\'' + ing.id + '\')">i</span>' +
                    '<span class="cart-btn btn-remove" onclick="event.stopPropagation(); confirmRemoveFromCart(\'' + ing.id + '\', event)">x</span>' +
                '</span>' +
            '</div>';
        });
        
        // Poi gli informativi (in rosso)
        if (informativi.length > 0) {
            html += '<div class="cart-separator">Teorici (non in lab)</div>';
            informativi.forEach(ing => {
                if (!ing || !ing.id) return; // Skip elementi malformati
                const ingNome = ing.nome || ing.id || 'Sconosciuto';
                html += '<div class="cart-item cart-item-teorico" data-id="' + ing.id + '">' +
                    '<span class="dot" style="background:#c00"></span>' +
                    '<span class="name" style="color:#c00; font-style:italic;">' + ingNome + '</span>' +
                    '<span class="cart-actions">' +
                        '<span class="cart-btn btn-remove" onclick="event.stopPropagation(); confirmRemoveFromCart(\'' + ing.id + '\', event)">x</span>' +
                    '</span>' +
                '</div>';
            });
        }
        body.innerHTML = html;
    }

    // Toast notification system
    function showToast(message, type = 'info', duration = 3000) {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = 'toast ' + type;
        toast.innerHTML = message;
        container.appendChild(toast);
        
        setTimeout(() => {
            toast.remove();
        }, duration);
    }
    
    // Modal di conferma personalizzato (sostituisce confirm() del browser)
    function showConfirmModal(title, message, onConfirm, onCancel) {
        // Rimuovi modal precedenti
        document.querySelectorAll('.confirm-modal-overlay').forEach(m => m.remove());
        
        const overlay = document.createElement('div');
        overlay.className = 'confirm-modal-overlay';
        overlay.innerHTML = `
            <div class="confirm-modal">
                <div class="confirm-modal-header">${title}</div>
                <div class="confirm-modal-body">${message}</div>
                <div class="confirm-modal-actions">
                    <button class="btn-confirm-cancel">Annulla</button>
                    <button class="btn-confirm-ok">Conferma</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(overlay);
        
        // Focus sul pulsante annulla per sicurezza
        overlay.querySelector('.btn-confirm-cancel').focus();
        
        // Click su Annulla
        overlay.querySelector('.btn-confirm-cancel').onclick = () => {
            overlay.remove();
            if (onCancel) onCancel();
        };
        
        // Click su Conferma
        overlay.querySelector('.btn-confirm-ok').onclick = () => {
            overlay.remove();
            if (onConfirm) onConfirm();
        };
        
        // Click su overlay chiude
        overlay.onclick = (e) => {
            if (e.target === overlay) {
                overlay.remove();
                if (onCancel) onCancel();
            }
        };
        
        // ESC chiude
        const escHandler = (e) => {
            if (e.key === 'Escape') {
                overlay.remove();
                document.removeEventListener('keydown', escHandler);
                if (onCancel) onCancel();
            }
        };
        document.addEventListener('keydown', escHandler);
    }
    
    // Conferma con toast
    let pendingDelete = null;
    function confirmRemoveFromCart(id, event) {
        const ing = cart.find(i => i && i.id === id);
        const ingName = ing?.nome || id || 'elemento';
        
        // Se non trovato come oggetto, cerca anche come stringa (elementi malformati)
        const idx = cart.findIndex(i => (i && i.id === id) || i === id);
        if (idx === -1) {
            // Forza rimozione per sicurezza
            doRemoveFromCartDirect(id);
            return;
        }
        
        // Rimuovi eventuali popup precedenti
        document.querySelectorAll('.confirm-popup').forEach(p => p.remove());
        
        // Trova l'elemento carrello
        const cartItem = event ? event.target.closest('.cart-item') : document.querySelector('.cart-item[data-id="' + id + '"]');
        if (!cartItem) {
            // Fallback: rimuovi direttamente senza conferma per elementi problematici
            doRemoveFromCartDirect(id);
            return;
        }
        
        // Assicura position relative sul parent
        cartItem.style.position = 'relative';
        
        // Crea popup inline
        const popup = document.createElement('div');
        popup.className = 'confirm-popup';
        popup.innerHTML = 'Rimuovere? ' +
            '<button onclick="doRemoveFromCartDirect(\'' + id + '\')">Sì</button>' +
            '<button class="cancel" onclick="this.parentElement.remove()">No</button>';
        cartItem.appendChild(popup);
        
        // Auto-rimuovi dopo 5 secondi
        setTimeout(() => { if (popup.parentElement) popup.remove(); }, 5000);
    }
    
    function doRemoveFromCartDirect(id) {
        const ing = cart.find(i => i && i.id === id);
        // Rimuovi sia oggetti con id che stringhe pure
        cart = cart.filter(i => {
            if (i && typeof i === 'object') return i.id !== id;
            if (typeof i === 'string') return i !== id;
            return true; // Rimuovi elementi undefined/null
        });
        // Pulisci anche eventuali elementi undefined
        cart = cart.filter(i => i != null);
        
        document.querySelectorAll('.confirm-popup').forEach(p => p.remove());
        updateCart();
        saveCartToStorage();
        showToast((ing?.nome || id || 'Elemento') + ' rimosso', 'info', 2000);
    }
    
    // Legacy - mantieni per compatibilità 
    function doRemoveFromCart() {
        if (pendingDelete) {
            doRemoveFromCartDirect(pendingDelete);
            pendingDelete = null;
            document.querySelectorAll('.toast-confirm').forEach(t => t.remove());
        }
    }
    
    function cancelRemove() {
        pendingDelete = null;
        document.querySelectorAll('.toast-confirm').forEach(t => t.remove());
    }

    function removeFromCart(id) {
        confirmRemoveFromCart(id);
    }

    function getCategoryColor(famiglia) {
        const colors = {
            'PROTEINA': '#e74c3c',
            'POLISACCARIDE_NEUTRO': '#3498db',
            'POLISACCARIDE_ANIONICO': '#9b59b6',
            'POLICATIONE': '#1abc9c',
            'PLASTIFICANTE': '#f39c12',
            'SALE_RETICOLANTE': '#e67e22',
            'LIPIDE': '#27ae60',
            'COLORANTE': '#e91e63',
            'CARICA': '#795548',
            'ADDITIVO': '#607d8b',
            'COLTURA': '#00bcd4',
            'teorico': '#c00'
        };
        return colors[famiglia] || '#888';
    }
    function getCategoryClass(famiglia) {
        const colors = {
            'PROTEINA': 'cat-proteina',
            'POLISACCARIDE_NEUTRO': 'cat-polisaccaride',
            'POLISACCARIDE_ANIONICO': 'cat-polisaccaride',
            'POLICATIONE': 'cat-policatione',
            'PLASTIFICANTE': 'cat-plastificante',
            'SALE_RETICOLANTE': 'cat-sale',
            'LIPIDE': 'cat-lipide',
            'COLORANTE': 'cat-colorante',
            'CARICA': 'cat-carica',
            'COLTURA': 'cat-coltura',
            'EMULSIONANTE': 'cat-emulsionante',
            'ADDITIVO': 'cat-additivo',
            'ACIDO': 'cat-additivo'
        };
        return colors[famiglia] || 'cat-default';
    }


    function exportCart() {
        if (cart.length === 0) {
            showToast('Il carrello    vuoto', 'warning');
            return;
        }
        const text = cart.map(i => i.nome + ' (' + i.id + ')').join('\n');
        // Copia negli appunti se possibile
        if (navigator.clipboard) {
            navigator.clipboard.writeText(text).then(() => {
                showToast('Lista copiata negli appunti!', 'success');
            });
        } else {
            showToast('Ingredienti: ' + cart.map(i => i.nome).join(', '), 'info', 5000);
        }
    }

    //                                                                                                                                                                                  
    // NAVIGAZIONE
    //                                                                                                                                                                                  
    
    function updateCartButton() {
        const btnB = document.getElementById('btnToB');
        const btnC = document.getElementById('btnToC');
        const btnClear = document.getElementById('btnClear');
        const btnAllToTavolo = document.getElementById('btnAllToTavolo');
        if (!btnB || !btnC || !btnClear) return;
        
        const panel = document.querySelector('.panel-container.active');
        const isC = panel && panel.id === 'panel-C';
        const isB = panel && panel.id === 'panel-B';
        
        // Tab A: mostra entrambi i bottoni navigazione
        // Tab B: mostra solo     Laboratorio
        // Tab C: mostra Tutti sul tavolo + Svuota tavolo
        btnB.style.display = (isC || isB) ? 'none' : 'block';
        btnC.style.display = isC ? 'none' : 'block';
        if (btnAllToTavolo) btnAllToTavolo.style.display = isC ? 'inline-block' : 'none';
        btnClear.style.display = isC ? 'inline-block' : 'none';
    }

    // =====================================================
    // TAB PROGETTO - PERCORSO INVERSO
    // =====================================================
    
    let activeProjectFilters = new Set();
    let suggestedIngredients = [];
    
    function toggleProjectFilter(chip) {
        const filter = chip.dataset.filter;
        chip.classList.toggle('active');
        
        if (activeProjectFilters.has(filter)) {
            activeProjectFilters.delete(filter);
        } else {
            activeProjectFilters.add(filter);
        }
        
        // v76: check visibile/nascosto via CSS (.active .filter-check)
        updateProjectResults();
    }
    
    function clearProjectFilters() {
        activeProjectFilters.clear();
        document.querySelectorAll('.filter-chip').forEach(chip => {
            chip.classList.remove('active');
            // v76: check nascosto via CSS
        });
        updateProjectResults();
    }
    
    function updateProjectResults() {
        const resultsSection = document.getElementById('projectResults');
        const filtersHint = document.getElementById('filtersHint');
        
        if (activeProjectFilters.size === 0) {
            resultsSection.style.display = 'none';
            filtersHint.style.display = 'block';
            // v72: nascondi anche tradeoffs e percorsi
            var td = document.getElementById('projectTradeoffs');
            var pp = document.getElementById('projectPaths');
            if (td) td.style.display = 'none';
            if (pp) pp.style.display = 'none';
            return;
        }
        
        resultsSection.style.display = 'grid';
        filtersHint.style.display = 'none';
        
        // Filtra ingredienti
        const matchingIngs = filterIngredientsByProperties();
        suggestedIngredients = matchingIngs;
        renderMatchingIngredients(matchingIngs);
        
        // Filtra materiali
        const matchingMats = filterMaterialsByProperties();
        renderMatchingMaterials(matchingMats);
        
        // Mostra suggerimenti per proprietà 
        renderPropertySuggestions();
        
        // Mostra/nascondi azioni
        const actionsDiv = document.getElementById('projectActions');
        actionsDiv.style.display = matchingIngs.length > 0 ? 'flex' : 'none';
        
        // v72: Trade-offs e percorsi consigliati
        renderTradeoffs();
        renderSuggestedPaths(matchingIngs);
    }
    
    function filterIngredientsByProperties() {
        const ings = INGREDIENTI_DATA?.ingredienti || {};
        const results = [];
        
        for (const [id, ing] of Object.entries(ings)) {
            // Salta additivi puri come acqua, sale
            if (ing.famiglia === 'ADDITIVO' && !ing.proprieta?.struttura) continue;
            
            let score = 0;
            let matches = 0;
            const totalFilters = activeProjectFilters.size;
            
            // Controllo ogni filtro
            if (activeProjectFilters.has('trasparente')) {
                const trasp = ing.proprieta?.trasparenza || '';
                if (trasp.toLowerCase().includes('trasparente') || trasp.toLowerCase().includes('alta')) {
                    score++; matches++;
                }
            }
            
            if (activeProjectFilters.has('flessibile')) {
                const flex = ing.proprieta?.flessibilita || '';
                if (flex.toLowerCase().includes('alta') || flex.toLowerCase().includes('media')) {
                    score++; matches++;
                } else if (ing.famiglia === 'PLASTIFICANTE') {
                    score += 0.5; matches++;
                }
            }
            
            if (activeProjectFilters.has('rigido')) {
                const flex = ing.proprieta?.flessibilita || '';
                if (flex.toLowerCase().includes('bassa') || flex.toLowerCase().includes('rigid')) {
                    score++; matches++;
                } else if (ing.famiglia === 'CARICA' || ing.famiglia === 'SALE_RETICOLANTE') {
                    score += 0.5; matches++;
                }
            }
            
            if (activeProjectFilters.has('resistente_acqua')) {
                const barr = ing.proprieta?.barriera_H2O || '';
                if (barr.toLowerCase().includes('buona') || barr.toLowerCase().includes('alta') || barr.toLowerCase().includes('eccellente')) {
                    score++; matches++;
                } else if (ing.famiglia === 'LIPIDE') {
                    score++; matches++;
                }
            }
            
            if (activeProjectFilters.has('vegano')) {
                if (ing.vegano === true) {
                    score++; matches++;
                }
            }
            
            if (activeProjectFilters.has('food_safe')) {
                if (ing.food_safe === true) {
                    score++; matches++;
                }
            }
            
            if (activeProjectFilters.has('antibatterico')) {
                if (ing.famiglia === 'POLICATIONE' || (ing.descrizione && ing.descrizione.toLowerCase().includes('antibatteric'))) {
                    score++; matches++;
                }
            }
            
            if (activeProjectFilters.has('termostabile')) {
                const tempFusione = ing.parametri?.temp_fusione_gel;
                if (tempFusione && tempFusione > 40) {
                    score++; matches++;
                } else if (ing.famiglia === 'POLISACCARIDE_NEUTRO' && ing.nome?.toLowerCase().includes('agar')) {
                    score++; matches++;
                } else if (ing.famiglia === 'LIPIDE' || ing.famiglia === 'CARICA') {
                    score += 0.5; matches++;
                }
            }
            
            if (activeProjectFilters.has('economico')) {
                const rep = ing.reperibilita || '';
                if (rep.toLowerCase().includes('facile') || rep.toLowerCase().includes('comune')) {
                    score++; matches++;
                }
            }
            
            // Includi se ha almeno un match
            if (matches > 0) {
                results.push({
                    id,
                    ing,
                    score,
                    matches,
                    matchPercent: Math.round((matches / totalFilters) * 100)
                });
            }
        }
        
        // Ordina per score e poi per match percent
        results.sort((a, b) => b.score - a.score || b.matchPercent - a.matchPercent);
        
        return results;
    }
    
    function filterMaterialsByProperties() {
        // Usa CATALOGO_DATA che ha i materiali con ingredienti
        const outputs = CATALOGO_DATA?.outputs || {};
        const results = [];
        const ings = INGREDIENTI_DATA?.ingredienti || {};
        
        // Itera su tutti i tipi di output
        for (const [outputType, outputData] of Object.entries(outputs)) {
            const documentati = outputData.documentati || [];
            
            for (const mat of documentati) {
                // Solo materiali replicabili con ingredienti
                if (!mat.replicabile || !mat.ingredienti || mat.ingredienti.length === 0) continue;
                
                let score = 0;
                let matches = 0;
                const totalFilters = activeProjectFilters.size;
                
                // Raccogli proprietà  degli ingredienti
                const matIngs = mat.ingredienti.map(id => ings[id]).filter(Boolean);
                if (matIngs.length === 0) continue;
                
                if (activeProjectFilters.has('trasparente')) {
                    const hasTransparent = matIngs.some(i => {
                        const t = i.proprieta?.trasparenza || '';
                        return t.toLowerCase().includes('trasparente') || t.toLowerCase().includes('alta');
                    });
                    const hasOpaque = matIngs.some(i => i.famiglia === 'CARICA' || i.famiglia === 'COLORANTE');
                    if (hasTransparent && !hasOpaque) { score++; matches++; }
                }
                
                if (activeProjectFilters.has('flessibile')) {
                    const hasPlast = matIngs.some(i => i.famiglia === 'PLASTIFICANTE');
                    const hasFlex = matIngs.some(i => {
                        const f = i.proprieta?.flessibilita || '';
                        return f.toLowerCase().includes('alta');
                    });
                    if (hasPlast || hasFlex) { score++; matches++; }
                }
                
                if (activeProjectFilters.has('rigido')) {
                    const hasCarica = matIngs.some(i => i.famiglia === 'CARICA');
                    const hasRetic = matIngs.some(i => i.famiglia === 'SALE_RETICOLANTE');
                    if (hasCarica || hasRetic || outputType === 'rigido') { score++; matches++; }
                }
                
                if (activeProjectFilters.has('resistente_acqua')) {
                    const hasLipid = matIngs.some(i => i.famiglia === 'LIPIDE');
                    if (hasLipid) { score++; matches++; }
                }
                
                if (activeProjectFilters.has('vegano')) {
                    const allVegan = matIngs.every(i => i.vegano === true);
                    if (allVegan) { score++; matches++; }
                }
                
                if (activeProjectFilters.has('food_safe')) {
                    const allFoodSafe = matIngs.every(i => i.food_safe === true);
                    if (allFoodSafe) { score++; matches++; }
                }
                
                if (activeProjectFilters.has('antibatterico')) {
                    const hasChito = matIngs.some(i => i.famiglia === 'POLICATIONE');
                    if (hasChito) { score++; matches++; }
                }
                
                if (activeProjectFilters.has('termostabile')) {
                    const hasAgar = matIngs.some(i => i.nome?.toLowerCase().includes('agar'));
                    const hasLipid = matIngs.some(i => i.famiglia === 'LIPIDE');
                    if (hasAgar || hasLipid) { score++; matches++; }
                }
                
                if (activeProjectFilters.has('economico')) {
                    const allEasy = matIngs.every(i => {
                        const r = i.reperibilita || '';
                        return r.toLowerCase().includes('facile');
                    });
                    if (allEasy) { score++; matches++; }
                }
                
                if (matches > 0) {
                    results.push({
                        mat: {...mat, output: outputType},
                        score,
                        matches,
                        matchPercent: Math.round((matches / totalFilters) * 100)
                    });
                }
            }
        }
        
        results.sort((a, b) => b.score - a.score || b.matchPercent - a.matchPercent);
        return results.slice(0, 8); // Max 8 risultati
    }
    
    function renderMatchingIngredients(results) {
        const container = document.getElementById('matchingIngredients');
        const countBadge = document.getElementById('ingredientsCount');
        
        // Filtra solo matrici e modificatori principali
        const matrici = results.filter(r => 
            ['PROTEINA', 'POLISACCARIDE_NEUTRO', 'POLISACCARIDE_ANIONICO', 'POLICATIONE', 'COLTURA'].includes(r.ing.famiglia)
        ).slice(0, 6);
        
        const modificatori = results.filter(r => 
            ['PLASTIFICANTE', 'LIPIDE', 'SALE_RETICOLANTE', 'CARICA'].includes(r.ing.famiglia)
        ).slice(0, 6);
        
        countBadge.textContent = matrici.length + modificatori.length;
        
        if (matrici.length === 0 && modificatori.length === 0) {
            container.innerHTML = '<div class="results-empty"><div class="empty-icon">Nessun risultato</div><div>Nessun ingrediente corrisponde ai filtri</div></div>';
            return;
        }
        
        let html = '';
        
        if (matrici.length > 0) {
            html += '<div style="margin-bottom: 0.75rem;"><div style="font-size: 0.7rem; color: #888; margin-bottom: 0.4rem;">Matrici base:</div>';
            matrici.forEach(r => {
                const color = getCategoryColor(r.ing.famiglia);
                html += '<div class="ingredient-suggestion" onclick="addProjectIngredient(\'' + r.id + '\')" title="' + r.matchPercent + '% match">';
                html += '<span class="ing-dot" style="background:' + color + ';"></span>';
                html += '<span>' + r.ing.nome + '</span>';
                html += '<span class="add-btn">+</span>';
                html += '</div>';
            });
            html += '</div>';
        }
        
        if (modificatori.length > 0) {
            html += '<div><div style="font-size: 0.7rem; color: #888; margin-bottom: 0.4rem;">Modificatori:</div>';
            modificatori.forEach(r => {
                const color = getCategoryColor(r.ing.famiglia);
                html += '<div class="ingredient-suggestion" onclick="addProjectIngredient(\'' + r.id + '\')" title="' + r.matchPercent + '% match">';
                html += '<span class="ing-dot" style="background:' + color + ';"></span>';
                html += '<span>' + r.ing.nome + '</span>';
                html += '<span class="add-btn">+</span>';
                html += '</div>';
            });
            html += '</div>';
        }
        
        container.innerHTML = html;
    }
    
    function renderMatchingMaterials(results) {
        const container = document.getElementById('matchingMaterials');
        const countBadge = document.getElementById('materialsCount');
        
        countBadge.textContent = results.length;
        
        if (results.length === 0) {
            container.innerHTML = '<div class="results-empty"><div class="empty-icon">Nessun risultato</div><div>Nessun materiale corrisponde ai filtri</div></div>';
            return;
        }
        
        let html = '';
        results.forEach(r => {
            const mat = r.mat;
            const outputIcon = getOutputIcon(mat.output);
            
            // Crea dots per match
            let dots = '';
            const totalFilters = activeProjectFilters.size;
            for (let i = 0; i < Math.min(totalFilters, 5); i++) {
                if (i < r.matches) {
                    dots += '<span class="match-dot"></span>';
                } else {
                    dots += '<span class="match-dot miss"></span>';
                }
            }
            
            // Escape nome per onclick
            const escapedNome = mat.nome.replace(/'/g, "\\'");
            
            html += '<div class="material-card" onclick="loadMaterialInProject(\'' + escapedNome + '\')">';
            html += '<div class="mat-icon">' + outputIcon + '</div>';
            html += '<div class="mat-info">';
            html += '<div class="mat-name">' + mat.nome + '</div>';
            html += '<div class="mat-desc">' + (mat.subtitle || mat.output) + '</div>';
            html += '</div>';
            html += '<div class="mat-match">' + dots + '</div>';
            html += '</div>';
        });
        
        container.innerHTML = html;
    }
    
    function renderPropertySuggestions() {
        const container = document.getElementById('propertySuggestions');
        const ings = INGREDIENTI_DATA?.ingredienti || {};
        let html = '';
        
        // Suggerimenti specifici basati sui filtri attivi
        if (activeProjectFilters.has('flessibile') && !activeProjectFilters.has('rigido')) {
            html += '<div class="property-suggestion">';
            html += '<div class="prop-label">Per maggiore flessibilita:</div>';
            html += '<div class="ingredient-suggestion" onclick="addProjectIngredient(\'glicerina\')"><span class="ing-dot" style="background:#9c27b0;"></span>Glicerina<span class="add-btn">+</span></div>';
            html += '<div class="ingredient-suggestion" onclick="addProjectIngredient(\'sorbitolo\')"><span class="ing-dot" style="background:#9c27b0;"></span>Sorbitolo<span class="add-btn">+</span></div>';
            html += '</div>';
        }
        
        if (activeProjectFilters.has('resistente_acqua')) {
            html += '<div class="property-suggestion">';
            html += '<div class="prop-label">Per resistenza all\'acqua (coating finale):</div>';
            html += '<div class="ingredient-suggestion" onclick="addProjectIngredient(\'cera_carnauba\')"><span class="ing-dot" style="background:#795548;"></span>Cera carnauba<span class="add-btn">+</span></div>';
            html += '<div class="ingredient-suggestion" onclick="addProjectIngredient(\'gommalacca\')"><span class="ing-dot" style="background:#795548;"></span>Gommalacca<span class="add-btn">+</span></div>';
            html += '</div>';
        }
        
        if (activeProjectFilters.has('rigido')) {
            html += '<div class="property-suggestion">';
            html += '<div class="prop-label">Per maggiore rigidita:</div>';
            html += '<div class="ingredient-suggestion" onclick="addProjectIngredient(\'cacl2\')"><span class="ing-dot" style="background:#ff9800;"></span>Cloruro di calcio<span class="add-btn">+</span></div>';
            html += '<div class="ingredient-suggestion" onclick="addProjectIngredient(\'fondi_caffe\')"><span class="ing-dot" style="background:#607d8b;"></span>Fondi di caffe<span class="add-btn">+</span></div>';
            html += '</div>';
        }
        
        container.innerHTML = html;
        container.style.display = html ? 'block' : 'none';
    }
    
    function getOutputIcon(output) {
        const icons = {
            'film': 'F',
            'gel': 'G',
            'rigido': 'R',
            'coating': 'C',
            'schiuma': 'S',
            'pelle': 'P',
            'composito': 'X'
        };
        return icons[output] || '?';
    }
    
    function addProjectIngredient(ingId) {
        const ings = INGREDIENTI_DATA?.ingredienti || {};
        const ing = ings[ingId];
        if (!ing) {
            showToast('Ingrediente non trovato', 'error');
            return;
        }
        
        if (cart.find(c => c.id === ingId)) {
            showToast(ing.nome + ' gia nel carrello', 'info');
            return;
        }
        
        cart.push({...ing, id: ingId, informativo: false});
        updateCart();
        showToast(ing.nome + ' aggiunto!', 'success');
    }
    
    function addAllSuggestedToCart() {
        // Aggiungi matrici e modificatori suggeriti
        const matrici = suggestedIngredients.filter(r => 
            ['PROTEINA', 'POLISACCARIDE_NEUTRO', 'POLISACCARIDE_ANIONICO', 'POLICATIONE', 'COLTURA'].includes(r.ing.famiglia)
        ).slice(0, 2);
        
        const modificatori = suggestedIngredients.filter(r => 
            ['PLASTIFICANTE', 'LIPIDE'].includes(r.ing.famiglia)
        ).slice(0, 1);
        
        let added = 0;
        [...matrici, ...modificatori].forEach(r => {
            if (!cart.find(c => c.id === r.id)) {
                cart.push({...r.ing, id: r.id, informativo: false});
                added++;
            }
        });
        
        if (added > 0) {
            updateCart();
            showToast(added + ' ingredienti aggiunti al carrello!', 'success');
        } else {
            showToast('Ingredienti gia nel carrello', 'info');
        }
    }
    
    // v72: Trade-offs tra filtri in conflitto
    function renderTradeoffs() {
        const container = document.getElementById('projectTradeoffs');
        if (!container) return;
        
        const conflicts = [
            { a: 'flessibile', b: 'rigido', msg: 'Flessibile e rigido sono opposti. Il sistema cerchera un compromesso "semirigido", ma dovrai scegliere quale privilegiare.' },
            { a: 'trasparente', b: 'rigido', msg: 'Trasparenza + rigidita: le cariche che danno struttura tendono a rendere opaco. Possibile con agar puro (rigido e trasparente) ma fragile.' },
            { a: 'flessibile', b: 'resistente_acqua', msg: 'Flessibilita + resistenza acqua: i plastificanti (glicerina, sorbitolo) sono idrosolubili. Servira un coating lipidico esterno per proteggere.' },
            { a: 'trasparente', b: 'resistente_acqua', msg: 'Trasparenza + barriera acqua: i lipidi che proteggono dall\'acqua rendono opaco. Possibile con gommalacca (traslucida) come coating esterno.' },
            { a: 'trasparente', b: 'antibatterico', msg: 'Il chitosano (antibatterico) e naturalmente giallastro. Otterrai una buona trasparenza ma con tonalita calda, non cristallina.' },
            { a: 'economico', b: 'antibatterico', msg: 'Il chitosano (antibatterico) non e tra i piu economici ne facili da reperire. Considera fonti online specializzate.' }
        ];
        
        let found = [];
        conflicts.forEach(c => {
            if (activeProjectFilters.has(c.a) && activeProjectFilters.has(c.b)) {
                found.push(c.msg);
            }
        });
        
        if (found.length === 0) {
            container.style.display = 'none';
            return;
        }
        
        container.style.display = 'block';
        let html = '<div class="tradeoff-label">Trade-offs nelle tue esigenze</div>';
        found.forEach(msg => {
            html += '<div class="tradeoff-box">' + msg + '</div>';
        });
        container.innerHTML = html;
    }
    
    // v89: Genera percorsi consigliati – approccio a blueprints strategici
    // Ogni blueprint è un modello di ricetta con proprietà  ottenibili.
    // Il motore valuta tutti i blueprint, li filtra per vincoli (vegano, food-safe),
    // li ordina per quante proprietà  richieste soddisfano, e mostra i migliori.
    function renderSuggestedPaths(matchingIngs) {
        const pathsDiv = document.getElementById('projectPaths');
        const content = document.getElementById('pathsContent');
        if (!pathsDiv || !content) return;
        
        const ings = INGREDIENTI_DATA?.ingredienti || {};
        const filters = [...activeProjectFilters];
        
        if (filters.length === 0) {
            pathsDiv.style.display = 'none';
            return;
        }
        
        // Filtri "proprietà " (da ottimizzare) vs "vincolo" (da rispettare)
        var propFilters = filters.filter(function(f) { return ['vegano','food_safe','economico'].indexOf(f) === -1; });
        var hasVegano = activeProjectFilters.has('vegano');
        var hasFoodSafe = activeProjectFilters.has('food_safe');
        var hasEconomico = activeProjectFilters.has('economico');
        
        // ██ BLUEPRINTS: modelli di ricetta con proprietà  ottenibili ██
        // Ogni blueprint definisce: famiglia matrice, filtro specifico (opz.),
        // modificatori necessari, proprietà  raggiunte, nota didattica
        var BLUEPRINTS = [
            // ███ PROTEINE – film classici ███
            { mFam:'PROTEINA', mods:[{f:'PLASTIFICANTE',r:'per flessibilità'}],
              achieves:['flessibile','trasparente','food_safe'],
              note:'Film proteico classico – trasparente SOLO senza cariche/coloranti. Il plastificante aumenta flessibilità.' },
            { mFam:'PROTEINA', mods:[{f:'PLASTIFICANTE',r:'per flessibilità'},{f:'LIPIDE',r:'come coating impermeabilizzante'}],
              achieves:['flessibile','resistente_acqua','food_safe'],
              note:'Film proteico con barriera lipidica – lo strato di cera protegge dall\'acqua' },
            { mFam:'PROTEINA', mods:[{f:'CARICA',r:'come rinforzo strutturale'}],
              achieves:['rigido','food_safe'],
              note:'Composito proteico rigido – la carica aumenta corpo ma rende OPACO e riduce flessibilità' },
            { mFam:'PROTEINA', mods:[],
              achieves:['resistente_acqua','trasparente','food_safe'],
              mFilter: function(i){ return i.nome.toLowerCase().indexOf('zeina') !== -1; },
              note:'La zeina (proteina del mais) è naturalmente idrofoba – forma film resistenti all\'acqua senza coating' },
            
            // ███ NUOVO: Caseina + reticolante (Galalite storica) ███
            { mFam:'PROTEINA', mods:[{f:'SALE_RETICOLANTE',r:'per indurimento'}],
              achieves:['rigido','food_safe'],
              mFilter: function(i){ return i.nome.toLowerCase().indexOf('caseina') !== -1; },
              note:'Plastica di caseina storica (Galalite, 1897) – si ottiene con latte cagliato + formalina o allume. Rigida, lavorabile, opaca.' },
            
            // ███ NUOVO: Gelatina + tannini (simil-cuoio) ███
            { mFam:'PROTEINA', mods:[{f:'PLASTIFICANTE',r:'per flessibilità'},{f:'SALE_RETICOLANTE',r:'per conciatura'}],
              achieves:['flessibile','food_safe'],
              mFilter: function(i){ return i.nome.toLowerCase().indexOf('gelatina') !== -1; },
              note:'Simil-cuoio vegetale – i tannini "conciano" la gelatina rendendola più resistente all\'acqua e termostabile. Diventa opaco/brunastro.' },
            
            // ███ POLISACCARIDI NEUTRI – amidi e agar ███
            { mFam:'POLISACCARIDE_NEUTRO', mods:[{f:'PLASTIFICANTE',r:'per flessibilità'}],
              achieves:['flessibile','food_safe'],
              note:'Film polisaccaridico flessibile – ATTENZIONE: sensibile all\'acqua! Proteggere con coating lipidico se serve impermeabilità.' },
            { mFam:'POLISACCARIDE_NEUTRO', mods:[{f:'PLASTIFICANTE',r:'per flessibilità'},{f:'LIPIDE',r:'come barriera acqua'}],
              achieves:['flessibile','resistente_acqua','food_safe'],
              note:'Film polisaccaridico con coating lipidico – la cera protegge la matrice idrofila dall\'umidità' },
            { mFam:'POLISACCARIDE_NEUTRO', mods:[],
              achieves:['rigido','food_safe','termostabile'],
              mFilter: function(i){ return i.nome.toLowerCase().indexOf('agar') !== -1; },
              note:'L\'agar forma gel termostabili e rigidi – non fonde a temperatura ambiente (>85°C)' },
            { mFam:'POLISACCARIDE_NEUTRO', mods:[{f:'PLASTIFICANTE',r:'per flessibilità'}],
              achieves:['flessibile','trasparente','food_safe','termostabile'],
              mFilter: function(i){ return i.nome.toLowerCase().indexOf('agar') !== -1; },
              note:'Agar plastificato – mantiene la termostabilità con maggiore flessibilità. Molto trasparente.' },
            { mFam:'POLISACCARIDE_NEUTRO', mods:[{f:'CARICA',r:'come rinforzo'}],
              achieves:['rigido','food_safe'],
              note:'Composito amido + fibra – struttura rigida tipo cartone, OPACO, economico e compostabile' },
            { mFam:'POLISACCARIDE_NEUTRO', mods:[],
              achieves:['rigido','food_safe'],
              mFilter: function(i){ return i.nome.toLowerCase().indexOf('amido') !== -1; },
              note:'Amido non plastificato – forma film rigidi e fragili, sensibili all\'acqua. Utili come substrato temporaneo.' },
            
            // ███ POLISACCARIDI ANIONICI – alginato, carragenina, pectina ███
            { mFam:'POLISACCARIDE_ANIONICO', mods:[{f:'SALE_RETICOLANTE',r:'per gelificazione/reticolazione'}],
              achieves:['rigido','termostabile','food_safe','trasparente'],
              note:'Gel reticolato con calcio – termostabile, trasparente, buona struttura. L\'alginato richiede CaCl₂.' },
            { mFam:'POLISACCARIDE_ANIONICO', mods:[{f:'SALE_RETICOLANTE',r:'per reticolare'},{f:'PLASTIFICANTE',r:'per flessibilità'}],
              achieves:['flessibile','termostabile','food_safe','trasparente'],
              note:'Gel reticolato plastificato – buon compromesso tra struttura, flessibilità e termostabilità' },
            { mFam:'POLISACCARIDE_ANIONICO', mods:[{f:'SALE_RETICOLANTE',r:'per ridurre solubilità'},{f:'LIPIDE',r:'come barriera acqua'}],
              achieves:['resistente_acqua','termostabile','food_safe'],
              note:'Doppia strategia anti-acqua: la reticolazione riduce la solubilità, il coating lipidico fa da barriera' },
            
            // ███ NUOVO: Pectina plastificata (senza reticolante) ███
            { mFam:'POLISACCARIDE_ANIONICO', mods:[{f:'PLASTIFICANTE',r:'per flessibilità'}],
              achieves:['flessibile','trasparente','food_safe'],
              mFilter: function(i){ return i.nome.toLowerCase().indexOf('pectina') !== -1; },
              note:'Pectina plastificata – forma film flessibili e trasparenti anche SENZA Ca²⁺. Sensibile all\'acqua, termolabile.' },
            
            // ███ CHITOSANO – antibatterico ███
            { mFam:'POLICATIONE', mods:[{f:'PLASTIFICANTE',r:'per flessibilità'}],
              achieves:['antibatterico','flessibile','food_safe'],
              note:'Il chitosano è naturalmente antibatterico – ottimo per packaging alimentare attivo. Richiede dissoluzione in acido (aceto).' },
            { mFam:'POLICATIONE', mods:[],
              achieves:['antibatterico','rigido'],
              note:'Film di chitosano puro – moderata resistenza all\'acqua, rigido, proprietà antimicrobiche. Richiede pH acido per dissolversi.' },
            { mFam:'POLICATIONE', mods:[{f:'PLASTIFICANTE',r:'per flessibilità'},{f:'LIPIDE',r:'per barriera acqua'}],
              achieves:['antibatterico','flessibile','resistente_acqua','food_safe'],
              note:'Chitosano flessibile impermeabilizzato – massima funzionalità per packaging attivo' },
            
            // ███ COLTURE – micelio e SCOBY ███
            { mFam:'COLTURA', mods:[],
              achieves:['rigido','resistente_acqua','termostabile'],
              mFilter: function(i){ return i.nome.toLowerCase().indexOf('micelio') !== -1; },
              note:'Il micelio cresce su substrato organico e forma pannelli rigidi, naturalmente idrofobi' },
            { mFam:'COLTURA', mods:[{f:'CARICA',r:'come substrato di crescita'}],
              achieves:['rigido','resistente_acqua','termostabile'],
              mFilter: function(i){ return i.nome.toLowerCase().indexOf('micelio') !== -1; },
              note:'Micelio su substrato fibroso – composito strutturale tipo pannello isolante o packaging' },
            { mFam:'COLTURA', mods:[{f:'PLASTIFICANTE',r:'per flessibilità'},{f:'LIPIDE',r:'per impermeabilizzare'}],
              achieves:['flessibile','resistente_acqua'],
              mFilter: function(i){ return i.nome.toLowerCase().indexOf('scoby') !== -1; },
              note:'Pelle di SCOBY trattata – la cellulosa batterica diventa flessibile e impermeabile con olio/cera' },
            
            // ███ LIPIDI come matrice (coating puro) ███
            { mFam:'LIPIDE', mods:[],
              achieves:['resistente_acqua','termostabile'],
              note:'Coating lipidico puro – si applica a pennello o immersione su superfici da impermeabilizzare' },
            
            // ███ COMBINAZIONI AVANZATE multi-proprietà ███
            { mFam:'POLISACCARIDE_NEUTRO', mods:[{f:'PLASTIFICANTE',r:'per flessibilità'},{f:'LIPIDE',r:'come barriera acqua'},{f:'CARICA',r:'per corpo e struttura'}],
              achieves:['flessibile','resistente_acqua','food_safe'],
              mFilter: function(i){ return i.nome.toLowerCase().indexOf('amido') !== -1; },
              note:'Composito amido completo – plastificante per lavorabilità, cera per acqua, fibra per resistenza meccanica. OPACO.' },
            { mFam:'PROTEINA', mods:[{f:'PLASTIFICANTE',r:'per flessibilità'},{f:'CARICA',r:'per rinforzo e opacità'}],
              achieves:['flessibile','food_safe'],
              note:'Film proteico semi-rigido – il plastificante evita fragilità, la carica dà corpo. OPACO, buon compromesso.' }
        ];
        
        // ██ Helper: cerca ingredienti da una famiglia rispettando vincoli ██
        function pickFromFamily(fam, filter) {
            var cc = Object.entries(ings).filter(function(e) { return e[1].famiglia === fam; });
            if (filter) cc = cc.filter(function(e) { return filter(e[1]); });
            if (hasVegano) cc = cc.filter(function(e) { return e[1].vegano === true; });
            if (hasFoodSafe) cc = cc.filter(function(e) { return e[1].food_safe === true; });
            if (hasEconomico) {
                var cheap = cc.filter(function(e) { return /facile|comune/i.test(e[1].reperibilita || ''); });
                if (cheap.length > 0) cc = cheap;
            }
            return cc;
        }
        
        // ██ Genera percorsi da tutti i blueprint ██
        var allPaths = [];
        
        BLUEPRINTS.forEach(function(bp) {
            // 1. Trova matrici candidate
            var matrices = pickFromFamily(bp.mFam, bp.mFilter || null);
            if (matrices.length === 0) return;
            
            // 2. Trova modificatori – se uno manca, skip blueprint
            var mods = [];
            var modOk = true;
            (bp.mods || []).forEach(function(m) {
                if (!modOk) return;
                var mc = pickFromFamily(m.f);
                if (mc.length === 0) { modOk = false; return; }
                mods.push({ entry: mc[0], reason: m.r, fam: m.f });
            });
            if (!modOk) return;
            
            // 3. Score: quante proprietà  attive soddisfa questo blueprint?
            var score = 0;
            propFilters.forEach(function(f) {
                if (bp.achieves.indexOf(f) !== -1) score++;
            });
            // Se nessun filtro proprietà  attivo (solo vincoli), accetta tutto
            if (propFilters.length === 0) score = 1;
            // Se ha filtri proprietà  ma score 0, skip
            if (propFilters.length > 0 && score === 0) return;
            
            // 4. Genera path per max 2 matrici candidate (varietà )
            var maxM = matrices.length > 1 ? 2 : 1;
            matrices.slice(0, maxM).forEach(function(mEntry) {
                var mId = mEntry[0], mIng = mEntry[1];
                var pathIngs = [{ id: mId, ing: mIng, role: 'base' }];
                
                mods.forEach(function(mod) {
                    pathIngs.push({ id: mod.entry[0], ing: mod.entry[1], role: 'modifier' });
                });
                
                // Titolo
                var outputType = guessOutputType(pathIngs.map(function(p){ return p.ing; }));
                var typeLabel = { film:'Film', gel:'Gel', rigido:'Composito', coating:'Coating' }[outputType] || 'Materiale';
                var names = pathIngs.map(function(p) {
                    var n = p.ing.nome.split('(')[0].trim();
                    if (n.length > 18) n = n.split(' ').slice(0,2).join(' ');
                    return n;
                });
                var title = typeLabel + ' ' + names.join(' + ');
                
                var diff = pathIngs.length <= 2 ? 'Facile' : (pathIngs.length <= 3 ? 'Medio' : 'Avanzato');
                
                allPaths.push({
                    title: title,
                    difficulty: diff,
                    ingredients: pathIngs,
                    note: bp.note,
                    ids: pathIngs.map(function(p){ return p.id; }),
                    score: score,
                    nIngs: pathIngs.length
                });
            });
        });
        
        // ██ Ordina: prima i più pertinenti, poi i più semplici ██
        allPaths.sort(function(a, b) { return b.score - a.score || a.nIngs - b.nIngs; });
        
        // ██ Deduplica per set ingredienti, max 6 percorsi ██
        var seen = {};
        var dedupAll = [];
        allPaths.forEach(function(p) {
            var key = p.ids.slice().sort().join('|');
            if (!seen[key]) {
                seen[key] = true;
                dedupAll.push(p);
            }
        });
        window._allPathsCount = dedupAll.length;
        var paths = dedupAll.slice(0, 6);
        
        if (paths.length === 0) {
            pathsDiv.style.display = 'none';
            return;
        }
        
        window._suggestedPaths = paths;
        pathsDiv.style.display = 'block';
        
        var html = '';
        paths.forEach(function(path, idx) {
            var diffCol = path.difficulty === 'Facile' ? '#4caf50' : (path.difficulty === 'Medio' ? '#ff9800' : '#e53935');
            html += '<div class="path-card">';
            html += '<div class="path-card-content">';
            html += '<div class="path-card-title">' + path.title;
            html += ' <span style="font-size:0.65rem;color:' + diffCol + ';font-weight:400;margin-left:0.4rem;">' + path.difficulty + '</span>';
            html += '</div>';
            if (path.note) {
                html += '<div style="font-size:0.67rem;color:#666;margin:0.15rem 0 0.3rem;font-style:italic;line-height:1.4;">' + path.note + '</div>';
            }
            html += '<div class="path-card-ings">';
            path.ingredients.forEach(function(p) {
                var cls = 'path-ing-chip';
                if (p.role !== 'base') cls += ' modifier';
                html += '<span class="' + cls + '">' + p.ing.nome + '</span>';
            });
            html += '</div>';
            html += '</div>';
            html += '<div class="path-card-actions">';
            html += '<button class="path-action-btn" onclick="showPathDetail(' + idx + ')" title="Dettagli percorso" style="font-size:0.7rem;font-weight:600;">i</button>';
            html += '<button class="path-action-btn add-btn" onclick="addPathToCart(' + idx + ')" title="Aggiungi tutti al carrello">+</button>';
            html += '</div>';
            html += '</div>';
        });
        // v89: nota percorsi nascosti
        if (window._allPathsCount > 6) {
            html += '<div style="text-align:center;font-size:0.7rem;color:#999;margin-top:0.5rem;padding:0.4rem;background:#f9f9f9;border-radius:6px;">';
            html += 'Mostrati 6 di ' + window._allPathsCount + ' percorsi possibili. Prova a modificare le proprieta per risultati diversi.';
            html += '</div>';
        }
        content.innerHTML = html;
    }
    
    // v72: Determina tipo output probabile per un set di ingredienti
    function guessOutputType(ingList) {
        const fams = ingList.map(i => i.famiglia);
        const hasPlast = fams.includes('PLASTIFICANTE');
        const hasLipide = fams.includes('LIPIDE');
        const hasRetic = fams.includes('SALE_RETICOLANTE');
        const hasCarica = fams.includes('CARICA');
        
        if (hasLipide && !hasPlast && !hasCarica) return 'coating';
        if (hasCarica || hasRetic) return 'rigido';
        if (hasPlast) return 'film';
        return 'gel';
    }
    
    // v89: Aggiungi ingredienti di un percorso al carrello
    function addPathToCart(pathIndex) {
        var paths = window._suggestedPaths;
        if (!paths || !paths[pathIndex]) return;
        var path = paths[pathIndex];
        var ings = INGREDIENTI_DATA?.ingredienti || {};
        var added = 0;
        path.ids.forEach(function(id) {
            if (ings[id] && !cart.find(function(c) { return c.id === id; })) {
                cart.push(Object.assign({}, ings[id], { id: id, informativo: false }));
                added++;
            }
        });
        if (added > 0) {
            updateCart();
            renderIngredientList();
            saveCartToStorage();
            showToast(added + ' ingredient' + (added > 1 ? 'i aggiunti' : 'e aggiunto') + ' al carrello', 'success');
        } else {
            showToast('Ingredienti già  nel carrello', 'info');
        }
    }

    // v89: Mostra dettagli percorso con possibilita di aggiungere singoli ingredienti
    function showPathDetail(pathIndex) {
        var paths = window._suggestedPaths;
        if (!paths || !paths[pathIndex]) return;
        var path = paths[pathIndex];
        var ings = INGREDIENTI_DATA?.ingredienti || {};
        
        var ingListHtml = '';
        path.ingredients.forEach(function(p) {
            var ing = p.ing;
            var id = path.ids[path.ingredients.indexOf(p)] || '';
            var roleLabel = p.role === 'base' ? 'Matrice' : (p.role === 'modifier' ? 'Modificatore' : p.role);
            var color = getCategoryColor(ing.famiglia || '');
            var inCart = cart.find(function(c) { return c.id === id; });
            
            ingListHtml += '<div style="display:flex;align-items:center;padding:0.5rem 0;border-bottom:1px solid #f0f0f0;">';
            ingListHtml += '<span style="width:10px;height:10px;border-radius:50%;background:' + color + ';margin-right:0.6rem;flex-shrink:0;"></span>';
            ingListHtml += '<div style="flex:1;">';
            ingListHtml += '<div style="font-size:0.8rem;font-weight:500;">' + ing.nome + '</div>';
            ingListHtml += '<div style="font-size:0.65rem;color:#888;">' + roleLabel + ' - ' + (ing.famiglia || '') + '</div>';
            if (ing.descrizione) {
                ingListHtml += '<div style="font-size:0.65rem;color:#666;margin-top:0.2rem;">' + ing.descrizione.substring(0, 120) + (ing.descrizione.length > 120 ? '...' : '') + '</div>';
            }
            ingListHtml += '</div>';
            if (!inCart) {
                ingListHtml += '<button onclick="addSinglePathIng(' + pathIndex + ',\'' + id + '\')" style="padding:0.25rem 0.5rem;font-size:0.65rem;background:#e8f5e9;color:#2e7d32;border:1px solid #a5d6a7;border-radius:4px;cursor:pointer;white-space:nowrap;">+ Aggiungi</button>';
            } else {
                ingListHtml += '<span style="font-size:0.65rem;color:#999;white-space:nowrap;">nel carrello</span>';
            }
            ingListHtml += '</div>';
        });
        
        var noteHtml = '';
        if (path.note) {
            noteHtml = '<div style="margin-top:0.8rem;padding:0.5rem;background:#fff8e1;border-radius:6px;border-left:3px solid #ffc107;font-size:0.72rem;color:#5d4037;line-height:1.5;">';
            noteHtml += '<strong>Nota:</strong> ' + path.note;
            noteHtml += '</div>';
        }
        
        // Modal
        document.querySelectorAll('.confirm-modal-overlay').forEach(function(m) { m.remove(); });
        var overlay = document.createElement('div');
        overlay.className = 'confirm-modal-overlay';
        overlay.innerHTML = 
            '<div class="confirm-modal" style="max-width:420px;">' +
                '<div class="confirm-modal-header">' + path.title + '</div>' +
                '<div class="confirm-modal-body" style="max-height:60vh;overflow-y:auto;">' +
                    '<div style="font-size:0.72rem;color:#666;margin-bottom:0.8rem;">Difficolta: <strong>' + path.difficulty + '</strong></div>' +
                    '<div style="font-size:0.75rem;font-weight:500;margin-bottom:0.4rem;">Ingredienti:</div>' +
                    ingListHtml +
                    noteHtml +
                '</div>' +
                '<div class="confirm-modal-actions">' +
                    '<button class="btn-confirm-cancel">Chiudi</button>' +
                    '<button class="btn-confirm-ok" onclick="addPathToCart(' + pathIndex + ');this.closest(\'.confirm-modal-overlay\').remove();">Aggiungi tutti</button>' +
                '</div>' +
            '</div>';
        
        document.body.appendChild(overlay);
        overlay.querySelector('.btn-confirm-cancel').onclick = function() { overlay.remove(); };
        overlay.onclick = function(e) { if (e.target === overlay) overlay.remove(); };
    }
    
    // v89: Aggiungi singolo ingrediente da percorso
    // v89: Scarica guida ingredienti multifase (PDF)
    function downloadGuidaMultifase() {
        window.open('data/files/guida_ingredienti_multifase.pdf', '_blank');
    }
    
        function addSinglePathIng(pathIndex, ingId) {
        var ings = INGREDIENTI_DATA?.ingredienti || {};
        var ing = ings[ingId];
        if (!ing) return;
        
        if (cart.find(function(c) { return c.id === ingId; })) {
            showToast(ing.nome + ' gia nel carrello', 'info');
            return;
        }
        
        cart.push(Object.assign({}, ing, { id: ingId, informativo: false }));
        updateCart();
        renderIngredientList();
        saveCartToStorage();
        showToast(ing.nome + ' aggiunto al carrello', 'success');
        
        // Refresh the detail modal to update button states
        showPathDetail(pathIndex);
    }

    // v73: Carica un percorso suggerito nel tavolo e vai a Tab C
    function tryPath(pathIndex) {
        const paths = window._suggestedPaths;
        if (!paths || !paths[pathIndex]) return;
        
        // Se tavolo ha ingredienti, chiedi conferma
        if (tavolo.length > 0) {
            showTryPathConfirm(pathIndex);
            return;
        }
        
        executeTryPath(pathIndex);
    }
    
    function showTryPathConfirm(pathIndex) {
        document.querySelectorAll('.confirm-modal-overlay').forEach(m => m.remove());
        
        const path = window._suggestedPaths[pathIndex];
        const ings = INGREDIENTI_DATA?.ingredienti || {};
        const pathNames = path.ids.map(id => ings[id] ? ings[id].nome : id).join(' + ');
        
        const overlay = document.createElement('div');
        overlay.className = 'confirm-modal-overlay';
        overlay.innerHTML = 
            '<div class="confirm-modal">' +
                '<div class="confirm-modal-header">Tavolo occupato</div>' +
                '<div class="confirm-modal-body">' +
                    'Hai ' + tavolo.length + ' ingredienti sul tavolo.<br><br>' +
                    'Vuoi caricare <strong>' + pathNames + '</strong>?' +
                '</div>' +
                '<div class="confirm-modal-actions" style="flex-wrap:wrap;gap:0.4rem;">' +
                    '<button class="btn-confirm-cancel">Annulla</button>' +
                    '<button class="btn-confirm-ok" style="background:#ff9800;" id="btnSaveReplace">Salva e sostituisci</button>' +
                    '<button class="btn-confirm-ok" id="btnReplace">Sostituisci</button>' +
                '</div>' +
            '</div>';
        
        document.body.appendChild(overlay);
        
        overlay.querySelector('.btn-confirm-cancel').onclick = function() { overlay.remove(); };
        
        overlay.querySelector('#btnSaveReplace').onclick = function() {
            overlay.remove();
            saveFormula();
            showToast('Formula salvata', 'success');
            setTimeout(function() { executeTryPath(pathIndex); }, 300);
        };
        
        overlay.querySelector('#btnReplace').onclick = function() {
            overlay.remove();
            executeTryPath(pathIndex);
        };
        
        overlay.onclick = function(e) {
            if (e.target === overlay) overlay.remove();
        };
    }
    
    function executeTryPath(pathIndex) {
        const paths = window._suggestedPaths;
        if (!paths || !paths[pathIndex]) return;
        
        const path = paths[pathIndex];
        const ings = INGREDIENTI_DATA?.ingredienti || {};
        
        // Svuota tavolo
        tavolo.length = 0;
        formulaSelection.clear();
        customDosages = {};
        window._editingFormulaId = null; window._editingFormulaName = null; // v75
        
        // Aggiungi ingredienti del percorso
        let names = [];
        path.ids.forEach(function(id) {
            if (ings[id] && !tavolo.includes(id)) {
                tavolo.push(id);
                formulaSelection.add(id);
                names.push(ings[id].nome);
            }
        });
        
        // updateTavolo fa gia checkCompatibility + calculateMaterial + calculateFormula
        updateTavolo();
        saveCartToStorage();
        switchTab('C');
        
        showToast('Percorso caricato: ' + names.join(' + '), 'success');
    }
    
    function loadMaterialInProject(matNome) {
        // Cerca il materiale nel catalogo
        const outputs = CATALOGO_DATA?.outputs || {};
        let mat = null;
        
        for (const [outputType, outputData] of Object.entries(outputs)) {
            const found = outputData.documentati?.find(m => m.nome === matNome);
            if (found) {
                mat = {...found, output: outputType};
                break;
            }
        }
        
        if (!mat || !mat.ingredienti || mat.ingredienti.length === 0) {
            showToast('Materiale non trovato', 'error');
            return;
        }
        
        // Mostra preview invece di aggiungere direttamente
        showMaterialPreview(mat);
    }
    
    function showMaterialPreview(mat) {
        const ings = INGREDIENTI_DATA?.ingredienti || {};
        
        // Costruisci lista ingredienti con dettagli
        let ingList = '';
        mat.ingredienti.forEach(ingId => {
            const ing = ings[ingId];
            const inCart = cart.find(c => c.id === ingId);
            const name = ing ? ing.nome : ingId;
            const famiglia = ing ? ing.famiglia : 'sconosciuto';
            const color = getCategoryColor(famiglia);
            const status = inCart ? ' (gia nel carrello)' : '';
            ingList += '<div style="display:flex;align-items:center;padding:0.4rem 0;border-bottom:1px solid #eee;">' +
                '<span style="width:10px;height:10px;border-radius:50%;background:' + color + ';margin-right:0.6rem;"></span>' +
                '<span style="flex:1;">' + name + '</span>' +
                '<span style="font-size:0.7rem;color:#888;">' + famiglia + status + '</span>' +
            '</div>';
        });
        
        // v89: Dosaggi testati se disponibili
        let dosaggiHtml = '';
        if (mat.ingredienti_descrizione) {
            dosaggiHtml = '<div style="margin-bottom:1rem;padding:0.6rem;background:#fff8e1;border-radius:6px;border-left:3px solid #ffc107;">' +
                '<div style="font-size:0.7rem;font-weight:600;color:#f57f17;margin-bottom:0.3rem;">DOSAGGI TESTATI:</div>' +
                '<div style="font-size:0.75rem;color:#5d4037;line-height:1.5;">' + mat.ingredienti_descrizione + '</div>' +
            '</div>';
        }
        
        const content = `
            <div style="margin-bottom:1rem;">
                <div style="font-size:0.8rem;color:#666;margin-bottom:0.3rem;">Tipo: ${mat.output}</div>
                <div style="font-size:0.75rem;color:#888;">${mat.subtitle || ''}</div>
            </div>
            ${dosaggiHtml}
            <div style="font-size:0.8rem;font-weight:500;margin-bottom:0.5rem;">Ingredienti (${mat.ingredienti.length}):</div>
            <div style="max-height:200px;overflow-y:auto;margin-bottom:1rem;">${ingList}</div>
        `;
        
        showMaterialActionModal(mat.nome, content, mat);
    }
    
    function showMaterialActionModal(title, content, mat) {
        // Rimuovi modal precedenti
        document.querySelectorAll('.confirm-modal-overlay').forEach(m => m.remove());
        
        const overlay = document.createElement('div');
        overlay.className = 'confirm-modal-overlay';
        overlay.innerHTML = `
            <div class="confirm-modal" style="max-width:450px;">
                <div class="confirm-modal-header">${title}</div>
                <div class="confirm-modal-body">${content}</div>
                <div class="confirm-modal-actions" style="flex-wrap:wrap;gap:0.5rem;">
                    <button class="btn-confirm-cancel">Chiudi</button>
                    <button class="btn-confirm-secondary">Aggiungi al carrello</button>
                    <button class="btn-confirm-ok">Aggiungi e vai al Lab</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(overlay);
        
        // Chiudi
        overlay.querySelector('.btn-confirm-cancel').onclick = () => overlay.remove();
        
        // Aggiungi al carrello
        overlay.querySelector('.btn-confirm-secondary').onclick = () => {
            addMaterialToCart(mat, false);
            overlay.remove();
        };
        
        // Aggiungi e vai al Lab
        overlay.querySelector('.btn-confirm-ok').onclick = () => {
            addMaterialToCart(mat, true);
            overlay.remove();
        };
        
        // Click su overlay chiude
        overlay.onclick = (e) => { if (e.target === overlay) overlay.remove(); };
    }
    
    function addMaterialToCart(mat, goToLab) {
        const ings = INGREDIENTI_DATA?.ingredienti || {};
        let added = 0;
        
        mat.ingredienti.forEach(ingId => {
            const ing = ings[ingId];
            if (ing && !cart.find(c => c.id === ingId)) {
                cart.push({...ing, id: ingId, informativo: false});
                added++;
            }
        });
        
        if (added > 0) {
            updateCart();
            showToast(mat.nome + ': ' + added + ' ingredienti aggiunti', 'success');
            if (goToLab) {
                setTimeout(() => switchTab('C'), 300);
            }
        } else {
            showToast('Ingredienti gia nel carrello', 'info');
        }
    }

    function switchTab(tab) {
        // v90: Aggiorna classe body per gestire overflow
        document.body.className = document.body.className.replace(/tab-[A-Z]-active/g, '').trim();
        document.body.classList.add('tab-' + tab + '-active');
        
        document.querySelectorAll('.tab').forEach((t, i) => {
            t.classList.toggle('active', ['P','A','B','C','D'][i] === tab);
        });
        document.querySelectorAll('.panel-container').forEach(p => {
            p.classList.toggle('active', p.id === 'panel-' + tab);
        });
        // Init Tab specifiche
        if (tab === 'B') renderIngredientList();
        if (tab === 'C') setTimeout(() => updateTavolo(), 50);
        if (tab === 'P') updateProjectResults();
        if (tab === 'D') tabD_init();
        updateCartButton();
        mobileUpdateFab();
    }
    
    function showPanel(id) { switchTab(id); }

    // ESC chiude modal
    document.addEventListener('keydown', e => { if (e.key === 'Escape') { closeModal(); tabD_closeSolModal(); } });

    // INIT
    // v77: Welcome onboarding modal
    function showWelcome(force) {
        document.getElementById('welcomeOverlay').classList.remove('hidden');
        document.getElementById('welcomeOverlay').style.opacity = '';
        document.getElementById('welcomeOverlay').style.transition = '';
        // v81: Reset alla vista card
        toggleWelcomeGuide(false);
    }
    
    function dismissWelcome() {
        const overlay = document.getElementById('welcomeOverlay');
        overlay.style.opacity = '0';
        overlay.style.transition = 'opacity 0.3s ease';
        setTimeout(() => overlay.classList.add('hidden'), 300);
    }
    
    function welcomeGoTo(tab) {
        dismissWelcome();
        setTimeout(() => switchTab(tab), 100);
    }

    // v81: Toggle tra cards e guida nel welcome
    function toggleWelcomeGuide(show) {
        var grid = document.querySelector('.welcome-grid');
        var link = document.getElementById('welcomeGuideLink');
        var guide = document.getElementById('welcomeGuide');
        if (!grid || !guide) return;
        if (show) {
            grid.style.display = 'none';
            link.style.display = 'none';
            guide.classList.add('visible');
        } else {
            grid.style.display = '';
            link.style.display = '';
            guide.classList.remove('visible');
        }
    }
    
    // Click su overlay chiude (ma non su modal)
    document.getElementById('welcomeOverlay')?.addEventListener('click', function(e) {
        if (e.target === this) dismissWelcome();
    });
    
    // ESC chiude welcome
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && !document.getElementById('welcomeOverlay').classList.contains('hidden')) {
            dismissWelcome();
        }
    });


    // =============================================================
    //  TAB D — PROBLEMI E SOLUZIONI (v90)
    //  Troubleshooting diagnostico con tavolo locale a 3 stati
    // =============================================================

    // ── DATA: 20 PROBLEMI ──
    const PROBLEMI = [
    // -- GRUPPO 1: ESSICCAZIONE --
    {
        id: 'crepe', gruppo: 'essiccazione', iconLabel: 'P01',
        titolo: 'Crepe durante l\'essiccazione',
        sottotitolo: 'Fessure che partono dai bordi o dal centro',
        gravita: 4, risolvibilita: 4,
        sintomo: 'Fessure che compaiono durante l\'asciugatura, partendo dai bordi o propagandosi dal centro verso l\'esterno.',
        causa: 'L\'acqua evapora più velocemente dalla superficie che dall\'interno. La "pelle" esterna si irrigidisce e contrae mentre il nucleo è ancora umido, generando tensioni interne che superano la resistenza del materiale → frattura. In letteratura: "drying stress cracking".',
        famiglie_rischio: ['PROTEINA','POLISACCARIDE_NEUTRO','POLISACCARIDE_ANIONICO'],
        ingredienti_rischio: ['gelatina','agar','amido_mais','amido_patata','caseina'],
        condizioni: ['spessore >3mm','ventilazione diretta','bassa umidità ambientale','assenza plastificante'],
        soluzioni: [
            { nome: 'Essiccazione lenta', desc: 'Coprire con carta (non plastica), ambiente non ventilato direttamente', pro: 'Semplice, zero costi', con: 'Tempi lunghi, rischio muffe', efficacia: 3, diff: 'Facile', link: 'muffe' },
            { nome: 'Più plastificante', desc: 'Aggiungere 10-15% glicerina sul peso della matrice', pro: 'Molto efficace, standard', con: 'Troppa → appiccicoso', efficacia: 3, diff: 'Facile', link: 'appiccicoso' },
            { nome: 'Spessore ridotto', desc: 'Versare film da 1-2mm massimo', pro: 'Elimina il problema alla radice', con: 'Limita le forme possibili', efficacia: 3, diff: 'Facile' },
            { nome: 'Essiccazione a fasi', desc: '24h coperto → 24h scoperto → 24h in ambiente secco', pro: 'Risultati professionali', con: 'Richiede pianificazione', efficacia: 3, diff: 'Medio' },
            { nome: 'Umidificazione ambiente', desc: 'Ciotola d\'acqua vicino al campione, o essiccare in bagno', pro: 'Improvvisabile', con: 'Tempi molto lunghi', efficacia: 2, diff: 'Facile' },
        ],
        studenti: [
            { testo: 'Un\'asciugatura non uniforme causa screpolature', materiale: 'CASEINA ESPANSA' },
            { testo: 'Molto fragile quando viene staccato dalla superficie', materiale: 'Pectina Elastica' },
            { testo: 'Dopo la formatura si verificano ritiro e deformazione', materiale: 'Amido Mais Bioplastica' },
        ],
        nota_sci: 'Alcune crepe sottili possono diventare texture interessante — nella ceramica giapponese il kintsugi trasforma le crepe in decorazione. Valutarle esteticamente prima di scartare il campione.',
    },
    {
        id: 'ritiro', gruppo: 'essiccazione', iconLabel: 'P02',
        titolo: 'Ritiro eccessivo e deformazione',
        sottotitolo: 'Restringimento, bordi sollevati, curling',
        gravita: 3, risolvibilita: 3,
        sintomo: 'Il campione si è ristretto molto (30-50%), bordi sollevati, forma distorta, bordi che si arricciano verso l\'alto (curling).',
        causa: 'L\'acqua costituisce 70-95% del volume iniziale — il ritiro è inevitabile. Diventa problematico quando è asimmetrico: la superficie a contatto con l\'aria asciuga prima di quella sullo stampo → il campione si incurva verso il lato che asciuga per primo. In letteratura: "differential shrinkage".',
        famiglie_rischio: ['POLISACCARIDE_NEUTRO','PROTEINA','POLISACCARIDE_ANIONICO'],
        ingredienti_rischio: ['agar','amido_mais','amido_patata','amido_tapioca','gelatina'],
        condizioni: ['film sottili','miscele molto diluite','assenza cariche'],
        soluzioni: [
            { nome: 'Sovradimensionare', desc: 'Fare campioni 30-50% più grandi del target finale', pro: 'Semplice, prevedibile', con: 'Serve esperienza per stimare', efficacia: 2, diff: 'Facile' },
            { nome: 'Fissare i bordi', desc: 'Nastro adesivo, pesi, o cornice durante essiccazione', pro: 'Previene curling', con: 'Possibili segni sui bordi', efficacia: 3, diff: 'Facile' },
            { nome: 'Aggiungere cariche', desc: 'Fondi caffè, farine, fibre (10-20% del totale)', pro: 'Riduce ritiro 30-40% + rinforza', con: 'Opacizza il materiale', efficacia: 3, diff: 'Facile' },
            { nome: 'Essiccare tra piani', desc: 'Campione tra due superfici piane con peso sopra', pro: 'Previene warping', con: 'Solo per lastre, rallenta', efficacia: 3, diff: 'Medio' },
            { nome: 'Girare il campione', desc: 'Capovolgere ogni 12h durante essiccazione', pro: 'Equalizza ritiro tra le facce', con: 'Campione delicato da maneggiare', efficacia: 2, diff: 'Facile' },
            { nome: 'Essiccazione su rete', desc: 'Griglia o rete che permette aria da entrambi i lati', pro: 'Ritiro uniforme, professionale', con: 'Serve supporto permeabile', efficacia: 3, diff: 'Medio' },
        ],
        studenti: [
            { testo: 'Forma cambia notevolmente dopo l\'essiccazione', materiale: 'Agar trasparente rigido' },
            { testo: 'Necessario appesantirlo per evitare deformazioni', materiale: 'Caseina+Fibra Lino' },
            { testo: 'Si è ridotto molto e asciugato velocemente', materiale: 'Agar+Fondi caffè composito' },
        ],
        nota_sci: 'Il ritiro degli amidi è proporzionale al contenuto di amilosio: mais > patata > tapioca. Le fibre di cellulosa riducono il ritiro del 30-40% (Rhim et al., 2013). L\'aggiunta di nanoargilla (1-5%) riduce ritiro e migliora la barriera ai gas.',
    },
    {
        id: 'appiccicoso', gruppo: 'essiccazione', iconLabel: 'P03',
        titolo: 'Materiale appiccicoso / non asciuga',
        sottotitolo: 'Resta umido, attira polvere, non si stacca',
        gravita: 3, risolvibilita: 4,
        sintomo: 'Dopo giorni il materiale resta appiccicoso al tatto, non si stacca, attira polvere e lascia impronte.',
        causa: 'La glicerina è igroscopica — assorbe acqua dall\'aria. Più glicerina c\'è, più il materiale resta umido indefinitamente. In ambienti umidi (>60% RH) il problema peggiora. Il rapporto critico glicerina/matrice è circa 40%: oltre, la Tg scende sotto la temperatura ambiente e il materiale non raggiunge mai uno stato stabile.',
        famiglie_rischio: ['PLASTIFICANTE'],
        ingredienti_rischio: ['glicerina','sorbitolo'],
        condizioni: ['plastificante >35% del totale','umidità ambientale >60%'],
        soluzioni: [
            { nome: 'Ridurre plastificante', desc: 'Rapporto plastificante/matrice massimo 30-40%', pro: 'Elimina la causa', con: 'Rischio fragilità', efficacia: 3, diff: 'Facile', link: 'fragile' },
            { nome: 'Sostituire con sorbitolo', desc: 'Stessa funzione della glicerina, meno igroscopico', pro: 'Più stabile nel tempo', con: 'Leggermente meno flessibile', efficacia: 3, diff: 'Facile' },
            { nome: 'Ambiente secco', desc: 'Essiccare con riscaldamento acceso, bustine di silica gel', pro: 'Semplice', con: 'Stagionale, non sempre possibile', efficacia: 2, diff: 'Facile' },
            { nome: 'Amido di superficie', desc: 'Spolverare con amido di mais o talco alimentare', pro: 'Elimina appiccicosità tattile', con: 'Cambia aspetto (opacizza)', efficacia: 2, diff: 'Facile' },
            { nome: 'Reticolazione', desc: 'Bagno in CaCl2 (alginato/pectina LM) o tannini (proteine)', pro: 'Stabilizza permanentemente', con: 'Irreversibile, cambia proprietà', efficacia: 3, diff: 'Avanzato' },
        ],
        studenti: [
            { testo: 'Proporzioni da rivedere', materiale: 'Amido tapioca flessibile' },
        ],
        nota_sci: 'Il sorbitolo ha temperatura di transizione vetrosa (Tg) più alta della glicerina → film meno appiccicosi a parità di flessibilità (Cazón et al., 2017). Per applicazioni che devono resistere all\'umidità, valutare la reticolazione chimica come alternativa all\'eccesso di plastificante.',
    },
    // -- GRUPPO 2: MECCANICA --
    {
        id: 'fragile', gruppo: 'meccanica', iconLabel: 'P04',
        titolo: 'Materiale troppo fragile',
        sottotitolo: 'Si rompe, si sbriciola, non si piega',
        gravita: 4, risolvibilita: 4,
        sintomo: 'Si rompe maneggiandolo, si sbriciola, non si piega. Si frattura lungo linee nette o si polverizza.',
        causa: 'Manca plastificante, oppure matrice troppo concentrata, oppure essiccazione troppo aggressiva che ha rimosso tutta l\'acqua residua (che fungeva da plastificante naturale). Le catene polimeriche sono troppo rigide e ordinate → zero capacità di deformazione prima della frattura.',
        famiglie_rischio: ['PROTEINA','POLISACCARIDE_NEUTRO'],
        ingredienti_rischio: ['caseina','agar','amido_mais'],
        condizioni: ['assenza plastificante','matrice >70% senza modificatori','essiccazione aggressiva'],
        soluzioni: [
            { nome: 'Aggiungere plastificante', desc: '10-20% glicerina o sorbitolo sul peso della matrice', pro: 'Standard, molto efficace', con: 'Può rendere appiccicoso', efficacia: 3, diff: 'Facile', link: 'appiccicoso' },
            { nome: 'Ridurre concentrazione', desc: 'Più acqua nella miscela iniziale → film più sottile', pro: 'Film naturalmente più flessibile', con: 'Più ritiro, tempi più lunghi', efficacia: 2, diff: 'Facile' },
            { nome: 'Aggiungere fibre', desc: '5-10% fibre di lino, cotone, cellulosa', pro: 'Rinforza senza irrigidire eccessivamente', con: 'Opacizza', efficacia: 3, diff: 'Facile' },
            { nome: 'Reidratare', desc: 'Nebulizzare acqua o tenere in ambiente umido', pro: 'Può recuperare parzialmente', con: 'Temporaneo, torna fragile', efficacia: 1, diff: 'Facile' },
            { nome: 'Cambiare matrice', desc: 'Gelatina più flessibile di agar; patata più di mais', pro: 'Soluzione strutturale', con: 'Cambia tutto il materiale', efficacia: 3, diff: 'Facile' },
            { nome: 'Laminare su tessuto', desc: 'Applicare su garza, TNT o tessuto sottile', pro: 'Struttura composita flessibile', con: 'Più complesso, cambia estetica', efficacia: 3, diff: 'Medio' },
        ],
        studenti: [
            { testo: 'Molto difficile, troppo fragile', materiale: 'Caseina plastica dura' },
            { testo: 'Se non compattato bene si sbriciola', materiale: 'Biocomposito caseina+feltro' },
            { testo: 'Simile a un biscotto, si frattura e sbriciola', materiale: 'Gelatina+Tannini Cuoio' },
            { testo: 'Tende a creparsi e perdere polvere', materiale: 'Gusci d\'uovo+gelatina' },
            { testo: 'Bioplastica troppo fragile, resistenza meccanica bassa', materiale: 'Amido Mais Bioplastica' },
        ],
        nota_sci: 'La fragilità degli amidi peggiora nel tempo per retrogradazione: le catene di amilosio ri-cristallizzano progressivamente, rendendo il materiale sempre più rigido. È lo stesso processo che rende il pane raffermo. I plastificanti rallentano ma non eliminano questo fenomeno.',
    },
    {
        id: 'schiuma_collassa', gruppo: 'meccanica', iconLabel: 'P05',
        titolo: 'Schiuma che collassa',
        sottotitolo: 'Perde volume, si appiattisce, diventa densa',
        gravita: 4, risolvibilita: 2,
        sintomo: 'La schiuma inizialmente soffice e voluminosa perde volume nelle ore/giorni successivi, si appiattisce e diventa densa e compatta.',
        causa: 'Le bolle d\'aria nella matrice sono instabili. La gravità spinge il liquido verso il basso (drenaggio), le pareti tra bolle si assottigliano e cedono (coalescenza), il gas diffonde dalle bolle piccole a quelle grandi (maturazione di Ostwald). Se la matrice non gelifica abbastanza velocemente da "congelare" la struttura porosa, la schiuma collassa inevitabilmente.',
        famiglie_rischio: ['PROTEINA','ADDITIVO'],
        ingredienti_rischio: ['albumina','gelatina','bicarbonato','aquafaba'],
        condizioni: ['areazione meccanica','gelificazione lenta','temperatura ambiente troppo alta'],
        soluzioni: [
            { nome: 'Gelificazione rapida', desc: 'Versare in stampo freddo, o aggiungere gelificante rapido', pro: 'Congela la struttura prima del collasso', con: 'Meno tempo per lavorare', efficacia: 3, diff: 'Medio' },
            { nome: 'Stabilizzante schiuma', desc: '0.5-1% xantano o metilcellulosa nella miscela', pro: 'Aumenta viscosità, rallenta drenaggio', con: 'Ingrediente aggiuntivo', efficacia: 2, diff: 'Medio' },
            { nome: 'Areazione a freddo', desc: 'Montare gelatina a 40-50°C poi versare subito in stampo freddo', pro: 'Gelifica in minuti', con: 'Solo per matrici termoreversibili', efficacia: 3, diff: 'Medio' },
            { nome: 'Reticolazione immediata', desc: 'Spray di CaCl2 su schiuma di alginato', pro: 'Fissa istantaneamente la struttura', con: 'Solo per polisaccaridi anionici', efficacia: 3, diff: 'Avanzato' },
            { nome: 'Liofilizzazione', desc: 'Congelare il gel poi sublimare l\'acqua sotto vuoto', pro: 'Struttura porosa perfetta, permanente', con: 'Richiede attrezzatura specifica', efficacia: 3, diff: 'Avanzato' },
        ],
        studenti: [
            { testo: 'Ricetta non totalmente valida', materiale: 'Gelatina spugnosa areata' },
            { testo: 'Difficile che si solidifichi quando si forma la pellicola finale', materiale: 'Albumina Antibatterica' },
        ],
        nota_sci: 'La stabilità delle schiume proteiche dipende dalla capacità della proteina di formare film interfacciali robusti alle pareti delle bolle. L\'albumina d\'uovo forma i film migliori (denaturazione >60°C), la gelatina è instabile a caldo ma si stabilizza raffreddando. Il metodo più affidabile per schiume biomateriali permanenti è la liofilizzazione di idrogeli congelati.',
    },
    {
        id: 'delaminazione', gruppo: 'meccanica', iconLabel: 'P06',
        titolo: 'Delaminazione e sfaldamento',
        sottotitolo: 'Si separa in strati, si sfoglia, perde polvere',
        gravita: 3, risolvibilita: 3,
        sintomo: 'Il materiale si separa in strati, le superfici si sfogliano, i compositi perdono polvere o particelle dalla superficie.',
        causa: 'Scarsa adesione tra fasi diverse. Nei compositi: la carica non è compatibile chimicamente con la matrice, o le particelle sono troppo grandi. Nei multilayer: le interfacce non hanno aderito (tempi di gelificazione diversi). Anche l\'essiccazione non uniforme crea gradienti di densità che favoriscono la separazione.',
        famiglie_rischio: ['CARICA'],
        ingredienti_rischio: ['gusci_uovo','caolino','gesso','segatura','pula_riso'],
        condizioni: ['carica >30% del totale','particelle grossolane','fibre non trattate'],
        soluzioni: [
            { nome: 'Macinare più fine', desc: 'Cariche sotto 100μm (polvere impalpabile)', pro: 'Migliora adesione matrice-carica', con: 'Richiede macinazione', efficacia: 3, diff: 'Medio' },
            { nome: 'Bagnare le fibre prima', desc: 'Immergere fibre nella soluzione di matrice prima dell\'assemblaggio', pro: 'Migliora l\'interfaccia', con: 'Passo aggiuntivo', efficacia: 3, diff: 'Facile' },
            { nome: 'Pressatura con peso', desc: 'Comprimere durante essiccazione con peso e calore moderato', pro: 'Elimina vuoti, consolida', con: 'Solo per lastre e pannelli', efficacia: 3, diff: 'Medio' },
            { nome: 'Ridurre % carica', desc: 'Restare sotto il 25-30% del totale', pro: 'Meno rischio sfaldamento', con: 'Meno rinforzo, meno effetto estetico', efficacia: 2, diff: 'Facile' },
            { nome: 'Emulsionante', desc: 'Lecitina 1-2% per sistemi con fasi grasse e acquose', pro: 'Ponte chimico olio-acqua', con: 'Cambia leggermente le proprietà', efficacia: 2, diff: 'Medio' },
        ],
        studenti: [
            { testo: 'Tende a perdere polvere', materiale: 'Gusci d\'uovo+gelatina' },
            { testo: 'Suono crepitante prima di frantumarsi', materiale: 'Resina pino+Segatura' },
        ],
        nota_sci: 'L\'adesione nei biocompositi migliora con il trattamento superficiale delle cariche. Un semplice lavaggio alcalino (NaOH 5%) delle fibre naturali rimuove cere e pectine superficiali, migliorando l\'adesione matrice-fibra del 30-50%.',
    },
    // -- GRUPPO 3: BIOLOGICI --
    {
        id: 'muffe', gruppo: 'biologici', iconLabel: 'P07',
        titolo: 'Muffe',
        sottotitolo: 'Macchie verdi, nere, bianche. Odore di cantina',
        gravita: 4, risolvibilita: 3,
        sintomo: 'Macchie verdi, nere o bianche pelose sulla superficie. Odore di cantina o di marcio.',
        causa: 'I biomateriali sono cibo per i funghi. Servono quattro condizioni: umidità (>65% RH), temperatura (18-28°C), nutrimento (zuccheri, proteine) e tempo. Tutte presenti in laboratorio. I materiali con scarti organici freschi (fondi caffè, bucce, pula) sono i più vulnerabili: aggiungono nutrienti fermentescibili.',
        famiglie_rischio: ['PROTEINA','POLISACCARIDE_NEUTRO','CARICA'],
        ingredienti_rischio: ['fondi_caffe','pula_riso','bucce_agrumi','segatura','gelatina','amido_mais','amido_patata'],
        condizioni: ['essiccazione lenta','scarti organici freschi','ambiente caldo-umido','assenza antimicrobico'],
        soluzioni: [
            { nome: 'Essiccazione rapida', desc: 'Portare sotto il 15% di umidità residua, ambiente ventilato', pro: 'Elimina condizione necessaria', con: 'Rischio crepe se troppo veloce', efficacia: 3, diff: 'Facile', link: 'crepe' },
            { nome: 'Acido citrico/aceto', desc: '2-5% nella miscela, abbassa pH sotto 4.5', pro: 'Antimicrobico naturale, economico', con: 'Odore (aceto), può cambiare pH-sensibili', efficacia: 3, diff: 'Facile' },
            { nome: 'Oli essenziali', desc: 'Tea tree, chiodi di garofano, timo: 0.5-1%', pro: 'Antimicotici potenti, profumati', con: 'Costosi, possono macchiare', efficacia: 3, diff: 'Facile' },
            { nome: 'Curcuma', desc: '1-3% nella miscela', pro: 'Antimicotico + colorante naturale', con: 'Colora di giallo, fotosensibile', efficacia: 2, diff: 'Facile' },
            { nome: 'Chitosano', desc: 'Come matrice o aggiunto al 5-10%', pro: 'Antimicrobico naturale e duraturo', con: 'Costoso, leggermente giallastro', efficacia: 3, diff: 'Medio' },
            { nome: 'Pre-essiccare gli scarti', desc: 'Forno 80°C per 30min prima di incorporare nella miscela', pro: 'Elimina umidità e spore residue', con: 'Passo aggiuntivo, cambia proprietà', efficacia: 2, diff: 'Facile' },
        ],
        studenti: [
            { testo: 'Dopo 3 giorni ha iniziato ad ammuffire, dopo 7 forte odore', materiale: 'Agar+Pula Riso Pannello' },
            { testo: 'Soggetto a muffe, forma cambia notevolmente', materiale: 'Agar trasparente rigido' },
            { testo: 'Muffa dopo qualche giorno in acqua', materiale: 'Amido+Bucce Agrumi' },
            { testo: 'Muffa nelle zone più spesse (fatica ad asciugare)', materiale: 'Amido tapioca flessibile' },
            { testo: 'Nessun cattivo odore dopo 2 settimane → il chitosano protegge', materiale: 'Chitosano film rigido' },
        ],
        nota_sci: 'La muffa è la prova che il materiale è biodegradabile. Non è un fallimento della formulazione, è una conferma delle sue qualità ecologiche. Il problema è di conservazione, non di composizione.',
    },
    {
        id: 'odore', gruppo: 'biologici', iconLabel: 'P08',
        titolo: 'Odore sgradevole',
        sottotitolo: 'Odore acido, animale, di marcio, di fermentazione',
        gravita: 2, risolvibilita: 3,
        sintomo: 'Odore persistente: acido (caseina+aceto), animale (gelatina), di marcio (decomposizione), di fermentazione (scarti).',
        causa: 'Ogni matrice ha un odore intrinseco. La gelatina è letteralmente colla animale. La caseina con aceto odora di formaggio acido. Gli scarti organici possono fermentare. Se l\'odore è di marcio → decomposizione batterica in corso, non solo odore.',
        famiglie_rischio: ['PROTEINA','CARICA'],
        ingredienti_rischio: ['gelatina','caseina','aceto','fondi_caffe','pula_riso','bucce_agrumi'],
        condizioni: ['matrice proteica','scarti organici','essiccazione incompleta'],
        soluzioni: [
            { nome: 'Essiccazione completa', desc: 'L\'odore si attenua molto quando il materiale è completamente asciutto', pro: 'Naturale, nessun intervento', con: 'Serve tempo', efficacia: 2, diff: 'Facile' },
            { nome: 'Oli essenziali', desc: 'Lavanda, limone, menta: 0.5-1% nella miscela', pro: 'Copre/sostituisce l\'odore', con: 'Non elimina la causa', efficacia: 2, diff: 'Facile' },
            { nome: 'Acido citrico al posto dell\'aceto', desc: 'Stessa funzione acidificante, molto meno odore', pro: 'Elimina odore acido alla fonte', con: 'Leggermente diverso chimicamente', efficacia: 3, diff: 'Facile' },
            { nome: 'Tannini', desc: '3-5% nella miscela proteica', pro: 'Fissano le proteine, riducono odore', con: 'Scuriscono il materiale', efficacia: 2, diff: 'Medio' },
        ],
        studenti: [
            { testo: 'Dopo 7 giorni forte odore', materiale: 'Agar+Pula Riso Pannello' },
        ],
    },
    // -- GRUPPO 4: PROCESSO --
    {
        id: 'non_gelifica', gruppo: 'processo', iconLabel: 'P09',
        titolo: 'Non gelifica / resta liquido',
        sottotitolo: 'Miscela ancora liquida dopo ore nello stampo',
        gravita: 5, risolvibilita: 4,
        sintomo: 'La miscela resta liquida nello stampo dopo il tempo previsto per la gelificazione.',
        causa: 'Ogni matrice ha una condizione specifica per gelificare. Se non viene rispettata, resta liquida.',
        famiglie_rischio: ['PROTEINA','POLISACCARIDE_NEUTRO','POLISACCARIDE_ANIONICO'],
        ingredienti_rischio: ['gelatina','agar','alginato','amido_mais','amido_patata','carragenina','pectina'],
        condizioni: [],
        is_matrix_guide: true,
        matrix_guide: [
            { matrice: 'Gelatina', problema: 'Troppo caldo (>25-30°C)', soluzione: 'Mettere in frigo. Se non gelifica in 2-3h → troppo diluita' },
            { matrice: 'Agar', problema: 'Non ha raggiunto ebollizione', soluzione: 'DEVE bollire 2-3 min. Riscaldare. Gelifica sotto 35°C' },
            { matrice: 'Alginato', problema: 'Manca calcio, o CaCl2 miscelato insieme', soluzione: 'CaCl2 va aggiunto DOPO: spray, bagno, strato. Se miscelato → grumi' },
            { matrice: 'Amido', problema: 'Non cotto abbastanza', soluzione: 'Deve diventare traslucido e denso. Se bianco → continuare a cuocere' },
            { matrice: 'Pectina HM', problema: 'Manca zucchero o acido', soluzione: 'Serve >55% zucchero + pH <3.5' },
            { matrice: 'Pectina LM', problema: 'Manca calcio', soluzione: 'Come alginato: serve CaCl2 per reticolare' },
            { matrice: 'Carragenina', problema: 'Tipo sbagliato o troppo diluita', soluzione: 'Lambda non gelifica mai. Kappa serve >0.5%' },
        ],
        soluzioni: [],
        studenti: [
            { testo: 'Temperatura deve essere attentamente controllata, altrimenti non solidifica', materiale: 'Carragenina gel elastico' },
            { testo: 'Difficile da controllare la temperatura, difficile che si solidifichi', materiale: 'Albumina Antibatterica' },
        ],
    },
    {
        id: 'bolle', gruppo: 'processo', iconLabel: 'P10',
        titolo: 'Bolle d\'aria intrappolate',
        sottotitolo: 'Bolle, buchi, superficie a "cratere lunare"',
        gravita: 2, risolvibilita: 4,
        sintomo: 'Bolle visibili nel materiale, buchi in superficie, texture irregolare tipo "cratere lunare".',
        causa: 'Aria incorporata durante miscelazione vigorosa e non eliminata prima del versamento nello stampo. Le miscele dense (alginato viscoso) e le polveri fini (spirulina, curcuma) intrappolano microbolle particolarmente tenaci.',
        famiglie_rischio: ['POLISACCARIDE_ANIONICO','COLORANTE','ADDITIVO'],
        ingredienti_rischio: ['alginato','spirulina','albumina','bicarbonato','curcuma'],
        condizioni: ['miscelazione vigorosa','polveri non pre-disperse','miscele dense'],
        soluzioni: [
            { nome: 'Mescolare lentamente', desc: 'Movimenti circolari con cucchiaio, non frusta', pro: 'Previene il problema alla fonte', con: 'Più tempo, possibile meno omogeneo', efficacia: 3, diff: 'Facile' },
            { nome: 'Riposo pre-versamento', desc: '5-15 minuti dopo miscelazione: le bolle salgono', pro: 'Le bolle escono da sole', con: 'Serve tempo, miscela può iniziare a gelificare', efficacia: 3, diff: 'Facile' },
            { nome: 'Versare da basso', desc: 'Tenere contenitore vicino allo stampo, versare lentamente', pro: 'Meno turbolenza', con: 'Serve pratica', efficacia: 2, diff: 'Facile' },
            { nome: 'Picchiettare lo stampo', desc: 'Battere delicatamente sul tavolo dopo il versamento', pro: 'Fa salire le bolle superficiali', con: 'Solo bolle vicine alla superficie', efficacia: 2, diff: 'Facile' },
            { nome: 'Pre-dispersione polveri', desc: 'Sciogliere spirulina/curcuma in poca acqua calda (fare una "pasta") prima', pro: 'Elimina microbolle intrappolate nelle polveri', con: 'Passo aggiuntivo', efficacia: 3, diff: 'Facile' },
        ],
        studenti: [
            { testo: 'L\'aggiunta di spirulina ha prodotto un gran numero di bolle', materiale: 'Gelatina colorata naturale' },
            { testo: 'Tende a formare grumi', materiale: 'Agar+Spirulina Bioattivo' },
        ],
    },
    {
        id: 'stampo', gruppo: 'processo', iconLabel: 'P11',
        titolo: 'Si attacca allo stampo',
        sottotitolo: 'Non si stacca, si rompe provando a estrarlo',
        gravita: 3, risolvibilita: 5,
        sintomo: 'Il materiale non si stacca dallo stampo, si rompe o si deforma nel tentativo di estrarlo.',
        causa: 'I biopolimeri sono adesivi naturali (la colla di pesce è gelatina!). L\'adesione chimica e meccanica tra materiale e superficie dello stampo è forte, soprattutto con stampi porosi o rugosi.',
        famiglie_rischio: ['PROTEINA','POLISACCARIDE_NEUTRO','POLISACCARIDE_ANIONICO'],
        ingredienti_rischio: [],
        condizioni: ['stampi non trattati','superfici porose','materiali molto adesivi'],
        soluzioni: [
            { nome: 'Stampi in silicone', desc: 'Naturalmente antiaderenti, migliore soluzione', pro: 'Risultati eccellenti, riusabili', con: 'Costosi, forme limitate', efficacia: 3, diff: 'Facile' },
            { nome: 'Olio vegetale', desc: 'Strato sottile sullo stampo prima del versamento', pro: 'Economico, molto efficace', con: 'Può macchiare leggermente il campione', efficacia: 3, diff: 'Facile' },
            { nome: 'Carta forno / acetato', desc: 'Foderare lo stampo con carta da forno', pro: 'Superficie liscia, facile rimozione', con: 'Possibili pieghe sulla superficie', efficacia: 3, diff: 'Facile' },
            { nome: 'Raffreddamento', desc: 'Mettere in frigo/freezer 30 minuti', pro: 'Il materiale si contrae dallo stampo', con: 'Condensa al ritorno a temperatura', efficacia: 2, diff: 'Facile' },
            { nome: 'Coltello sottile', desc: 'Fare leva delicatamente dai bordi', pro: 'Salva il campione', con: 'Può danneggiare', efficacia: 1, diff: 'Facile' },
        ],
        studenti: [
            { testo: 'Molto fragile quando viene staccato dalla superficie del contenitore', materiale: 'Pectina Elastica' },
        ],
    },
    {
        id: 'grumi', gruppo: 'processo', iconLabel: 'P12',
        titolo: 'Miscela non omogenea / grumi',
        sottotitolo: 'Grumi, particelle non sciolte, fasi separate',
        gravita: 3, risolvibilita: 4,
        sintomo: 'Grumi visibili, particelle non sciolte, sedimentazione, fasi separate (olio-acqua).',
        causa: 'Le polveri si aggregano in acqua formando grumi con l\'esterno idratato e l\'interno ancora secco. Coloranti in polvere e cariche minerali sono i peggiori. Le fasi grasse e acquose si separano spontaneamente senza emulsionante.',
        famiglie_rischio: ['COLORANTE','CARICA','LIPIDE'],
        ingredienti_rischio: ['spirulina','curcuma','caolino','gesso','fondi_caffe','bucce_agrumi'],
        condizioni: ['polveri aggiunte tutte insieme','miscelazione insufficiente','fasi olio-acqua senza emulsionante'],
        soluzioni: [
            { nome: 'Pre-dispersione', desc: 'Sciogliere la polvere in poca acqua calda (fare una "pasta") prima di aggiungere', pro: 'Elimina grumi alla fonte', con: 'Passo aggiuntivo', efficacia: 3, diff: 'Facile' },
            { nome: 'Aggiunta graduale', desc: 'Spolverare polvere lentamente nella miscela mescolando', pro: 'Previene agglomerazione', con: 'Più tempo', efficacia: 3, diff: 'Facile' },
            { nome: 'Frullatore / mixer', desc: 'Omogeneizzare meccanicamente', pro: 'Rapido, efficace per scarti', con: 'Incorpora aria → bolle', efficacia: 3, diff: 'Facile', link: 'bolle' },
            { nome: 'Setacciare prima', desc: 'Passare polveri e cariche al setaccio prima dell\'uso', pro: 'Elimina grumi preesistenti', con: 'Serve setaccio fine', efficacia: 2, diff: 'Facile' },
            { nome: 'Emulsionante', desc: 'Lecitina 1-2% per sistemi con fasi grasse e acquose', pro: 'Stabilizza emulsione permanentemente', con: 'Ingrediente aggiuntivo', efficacia: 3, diff: 'Medio' },
        ],
        studenti: [
            { testo: 'Curcuma in polvere conteneva grumi, non mescolata accuratamente', materiale: 'Agar+curcuma antimicrobico' },
            { testo: 'Difficile da mescolare in modo uniforme, forma grumi, tende a curvarsi', materiale: 'Agar+Spirulina Bioattivo' },
            { testo: 'Il materiale non riesce a diventare omogeneo', materiale: 'Caseina flessibile' },
            { testo: 'L\'aggiunta di coloranti naturali ha causato sedimentazione', materiale: 'Gelatina colorata naturale' },
            { testo: 'Necessario frullatore, altrimenti difficile ottenere consistenza liscia', materiale: 'Bucce Banana Bioplastica' },
        ],
        nota_sci: 'La spirulina in polvere è particolarmente problematica: le particelle fini intrappolano microbolle d\'aria resistenti. Pre-dispersione in acqua calda risolve entrambi i problemi (grumi e bolle) simultaneamente.',
    },
    // -- GRUPPO 5: STABILITA --
    {
        id: 'colore', gruppo: 'stabilita', iconLabel: 'P13',
        titolo: 'Colore inaspettato o instabile',
        sottotitolo: 'Viraggio, scolorimento, ingiallimento',
        gravita: 2, risolvibilita: 2,
        sintomo: 'Colore diverso dal previsto, scolorimento con la luce, ingiallimento, viraggio nel tempo.',
        causa: 'I coloranti naturali sono intrinsecamente instabili. Curcuma: fotosensibile, sbiadisce con UV. Spirulina: vira dal verde al bruno. Amidi: scuriscono se surriscaldati (Maillard). Gelatina: ingiallisce con il calore.',
        famiglie_rischio: ['COLORANTE','PROTEINA'],
        ingredienti_rischio: ['curcuma','spirulina','paprika','gelatina'],
        condizioni: ['esposizione a luce diretta','surriscaldamento','pH variabile'],
        is_color_guide: true,
        color_guide: [
            { col: 'Curcuma', stab: 'Bassa', problema: 'Sbiadisce con luce UV', nota: 'Conservare al buio; accettare come evoluzione' },
            { col: 'Spirulina', stab: 'Media', problema: 'Vira al bruno col tempo', nota: 'Aggiungere antiossidante (vitamina C)' },
            { col: 'Carbone vegetale', stab: 'Alta', problema: 'Nessuno — stabilissimo', nota: 'Scelta migliore per nero permanente' },
            { col: 'Ossidi/ocre', stab: 'Alta', problema: 'Nessuno', nota: 'Scelta migliore per colori stabili' },
            { col: 'Tè/caffè', stab: 'Media', problema: 'Scurisce nel tempo', nota: 'Accettabile, evoluzione naturale' },
            { col: 'Barbabietola', stab: 'Bassa', problema: 'pH-sensibile, sbiadisce', nota: 'Solo per effetti temporanei' },
        ],
        soluzioni: [],
        studenti: [
            { testo: 'Coloranti naturali hanno causato sedimentazione oltre che viraggio', materiale: 'Gelatina colorata naturale' },
        ],
        nota_sci: 'Per colori permanenti nei biomateriali: ossidi minerali (ocre, terre) e carbone vegetale. Per colori che evolvono nel tempo (progetto con "aging" intenzionale): curcuma, spirulina, pigmenti botanici.',
    },
    {
        id: 'retrogradazione', gruppo: 'stabilita', iconLabel: 'P14',
        titolo: 'Retrogradazione degli amidi',
        sottotitolo: 'Indurimento e opacizzazione progressiva',
        gravita: 3, risolvibilita: 2,
        sintomo: 'Il materiale a base di amido diventa progressivamente più rigido, opaco e fragile nelle settimane successive alla produzione.',
        causa: 'Le catene di amilosio, disperse nella matrice dopo la gelatinizzazione, tendono a ri-cristallizzarsi lentamente (retrogradazione). Questo espelle acqua dal gel (sinéresi), aumenta opacità e rigidità. È lo stesso processo che rende il pane raffermo.',
        famiglie_rischio: ['POLISACCARIDE_NEUTRO'],
        ingredienti_rischio: ['amido_mais','amido_patata','amido_tapioca'],
        condizioni: ['base amido con alto amilosio (mais)','conservazione a bassa umidità'],
        soluzioni: [
            { nome: 'Più plastificante', desc: 'Glicerina 20-30% rallenta la cristallizzazione', pro: 'Efficace, standard', con: 'Può diventare appiccicoso', efficacia: 2, diff: 'Facile', link: 'appiccicoso' },
            { nome: 'Amido waxy (ceroso)', desc: 'Usare amidi ad alta amilopectina se disponibili', pro: 'Quasi zero retrogradazione', con: 'Meno reperibile, film più deboli', efficacia: 3, diff: 'Medio' },
            { nome: 'Ambiente umido controllato', desc: 'Conservare a 50-60% RH, non troppo secco', pro: 'Rallenta il processo', con: 'Non elimina, solo rallenta', efficacia: 1, diff: 'Facile' },
            { nome: 'Documentare l\'evoluzione', desc: 'Testare flessibilità e trasparenza a 1, 7, 14, 28 giorni', pro: 'Valore didattico, nessun intervento', con: 'Il materiale cambia comunque', efficacia: 0, diff: 'Facile' },
        ],
        studenti: [],
        nota_sci: 'Sequenza retrogradazione: mais (alto amilosio, più rapida) > patata (intermedia) > tapioca (basso amilosio, più lenta). Esperimento didattico: far misurare agli studenti la flessibilità dello stesso campione a 1, 7, 14, 28 giorni — visualizzano il fenomeno direttamente.',
    },
    {
        id: 'sineresi', gruppo: 'stabilita', iconLabel: 'P15',
        titolo: 'Sinéresi (il gel "piange")',
        sottotitolo: 'Liquido trasparente che essuda dalla superficie',
        gravita: 2, risolvibilita: 2,
        sintomo: 'Liquido trasparente che essuda dalla superficie del gel, il campione è circondato da una pozza d\'acqua.',
        causa: 'La rete del gel si contrae espellendo acqua intrappolata. Comune in gel di agar e amido. Innescata da retrogradazione, sbalzi di temperatura o invecchiamento.',
        famiglie_rischio: ['POLISACCARIDE_NEUTRO'],
        ingredienti_rischio: ['agar','amido_mais','amido_patata'],
        condizioni: ['gel conservati a lungo','cicli caldo/freddo','alta concentrazione di matrice'],
        soluzioni: [
            { nome: 'Temperatura costante', desc: 'Evitare cicli caldo/freddo durante conservazione', pro: 'Previene contrazioni della rete', con: 'Non sempre possibile', efficacia: 2, diff: 'Facile' },
            { nome: 'Ridurre concentrazione', desc: 'Gel meno concentrato = meno acqua espellibile', pro: 'Meno sinéresi', con: 'Gel più debole', efficacia: 2, diff: 'Facile' },
            { nome: 'Cariche assorbenti', desc: 'Amido o farine assorbono l\'acqua liberata', pro: 'Mascherano il fenomeno', con: 'Opacizzano il gel', efficacia: 2, diff: 'Facile' },
            { nome: 'Essiccare', desc: 'Se il prodotto finale è un film secco, la sinéresi avviene durante essiccazione', pro: 'Il fenomeno è parte del processo', con: 'Non applicabile a gel finali', efficacia: 3, diff: 'Facile' },
        ],
        studenti: [],
    },
    // -- GRUPPO 6: COLTURE --
    {
        id: 'micelio_no_crescita', gruppo: 'colture', iconLabel: 'P16',
        titolo: 'Micelio non cresce',
        sottotitolo: 'Substrato invariato dopo giorni',
        gravita: 5, risolvibilita: 3,
        sintomo: 'Nessuna muffa bianca visibile sul substrato dopo 5-7 giorni. Substrato invariato o con colori sospetti.',
        causa: 'Condizioni ambientali inadatte, contaminazione da competitori, o spawn (inoculo) non vitale.',
        famiglie_rischio: ['COLTURA'],
        ingredienti_rischio: ['micelio'],
        condizioni: ['coltura biologica'],
        is_checklist: true,
        checklist: [
            'Substrato sterile? (pastorizzato 80-100°C per 1h)',
            'Temperatura 20-25°C? (sotto 18°C quasi fermo, sopra 28°C stress)',
            'Spawn fresco e vitale? (bianco e attivo, non secco o giallo)',
            'Umidità corretta? (umido ma non fradicio — test: stringere, poche gocce)',
            'Contaminanti visibili? (verde/nero/arancione → buttare e ricominciare)',
        ],
        soluzioni: [],
        studenti: [],
    },
    {
        id: 'scoby_no_forma', gruppo: 'colture', iconLabel: 'P17',
        titolo: 'SCOBY non si forma',
        sottotitolo: 'Nessuna pellicola dopo 1-2 settimane',
        gravita: 4, risolvibilita: 3,
        sintomo: 'Nessuna pellicola visibile in superficie dopo 1-2 settimane di fermentazione.',
        causa: 'Batteri uccisi dal calore, mancanza di nutrienti, condizioni ambientali inadatte.',
        famiglie_rischio: ['COLTURA'],
        ingredienti_rischio: ['scoby'],
        condizioni: ['coltura biologica'],
        is_checklist: true,
        checklist: [
            'Tè a temperatura ambiente quando aggiunto lo SCOBY? (>40°C uccide i batteri)',
            'Zucchero sufficiente? (50-100g per litro)',
            'Contenitore largo? (serve SUPERFICIE, non profondità)',
            'Temperatura 22-28°C?',
            'Coperto con tessuto traspirante? (serve ossigeno, no insetti)',
        ],
        soluzioni: [],
        studenti: [],
    },
    {
        id: 'contaminazione', gruppo: 'colture', iconLabel: 'P18',
        titolo: 'Contaminazione colture',
        sottotitolo: 'Colori diversi da bianco (micelio) o beige (SCOBY)',
        gravita: 5, risolvibilita: 1,
        sintomo: 'Macchie di colore diverso dal previsto: verdi, nere, arancioni, rosa sulla coltura.',
        causa: 'Sterilizzazione insufficiente del substrato o contaminazione ambientale (spore nell\'aria).',
        famiglie_rischio: ['COLTURA'],
        ingredienti_rischio: ['micelio','scoby'],
        condizioni: ['coltura biologica'],
        is_color_guide: true,
        color_guide: [
            { col: 'Verde/blu', stab: 'STOP', problema: 'Trichoderma o Penicillium', nota: 'Comune, aggressivo → buttare' },
            { col: 'Nero', stab: 'STOP!', problema: 'Aspergillus — pericoloso', nota: 'Buttare con precauzione, guanti' },
            { col: 'Arancione/rosa', stab: 'STOP', problema: 'Neurospora — molto contagioso', nota: 'Isolare immediatamente e buttare' },
            { col: 'Giallo su micelio', stab: '?', problema: 'Possibile metabolita del micelio', nota: 'Non sempre patogeno, monitorare' },
            { col: 'Bianco cotonoso', stab: '?', problema: 'Potrebbe essere il vostro micelio... o no', nota: 'Confrontare con foto di riferimento' },
        ],
        soluzioni: [
            { nome: 'Prevenzione: sterilizzazione', desc: 'Pastorizzare substrato a 80-100°C per almeno 1h', pro: 'Elimina competitori', con: 'Serve attrezzatura', efficacia: 3, diff: 'Medio' },
            { nome: 'Lavorare in ambiente pulito', desc: 'Pulire superfici con alcool 70%, chiudere finestre', pro: 'Riduce contaminazione aerea', con: 'Non garantisce sterilità', efficacia: 2, diff: 'Facile' },
            { nome: 'Se contaminato: buttare', desc: 'Non tentare di salvare una coltura contaminata', pro: 'Evita propagazione', con: 'Ricominciare da capo', efficacia: 3, diff: 'Facile' },
        ],
        studenti: [],
        nota_sci: 'La contaminazione nelle colture biologiche è la norma, non l\'eccezione. I laboratori professionali lavorano sotto cappa a flusso laminare. In un laboratorio didattico, prevedere un tasso di successo del 50-60% e preparare sempre colture di backup.',
    },
    // -- GRUPPO 7: AMBIENTE --
    {
        id: 'calore', gruppo: 'ambiente', iconLabel: 'P19',
        titolo: 'Sensibilità al calore',
        sottotitolo: 'Si ammorbidisce, deforma o fonde al caldo',
        gravita: 3, risolvibilita: 3,
        sintomo: 'Il materiale si ammorbidisce, deforma o fonde quando esposto al sole diretto o in ambienti caldi d\'estate.',
        causa: 'La gelatina fonde a 25-30°C: i materiali a base di gelatina sono instabili in ambienti caldi. Anche i film con molta glicerina possono ammorbidirsi (Tg bassa).',
        famiglie_rischio: ['PROTEINA','PLASTIFICANTE'],
        ingredienti_rischio: ['gelatina','glicerina'],
        condizioni: ['base gelatina','plastificante >30%','esposizione al sole'],
        soluzioni: [
            { nome: 'Reticolazione con tannini', desc: 'Bagno o aggiunta di tannini 3-5% nella miscela', pro: 'Alza la T di fusione di 20-30°C', con: 'Scurisce il materiale, irreversibile', efficacia: 3, diff: 'Medio' },
            { nome: 'Cambiare matrice', desc: 'Agar fonde a 85°C vs 30°C della gelatina', pro: 'Soluzione radicale al problema', con: 'Proprietà completamente diverse', efficacia: 3, diff: 'Facile' },
            { nome: 'Conservazione controllata', desc: 'Frigo o ambiente climatizzato', pro: 'Semplice', con: 'Non sempre possibile per oggetti esposti', efficacia: 2, diff: 'Facile' },
            { nome: 'Disidratazione completa', desc: 'Film molto secco è più stabile al calore', pro: 'Alza la Tg', con: 'Più fragile', efficacia: 2, diff: 'Facile', link: 'fragile' },
        ],
        studenti: [],
        nota_sci: 'La reticolazione con tannini vegetali è il metodo più accessibile per stabilizzare la gelatina. È lo stesso principio della concia del cuoio. La genipin (estratta dalla gardenia) è un\'alternativa non tossica che produce un bel colore blu, ma è costosa.',
    },
    {
        id: 'troppo_rigido', gruppo: 'ambiente', iconLabel: 'P20',
        titolo: 'Troppo rigido (volevo flessibile)',
        sottotitolo: 'Duro, non si piega, non era il risultato voluto',
        gravita: 2, risolvibilita: 4,
        sintomo: 'Il materiale è più rigido del desiderato, non si piega come previsto nel progetto.',
        causa: 'Matrice intrinsecamente rigida (agar, caseina), plastificante insufficiente, o essiccazione eccessiva che ha rimosso l\'umidità residua.',
        famiglie_rischio: ['POLISACCARIDE_NEUTRO','PROTEINA'],
        ingredienti_rischio: ['agar','caseina','amido_mais'],
        condizioni: ['plastificante <10%','essiccazione troppo spinta','matrice rigida pura'],
        soluzioni: [
            { nome: 'Più glicerina', desc: 'Aumentare plastificante al 20-30% sul peso matrice', pro: 'Standard, prevedibile', con: 'Può diventare appiccicoso', efficacia: 3, diff: 'Facile', link: 'appiccicoso' },
            { nome: 'Cambiare matrice', desc: 'Gelatina è più flessibile di agar/caseina', pro: 'Flessibilità intrinseca', con: 'Cambia tutto il materiale', efficacia: 3, diff: 'Facile' },
            { nome: 'Film più sottile', desc: 'Sotto 0.5mm anche materiali rigidi si piegano', pro: 'Flessibilità geometrica, non chimica', con: 'Meno resistente', efficacia: 2, diff: 'Facile' },
            { nome: 'Blend di matrici', desc: 'Gelatina + amido: combina flessibilità proteica + struttura', pro: 'Proprietà intermedie regolabili', con: 'Più complesso da bilanciare', efficacia: 3, diff: 'Medio' },
        ],
        studenti: [],
    },
    ];

    // ── CONSTANTS ──
    const TABD_FAMILY_COLORS = {
        'PROTEINA': '#e74c3c', 'POLISACCARIDE_NEUTRO': '#3498db',
        'POLISACCARIDE_ANIONICO': '#9b59b6', 'POLICATIONE': '#1abc9c',
        'PLASTIFICANTE': '#f39c12', 'SALE_RETICOLANTE': '#e67e22',
        'LIPIDE': '#27ae60', 'COLORANTE': '#e91e63',
        'CARICA': '#795548', 'ADDITIVO': '#607d8b',
        'COLTURA': '#00bcd4', 'EMULSIONANTE': '#ff7043', 'ACIDO': '#607d8b',
    };
    const TABD_FAMILY_LABELS = {
        'PROTEINA': 'Proteina', 'POLISACCARIDE_NEUTRO': 'Polisacc. Neutro',
        'POLISACCARIDE_ANIONICO': 'Polisacc. Anionico', 'POLICATIONE': 'Policatione',
        'PLASTIFICANTE': 'Plastificante', 'SALE_RETICOLANTE': 'Sale Reticolante',
        'LIPIDE': 'Lipide', 'COLORANTE': 'Colorante',
        'CARICA': 'Carica', 'ADDITIVO': 'Additivo',
        'COLTURA': 'Coltura', 'EMULSIONANTE': 'Emulsionante', 'ACIDO': 'Acido',
    };
    const GROUP_NAMES = {
        essiccazione: 'Essiccazione', meccanica: 'Meccanica', biologici: 'Biologici',
        processo: 'Processo', stabilita: 'Stabilità nel tempo',
        colture: 'Colture', ambiente: 'Sensibilità ambientale',
    };
    const GROUP_ICONS = {
        essiccazione: { cls: 'g-ess', label: 'Es' }, meccanica: { cls: 'g-mec', label: 'Mc' },
        biologici: { cls: 'g-bio', label: 'Bi' }, processo: { cls: 'g-pro', label: 'Pr' },
        stabilita: { cls: 'g-sta', label: 'St' }, colture: { cls: 'g-col', label: 'Co' },
        ambiente: { cls: 'g-amb', label: 'Am' },
    };
    const GROUP_COLORS = {
        essiccazione: '#e65100', meccanica: '#c62828', biologici: '#2e7d32',
        processo: '#1565c0', stabilita: '#6a1b9a', colture: '#00695c', ambiente: '#f57f17',
    };
    const SOLUTION_INGREDIENTS = {
        crepe: [{ match: 'plastificante', ingredienti: ['glicerina','sorbitolo'] }],
        appiccicoso: [
            { match: 'sorbitolo', ingredienti: ['sorbitolo'] },
            { match: 'Reticolazione', ingredienti: ['cacl2','tannini'] },
        ],
        fragile: [
            { match: 'plastificante', ingredienti: ['glicerina','sorbitolo'] },
            { match: 'fibre', ingredienti: ['fibre_lino','fibre_cotone'] },
        ],
        schiuma_collassa: [{ match: 'Reticolazione immediata', ingredienti: ['cacl2'] }],
        delaminazione: [{ match: 'Emulsionante', ingredienti: ['lecitina'] }],
        muffe: [
            { match: 'citrico', ingredienti: ['acido_citrico'] },
            { match: 'Curcuma', ingredienti: ['curcuma'] },
            { match: 'Chitosano', ingredienti: ['chitosano'] },
        ],
        grumi: [{ match: 'Emulsionante', ingredienti: ['lecitina'] }],
        retrogradazione: [{ match: 'plastificante', ingredienti: ['glicerina'] }],
        calore: [{ match: 'tannini', ingredienti: ['tannini'] }],
        troppo_rigido: [{ match: 'glicerina', ingredienti: ['glicerina'] }],
    };
    const MITIGATIONS = {
        calore: [
            { ingredienti: ['tannini'], score: -6, reason: 'Tannini reticolano la gelatina, +20-30C' },
            { ingredienti: ['allume','borace'], score: -3, reason: 'Reticolazione parziale' },
        ],
        appiccicoso: [
            { ingredienti: ['sorbitolo'], score: -3, reason: 'Sorbitolo meno igroscopico della glicerina' },
            { ingredienti: ['cacl2','tannini','allume','borace'], score: -4, reason: 'Reticolazione stabilizza la superficie' },
        ],
        fragile: [
            { famiglie: ['PLASTIFICANTE'], score: -6, reason: 'Plastificante presente' },
            { ingredienti: ['fibre_lino','fibre_cotone','cellulosa_carta'], score: -3, reason: 'Fibre rinforzano senza irrigidire' },
        ],
        crepe: [
            { famiglie: ['PLASTIFICANTE'], score: -5, reason: 'Plastificante riduce tensioni interne' },
            { ingredienti: ['fibre_lino','fibre_cotone','cellulosa_carta'], score: -2, reason: 'Fibre distribuiscono le tensioni' },
        ],
        muffe: [
            { ingredienti: ['chitosano'], score: -5, reason: 'Chitosano è antimicrobico naturale' },
            { ingredienti: ['acido_citrico'], score: -3, reason: 'Abbassa pH sotto 4.5' },
            { ingredienti: ['curcuma'], score: -2, reason: 'Antimicotico naturale' },
        ],
        delaminazione: [{ ingredienti: ['lecitina'], score: -3, reason: 'Emulsionante migliora adesione' }],
        troppo_rigido: [{ famiglie: ['PLASTIFICANTE'], score: -6, reason: 'Plastificante presente' }],
        ritiro: [
            { famiglie: ['CARICA'], score: -3, reason: 'Cariche riducono ritiro 30-40%' },
            { famiglie: ['PLASTIFICANTE'], score: -2, reason: 'Plastificante riduce tensioni' },
        ],
        schiuma_collassa: [{ ingredienti: ['cacl2'], score: -3, reason: 'Reticolazione fissa la struttura' }],
        grumi: [{ ingredienti: ['lecitina'], score: -3, reason: 'Emulsionante stabilizza la miscela' }],
        retrogradazione: [{ famiglie: ['PLASTIFICANTE'], score: -2, reason: 'Plastificante rallenta ri-cristallizzazione' }],
        odore: [
            { ingredienti: ['acido_citrico'], score: -3, reason: 'Acido citrico al posto dell\'aceto' },
            { ingredienti: ['tannini'], score: -2, reason: 'Tannini fissano le proteine' },
        ],
    };

    // ── TAB D STATE ──
    let tabD_tavolo = []; // [{id, nome, fam, active, type: 'base'|'correttivo'}]
    let tabD_activeFilter = 'all';
    let tabD_userChoseFilter = false;

    // ── INIT ──
    function tabD_init() {
        tabD_syncFromSharedTavolo();
        tabD_populateSelect();
        tabD_renderProblems();
        tabD_renderTavolo();
        tabD_updateAll();
    }

    function tabD_syncFromSharedTavolo() {
        // Import from shared tavolo (array of IDs) — keep existing correttivi
        var ings = (INGREDIENTI_DATA && INGREDIENTI_DATA.ingredienti) ? INGREDIENTI_DATA.ingredienti : {};
        var existingCorrettivi = tabD_tavolo.filter(function(t) { return t.type === 'correttivo'; });
        var newTavolo = [];
        tavolo.forEach(function(id) {
            var ingObj = ings[id];
            if (ingObj) {
                newTavolo.push({ id: id, nome: ingObj.nome, fam: ingObj.famiglia, active: true, type: 'base' });
            }
        });
        // Re-add correttivi that aren't already on shared tavolo
        existingCorrettivi.forEach(function(c) {
            if (!newTavolo.find(function(t) { return t.id === c.id; })) {
                newTavolo.push(c);
            }
        });
        tabD_tavolo = newTavolo;
    }

    function tabD_populateSelect() {
        var sel = document.getElementById('tdIngSelect');
        if (!sel) return;
        // Clear old options except first
        while (sel.options.length > 1) sel.remove(1);
        var ings = (INGREDIENTI_DATA && INGREDIENTI_DATA.ingredienti) ? INGREDIENTI_DATA.ingredienti : {};
        var byFam = {};
        Object.keys(ings).forEach(function(id) {
            var ing = ings[id];
            var fam = ing.famiglia || 'ALTRO';
            if (!byFam[fam]) byFam[fam] = [];
            byFam[fam].push({ id: id, nome: ing.nome });
        });
        Object.keys(byFam).sort().forEach(function(fam) {
            var optg = document.createElement('optgroup');
            optg.label = TABD_FAMILY_LABELS[fam] || fam;
            byFam[fam].sort(function(a,b) { return a.nome.localeCompare(b.nome); }).forEach(function(ing) {
                var opt = document.createElement('option');
                opt.value = ing.id;
                opt.textContent = ing.nome;
                optg.appendChild(opt);
            });
            sel.appendChild(optg);
        });
    }

    // ── TAVOLO MANAGEMENT ──
    function tabD_addToTavolo(id, type) {
        if (!id) return;
        var sel = document.getElementById('tdIngSelect');
        if (sel) sel.value = '';
        if (tabD_tavolo.find(function(t) { return t.id === id; })) {
            var item = tabD_tavolo.find(function(t) { return t.id === id; });
            if (!item.active) { item.active = true; }
            tabD_renderTavolo();
            tabD_updateAll();
            return;
        }
        var ings = (INGREDIENTI_DATA && INGREDIENTI_DATA.ingredienti) ? INGREDIENTI_DATA.ingredienti : {};
        var ingObj = ings[id];
        if (!ingObj) return;
        tabD_tavolo.push({ id: id, nome: ingObj.nome, fam: ingObj.famiglia, active: true, type: type || 'base' });
        tabD_renderTavolo();
        tabD_updateAll();
    }

    function tabD_askRemove(id) {
        var el = document.querySelector('#tdCartBody .td-item[data-id="' + id + '"]');
        if (!el || el.classList.contains('confirming')) return;
        el.classList.add('confirming');
        var item = tabD_tavolo.find(function(t) { return t.id === id; });
        var nome = item ? item.nome : '';
        el.innerHTML = '<span class="td-confirm-msg">Rimuovere ' + nome + '?</span>' +
            '<button class="td-cfm-yes disabled" id="tdCfmYes_' + id + '">Sì</button>' +
            '<button class="td-cfm-no" onclick="tabD_cancelRemove(\'' + id + '\')">No</button>';
        setTimeout(function() {
            var btn = document.getElementById('tdCfmYes_' + id);
            if (btn) { btn.classList.remove('disabled'); btn.onclick = function() { tabD_removeFromTavolo(id); }; }
        }, 600);
        el._confirmTimer = setTimeout(function() { tabD_cancelRemove(id); }, 5000);
    }

    function tabD_cancelRemove(id) {
        var el = document.querySelector('#tdCartBody .td-item[data-id="' + id + '"]');
        if (el && el._confirmTimer) clearTimeout(el._confirmTimer);
        tabD_renderTavolo();
    }

    function tabD_removeFromTavolo(id) {
        tabD_tavolo = tabD_tavolo.filter(function(t) { return t.id !== id; });
        tabD_renderTavolo();
        tabD_updateAll();
    }

    function tabD_toggleActive(id) {
        var item = tabD_tavolo.find(function(t) { return t.id === id; });
        if (item) { item.active = !item.active; }
        tabD_renderTavolo();
        tabD_updateAll();
    }

    function tabD_askClear() {
        if (tabD_tavolo.length === 0) return;
        var zone = document.getElementById('tdClearZone');
        if (!zone || zone.classList.contains('confirming')) return;
        zone.classList.add('confirming');
        zone.innerHTML = '<span class="td-clear-msg">Svuotare tutto?</span>' +
            '<button class="td-cfm-yes disabled" id="tdCfmClearYes">Sì</button>' +
            '<button class="td-cfm-no" onclick="tabD_cancelClear()">No</button>';
        setTimeout(function() {
            var btn = document.getElementById('tdCfmClearYes');
            if (btn) { btn.classList.remove('disabled'); btn.onclick = function() { tabD_clearTavolo(); }; }
        }, 600);
        zone._confirmTimer = setTimeout(tabD_cancelClear, 5000);
    }

    function tabD_cancelClear() {
        var zone = document.getElementById('tdClearZone');
        if (!zone) return;
        if (zone._confirmTimer) clearTimeout(zone._confirmTimer);
        zone.classList.remove('confirming');
        zone.innerHTML = '<button class="td-clear-btn" onclick="tabD_askClear()">Svuota ricetta</button>';
    }

    function tabD_clearTavolo() {
        var zone = document.getElementById('tdClearZone');
        if (zone && zone._confirmTimer) clearTimeout(zone._confirmTimer);
        tabD_tavolo = [];
        tabD_renderTavolo();
        tabD_updateAll();
        if (zone) { zone.classList.remove('confirming'); zone.innerHTML = '<button class="td-clear-btn" onclick="tabD_askClear()">Svuota ricetta</button>'; }
    }

    function tabD_updateAll() {
        tabD_updateContextZone();
        tabD_updateLabButton();
    }

    function tabD_updateLabButton() {
        var btn = document.getElementById('tdGotoLab');
        var countEl = document.getElementById('tdLabCount');
        var active = tabD_getActiveItems();
        var corr = tabD_getCorrettivi();
        if (active.length > 0) {
            btn.style.display = 'block';
            countEl.textContent = active.length + ' ing.';
            if (corr.length > 0) {
                countEl.textContent = active.length + ' ing. / ' + corr.length + ' fix';
            }
        } else {
            btn.style.display = 'none';
        }
    }

    function tabD_gotoLab() {
        // Push correttivi to shared tavolo
        var corr = tabD_getCorrettivi();
        corr.forEach(function(c) {
            if (!tavolo.includes(c.id)) {
                // Also add to cart if not there
                if (!cart.includes(c.id)) cart.push(c.id);
                tavolo.push(c.id);
            }
        });
        // Switch to Tab C (Laboratorio)
        switchTab('C');
    }

    // Helpers
    function tabD_getActiveItems() { return tabD_tavolo.filter(function(t) { return t.active; }); }
    function tabD_getBaseItems() { return tabD_tavolo.filter(function(t) { return t.type === 'base'; }); }
    function tabD_getCorrettivi() { return tabD_tavolo.filter(function(t) { return t.type === 'correttivo'; }); }
    function tabD_isOnTavolo(id) { return tabD_tavolo.some(function(t) { return t.id === id; }); }

    // ── RENDER TAVOLO ──
    function tabD_renderTavolo() {
        var body = document.getElementById('tdCartBody');
        var countEl = document.getElementById('tdCartCount');
        if (!body || !countEl) return;
        var activeCount = tabD_getActiveItems().length;
        countEl.textContent = activeCount + '/' + tabD_tavolo.length;

        if (tabD_tavolo.length === 0) {
            body.innerHTML = '<div class="td-empty">Nessun ingrediente.<br><br>Aggiungi la ricetta che stai preparando per diagnosticare problemi e trovare soluzioni.<br><br>Attiva/disattiva ciascuno per isolare quale ingrediente causa cosa.</div>';
            return;
        }

        var html = '';
        var base = tabD_getBaseItems();
        var corr = tabD_getCorrettivi();

        if (base.length > 0) {
            html += '<div class="td-section"><div class="td-section-title">Ricetta base <span class="sec-count">(' + base.length + ')</span></div>';
            html += base.map(tabD_renderTavoloItem).join('');
            html += '</div>';
        }
        if (corr.length > 0) {
            html += '<div class="td-section"><div class="td-section-title correttivi">Correttivi suggeriti <span class="sec-count">(' + corr.length + ')</span></div>';
            html += corr.map(tabD_renderTavoloItem).join('');
            html += '</div>';
        }
        body.innerHTML = html;
    }

    function tabD_renderTavoloItem(item) {
        var stateClass = item.type === 'correttivo' ? 'correttivo' : (item.active ? 'active' : 'inactive');
        var checkMark = item.active ? '✓' : '';
        var fixBadge = item.type === 'correttivo' ? '<span class="td-fix-badge">FIX</span>' : '';
        var col = TABD_FAMILY_COLORS[item.fam] || '#888';
        return '<div class="td-item ' + stateClass + '" data-id="' + item.id + '">' +
            '<span class="td-check" onclick="tabD_toggleActive(\'' + item.id + '\')" title="' + (item.active ? 'Disattiva' : 'Attiva') + '">' + checkMark + '</span>' +
            '<span class="dot" style="background:' + col + '"></span>' +
            '<span class="name">' + item.nome + '</span>' +
            fixBadge +
            '<span class="fam">' + (TABD_FAMILY_LABELS[item.fam] || '').substring(0, 8) + '</span>' +
            '<button class="remove" onclick="tabD_askRemove(\'' + item.id + '\')" title="Rimuovi">✕</button>' +
        '</div>';
    }

    // ── CONTEXTUAL MATCHING ──
    function tabD_getRelevantProblems() {
        var active = tabD_getActiveItems();
        if (active.length === 0) return [];
        var activeIds = active.map(function(c) { return c.id; });
        var activeFams = []; active.forEach(function(c) { if (activeFams.indexOf(c.fam) === -1) activeFams.push(c.fam); });
        var hasMatrice = activeFams.some(function(f) { return ['PROTEINA','POLISACCARIDE_NEUTRO','POLISACCARIDE_ANIONICO','POLICATIONE','COLTURA'].indexOf(f) !== -1; });
        var hasPlast = activeFams.indexOf('PLASTIFICANTE') !== -1;
        var hasCarica = activeFams.indexOf('CARICA') !== -1;
        var hasColorante = activeFams.indexOf('COLORANTE') !== -1;
        var hasScarti = activeIds.some(function(id) { return ['fondi_caffe','pula_riso','bucce_agrumi','segatura'].indexOf(id) !== -1; });

        var scored = PROBLEMI.map(function(p) {
            var score = 0;
            p.ingredienti_rischio.forEach(function(ir) { if (activeIds.indexOf(ir) !== -1) score += 3; });
            p.famiglie_rischio.forEach(function(fr) { if (activeFams.indexOf(fr) !== -1) score += 1; });
            if (p.id === 'fragile' && hasMatrice && !hasPlast) score += 4;
            if (p.id === 'crepe' && hasMatrice && !hasPlast) score += 3;
            if (p.id === 'appiccicoso' && hasPlast) score += 1;
            if (p.id === 'muffe' && hasScarti) score += 4;
            if (p.id === 'odore' && hasScarti) score += 2;
            if (p.id === 'grumi' && (hasColorante || hasScarti)) score += 2;
            if (p.id === 'bolle' && activeIds.indexOf('spirulina') !== -1) score += 3;
            if (p.id === 'non_gelifica' && hasMatrice) score += 1;
            if (p.id === 'calore' && activeIds.indexOf('gelatina') !== -1) score += 4;
            if (p.id === 'retrogradazione' && activeIds.some(function(id) { return id.indexOf('amido') === 0; })) score += 4;
            if (p.id === 'sineresi' && activeIds.some(function(id) { return id.indexOf('amido') === 0 || id === 'agar'; })) score += 2;
            if (p.id === 'schiuma_collassa' && activeIds.some(function(id) { return ['albumina','aquafaba','bicarbonato'].indexOf(id) !== -1; })) score += 4;
            if (p.id === 'delaminazione' && hasCarica) score += 2;
            if (p.id === 'colore' && activeIds.some(function(id) { return ['curcuma','spirulina','paprika'].indexOf(id) !== -1; })) score += 3;
            if (['micelio_no_crescita','contaminazione'].indexOf(p.id) !== -1 && activeIds.indexOf('micelio') !== -1) score += 5;
            if (['scoby_no_forma','contaminazione'].indexOf(p.id) !== -1 && activeIds.indexOf('scoby') !== -1) score += 5;

            // MITIGATIONS
            var mits = MITIGATIONS[p.id];
            if (mits && score > 0) {
                mits.forEach(function(m) {
                    var applies = false;
                    if (m.ingredienti) applies = m.ingredienti.some(function(mid) { return activeIds.indexOf(mid) !== -1; });
                    if (!applies && m.famiglie) applies = m.famiglie.some(function(mf) { return activeFams.indexOf(mf) !== -1; });
                    if (applies) score += m.score;
                });
            }
            return { id: p.id, gruppo: p.gruppo, titolo: p.titolo, gravita: p.gravita, score: score };
        }).filter(function(p) { return p.score > 0; }).sort(function(a, b) { return b.score - a.score; });

        return scored;
    }

    function tabD_updateContextZone() {
        var zone = document.getElementById('tdContextZone');
        var title = document.getElementById('tdContextTitle');
        var chips = document.getElementById('tdContextChips');
        if (!zone || !title || !chips) return;
        var relevant = tabD_getRelevantProblems();
        var active = tabD_getActiveItems();

        if (active.length === 0) {
            zone.className = 'td-context empty';
            if (tabD_tavolo.length > 0) {
                title.innerHTML = 'Nessun ingrediente attivo — attiva gli ingredienti nel tavolo per vedere i problemi';
            } else {
                title.innerHTML = 'Aggiungi ingredienti al tavolo per evidenziare i problemi della tua ricetta';
            }
            chips.innerHTML = '';
            document.querySelectorAll('#tdProblemsList .td-problem-card').forEach(function(c) { c.classList.remove('highlighted'); });
            return;
        }

        zone.className = 'td-context';
        var top = relevant.slice(0, 6);
        title.innerHTML = '⚠ ' + relevant.length + ' problemi probabili con ' + active.length + ' ingredienti attivi';
        chips.innerHTML = top.map(function(p) {
            var gDots = '';
            for (var i = 0; i < 5; i++) gDots += '<span class="td-gbar' + (i < p.gravita ? ' g' + (i + 1) : '') + '"></span>';
            return '<span class="td-context-chip" onclick="tabD_scrollToAndOpen(\'' + p.id + '\')">' + p.titolo + ' <span class="td-grav">' + gDots + '</span></span>';
        }).join('');

        var corr = tabD_getCorrettivi();
        if (corr.length > 0) {
            chips.innerHTML += '<br><button class="td-context-lab-btn" onclick="tabD_gotoLab()">← Vai in Laboratorio — ' + corr.length + ' correttiv' + (corr.length === 1 ? 'o' : 'i') + ' aggiunti</button>';
        }

        var relIds = relevant.map(function(r) { return r.id; });
        document.querySelectorAll('#tdProblemsList .td-problem-card').forEach(function(c) {
            c.classList.toggle('highlighted', relIds.indexOf(c.dataset.id) !== -1);
        });

        tabD_autoFilter();
    }

    // ── FILTERS ──
    function tabD_toggleFilter(f) {
        if (f === tabD_activeFilter && f !== 'all') {
            tabD_activeFilter = 'all';
            tabD_userChoseFilter = false;
        } else {
            tabD_activeFilter = f;
            tabD_userChoseFilter = (f !== 'all' && f !== 'relevant');
        }
        document.querySelectorAll('#tdFilterBar .td-filter-btn').forEach(function(b) {
            b.classList.toggle('active', b.dataset.filter === tabD_activeFilter);
        });
        tabD_applyFilter();
    }

    function tabD_autoFilter() {
        var active = tabD_getActiveItems();
        if (active.length === 0) {
            tabD_activeFilter = 'all';
            tabD_userChoseFilter = false;
        } else if (!tabD_userChoseFilter) {
            tabD_activeFilter = 'relevant';
        }
        document.querySelectorAll('#tdFilterBar .td-filter-btn').forEach(function(b) {
            b.classList.toggle('active', b.dataset.filter === tabD_activeFilter);
        });
        tabD_applyFilter();
    }

    function tabD_showAllProblems() { tabD_toggleFilter('all'); }

    function tabD_applyFilter() {
        var relevant = tabD_getRelevantProblems();
        var relIds = relevant.map(function(r) { return r.id; });
        var active = tabD_getActiveItems();
        var isAutoRelevant = tabD_activeFilter === 'relevant' && active.length > 0;
        var hiddenCount = 0;

        document.querySelectorAll('#tdProblemsList .td-problem-card').forEach(function(card) {
            var id = card.dataset.id;
            var gruppo = card.dataset.gruppo;
            var show = false;
            if (tabD_activeFilter === 'all') show = true;
            else if (tabD_activeFilter === 'relevant') show = relIds.indexOf(id) !== -1;
            else show = gruppo === tabD_activeFilter;
            card.classList.toggle('hidden', !show);
            if (!show) hiddenCount++;
        });

        document.querySelectorAll('#tdProblemsList .td-group-sep').forEach(function(sep) {
            var gruppo = sep.dataset.gruppo;
            if (tabD_activeFilter === 'all' || tabD_activeFilter === gruppo) sep.style.display = '';
            else if (tabD_activeFilter === 'relevant') {
                var hasVisible = false;
                document.querySelectorAll('#tdProblemsList .td-problem-card[data-gruppo="' + gruppo + '"]').forEach(function(c) { if (!c.classList.contains('hidden')) hasVisible = true; });
                sep.style.display = hasVisible ? '' : 'none';
            }
            else sep.style.display = 'none';
        });

        var showMoreZone = document.getElementById('tdShowMoreZone');
        var showMoreBtn = document.getElementById('tdShowMoreBtn');
        if (showMoreZone && showMoreBtn) {
            if (isAutoRelevant && hiddenCount > 0) {
                showMoreZone.style.display = '';
                showMoreBtn.textContent = 'Mostra anche gli altri ' + hiddenCount + ' problemi (enciclopedia completa)';
            } else {
                showMoreZone.style.display = 'none';
            }
        }
    }

    // ── RENDER PROBLEMS ──
    function tabD_renderProblems() {
        var list = document.getElementById('tdProblemsList');
        if (!list) return;
        var lastGruppo = '';
        var html = '';

        PROBLEMI.forEach(function(p) {
            if (p.gruppo !== lastGruppo) {
                var gc = GROUP_COLORS[p.gruppo] || '#555';
                html += '<div class="td-group-sep" data-gruppo="' + p.gruppo + '"><span class="td-gs-icon" style="background:' + gc + '">' + (GROUP_ICONS[p.gruppo] || {}).label + '</span> ' + (GROUP_NAMES[p.gruppo] || p.gruppo) + '</div>';
                lastGruppo = p.gruppo;
            }

            var gi = GROUP_ICONS[p.gruppo] || { cls: '', label: '?' };
            var gravDots = ''; for (var i = 0; i < 5; i++) gravDots += '<span class="td-pc-dot' + (i < p.gravita ? ' g' + (i + 1) : '') + '"></span>';
            var resDots = ''; for (var i = 0; i < 5; i++) resDots += '<span class="td-pc-dot' + (i < p.risolvibilita ? ' active-green' : '') + '"></span>';

            var bodyHTML = '';
            bodyHTML += '<div class="td-pc-section"><div class="td-pc-section-title">SINTOMO</div><div class="td-pc-text">' + p.sintomo + '</div></div>';
            bodyHTML += '<div class="td-pc-section"><div class="td-pc-section-title">CAUSA</div><div class="td-pc-text">' + p.causa + '</div></div>';

            if (p.condizioni && p.condizioni.length > 0) {
                bodyHTML += '<div class="td-pc-section"><div class="td-tag-row">' + p.condizioni.map(function(c) { return '<span class="td-tag td-risk">' + c + '</span>'; }).join('') + '</div></div>';
            }

            if (p.is_matrix_guide && p.matrix_guide) {
                bodyHTML += '<div class="td-pc-section"><div class="td-pc-section-title">GUIDA PER MATRICE</div>';
                bodyHTML += '<table class="td-matrix-table"><tr><th>Matrice</th><th>Perché non gelifica</th><th>Cosa fare</th></tr>';
                bodyHTML += p.matrix_guide.map(function(m) { return '<tr><td><strong>' + m.matrice + '</strong></td><td>' + m.problema + '</td><td>' + m.soluzione + '</td></tr>'; }).join('');
                bodyHTML += '</table></div>';
            }

            if (p.is_checklist && p.checklist) {
                bodyHTML += '<div class="td-pc-section"><div class="td-pc-section-title">CHECKLIST DIAGNOSTICA</div>';
                bodyHTML += '<ul class="td-checklist">' + p.checklist.map(function(c) { return '<li>' + c + '</li>'; }).join('') + '</ul></div>';
            }

            if (p.is_color_guide && p.color_guide) {
                bodyHTML += '<div class="td-pc-section"><div class="td-pc-section-title">GUIDA</div>';
                bodyHTML += '<table class="td-matrix-table"><tr><th>' + (p.id === 'contaminazione' ? 'Colore' : 'Colorante') + '</th><th>Stabilità</th><th>Problema</th><th>Nota</th></tr>';
                bodyHTML += p.color_guide.map(function(c) { return '<tr><td><strong>' + c.col + '</strong></td><td>' + c.stab + '</td><td>' + c.problema + '</td><td>' + c.nota + '</td></tr>'; }).join('');
                bodyHTML += '</table></div>';
            }

            if (p.soluzioni && p.soluzioni.length > 0) {
                bodyHTML += '<div class="td-pc-section"><div class="td-pc-section-title">SOLUZIONI</div><div class="td-solutions-grid">';
                bodyHTML += p.soluzioni.map(function(s, si) {
                    var stars = ''; for (var j = 0; j < 3; j++) stars += (j < s.efficacia ? '★' : '☆');
                    var diffClass = s.diff === 'Avanzato' ? 'hard' : s.diff === 'Medio' ? 'medium' : '';
                    var suggests = tabD_getSuggestedIngredients(p.id, s.nome);
                    var addBtns = '';
                    if (suggests.length > 0) {
                        addBtns = '<div class="td-sol-adds">' + suggests.map(function(sid) {
                            var ings = (INGREDIENTI_DATA && INGREDIENTI_DATA.ingredienti) ? INGREDIENTI_DATA.ingredienti : {};
                            var sIng = ings[sid];
                            if (!sIng) return '';
                            var onTav = tabD_isOnTavolo(sid);
                            return '<span class="td-sol-add-btn' + (onTav ? ' added' : '') + '" onclick="event.stopPropagation();' + (onTav ? '' : 'tabD_addCorrettivo(\'' + sid + '\')') + '">' +
                                (onTav ? '✓ ' : '<span class="td-plus">+</span> ') + sIng.nome + '</span>';
                        }).join('') + '</div>';
                    }
                    return '<div class="td-sol-card" onclick="event.stopPropagation();tabD_openSolModal(\'' + p.id + '\',' + si + ')">' +
                        '<div class="td-sol-header"><span class="td-sol-name">' + s.nome + '</span><span class="td-sol-difficulty ' + diffClass + '">' + s.diff + '</span><span class="td-sol-stars">' + stars + '</span></div>' +
                        '<div class="td-sol-desc">' + s.desc + '</div>' +
                        addBtns +
                        '</div>';
                }).join('');
                bodyHTML += '</div></div>';
            }

            if (p.studenti && p.studenti.length > 0) {
                bodyHTML += '<div class="td-pc-section"><div class="td-pc-section-title">ESPERIENZE REALI</div>';
                bodyHTML += p.studenti.map(function(s) { return '<div class="td-student-quote">"' + s.testo + '" <span class="td-source">— ' + s.materiale + '</span></div>'; }).join('');
                bodyHTML += '</div>';
            }

            if (p.nota_sci) {
                bodyHTML += '<div class="td-pc-section"><div class="td-sci-note">' + p.nota_sci + '</div></div>';
            }

            if (p.famiglie_rischio && p.famiglie_rischio.length > 0) {
                bodyHTML += '<div class="td-tag-row">' + p.famiglie_rischio.map(function(f) {
                    var c = TABD_FAMILY_COLORS[f] || '#888';
                    return '<span class="td-tag td-family" style="background:' + c + '22;color:' + c + ';border:1px solid ' + c + '44">' + (TABD_FAMILY_LABELS[f] || f) + '</span>';
                }).join('') + '</div>';
            }

            html += '<div class="td-problem-card" data-id="' + p.id + '" data-gruppo="' + p.gruppo + '">' +
                '<div class="td-pc-header" onclick="tabD_toggleCard(\'' + p.id + '\')">' +
                    '<div class="td-pc-icon ' + gi.cls + '">' + gi.label + '</div>' +
                    '<div class="td-pc-title-area"><div class="td-pc-title">' + p.titolo + '</div><div class="td-pc-subtitle">' + p.sottotitolo + '</div></div>' +
                    '<div class="td-pc-indicators">' +
                        '<div class="td-pc-indicator"><div class="td-pc-dots">' + gravDots + '</div><label>Gravità</label></div>' +
                        '<div class="td-pc-indicator"><div class="td-pc-dots">' + resDots + '</div><label>Risolvib.</label></div>' +
                    '</div>' +
                    '<span class="td-pc-chevron">▶</span>' +
                '</div>' +
                '<div class="td-pc-body">' + bodyHTML + '</div>' +
            '</div>';
        });

        list.innerHTML = html;
    }

    function tabD_toggleCard(id) {
        var card = document.querySelector('#tdProblemsList .td-problem-card[data-id="' + id + '"]');
        if (card) card.classList.toggle('open');
    }

    function tabD_scrollToAndOpen(id) {
        var card = document.querySelector('#tdProblemsList .td-problem-card[data-id="' + id + '"]');
        if (!card) return;
        if (card.classList.contains('hidden')) { tabD_toggleFilter('all'); }
        card.classList.add('open');
        card.scrollIntoView({ behavior: 'smooth', block: 'start' });
        card.style.transition = 'box-shadow 0.3s';
        card.style.boxShadow = '0 0 0 3px #ff9800';
        setTimeout(function() { card.style.boxShadow = ''; }, 1500);
    }

    // ── SOLUTION INGREDIENTS ──
    function tabD_getSuggestedIngredients(problemId, solNome) {
        var mappings = SOLUTION_INGREDIENTS[problemId];
        if (!mappings) return [];
        for (var i = 0; i < mappings.length; i++) {
            if (solNome.toLowerCase().indexOf(mappings[i].match.toLowerCase()) !== -1) {
                return mappings[i].ingredienti;
            }
        }
        return [];
    }

    function tabD_addCorrettivo(id) {
        tabD_addToTavolo(id, 'correttivo');
        tabD_renderProblems();
        tabD_updateAll();
    }

    // ── SOLUTION MODAL ──
    function tabD_openSolModal(problemId, solIndex) {
        var p = PROBLEMI.find(function(x) { return x.id === problemId; });
        if (!p || !p.soluzioni || !p.soluzioni[solIndex]) return;
        var s = p.soluzioni[solIndex];

        document.getElementById('tdSolModalTitle').textContent = s.nome;
        var badge = document.getElementById('tdSolModalBadge');
        badge.textContent = s.diff;
        badge.className = 'td-sol-modal-badge' + (s.diff === 'Avanzato' ? ' hard' : s.diff === 'Medio' ? ' medium' : '');

        var starsHTML = '';
        for (var i = 0; i < 3; i++) starsHTML += '<span class="td-sol-modal-star' + (i < s.efficacia ? ' filled' : '') + '"></span>';

        var html = '';
        html += '<div class="td-sol-modal-section"><div class="td-sol-modal-label">Cosa fare</div><div class="td-sol-modal-desc">' + s.desc + '</div></div>';
        html += '<div class="td-sol-modal-section"><div class="td-sol-modal-label">Efficacia</div><div class="td-sol-modal-efficacy">' + starsHTML + '</div></div>';
        html += '<div class="td-sol-modal-section"><div class="td-sol-modal-label">Pro e Contro</div><div class="td-sol-modal-procon">' +
            '<div class="td-sol-modal-pro">+ ' + s.pro + '</div>' +
            '<div class="td-sol-modal-con">- ' + s.con + '</div>' +
        '</div></div>';

        var suggests = tabD_getSuggestedIngredients(problemId, s.nome);
        if (suggests.length > 0) {
            html += '<div class="td-sol-modal-section"><div class="td-sol-modal-label">Aggiungi al tavolo come correttivo</div><div class="td-sol-modal-adds">';
            var ings = (INGREDIENTI_DATA && INGREDIENTI_DATA.ingredienti) ? INGREDIENTI_DATA.ingredienti : {};
            html += suggests.map(function(sid) {
                var sIng = ings[sid];
                if (!sIng) return '';
                var onTav = tabD_isOnTavolo(sid);
                return '<span class="td-sol-add-btn' + (onTav ? ' added' : '') + '" onclick="' + (onTav ? '' : 'tabD_addCorrettivoFromModal(\'' + sid + '\',\'' + problemId + '\',' + solIndex + ')') + '">' +
                    (onTav ? '✓ Sul tavolo' : '<span class="td-plus">+</span> ' + sIng.nome) + '</span>';
            }).join('');
            html += '</div></div>';
        }

        html += '<div class="td-sol-modal-section"><div class="td-sol-modal-label">Problema di riferimento</div><div class="td-sol-modal-desc">' + p.titolo + '</div></div>';

        if (s.link) {
            var linked = PROBLEMI.find(function(x) { return x.id === s.link; });
            if (linked) {
                html += '<div class="td-sol-modal-section"><div class="td-sol-modal-label">Attenzione</div>' +
                    '<span class="td-sol-modal-link" onclick="tabD_closeSolModal();tabD_scrollToAndOpen(\'' + s.link + '\')">' +
                    'Questa soluzione può causare: ' + linked.titolo + ' →' +
                    '</span></div>';
            }
        }

        document.getElementById('tdSolModalBody').innerHTML = html;
        document.getElementById('tdSolModal').classList.add('open');
        document.body.style.overflow = 'hidden';
    }

    function tabD_addCorrettivoFromModal(id, problemId, solIndex) {
        tabD_addCorrettivo(id);
        tabD_openSolModal(problemId, solIndex);
    }

    function tabD_closeSolModal() {
        document.getElementById('tdSolModal').classList.remove('open');
        document.body.style.overflow = '';
    }
    // ============================================
    // MOBILE RESPONSIVE — sidebar toggle
    // ============================================
    
    function mobileIsMobile() {
        return window.innerWidth <= 768;
    }
    
    function mobileUpdateFab() {
        var fab = document.getElementById('cartFab');
        var badge = document.getElementById('fabBadge');
        if (!fab || !badge) return;
        
        // Determina quale tab è attiva
        var isTabD = document.body.classList.contains('tab-D-active');
        
        if (isTabD) {
            // Tab D: mostra conteggio ricetta diagnostica
            fab.classList.add('fab-tabD');
            var count = tabD_tavolo ? tabD_tavolo.length : 0;
            badge.textContent = count > 0 ? count : '';
        } else {
            // Tab normali: mostra conteggio carrello
            fab.classList.remove('fab-tabD');
            var count = cart ? cart.length : 0;
            badge.textContent = count > 0 ? count : '';
        }
    }
    
    function mobileToggleSidebar() {
        if (!mobileIsMobile()) return;
        
        var isTabD = document.body.classList.contains('tab-D-active');
        var sidebar = isTabD 
            ? document.querySelector('.tabD-sidebar') 
            : document.querySelector('.cart-sidebar');
        var overlay = document.getElementById('mobileOverlay');
        
        if (!sidebar) return;
        
        var isOpen = sidebar.classList.contains('mobile-open');
        if (isOpen) {
            mobileCloseSidebar();
        } else {
            sidebar.classList.add('mobile-open');
            overlay.classList.add('show');
        }
    }
    
    function mobileCloseSidebar() {
        document.querySelectorAll('.cart-sidebar, .tabD-sidebar').forEach(function(el) {
            el.classList.remove('mobile-open');
        });
        var overlay = document.getElementById('mobileOverlay');
        if (overlay) overlay.classList.remove('show');
    }
    
    // Chiudi sidebar su resize (se torna desktop)
    window.addEventListener('resize', function() {
        if (!mobileIsMobile()) {
            mobileCloseSidebar();
        }
    });

    document.addEventListener('DOMContentLoaded', loadData);
    </script>
    <!-- Toast container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- DISCLAIMER FOOTER -->
    <!-- MOBILE: overlay + FAB -->
    <div class="mobile-overlay" id="mobileOverlay" onclick="mobileCloseSidebar()"></div>
    <button class="cart-fab" id="cartFab" onclick="mobileToggleSidebar()">
        <svg viewBox="0 0 24 24">
            <circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/>
            <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
        </svg>
        <span class="fab-badge" id="fabBadge"></span>
    </button>
    
    <div class="disclaimer-footer">
        <strong>Strumento didattico sperimentale</strong> | Le formulazioni sono indicative e richiedono verifica pratica in laboratorio. Non sostituisce competenze chimiche.
        <br><span style="opacity: 0.7; font-size: 0.65rem;">Sviluppato con Claude AI by Anthropic</span>
    </div>

</body>
</html>